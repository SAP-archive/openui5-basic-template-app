/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/uid","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,n){"use strict";var o={};o.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";o.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";o.sTypeTitle="sap.ui.core.Title";o.sTypeMTitle="sap.m.Title";o.sTypeToolBar="sap.m.Toolbar";o.sTypeOverflowToolBar="sap.m.OverflowToolbar";o.sTypeLabel="sap.m.Label";o.sTypeSmartLabel="sap.ui.comp.smartfield.SmartLabel";o.CONTENT_AGGREGATION="content";var a=function(e,r,t){for(var n=0;n<t.length;n++){var o=e.getControlType(t[n]);if(r.indexOf(o)===-1){if(e.getVisible(t[n])){return true}}else{return false}}};var l=function(e,t,n,o,l){if(a(e,l,t)){var i=o.view;var p=o.appComponent;var v=p.createId(r());var c=e.createControl("sap.ui.core.Title",p,i,v);e.setProperty(c,"text","");e.insertAggregation(n,"content",c,0,i)}return e.getAggregation(n,"content")};var i=function(e,r,t,n){var o;var l=-1;if(a(e,r,t)){l++}for(var i=0;i<t.length;i++){var p=e.getControlType(t[i]);if(r.indexOf(p)>-1){l++;if(l===n){o=t[i];break}}}return t.indexOf(o)};var p=function(e,r,t){if(r>=e.length||r===-1){return true}var n=t.getControlType(e[r]);return o.sTypeTitle===n||o.sTypeToolBar===n||o.sTypeMTitle===n||o.sTypeOverflowToolBar===n};var v=function(e,r,t,n){var o=0;for(o=r+1;o<t.length;++o){var a=e.getControlType(t[o]);if(n.indexOf(a)>-1){break}}return o-r};var c=function(e,r,t){return v(e,t,r,[o.sTypeTitle,o.sTypeMTitle,o.sTypeToolBar,o.sTypeOverflowToolBar,o.sTypeLabel,o.sTypeSmartLabel])};var g=function(e,r,n,o,a){if(!p(r,n,e)){t.error("Illegal argument. iIndex has to point to a Label.")}else{o=a?o+1:o;var l=0;var i=n;var v;while(i<r.length&&l<o){++l;v=c(e,r,i);i+=v}return i}};var s=function(e,r,t,n,o){var a=t;for(var l=0;l<o;l++){a.splice(n+l,0,e[r+l])}return a};var u=function(e){var r=e.getTitle();if(!r){r=e.getToolbar()}return r};var d=function(r,t,n,a,l){var i=u(t.element);var p=e.getSelector(r,l.appComponent);var v={elementSelector:e.getSelector(i,l.appComponent),source:{groupIndex:t.sourceIndex},target:{groupIndex:t.targetIndex}};return{changeType:o.CHANGE_TYPE_MOVE_GROUP,targetSelector:p,movedControl:i,movedElements:[v]}};var f=function(r,t,n,a,l){var i=e.getSelector(r,l.appComponent);var p=t.element.getLabel();var v=e.getSelector(p,l.appComponent);var c=u(a.parent);var g=u(n.parent);var s=e.getSelector(c,l.appComponent);var d=e.getSelector(g,l.appComponent);var f={elementSelector:v,source:{groupSelector:d,fieldIndex:t.sourceIndex},target:{groupSelector:s,fieldIndex:t.targetIndex}};return{changeType:o.CHANGE_TYPE_MOVE_FIELD,targetSelector:i,target:c,source:g,movedControl:p,movedElements:[f]}};var m=function(e,r,t,n,o){e.removeAllAggregation(r,t.CONTENT_AGGREGATION);for(var a=0;a<n.length;++a){e.insertAggregation(r,t.CONTENT_AGGREGATION,n[a],a,o)}};o.applyChange=function(e,r,n){var a=n.modifier;var p=n.view;var u=n.appComponent;var d,f;var T=e.getContent();var y=T.movedElements[0];var C=a.getAggregation(r,o.CONTENT_AGGREGATION);var E=C.map(function(e){return a.getSelector(e,u)});var S={content:E};e.setRevertData(S);if(e.getChangeType()===o.CHANGE_TYPE_MOVE_FIELD){var I=a.bySelector(y.elementSelector||y.element,u,p);var O=C.indexOf(I);var x=c(a,C,O);d=a.bySelector(y.target.groupSelector||y.target.groupId,u,p);var b=C.indexOf(d);var h=a.bySelector(y.source.groupSelector||y.source.groupId,u,p);var G=C.indexOf(h);var _=g(a,C,b,y.target.fieldIndex,G===b&&y.source.fieldIndex<y.target.fieldIndex);var A=c(a,C,_);f=C.slice();var N=f.slice(O,O+x);var w,L,M,P;if(O<_){w=f.slice(0,O);M=f.slice(O+x,_+A);P=f.slice(_+A,f.length);f=w.concat(M.concat(N.concat(P)))}else if(O>_){L=f.slice(0,_+A);M=f.slice(_+A,O);P=f.slice(O+x,f.length);f=L.concat(N.concat(M.concat(P)))}if(O!=_){m(a,r,o,f,p)}}else if(e.getChangeType()===o.CHANGE_TYPE_MOVE_GROUP){var F=[o.sTypeTitle,o.sTypeToolBar,o.sTypeMTitle,o.sTypeOverflowToolBar];var D=a.bySelector(y.elementSelector||y.element,u,p);if(y.target.groupIndex===0||!D){C=l(a,C,r,n,F,T.newControlId)}var R=D?C.indexOf(D):0;var B=i(a,F,C,y.target.groupIndex);d=C[B];var V=v(a,B,C,F);var H=v(a,R,C,F);f=C.slice();f.splice(R,H);B=f.indexOf(d);var Y=y.source.groupIndex<y.target.groupIndex?V:0;f=s(C,R,f,B+Y,H);m(a,r,o,f,p)}else{t.warning("Unknown change type detected. Cannot apply to SimpleForm")}return true};o.completeChangeContent=function(e,r,o){var a;var l=o.modifier;var i=o.view;var p=o.appComponent;var v=l.bySelector(r.selector,p,i);var c=r.movedElements;if(c.length>1){t.warning("Moving more than 1 Formelement is not yet supported.")}var g=c[0];g.element=sap.ui.getCore().byId(g.id);var s=n.extend({},r.source);var u=n.extend({},r.target);if(!u.parent){u.parent=sap.ui.getCore().byId(u.id)}if(!s.parent){s.parent=sap.ui.getCore().byId(s.id)}if(v&&g.element&&u.parent){if(r.changeType==="moveSimpleFormGroup"){a=d(v,g,s,u,o)}else if(r.changeType==="moveSimpleFormField"){a=f(v,g,s,u,o)}}else{t.error("Element not found. This may caused by an instable id!")}var m=e.getDefinition();m.content.targetSelector=a.targetSelector;m.content.movedElements=a.movedElements;if(a.source&&a.target){e.addDependentControl(a.source,"sourceParent",o);e.addDependentControl(a.target,"targetParent",o)}e.addDependentControl([a.movedControl],"movedElements",o)};o.revertChange=function(e,r,t){var n=t.modifier;var a=t.appComponent;var l=t.view;var i=e.getRevertData().content;var p=i.map(function(e){return n.bySelector(e,a,l)});m(n,r,o,p,l);e.resetRevertData();return true};return o},true);