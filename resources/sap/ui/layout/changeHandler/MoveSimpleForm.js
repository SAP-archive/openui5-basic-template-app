/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/uid","sap/base/Log"],function(e,t,r){"use strict";var n={};n.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";n.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";n.sTypeTitle="sap.ui.core.Title";n.sTypeMTitle="sap.m.Title";n.sTypeToolBar="sap.m.Toolbar";n.sTypeOverflowToolBar="sap.m.OverflowToolbar";n.sTypeLabel="sap.m.Label";n.sTypeSmartLabel="sap.ui.comp.smartfield.SmartLabel";n.CONTENT_AGGREGATION="content";function o(e,t,r){return r.reduce(function(r,n){return r.then(function(r){if(r!==undefined){return r}var o=e.getControlType(n);if(t.indexOf(o)===-1){return Promise.resolve().then(e.getVisible.bind(e,n)).then(function(e){return e||undefined})}else{return false}})},Promise.resolve())}function a(e,t,r,n,a,i,l){return o(t,i,r).then(function(r){if(r){var o=a.view;var i=a.appComponent;var c;return Promise.resolve().then(t.createControl.bind(t,"sap.ui.core.Title",i,o,l)).then(function(e){c=e;t.setProperty(c,"text","");return t.insertAggregation(n,"content",c,0,o)}).then(function(){var t=e.getRevertData();t.createdTitleSelector=a.modifier.getSelector(c,a.appComponent);e.setRevertData(t)})}return Promise.resolve()}).then(function(){return t.getAggregation(n,"content")})}function i(e,t,r,n){var a;var i=-1;return o(e,t,r).then(function(o){if(o){i++}for(var l=0;l<r.length;l++){var c=e.getControlType(r[l]);if(t.indexOf(c)>-1){i++;if(i===n){a=r[l];break}}}return r.indexOf(a)})}function l(e,t,r){if(t>=e.length||t===-1){return true}var o=r.getControlType(e[t]);return n.sTypeTitle===o||n.sTypeToolBar===o||n.sTypeMTitle===o||n.sTypeOverflowToolBar===o}function c(e,t,r,n){var o=0;for(o=t+1;o<r.length;++o){var a=e.getControlType(r[o]);if(n.indexOf(a)>-1){break}}return o-t}function u(e,t,r){return c(e,r,t,[n.sTypeTitle,n.sTypeMTitle,n.sTypeToolBar,n.sTypeOverflowToolBar,n.sTypeLabel,n.sTypeSmartLabel])}function p(e,t,n,o,a){if(!l(t,n,e)){r.error("Illegal argument. iIndex has to point to a Label.")}else{o=a?o+1:o;var i=0;var c=n;var p;while(c<t.length&&i<o){++i;p=u(e,t,c);c+=p}return c}}function s(e,t,r,n,o){var a=r;for(var i=0;i<o;i++){a.splice(n+i,0,e[t+i])}return a}function v(e){var t=e.getTitle();if(!t){t=e.getToolbar()}return t}function g(e,t,r){var o=v(t.element);var a=r.modifier.getSelector(e,r.appComponent);var i={elementSelector:r.modifier.getSelector(o,r.appComponent),source:{groupIndex:t.sourceIndex},target:{groupIndex:t.targetIndex}};return{changeType:n.CHANGE_TYPE_MOVE_GROUP,targetSelector:a,movedControl:o,movedElements:[i]}}function f(e,t,r,o,a){var i=a.modifier.getSelector(e,a.appComponent);var l=t.element.getLabel();var c=a.modifier.getSelector(l,a.appComponent);var u=v(o.parent);var p=v(r.parent);var s=a.modifier.getSelector(u,a.appComponent);var g=a.modifier.getSelector(p,a.appComponent);var f={elementSelector:c,source:{groupSelector:g,fieldIndex:t.sourceIndex},target:{groupSelector:s,fieldIndex:t.targetIndex}};return{changeType:n.CHANGE_TYPE_MOVE_FIELD,targetSelector:i,target:u,source:p,movedControl:l,movedElements:[f]}}function d(e,t,r,n,o){return Promise.resolve().then(e.removeAllAggregation.bind(e,t,r.CONTENT_AGGREGATION)).then(function(){return n.reduce(function(n,a,i){return n.then(e.insertAggregation.bind(e,t,r.CONTENT_AGGREGATION,a,i,o))},Promise.resolve())})}n.applyChange=function(e,t,o){var l=o.modifier;var v=o.view;var g=o.appComponent;var f;var m;var T;var C=e.getContent();var y=C.movedElements[0];return Promise.resolve().then(function(){return l.getAggregation(t,n.CONTENT_AGGREGATION)}).then(function(S){var h=S.map(function(e){return l.getSelector(e,g)});var E={content:h};e.setRevertData(E);if(e.getChangeType()===n.CHANGE_TYPE_MOVE_FIELD){var b=l.bySelector(y.elementSelector||y.element,g,v);var I=S.indexOf(b);var O=u(l,S,I);f=l.bySelector(y.target.groupSelector||y.target.groupId,g,v);var x=S.indexOf(f);var G=l.bySelector(y.source.groupSelector||y.source.groupId,g,v);var _=S.indexOf(G);var P=p(l,S,x,y.target.fieldIndex,_===x&&y.source.fieldIndex<y.target.fieldIndex);var A=u(l,S,P);m=S.slice();var N=m.slice(I,I+O);var w,D,L,M;if(I<P){w=m.slice(0,I);L=m.slice(I+O,P+A);M=m.slice(P+A,m.length);m=w.concat(L.concat(N.concat(M)))}else if(I>P){D=m.slice(0,P+A);L=m.slice(P+A,I);M=m.slice(I+O,m.length);m=D.concat(N.concat(L.concat(M)))}if(I!=P){return d(l,t,n,m,v)}}else if(e.getChangeType()===n.CHANGE_TYPE_MOVE_GROUP){var R=[n.sTypeTitle,n.sTypeToolBar,n.sTypeMTitle,n.sTypeOverflowToolBar];var F=l.bySelector(y.elementSelector||y.element,g,v);return Promise.resolve().then(function(){if(y.target.groupIndex===0||!F){return a(e,l,S,t,o,R,C.newControlId).then(function(e){S=e})}return undefined}).then(function(){T=F?S.indexOf(F):0;return i(l,R,S,y.target.groupIndex)}).then(function(e){f=S[e];var r=c(l,e,S,R);var o=c(l,T,S,R);m=S.slice();m.splice(T,o);e=m.indexOf(f);var a=y.source.groupIndex<y.target.groupIndex?r:0;m=s(S,T,m,e+a,o);return d(l,t,n,m,v)})}else{r.warning("Unknown change type detected. Cannot apply to SimpleForm")}})};n.completeChangeContent=function(e,n,o){var a;var i=o.modifier;var l=o.view;var c=o.appComponent;var u=i.bySelector(n.selector,c,l);var p=n.movedElements;if(p.length>1){r.warning("Moving more than 1 Formelement is not yet supported.")}var s=p[0];s.element=sap.ui.getCore().byId(s.id);var v=Object.assign({},n.source);var d=Object.assign({},n.target);if(!d.parent){d.parent=sap.ui.getCore().byId(d.id)}if(!v.parent){v.parent=sap.ui.getCore().byId(v.id)}if(u&&s.element&&d.parent){if(n.changeType==="moveSimpleFormGroup"){a=g(u,s,o)}else if(n.changeType==="moveSimpleFormField"){a=f(u,s,v,d,o)}}else{r.error("Element not found. This may be caused by an unstable id!")}var m=e.getDefinition();m.content.targetSelector=a.targetSelector;m.content.movedElements=a.movedElements;m.content.newControlId=i.getSelector(l.createId(t()),c);if(a.source&&a.target){e.addDependentControl(a.source,"sourceParent",o);e.addDependentControl(a.target,"targetParent",o)}e.addDependentControl([a.movedControl],"movedElements",o)};n.revertChange=function(e,t,r){var o=r.modifier;var a=r.appComponent;var i=r.view;var l=e.getRevertData();var c=l.content;var u=c.map(function(e){return o.bySelector(e,a,i)});return d(o,t,n,u,i).then(function(){var t=l.createdTitleSelector;var n=r.modifier.bySelector(t,r.appComponent);if(n){n.destroy()}e.resetRevertData();return true})};n.getChangeVisualizationInfo=function(t,r){var n=t.getContent().movedElements[0];var o=n.source.groupSelector;var a=e.bySelector(n.elementSelector,r).getParent().getId();return{affectedControls:[a],dependentControls:[o&&o.id?o:t.getContent().targetSelector]}};return n},true);