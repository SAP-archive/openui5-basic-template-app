/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/Log"],function(e,t,n){"use strict";var r={};r.CONTENT_AGGREGATION="content";var o=function(e,t,n){return n.reduce(function(n,r){return n.then(function(n){if(n!==undefined){return n}var o=e.getControlType(r);if(t.indexOf(o)===-1){return Promise.resolve().then(e.getVisible.bind(e,r)).then(function(e){return e||undefined})}else{return false}})},Promise.resolve())};var i=function(e,t,n,r){var i;var a=-1;if(r===0){return r}return o(e,t,n).then(function(o){if(o){a++}for(var u=0;u<n.length;u++){var f=e.getControlType(n[u]);if(t.indexOf(f)>-1){a++;if(a===r){i=n[u];return n.indexOf(i)}}}return n.length})};r.applyChange=function(t,o,a){var u=a.modifier;var f=a.view;var c=a.appComponent;var l;var g=t.getDefinition();if(g.texts&&g.texts.groupLabel&&g.texts.groupLabel.value&&g.content&&g.content.group&&(g.content.group.selector||g.content.group.id)){var s=g.content.group.selector;var p;if(s){if(s.idIsLocal){p=c.createId(s.id)}else{p=s.id}}else{p=g.content.group.id}t.setRevertData({groupId:p});var d=g.texts.groupLabel.value;var v;return Promise.resolve().then(function(){return u.getAggregation(o,r.CONTENT_AGGREGATION)}).then(function(e){if(typeof g.content.group.index==="number"){return g.content.group.index}else{v=g.content.group.relativeIndex;return i(u,["sap.ui.core.Title","sap.m.Title","sap.m.Toolbar","sap.m.OverflowToolbar"],e,v)}}).then(function(t){l=t;if(u.bySelector(p,c)){return e.markAsNotApplicable("Control to be created already exists:"+p)}return u.createControl("sap.ui.core.Title",c,f,p)}).then(function(e){u.setProperty(e,"text",d);return u.insertAggregation(o,"content",e,l,f)})}else{n.error("Change does not contain sufficient information to be applied: ["+g.layer+"]"+g.namespace+"/"+g.fileName+"."+g.fileType)}};r.completeChangeContent=function(n,r,o){var i=n.getDefinition();var a=o.appComponent;if(r.newLabel){e.setTextInChange(i,"groupLabel",r.newLabel,"XFLD")}else{throw new Error("oSpecificChangeInfo.newLabel attribute required")}if(!i.content){i.content={}}if(!i.content.group){i.content.group={}}if(r.newControlId){i.content.group.selector=t.getSelector(r.newControlId,a)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(r.index===undefined){throw new Error("oSpecificChangeInfo.index attribute required")}else{i.content.group.relativeIndex=r.index}};r.getControlIdFromChangeContent=function(e){var t;if(e&&e._oDefinition){t=e._oDefinition.content.group.id}return t};r.revertChange=function(e,t,n){var o=n.appComponent;var i=n.view;var a=n.modifier;var u=e.getRevertData().groupId;var f=a.getSelector(u,o);var c=a.bySelector(f,o,i);return Promise.resolve().then(function(){return a.removeAggregation(t,r.CONTENT_AGGREGATION,c)}).then(function(){a.destroy(c);e.resetRevertData()})};r.getChangeVisualizationInfo=function(e,n){var r=e.getDefinition().content.group.selector;var o=t.bySelector(r,n).getParent().getId();return{affectedControls:[o]}};return r},true);