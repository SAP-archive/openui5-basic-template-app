/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Control","sap/ui/core/mvc/Controller","sap/base/util/merge","sap/ui/core/library","./ViewRenderer","./XMLProcessingMode","sap/base/assert","sap/base/Log","sap/base/util/extend"],function(e,r,t,o,n,i,s,a,c,p){"use strict";var u=n.mvc.ViewType;var f=r.extend("sap.ui.core.mvc.View",{metadata:{interfaces:["sap.ui.core.IDScope"],library:"sap.ui.core",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},viewName:{type:"string",group:"Misc",defaultValue:null},displayBlock:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},events:{afterInit:{},beforeExit:{},afterRendering:{},beforeRendering:{}},specialSettings:{controller:"sap.ui.core.mvc.Controller",controllerName:"string",preprocessors:"Object",resourceBundleName:"string",resourceBundleUrl:"sap.ui.core.URI",resourceBundleLocale:"string",resourceBundleAlias:"string",type:"string",definition:"any",viewContent:{type:"any",deprecated:true},viewData:"any",async:{type:"boolean",defaultValue:false}},designtime:"sap/ui/core/designtime/mvc/View.designtime"}});f._mPreprocessors={};function l(e){e._settings={};for(var r in e){if(r.indexOf("_")!==0){e._settings[r]=e[r]}}}function d(e,r){var t;if(typeof e.preprocessor==="string"){var o=e.preprocessor.replace(/\./g,"/");if(r){return new Promise(function(e,r){sap.ui.require([o],function(r){e(r)},r)})}else{return sap.ui.requireSync(o)}}else if(typeof e.preprocessor==="function"&&!e.preprocessor.process){t={process:e.preprocessor}}else{t=e.preprocessor}if(r){return Promise.resolve(t)}else{return t}}function g(e,r){var t=this.mPreprocessors[r]||[],o=[],n,i,s,a=[];if(f._mPreprocessors[e]&&f._mPreprocessors[e][r]){o=f._mPreprocessors[e][r].map(function(e){return Object.assign({},e)})}for(n=0,i=o.length;n<i;n++){if(o[n]._onDemand){s=o[n]}else{a.push(o[n])}}for(n=0,i=t.length;n<i;n++){var c=!t[n].preprocessor;if(c&&s){a.unshift(p(t[n],s))}else if(!c){a.push(t[n])}}return a}function m(e,r){var t=e.getMetadata().getClass();function o(e){e.preprocessor=d(e,r.async)}e.mPreprocessors=Object.assign({},r.preprocessors);for(var n in t.PreprocessorType){var i=t.PreprocessorType[n];if(e.mPreprocessors[i]&&!Array.isArray(e.mPreprocessors[i])){e.mPreprocessors[i]=[e.mPreprocessors[i]]}else if(!e.mPreprocessors[i]){e.mPreprocessors[i]=[]}e.mPreprocessors[i].forEach(l);e.mPreprocessors[i]=g.call(e,t._sType,i);e.mPreprocessors[i].forEach(o)}}function h(e){e.oAsyncState={};e.oAsyncState.promise=null}var y=function(r,o){if(!sap.ui.getCore().getConfiguration().getControllerCodeDeactivated()){var n=o.controller,i=n&&typeof n.getMetadata==="function"&&n.getMetadata().getName(),s=o.async;if(!n&&r.getControllerName){var a=r.getControllerName();if(a){var c=sap.ui.require("sap/ui/core/CustomizingConfiguration");var p=c&&c.getControllerReplacement(a,e._sOwnerId);if(p){a=typeof p==="string"?p:p.controllerName}if(s){n=t.create({name:a})}else{n=sap.ui.controller(a,true)}}}else if(n){var u=e._sOwnerId;if(!n._isExtended()){if(s){n=t.extendByCustomizing(n,i,u,s).then(function(e){return t.extendByProvider(e,i,u,s)})}else{n=t.extendByCustomizing(n,i,u,s);n=t.extendByProvider(n,i,u,s)}}else if(s){n=Promise.resolve(n)}}if(n){var f=function(e){r.oController=e;e.oView=r};if(s){if(!r.oAsyncState){throw new Error("The view "+r.sViewName+" runs in sync mode and therefore cannot use async controller extensions!")}return n.then(f)}else{f(n)}}}else{sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl",{"_sap.ui.core.mvc.EmptyControllerImpl":true});r.oController=sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl")}};f.prototype._initCompositeSupport=function(e){a(!e.preprocessors||this.getMetadata().getName().indexOf("XMLView"),"Preprocessors only available for XMLView");this.oViewData=e.viewData;this.sViewName=e.viewName;var r=this;m(this,e);if(e.async){h(this)}var t=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(t&&t.hasCustomProperties(this.sViewName,this)){this._fnSettingsPreprocessor=function(e){var o=this.getId();if(t&&o){if(r.isPrefixedId(o)){o=o.substring((r.getId()+"--").length)}var n=t.getCustomProperties(r.sViewName,o,r);if(n){e=p(e,n)}}}}var o=function(e,t){a(typeof e==="function","fn must be a function");var o=sap.ui.require("sap/ui/core/Component");var n=o&&o.getOwnerComponentFor(r);if(n){if(t){r.fnScopedRunWithOwner=r.fnScopedRunWithOwner||function(e){return n.runAsOwner(e)}}return n.runAsOwner(e)}return e()};var n=function(e){if(e.oController&&e.oController.connectToView){return e.oController.connectToView(e)}};var i=function(){if(r.onControllerConnected){return r.onControllerConnected(r.oController)}};if(this.initViewSettings){if(e.async){this.oAsyncState.promise=this.initViewSettings(e).then(function(){return o(y.bind(null,r,e),true)}).then(function(){return o(i,true)}).then(function(){return n(r)}).then(function(){return r.runPreprocessor("controls",r,false)}).then(function(){return o(r.fireAfterInit.bind(r),true)}).then(function(){return r}).catch(function(e){this.deregister();throw e}.bind(this))}else{this.initViewSettings(e);y(this,e);i();n(this);this.runPreprocessor("controls",this,true);this.fireAfterInit()}}};f.prototype.getController=function(){return this.oController};f.prototype.byId=function(e){return sap.ui.getCore().byId(this.createId(e))};f.prototype.createId=function(e){if(!this.isPrefixedId(e)){e=this.getId()+"--"+e}return e};f.prototype.getLocalId=function(e){var r=this.getId()+"--";return e&&e.indexOf(r)===0?e.slice(r.length):null};f.prototype.isPrefixedId=function(e){return!!(e&&e.indexOf(this.getId()+"--")===0)};f.prototype.getViewData=function(){return this.oViewData};function v(){this.oAsyncState=null}f.prototype.exit=function(){this.fireBeforeExit();delete this.oController;delete this.oPreprocessorInfo;if(this.oAsyncState){var e=v.bind(this);this.oAsyncState.promise.then(e,e)}};f.prototype.onAfterRendering=function(){this.fireAfterRendering()};f.prototype.onBeforeRendering=function(){this.fireBeforeRendering()};f.prototype.clone=function(e,t){var o={},n,i;for(n in this.mProperties&&!(this.isBound&&this.isBound(n))){if(this.mProperties.hasOwnProperty(n)){o[n]=this.mProperties[n]}}i=r.prototype.clone.call(this,e,t,{cloneChildren:false,cloneBindings:true});var s,a,c;for(s in i.mEventRegistry){a=i.mEventRegistry[s];for(c=a.length-1;c>=0;c--){if(a[c].oListener===this.getController()){a[c]={oListener:i.getController(),fFunction:a[c].fFunction,oData:a[c].oData}}}}i.applySettings(o);return i};f.prototype.getPreprocessors=function(){return this.mPreprocessors};f.prototype.getPreprocessorInfo=function(e){if(!this.oPreprocessorInfo){this.oPreprocessorInfo={name:this.sViewName,componentId:this._sOwnerId,id:this.getId(),caller:this+" ("+this.sViewName+")",sync:!!e}}if(f._supportInfo){this.oPreprocessorInfo._supportInfo=f._supportInfo}return this.oPreprocessorInfo};f.prototype.runPreprocessor=function(e,r,t){var o=this.getPreprocessorInfo(t),n=this.mPreprocessors&&this.mPreprocessors[e]||[],i,s,a;if(!t){s=function(e,r){return function(t){return r.preprocessor.then(function(o){return o.process(t,e,r._settings)})}};a=Promise.resolve(r)}for(var p=0,u=n.length;p<u;p++){if(t&&n[p]._syncSupport===true){i=n[p].preprocessor.process;r=i(r,o,n[p]._settings)}else if(!t){a=a.then(s(o,n[p]))}else{c.debug('Async "'+e+'"-preprocessor was skipped in sync view execution for '+this.getMetadata().getClass()._sType+"View",this.getId())}}return t?r:a};function w(e,r){if(!f._mPreprocessors[r]){f._mPreprocessors[r]={}}if(!f._mPreprocessors[r][e]){f._mPreprocessors[r][e]=[]}}function P(e,r,t){f._mPreprocessors[r][t].forEach(function(r){if(r._onDemand){c.error('Registration for "'+t+'" failed, only one on-demand-preprocessor allowed',e.getMetadata().getName());return false}});return true}f.registerPreprocessor=function(e,r,t,o,n,i){if(typeof n!=="boolean"){i=n;n=false}if(r){w(e,t);if(n&&!P(this,t,e)){return}f._mPreprocessors[t][e].push({preprocessor:r,_onDemand:n,_syncSupport:o,_settings:i});c.debug("Registered "+(n?"on-demand-":"")+'preprocessor for "'+e+'"'+(o?" with syncSupport":""),this.getMetadata().getName())}else{c.error('Registration for "'+e+'" failed, no preprocessor specified',this.getMetadata().getName())}};f.prototype.hasPreprocessor=function(e){return!!this.mPreprocessors[e].length};f.create=function(r){var t=o({},r);t.async=true;t.viewContent=t.definition;var n=sap.ui.require("sap/ui/core/Component");var i;if(n&&e._sOwnerId){i=n.get(e._sOwnerId)}function a(){return C(t.id,t,t.type).loaded()}return new Promise(function(e,r){var o=I(t);sap.ui.require([o],function(r){e(r)},r)}).then(function(e){if(e.getMetadata().isA("sap.ui.core.mvc.XMLView")){t.processingMode=s.Sequential}if(i){return i.runAsOwner(a)}else{return a()}})};f._legacyCreate=C;sap.ui.view=function(e,r,t){var o=function(t){var o="";if(typeof e=="object"){o=e.viewName}o=o||r&&r.name;c[t]("Do not use deprecated view factory functions ("+o+"). "+"Use the static create function on the view module instead: [XML|JS|HTML|JSON|]View.create().","sap.ui.view",null,function(){return{type:"sap.ui.view",name:o}})};if(r&&r.async){o("info")}else{o("warning")}return C(e,r,t)};function C(r,t,o){var n=null,i={};if(typeof r==="object"||typeof r==="string"&&t===undefined){t=r;r=undefined}if(t){if(typeof t==="string"){i.viewName=t}else{i=t}}a(!i.async||typeof i.async==="boolean","sap.ui.view factory: Special setting async has to be of the type 'boolean'!");if(r){i.id=r}if(o){i.type=o}if(i.type===u.XML&&i.async){i.processingMode=i.processingMode||s.SequentialLegacy}var f=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(f){var l=f.getViewReplacement(i.viewName,e._sOwnerId);if(l){c.info("Customizing: View replacement for view '"+i.viewName+"' found and applied: "+l.viewName+" (type: "+l.type+")");p(i,l)}else{c.debug("Customizing: no View replacement found for view '"+i.viewName+"'.")}}var d=I(i);n=S(d,i);return n}function I(e){var r;if(!e.type){throw new Error("No view type specified.")}else if(e.type===u.JS){r="sap/ui/core/mvc/JSView"}else if(e.type===u.JSON){r="sap/ui/core/mvc/JSONView"}else if(e.type===u.XML){r="sap/ui/core/mvc/XMLView"}else if(e.type===u.HTML){r="sap/ui/core/mvc/HTMLView"}else if(e.type===u.Template){r="sap/ui/core/mvc/TemplateView"}else{throw new Error("Unknown view type "+e.type+" specified.")}return r}function S(e,r){var t=sap.ui.require(e);if(!t){t=sap.ui.requireSync(e);if(r.async){c.warning("sap.ui.view was called without requiring the according view class.")}}return new t(r)}f.prototype.loaded=function(){if(this.oAsyncState&&this.oAsyncState.promise){return this.oAsyncState.promise}else{return Promise.resolve(this)}};return f});