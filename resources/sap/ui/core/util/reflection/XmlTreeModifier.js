/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BaseTreeModifier","sap/ui/base/ManagedObject","sap/ui/base/DataType","sap/base/util/merge","sap/ui/util/XMLHelper","sap/ui/core/mvc/EventHandlerResolver","sap/base/util/includes","sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/ui/core/Fragment"],function(e,t,r,n,i,a,o,g,u){"use strict";var s="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var l=n({},e,{targets:"xmlTree",setVisible:function(e,t){if(t){e.removeAttribute("visible")}else{e.setAttribute("visible",t)}},getVisible:function(e){return l.getProperty(e,"visible")},setStashed:function(e,t){if(!t){e.removeAttribute("stashed")}else{e.setAttribute("stashed",t)}l.setVisible(e,!t)},getStashed:function(e){return l.getProperty(e,"stashed")||!l.getProperty(e,"visible")},bindProperty:function(e,t,r){e.setAttribute(t,"{"+r+"}")},unbindProperty:function(e,t){e.removeAttribute(t)},_setProperty:function(e,t,r,n){var i=l._getSerializedValue(r);if(n){i=l._escapeCurlyBracketsInString(i)}e.setAttribute(t,i)},setProperty:function(e,t,r){l._setProperty(e,t,r,true)},getProperty:function(e,n){var i=e.getAttribute(n);var a=l.getControlMetadata(e).getProperty(n);if(a){var o=a.getType();if(n==="value"&&l.getControlType(e)==="sap.ui.core.CustomData"&&l.getProperty(e,"key")==="sap-ui-custom-settings"){o=r.getType("object")}if(i===null){i=a.getDefaultValue()||o.getDefaultValue()}else{var g=t.bindingParser(i,undefined,true);if(u(g)){if(g.path||g.parts){i=undefined}else{i=g}}else{i=o.parseValue(g||i)}}}return i},isPropertyInitial:function(e,t){var r=e.getAttribute(t);return r==null},setPropertyBinding:function(e,t,r){if(typeof r!=="string"){throw new Error("For XML, only strings are supported to be set as property binding.")}e.setAttribute(t,r)},getPropertyBinding:function(e,r){var n=e.getAttribute(r);if(n){var i=t.bindingParser(n,undefined,true);if(i&&(i.path||i.parts)){return i}}},createAndAddCustomData:function(e,t,r){e.setAttributeNS(s,"custom.data.via.modifier:"+t,l._escapeCurlyBracketsInString(r))},createControl:function(e,t,r,n,i,a){var o,g,u;if(!l.bySelector(n,t,r)){var s=e.split(".");var f="";if(s.length>1){g=s.pop();f=s.join(".")}var c=r.ownerDocument.createElementNS(f,g);o=l.getControlIdBySelector(n,t);if(o){c.setAttribute("id",o)}if(i){l.applySettings(c,i)}return a?Promise.resolve(c):c}else{u=new Error("Can't create a control with duplicated ID "+o);if(a){return Promise.reject(u)}throw u}},applySettings:function(e,t){var r=l.getControlMetadata(e);var n=r.getJSONKeys();Object.keys(t).forEach(function(r){var i=n[r];var a=t[r];switch(i._iKind){case 0:l._setProperty(e,r,a,false);break;case 3:l.setAssociation(e,r,a);break;default:throw new Error("Unsupported in applySettings on XMLTreeModifier: "+r)}})},_byId:function(e,t){if(t){if(t.ownerDocument&&t.ownerDocument.getElementById&&t.ownerDocument.getElementById(e)){return t.ownerDocument.getElementById(e)}else{return t.querySelector("[id='"+e+"']")}}},getId:function(e){return e.getAttribute("id")},getParent:function(e){var t=e.parentNode;if(!l.getId(t)&&!l._isExtensionPoint(t)){t=t.parentNode}return t},_getLocalName:function(e){return e.localName||e.baseName||e.nodeName},getControlType:function(e){return l._getControlTypeInXml(e)},setAssociation:function(e,t,r){if(typeof r!=="string"){r=l.getId(r)}e.setAttribute(t,r)},getAssociation:function(e,t){return e.getAttribute(t)},getAllAggregations:function(e){var t=l.getControlMetadata(e);return t.getAllAggregations()},getAggregation:function(e,t){var r=l._findAggregationNode(e,t);var n=l._isSingleValueAggregation(e,t);var i=[];if(r){i=l._getControlsInAggregation(e,r)}else if(l._isAltTypeAggregation(e,t)&&n){i.push(l.getProperty(e,t))}if(t==="customData"){var a;var o=Array.prototype.slice.call(e.attributes).reduce(function(t,r){var n=l._getLocalName(r);if(r.namespaceURI===s){var i=e.ownerDocument.createElementNS("sap.ui.core","CustomData");i.setAttribute("key",n);i.setAttribute("value",r.value);t.push(i)}else if(r.namespaceURI&&r.name.indexOf("xmlns:")!==0){if(!a){a={}}if(!a.hasOwnProperty(r.namespaceURI)){a[r.namespaceURI]={}}a[r.namespaceURI][n]=r.nodeValue}return t},[]);i=i.concat(o);if(a){var g=e.ownerDocument.createElementNS("sap.ui.core","CustomData");g.setAttribute("key","sap-ui-custom-settings");l.setProperty(g,"value",a);i.push(g)}}return n?i[0]:i},insertAggregation:function(e,t,r,n,i){var a=l._findAggregationNode(e,t);if(!a){var o=e.namespaceURI;a=l.createControl(o+"."+t,undefined,i);e.appendChild(a)}if(n>=a.childElementCount){a.appendChild(r)}else{var g=l._getControlsInAggregation(e,a)[n];a.insertBefore(r,g)}},removeAggregation:function(e,t,r){var n=l._findAggregationNode(e,t);n.removeChild(r)},removeAllAggregation:function(e,t){var r=l._findAggregationNode(e,t);if(e===r){var n=l._getControlsInAggregation(e,e);n.forEach(function(t){e.removeChild(t)})}else{e.removeChild(r)}},_findAggregationNode:function(e,t){var r;var n=l._children(e);for(var i=0;i<n.length;i++){var a=n[i];if(a.localName===t){r=a;break}}if(!r&&l._isDefaultAggregation(e,t)){r=e}return r},_isDefaultAggregation:function(e,t){var r=l.getControlMetadata(e);var n=r.getDefaultAggregation();return n&&t===n.name},_isNotNamedAggregationNode:function(e,t){var r=l.getAllAggregations(e);var n=r[t.localName];return e.namespaceURI!==t.namespaceURI||!n},_isSingleValueAggregation:function(e,t){var r=l.getAllAggregations(e);var n=r[t];return!n.multiple},_isAltTypeAggregation:function(e,t){var r=l.getControlMetadata(e);var n=r.getAllAggregations()[t];return!!n.altTypes},_isExtensionPoint:function(e){return l._getControlTypeInXml(e)==="sap.ui.core.ExtensionPoint"},getControlMetadata:function(e){return l._getControlMetadataInXml(e)},_getControlsInAggregation:function(e,t){var r=Array.prototype.slice.call(l._children(t));return r.filter(l._isNotNamedAggregationNode.bind(this,e))},_children:function(e){if(e.children){return e.children}else{var t=[];for(var r=0;r<e.childNodes.length;r++){var n=e.childNodes[r];if(n.nodeType===n.ELEMENT_NODE){t.push(n)}}return t}},getBindingTemplate:function(e,t){var r=l._findAggregationNode(e,t);if(r){var n=l._children(r);if(n.length===1){return n[0]}}},updateAggregation:function(e,t){},findIndexInParentAggregation:function(e){var t,r,n;t=l.getParent(e);if(!t){return-1}r=l.getParentAggregationName(e,t);n=l.getAggregation(t,r);if(Array.isArray(n)){n=n.filter(function(e){if(l._isExtensionPoint(e)){return true}return!l.getProperty(e,"stashed")});return n.indexOf(e)}else{return 0}},getParentAggregationName:function(e,t){var r,n;if(!t.isSameNode(e.parentNode)){r=false}else{r=l._isNotNamedAggregationNode(t,e)}if(r){n=l.getControlMetadata(t).getDefaultAggregationName()}else{n=l._getLocalName(e.parentNode)}return n},findAggregation:function(e,t){var r=l.getControlMetadata(e);var n=r.getAllAggregations();if(n){return n[t]}},validateType:function(e,t,r,n,i){var a=t.type;if(t.multiple===false&&l.getAggregation(r,t.name)&&l.getAggregation(r,t.name).length>0){return false}var o=sap.ui.xmlfragment({fragmentContent:n});if(!Array.isArray(o)){o=[o]}var g=o[i].isA(a);o.forEach(function(e){e.destroy()});return g},instantiateFragment:function(e,t,r){var n;var a=i.parse(e);a=l._checkAndPrefixIdsInFragment(a,t);if(a.localName==="FragmentDefinition"){n=l._getElementNodeChildren(a)}else{n=[a]}n.forEach(function(e){if(l._byId(e.getAttribute("id"),r)){throw Error("The following ID is already in the view: "+e.getAttribute("id"))}});return n},templateControlFragment:function(t,r){return e._templateFragment(t,r).then(function(e){return l._children(e)})},destroy:function(e){var t=e.parentNode;if(t){t.removeChild(e)}},_getFlexCustomData:function(e,t){if(!e){return undefined}return e.getAttributeNS("sap.ui.fl",t)},attachEvent:function(e,t,r,n){if(typeof g.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var i=l.getProperty(e,t)||"";var u=a.parse(i);var s=r;var f=["$event"];if(n){f.push(JSON.stringify(n))}s+="("+f.join(",")+")";if(!o(u,s)){u.push(s)}e.setAttribute(t,u.join(";"))},detachEvent:function(e,t,r){if(typeof g.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var n=l.getProperty(e,t)||"";var i=a.parse(n);var o=i.findIndex(function(e){return e.includes(r)});if(o>-1){i.splice(o,1)}if(i.length){e.setAttribute(t,i.join(";"))}else{e.removeAttribute(t)}},bindAggregation:function(e,t,r,n){l.bindProperty(e,t,r.path);l.insertAggregation(e,t,r.template,0,n)},unbindAggregation:function(e,t){if(e.hasAttribute(t)){e.removeAttribute(t);l.removeAllAggregation(e,t)}},getExtensionPointInfo:function(e,t){if(t&&e){var r=Array.prototype.slice.call(t.getElementsByTagNameNS("sap.ui.core","ExtensionPoint"));var n=r.filter(function(t){return t.getAttribute("name")===e});var i=n.length===1?n[0]:undefined;if(i){var a=l.getParent(i);var o={parent:a,aggregationName:l.getParentAggregationName(i,a),index:l.findIndexInParentAggregation(i)+1,defaultContent:Array.prototype.slice.call(l._children(i))};return o}}}});return l},true);