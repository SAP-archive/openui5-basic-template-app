/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/library","./HashChanger","sap/base/Log","sap/ui/thirdparty/URI","sap/ui/Device"],function(t,i,s,e,r){"use strict";var o=t.routing.HistoryDirection;var a=function(t){this._iHistoryLength=window.history.length;this.aHistory=[];this._bIsInitial=true;if(!r.browser.msie){var i=window.history.state===null?{}:window.history.state;if(typeof i==="object"){a._aStateHistory.push(window.location.hash);i.sap={};i.sap.history=a._aStateHistory;window.history.replaceState(i,window.document.title)}else{s.debug("Unable to determine HistoryDirection as history.state is already set: "+window.history.state,"sap.ui.core.routing.History")}}if(!t){s.error("sap.ui.core.routing.History constructor was called and it did not get a hashChanger as parameter")}this._setHashChanger(t);this._reset()};a._aStateHistory=[];a.prototype.destroy=function(t){this._unRegisterHashChanger()};a.prototype.getDirection=function(t){if(t!==undefined&&this._bIsInitial){return undefined}if(t===undefined){return this._sCurrentDirection}return this._getDirection(t)};a.prototype.getPreviousHash=function(){return this.aHistory[this.iHistoryPosition-1]};a.prototype._setHashChanger=function(t){var i=t.getEventNamesForHistory();if(this._oHashChanger){this._unRegisterHashChanger()}this._oHashChanger=t;i.forEach(function(t){this._oHashChanger.attachEvent(t,this._onHashChange,this)}.bind(this));this._oHashChanger.attachEvent("hashReplaced",this._hashReplaced,this);this._oHashChanger.attachEvent("hashSet",this._hashSet,this)};a.prototype._unRegisterHashChanger=function(){var t=this._oHashChanger.getEventNamesForHistory();t.forEach(function(t){this._oHashChanger.detachEvent(t,this._onHashChange,this)}.bind(this));this._oHashChanger.detachEvent("hashReplaced",this._hashReplaced,this);this._oHashChanger.detachEvent("hashSet",this._hashSet,this);this._oHashChanger=null};a.prototype._reset=function(){this.aHistory.length=0;this.iHistoryPosition=0;this._bUnknown=true;this.aHistory[0]=this._oHashChanger.getHash()};a.prototype._getDirection=function(t,i,s){if(s&&this._oNextHash&&this._oNextHash.sHash===t){return o.NewEntry}if(i){return o.NewEntry}if(this._bUnknown){return o.Unknown}if(this.aHistory[this.iHistoryPosition+1]===t&&this.aHistory[this.iHistoryPosition-1]===t){return o.Unknown}if(this.aHistory[this.iHistoryPosition-1]===t){return o.Backwards}if(this.aHistory[this.iHistoryPosition+1]===t){return o.Forwards}return o.Unknown};a.prototype._getDirectionWithState=function(t){var i=window.history.state===null?{}:window.history.state,e,r;if(typeof i==="object"){if(i.sap===undefined){a._aStateHistory.push(t);i.sap={};i.sap.history=a._aStateHistory;history.replaceState(i,document.title);r=o.NewEntry}else{e=i.sap.history.every(function(t,i){return t===a._aStateHistory[i]});if(e&&i.sap.history.length===a._aStateHistory.length){r=undefined}else{r=e?o.Backwards:o.Forwards;a._aStateHistory=i.sap.history}}}else{s.debug("Unable to determine HistoryDirection as history.state is already set: "+window.history.state,"sap.ui.core.routing.History")}return r};a.prototype._onHashChange=function(t){this._hashChange(t.getParameter("newHash"),t.getParameter("oldHash"),t.getParameter("fullHash"))};a.prototype._hashChange=function(t,i,s){var e=window.history.length,h;if(this._oNextHash&&this._oNextHash.bWasReplaced&&this._oNextHash.sHash===t){this.aHistory[this.iHistoryPosition]=t;if(s!==undefined&&!r.browser.msie&&this===a.getInstance()){a._aStateHistory[a._aStateHistory.length-1]=s;window.history.replaceState({sap:{history:a._aStateHistory}},window.document.title)}this._oNextHash=null;if(!this._bIsInitial){this._sCurrentDirection=o.Unknown}return}this._bIsInitial=false;if(s&&!r.browser.msie&&this===a.getInstance()){h=this._getDirectionWithState(s)}if(!h){h=this._getDirection(t,this._iHistoryLength<window.history.length,true)}this._sCurrentDirection=h;this._iHistoryLength=e;if(this._oNextHash){this._oNextHash=null}if(h===o.Unknown){this._reset();return}this._bUnknown=false;if(h===o.NewEntry){if(this.iHistoryPosition+1<this.aHistory.length){this.aHistory=this.aHistory.slice(0,this.iHistoryPosition+1)}this.aHistory.push(t);this.iHistoryPosition+=1;return}if(h===o.Forwards){this.iHistoryPosition++;return}if(h===o.Backwards){this.iHistoryPosition--}};a.prototype._hashSet=function(t){this._hashChangedByApp(t.getParameter("sHash"),false)};a.prototype._hashReplaced=function(t){this._hashChangedByApp(t.getParameter("sHash"),true)};a.prototype._hashChangedByApp=function(t,i){this._oNextHash={sHash:t,bWasReplaced:i}};var h=new a(i.getInstance());a.getInstance=function(){return h};return a},true);