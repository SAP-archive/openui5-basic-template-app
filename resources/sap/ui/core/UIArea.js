/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","./Element","./RenderManager","sap/ui/performance/trace/Interaction","sap/ui/dom/containsOrEquals","sap/ui/util/ActivityDetection","sap/ui/events/KeyCodes","sap/base/Log","sap/base/assert","sap/ui/performance/Measurement","sap/ui/events/jquery/EventExtension","sap/ui/events/ControlEvents","sap/ui/events/F6Navigation","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(e,t,o,r,n,i,a,s,d,u,l,f,p,g){"use strict";var c;l.apply();g(document).on("keydown",function(e){p.handleF6GroupNavigation(e,null)});var h=s.getLogger("sap.ui.Rendering",window["sap-ui-config"]&&(window["sap-ui-config"]["xx-debugRendering"]||window["sap-ui-config"]["xx-debugrendering"])||/sap-ui-xx-debug(R|-r)endering=(true|x|X)/.test(document.location.search)?s.Level.DEBUG:Math.min(s.Level.INFO,s.getLevel())),v=function(e){return e},y=function(){},m=function(){};if(h.isLoggable()){v=function(e){var t;try{throw new Error}catch(e){t=e.stack||e.stacktrace||(e.sourceURL?e.sourceURL+":"+e.line:null);t=t?t.split(/\n\s*/g).slice(2):undefined}return{obj:e,location:t}};y=function(e,t){var o=sap.ui.getCore(),r={},n,i;for(n in t){i=o.byId(n);r[n]={type:i?i.getMetadata().getName():t[n].obj===e?"UIArea":"(no such control)",location:t[n].location,reason:t[n].reason}}h.debug("  UIArea '"+e.getId()+"', pending updates: "+JSON.stringify(r,null,"\t"))};m=function(e,t){var o;for(o in t){if(e[o]!=null){if(e[o].obj!==t[o].obj){t[o].reason="replaced during rendering"}else{t[o].reason="invalidated again during rendering"}}else{t[o].reason="invalidated during rendering"}}}}var C=e.extend("sap.ui.core.UIArea",{constructor:function(t,o){if(arguments.length===0){return}e.apply(this);this.oCore=t;this.bLocked=false;this.bInitial=true;this.aContentToRemove=[];this.bNeedsRerendering=false;if(o!=null){this.setRootNode(o);this.bNeedsRerendering=this.bNeedsRerendering&&!(o.id+"-Init"?window.document.getElementById(o.id+"-Init"):null)}this.mInvalidatedControls={};if(!this.bNeedsRerendering){this.bRenderSelf=false}else{this.oCore.addInvalidatedUIArea(this)}},metadata:{publicMethods:["setRootNode","getRootNode","setRootControl","getRootControl","lock","unlock","isLocked"],aggregations:{content:{name:"content",type:"sap.ui.core.Control",multiple:true,singularName:"content"},dependents:{name:"dependents",type:"sap.ui.core.Control",multiple:true}}}});C.prototype.isInvalidateSuppressed=function(){return this.iSuppressInvalidate>0};C.prototype.getId=function(){return this.oRootNode?this.oRootNode.id:null};C.prototype.getUIArea=function(){return this};C.prototype.setRootNode=function(e){if(this.oRootNode===e){return}d(!e||e.nodeType===1&&!g(e).attr("data-sap-ui-area"),"UIArea root node must be a DOMElement");if(this.oRootNode){this._ondetach()}this.oRootNode=e;if(this.getContent().length>0){this.invalidate()}if(this.oRootNode){this._onattach()}};C.prototype.getRootNode=function(){return this.oRootNode};C.prototype.setRootControl=function(e){this.removeAllContent();this.addContent(e)};C.prototype.getRootControl=function(e){var t=this.getContent();if(t.length>0){if(e>=0&&e<t.length){return t[e]}return t[0]}return null};C.prototype._addRemovedContent=function(e){if(this.oRootNode&&e){this.aContentToRemove.push(e)}};C.prototype.addContent=function(e,t){this.addAggregation("content",e,t);if(t!==true){this.invalidate()}return this};C.prototype.removeContent=function(e,t){var o=this.removeAggregation("content",e,t);if(!t){var r;if(o&&o.getDomRef){r=o.getDomRef()}this._addRemovedContent(r)}return o};C.prototype.removeAllContent=function(){var e=this.removeAllAggregation("content");for(var t=0;t<e.length;t++){var o;var r=e[t];if(r&&r.getDomRef){o=r.getDomRef()}this._addRemovedContent(o)}return e};C.prototype.destroyContent=function(){var e=this.getContent();for(var t=0;t<e.length;t++){var o;var r=e[t];if(r&&r.getDomRef){o=r.getDomRef()}this._addRemovedContent(o)}this.destroyAggregation("content");return this};C.prototype.lock=function(){this.bLocked=true};C.prototype.unlock=function(){if(this.bLocked&&this.bNeedsRerendering){this.oCore.addInvalidatedUIArea(this)}this.bLocked=false};C.prototype.isLocked=function(){return this.bLocked};C.prototype.getBindingContext=function(){return null};C.prototype.getEventingParent=function(){return this.oCore._getEventProvider()};C.prototype.isActive=function(){return(this.getId()?window.document.getElementById(this.getId()):null)!=null};C.prototype.invalidate=function(){this.addInvalidatedControl(this)};C.prototype.addInvalidatedControl=function(e){if(this.bRenderSelf){return}if(!this.bNeedsRerendering){this.oCore.addInvalidatedUIArea(this)}var t=e.getId();if(e===this){this.bRenderSelf=true;this.bNeedsRerendering=true;this.mInvalidatedControls={};this.mInvalidatedControls[t]=v(this);return}if(this.mInvalidatedControls[t]){return}if(!this.bRenderSelf){this.mInvalidatedControls[t]=v(e);this.bNeedsRerendering=true}};C.prototype.rerender=function(e){var t=this;function r(){t.bRenderSelf=false;t.aContentToRemove=[];t.mInvalidatedControls={};t.bNeedsRerendering=false}function n(){try{return document.activeElement}catch(e){}}if(e){this.bNeedsRerendering=true}if(this.bLocked||!this.bNeedsRerendering){return false}var i=this.bRenderSelf,a=this.aContentToRemove,d=this.mInvalidatedControls,l=false;r();u.pause("renderPendingUIUpdates");u.start(this.getId()+"---rerender","Rerendering of "+this.getMetadata().getName());y(this,d);if(i){if(this.oRootNode){h.debug("Full Rendering of UIArea '"+this.getId()+"'");o.preserveContent(this.oRootNode,false,this.bInitial);this.bInitial=false;var f=function(e,r){var n=e.length;var i;for(var a=0;a<n;a++){i=r?e[a].getDomRef():e[a];if(i&&!o.isPreservedContent(i)&&t.oRootNode===i.parentNode){g(i).remove()}}return n};var p=n();var c=this.oCore.oFocusHandler.getControlFocusInfo();f(a);var v=this.getContent();var C=f(v,true);var R=n();for(var I=0;I<C;I++){if(v[I]&&v[I].getParent()===this){this.oCore.oRenderManager.render(v[I],this.oRootNode,true)}}l=true;if(p&&p!=R&&R===n()){try{this.oCore.oFocusHandler.restoreFocus(c)}catch(e){s.warning("Problems while restoring the focus after full UIArea rendering: "+e,null,this)}}}else{h.debug("Full Rendering of UIArea '"+this.getId()+"' postponed, no root node")}}else{var b=function(e){for(;;){if(e.getMetadata&&e.getMetadata().isInstanceOf("sap.ui.core.PopupInterface")){break}e=e.getParent();if(!e||e===t){return false}if(d.hasOwnProperty(e.getId())){return true}}};for(var N in d){var k=this.oCore.byId(N);if(k&&!b(k)){k.rerender();l=true}}}m(d,this.mInvalidatedControls);u.end(this.getId()+"---rerender");u.resume("renderPendingUIUpdates");return l};C.prototype._onControlRendered=function(e){var t=e.getId();if(this.mInvalidatedControls[t]){delete this.mInvalidatedControls[t]}};C.rerenderControl=function(e){var t=null;if(e){t=e.getDomRef();if(!t||o.isPreservedContent(t)){t=o.RenderPrefixes.Invisible+e.getId()?window.document.getElementById(o.RenderPrefixes.Invisible+e.getId()):null}}var r=t&&t.parentNode;if(r){var n=e.getUIArea();var i=n?n.oCore.oRenderManager:sap.ui.getCore().createRenderManager();h.debug("Rerender Control '"+e.getId()+"'"+(n?"":" (using a temp. RenderManager)"));o.preserveContent(t,true,false);i.render(e,r)}else{var n=e.getUIArea();n&&n._onControlRendered(e);h.warning("Couldn't rerender '"+e.getId()+"', as its DOM location couldn't be determined")}};var R=/^(mousedown|mouseup|click|keydown|keyup|keypress|touchstart|touchend|tap)$/;var I=[],b=[];var N={mousemove:1,mouseover:1,mouseout:1,scroll:1,dragover:1,dragenter:1,dragleave:1};C.addEventPreprocessor=function(e){I.push(e)};C.getEventPreprocessors=function(){return I};C.addEventPostprocessor=function(e){b.push(e)};C.getEventPostprocessors=function(){return b};C.prototype._handleEvent=function(e){var o=null,a;o=g(e.target).control(0);i.refresh();if(o===null){return}if(e.isMarked("delayedMouseEvent")){return}var d=e.getMark("handledByUIArea"),u=this.getId();if(d&&d!==u){e.setMark("firstUIArea",false);return}e.setMarked("firstUIArea");e.srcControl=o;if(e.type==="contextmenu"&&e.shiftKey&&e.altKey&&!!(e.metaKey||e.ctrlKey)){s.info("Suppressed forwarding the contextmenu event as control event because CTRL+SHIFT+ALT is pressed!");return}I.forEach(function(t){t(e)});this.oCore._handleControlEvent(e,u);if(this.bLocked||this.oCore.isLocked()){return}if(r.getActive()){a=e.type.match(R);if(a){r.notifyEventStart(e)}}var l=[];if(e.getPseudoTypes){l=e.getPseudoTypes()}l.push(e.type);var f=false;while(o instanceof t&&o.isActive()&&!e.isPropagationStopped()){for(var p=0,c=l.length;p<c;p++){var h=l[p];e.type=h;e.currentTarget=o.getDomRef();o._handleEvent(e);if(e.isImmediatePropagationStopped()){break}}if(!f&&!e.isMarked("enterKeyConsumedAsContent")){f=this._handleGroupChange(e,o)}if(e.isPropagationStopped()){break}if(o.bStopEventBubbling){break}var v=o.getDomRef();if(!v){break}v=v.parentNode;o=null;if(e.isMarked("fromMouseout")&&n(v,e.relatedTarget)){break}while(v&&v!==this.getRootNode()){if(v.id){o=g(v).control(0);if(o){break}}v=v.parentNode}}b.forEach(function(t){t(e)});if(a){r.notifyEventEnd(e)}e.currentTarget=this.getRootNode();e.setMark("handledByUIArea",u);if(e.isPropagationStopped()){s.debug("'"+e.type+"' propagation has been stopped")}var y=e.type;if(!N[y]){var m=g(e.target).control(0);if(m){s.debug("Event fired: '"+y+"' on "+m,"","sap.ui.core.UIArea")}else{s.debug("Event fired: '"+y+"'","","sap.ui.core.UIArea")}}};C.prototype._onattach=function(){var e=this.getRootNode();if(e==null){return}g(e).attr("data-sap-ui-area",e.id).bind(f.events.join(" "),this._handleEvent.bind(this))};C.prototype._ondetach=function(){var e=this.getRootNode();if(e==null){return}g(e).removeAttr("data-sap-ui-area").unbind()};C.prototype.clone=function(){throw new Error("UIArea can't be cloned")};C.prototype._handleGroupChange=function(e,t){var o=C._oFieldGroupValidationKey;if(e.type==="focusin"){if(C._iFieldGroupDelayTimer){clearTimeout(C._iFieldGroupDelayTimer);C._iFieldGroupDelayTimer=null}C._iFieldGroupDelayTimer=setTimeout(this.setFieldGroupControl.bind(this,t),0);return true}else if(this.getFieldGroupControl()&&e.type==="keyup"&&e.keyCode===o.keyCode&&e.shiftKey===o.shiftKey&&e.altKey===o.altKey&&e.ctrlKey===o.ctrlKey){if(C._iFieldGroupTriggerDelay){clearTimeout(C._iFieldGroupTriggerDelay)}var r=this.getFieldGroupControl(),n=r?r._getFieldGroupIds():[];if(n.length>0){r.triggerValidateFieldGroup(n)}return true}return false};C.prototype.setFieldGroupControl=function(e){function t(e,o){var r=e.getParent();if(r){if(o(r)){return r}else{return t(r,o)}}return null}var o=this.getFieldGroupControl();if(e!=o){var r=null;c=c||sap.ui.require("sap/ui/core/Control");if(c){if(e instanceof c){r=e}else{r=t(e,function(e){return e instanceof c})}}var n=o?o._getFieldGroupIds():[],i=r?r._getFieldGroupIds():[],a=[];for(var s=0;s<n.length;s++){var d=n[s];if(i.indexOf(d)===-1){a.push(d)}}if(a.length>0){o.triggerValidateFieldGroup(a)}C._oFieldGroupControl=r}return this};C.prototype.getFieldGroupControl=function(){if(C._oFieldGroupControl&&!C._oFieldGroupControl.bIsDestroyed){return C._oFieldGroupControl}return null};C._oFieldGroupControl=null;C._iFieldGroupDelayTimer=null;C._oFieldGroupValidationKey={keyCode:a.ENTER,shiftKey:false,altKey:false,ctrlKey:false};C._oRenderLog=h;return C});