/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","./Core","sap/ui/thirdparty/URI","sap/base/Log","sap/base/util/extend","sap/base/strings/escapeRegExp","sap/ui/thirdparty/jquery","sap/ui/core/IconPool"],function(e,r,t,o,n,a,i,s){"use strict";var p=sap.ui.getCore().getConfiguration();var c=p.getLanguage();var u=p.getAppCacheBusterMode()==="sync";var f=p.getAppCacheBusterMode()==="batch";var l={index:{},active:false};var d,g,v,y,h;var b=document.baseURI.replace(/\?.*|#.*/g,"");var L=t(sap.ui.require.toUrl("")+"/../");var m=L.toString();if(L.is("relative")){L=L.absoluteTo(b)}var x=L.normalize().toString();var C=t("resources").absoluteTo(x).toString();var A=new RegExp("^"+a(C));var R=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/"}return e};var U=function(e,r){var t=l.index;var a;var s;var p;if(Array.isArray(e)&&!f){e.forEach(function(e){U(e,r)})}else if(Array.isArray(e)&&f){var d=R(e[0]);var g=[];o.debug('sap.ui.core.AppCacheBuster.register("'+d+'"); // BATCH MODE!');var v=T.normalizeURL(d);o.debug('  --\x3e normalized to: "'+v+'"');e.forEach(function(e){s=R(e);var r=T.normalizeURL(s);if(!t[p]){g.push(r)}});if(g.length>0){var s=v+"sap-ui-cachebuster-info.json?sap-ui-language="+c;a={url:s,type:"POST",async:!u&&!!r,dataType:"json",contentType:"text/plain",data:g.join("\n"),success:function(e){T.onIndexLoaded(s,e);n(t,e)},error:function(){o.error('Failed to batch load AppCacheBuster index file from: "'+s+'".')}}}}else{e=R(e);o.debug('sap.ui.core.AppCacheBuster.register("'+e+'");');p=T.normalizeURL(e);o.debug('  --\x3e normalized to: "'+p+'"');if(!t[p]){var s=p+"sap-ui-cachebuster-info.json?sap-ui-language="+c;a={url:s,async:!u&&!!r,dataType:"json",success:function(e){T.onIndexLoaded(s,e);t[p]=e},error:function(){o.error('Failed to load AppCacheBuster index file from: "'+s+'".')}}}}if(a){var y=T.onIndexLoad(a.url);if(y!=null){o.info('AppCacheBuster index file injected for: "'+s+'".');a.success(y)}else{if(a.async){var h=r.startTask("load "+s);var b=a.success,L=a.error;Object.assign(a,{success:function(e){b.apply(this,arguments);r.finishTask(h)},error:function(){L.apply(this,arguments);r.finishTask(h,false)}})}o.info('Loading AppCacheBuster index file from: "'+s+'".');i.ajax(a)}}};var T={boot:function(e){var r=p.getAppCacheBuster();if(r&&r.length>0){r=r.slice();var o=true;var n=String(r[0]).toLowerCase();if(r.length===1){if(n==="true"||n==="x"){var a=t(m);r=a.is("relative")?[a.toString()]:[]}else if(n==="false"){o=false}}if(o){T.init();U(r,e)}}},init:function(){l.active=true;d=e.prototype.validateProperty;g=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");v=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var r=T.convertURL;var t=T.normalizeURL;var n=function(e){if(this.active===true&&e&&typeof e==="string"){e=t(e);return!e.match(A)}return false}.bind(l);y=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){if(t&&n(t)){arguments[1]=r(t)}y.apply(this,arguments)};h=XMLHttpRequest.prototype.open;e.prototype.validateProperty=function(e,t){var o=this.getMetadata(),a=o.getProperty(e),i;if(a&&a.type==="sap.ui.core.URI"){i=Array.prototype.slice.apply(arguments);try{if(n(i[1])){i[1]=r(i[1])}}catch(e){}}return d.apply(this,i||arguments)};s._convertUrl=function(e){return r(e)};var a=function(e){var t={get:e.get,set:function(t){if(n(t)){t=r(t)}e.set.call(this,t)},enumerable:e.enumerable,configurable:e.configurable};t.set._sapUiCoreACB=true;return t};var i=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",a(g))}catch(e){o.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);i=true}try{Object.defineProperty(HTMLLinkElement.prototype,"href",a(v))}catch(e){o.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);i=true}if(i){this.exit()}},exit:function(){e.prototype.validateProperty=d;delete s._convertUrl;if(XMLHttpRequest.prototype.open===h){XMLHttpRequest.prototype.open=y}var r;if((r=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&r.set&&r.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",g)}if((r=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&r.set&&r.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",v)}l.index={};l.active=false;l={index:{},active:false}},register:function(e){U(e)},convertURL:function(e){o.debug('sap.ui.core.AppCacheBuster.convertURL("'+e+'");');var r=l.index;if(r&&e&&!/^#/.test(e)){var t=T.normalizeURL(e);o.debug('  --\x3e normalized to: "'+t+'"');if(t&&T.handleURL(t)){for(var n in r){var a=r[n],i,s;if(n&&t.length>=n.length&&t.slice(0,n.length)===n){i=t.slice(n.length);s=i.match(/([^?#]*)/)[1];if(a[s]){e=n+"~"+a[s]+"~/"+i;o.debug('  ==> rewritten to "'+e+'";');break}}}}}return e},normalizeURL:function(e){var r=t(e||"./");if(r.is("relative")){r=r.absoluteTo(b)}return r.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString()},handleURL:function(e){return true},onIndexLoad:function(e){return null},onIndexLoaded:function(e,r){}};var j=p.getAppCacheBusterHooks();if(j){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof j[e]==="function"){T[e]=j[e]}})}return T},true);