/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","../base/ManagedObject","./Element","./DeclarativeSupport","./XMLTemplateProcessor","sap/base/Log","sap/base/util/LoaderExtensions","sap/base/util/merge","sap/ui/core/Component","sap/ui/core/mvc/XMLProcessingMode"],function(e,t,n,i,r,o,a,s,f,u){"use strict";var g={},c={};var p=t.extend("sap.ui.core.Fragment",{metadata:{properties:{type:"string"},specialSettings:{async:{type:"boolean",visibility:"hidden"},fragmentName:"string",fragmentContent:"any",containingView:{type:"sap.ui.core.mvc.View",visibility:"hidden"},oController:{type:"sap.ui.core.mvc.Controller",visibility:"hidden"},sId:{type:"sap.ui.core.ID",visibility:"hidden"},sOwnerId:{type:"sap.ui.core.ID",visibility:"hidden"},processingMode:{type:"sap.ui.core.mvc.XMLProcessingMode",visibility:"hidden"}}},constructor:function(e,n){t.apply(this,arguments);if(!this._bAsync){if(this._aContent&&this._aContent.length==1){return this._aContent[0]}else{return this._aContent}}}});p.registerType=function(e,t){if(typeof e!=="string"){o.error("Ignoring non-string Fragment type: "+e);return}if(c[e]){o.warning("sap.ui.core.Fragment.registerType(): Fragment type '"+e+"' is already defined. Overriding this type now!")}c[e]=t};p.prototype._initCompositeSupport=function(e){if(!e){throw new Error("Settings must be set")}if(!(e.fragmentName||e.fragmentContent)){throw new Error("Please provide a fragment name")}if(e.oController){this.oController=e.oController}this._bAsync=e.async||false;this._sExplicitId=e.sId||e.id;this._sFragmentName=e.fragmentName;this.fnScopedRunWithOwner=e.containingView&&e.containingView.fnScopedRunWithOwner;if(!this.fnScopedRunWithOwner&&this._sOwnerId){var t=f.get(this._sOwnerId);this.fnScopedRunWithOwner=function(e){return t.runAsOwner(e)}}var n=p.getType(e.type);if(n){this._pContentPromise=n.init.apply(this,[e]);if(!this._pContentPromise){this._pContentPromise=Promise.resolve(this._aContent)}}else{throw new Error("No type for the fragment has been specified: "+e.type)}};p.prototype.getFragmentName=function(){return this._sFragmentName};p.prototype.getController=function(){return this.oController};p.byId=function(e,t){if(!(typeof e==="string"&&typeof t==="string")){o.error("sap.ui.core.Fragment.byId: two strings must be given as parameters, but are: "+e+" and "+t);return undefined}return sap.ui.getCore().byId(e+"--"+t)};p.createId=function(e,t){if(!(typeof e==="string"&&typeof t==="string")){o.error("sap.ui.core.Fragment.createId: two strings must be given as parameters, but are: "+e+" and "+t);return undefined}return e+"--"+t};p.prototype.createId=function(e){var t=this._sExplicitId?this._sExplicitId+"--"+e:e;if(this._oContainingView&&this._oContainingView!=this){t=this._oContainingView.createId(t)}return t};p.prototype.isSubView=function(){return true};sap.ui.fragment=function(e,t,n){var i;if(typeof t==="string"){i=t.toLowerCase()}else if(typeof t==="object"&&typeof t.fragmentName==="string"){i=t.fragmentName.toLowerCase()}else{i=""}o.info("Do not use deprecated factory function 'sap.ui."+i+"fragment'. Require 'sap/ui/core/Fragment' and use 'load()' instead","sap.ui."+i+"fragment",null,function(){return{type:"sap.ui."+i+"fragment",name:i?e+".fragment."+i:e}});return m(e,t,n)};function m(e,t,n){var i={};if(typeof e==="string"){i.fragmentName=e;i.oController=n;i.type=t}else if(typeof e==="object"){i=e;i.async=i.async===true?i.async:false;if(t){i.oController=t}if(i.async){var r=function(){var e=i.sOwnerId||i.containingView&&i.containingView._sOwnerId;var t=f.get(e);if(t){return t.runAsOwner(function(){return new p(i)})}return new p(i)};var a=p.getType(i.type);if(i.fragmentName&&i.fragmentContent){delete i.fragmentName}if(i.fragmentName&&typeof a.load=="function"){return new Promise(function(e,t){a.load(i).then(function(t){i.fragmentContent=t;e(r())}).catch(function(e){t(e)})})}else{return Promise.resolve(r())}}}else{o.error("sap.ui.fragment() must be called with Fragment name or config object as first parameter, but is: "+e)}return new p(i)}p.load=function(e){var n=Object.assign({},e);if(n.name&&n.definition){o.error("The properties 'name' and 'definition' shouldn't be provided at the same time. The fragment definition will be used instead of the name. Fragment name was: "+n.name);delete n.name}n.type=n.type||"XML";n.async=true;n.processingMode=n.processingMode||u.Sequential;n.fragmentName=n.fragmentName||n.name;n.fragmentContent=n.fragmentContent||n.definition;n.oController=n.controller;n.sOwnerId=t._sOwnerId;delete n.name;delete n.definition;delete n.controller;var i=m(n);return i.then(function(e){return e._pContentPromise})};p.getType=function(e){return c[e]};sap.ui.xmlfragment=function(e,t,n){if(typeof e==="string"){if(typeof t==="string"){return sap.ui.fragment({fragmentName:t,sId:e,type:"XML"},n)}else{return sap.ui.fragment(e,"XML",t)}}else{e.type="XML";return sap.ui.fragment(e,t)}};sap.ui.jsfragment=function(e,t,n){if(typeof e==="string"&&typeof t==="object"){if(t.createContent){g[e]=t;sap.ui.loader._.declareModule(e.replace(/\./g,"/")+".fragment.js")}else{return sap.ui.fragment(e,"JS",t)}}else if(typeof e==="string"&&t===undefined){return sap.ui.fragment(e,"JS")}else if(typeof e==="object"){e.type="JS";return sap.ui.fragment(e,t)}else if(arguments.length>=3){return sap.ui.fragment({id:e,fragmentName:t,type:"JS"},n)}else{o.error("sap.ui.jsfragment() was called with wrong parameter set: "+e+" + "+t)}};sap.ui.htmlfragment=function(e,t,n){if(typeof e==="string"){if(typeof t==="string"){return sap.ui.fragment({fragmentName:t,sId:e,type:"HTML"},n)}else{return sap.ui.fragment(e,"HTML",t)}}else{e.type="HTML";return sap.ui.fragment(e,t)}};p.registerType("XML",{load:function(e){return r.loadTemplatePromise(e.fragmentName,"fragment").then(function(e){return e})},init:function(i){this._aContent=[];if(i.fragmentContent){if(typeof i.fragmentContent==="string"){this._xContent=e.parseXML(i.fragmentContent).documentElement}else{this._xContent=i.fragmentContent}}else{o.warning("Synchronous loading of fragment, due to Fragment.init() call for '"+i.fragmentName+"'. Use 'sap/ui/core/Fragment' module with Fragment.load() instead.","SyncXHR",null,function(){return{type:"SyncXHR",name:"Fragment"}});this._xContent=r.loadTemplate(i.fragmentName,"fragment")}this._oContainingView=this._sExplicitId?this:i.containingView||this;if(this._oContainingView===this){this._oContainingView.oController=i.containingView&&i.containingView.oController||i.oController}this._sProcessingMode=i.processingMode;var a=this._oContainingView._fnSettingsPreprocessor;var s={fnRunWithPreprocessor:function(e){return t.runWithPreprocessors(e,{settings:a})}};var f=r.parseTemplatePromise(this._xContent,this,this._bAsync,s).then(function(e){this._aContent=e;if(this._aContent&&this._aContent.length&&i.objectBindings){this._aContent.forEach(function(e,t){if(e instanceof n){for(var r in i.objectBindings){e.bindObject(i.objectBindings[r])}}})}return this._aContent.length>1?this._aContent:this._aContent[0]}.bind(this));if(!this._bAsync){try{f.unwrap()}catch(e){o.error("An Error occured during XML processing of '"+this.getMetadata().getName()+"' with id '"+this.getId()+"':\n"+e.stack)}}return f}});p.registerType("JS",{load:function(e){var t=e.fragmentName.replace(/\./g,"/")+".fragment";return new Promise(function(e,n){sap.ui.require([t],function(t){e(t)},n)})},init:function(e){this._aContent=[];if(e.fragmentContent){s(this,e.fragmentContent)}else{if(!g[e.fragmentName]){sap.ui.requireSync(e.fragmentName.replace(/\./g,"/")+".fragment")}s(this,g[e.fragmentName])}this._oContainingView=e.containingView||this;return t.runWithPreprocessors(function(){var t;if(this.fnScopedRunWithOwner){this.fnScopedRunWithOwner(function(){t=this.createContent(e.oController||this._oContainingView.oController)}.bind(this))}else{t=this.createContent(e.oController||this._oContainingView.oController)}if(t instanceof Promise){return t.then(function(e){this._aContent=this._aContent.concat(e);return this._aContent.length>1?this._aContent:this._aContent[0]}.bind(this))}else{return new Promise(function(e,n){this._aContent=this._aContent.concat(t);e(this._aContent.length>1?this._aContent:this._aContent[0])}.bind(this))}}.bind(this),{settings:this._oContainingView._fnSettingsPreprocessor})}});(function(){var n={};var r=function(e){var t=sap.ui.require.toUrl(e.replace(/\./g,"/"))+".fragment.html";var i=n[t];var r;if(!i){r=e.replace(/\./g,"/")+".fragment.html";i=a.loadResource(r);n[t]=i}return i};p.registerType("HTML",{load:function(e){var t=e.fragmentName.replace(/\./g,"/")+".fragment";return a.loadResource(t+".html",{async:true}).then(function(e){return e})},init:function(n){this._aContent=[];this.getContent=function(){return this._aContent};this.addContent=function(e){this._aContent.push(e)};this._oContainingView=n.containingView||this;this._sProcessingMode=n.processingMode;var o=n.fragmentContent||r(n.fragmentName);this._oTemplate=document.createElement("div");if(typeof o==="string"){this._oTemplate.innerHTML=o}else{var a=o;var s=document.createDocumentFragment();for(var f=0;f<a.length;f++){s.appendChild(a.item(f))}this._oTemplate.appendChild(s)}var u=this._oTemplate.getElementsByTagName("template")[0];var g=this.getMetadata().getAllProperties();if(u){var c=this;e.each(u.attributes,function(e,t){var r=i.convertAttributeToSettingName(t.name,c.getId());var o=t.value;var a=g[r];if(!n[r]){if(a){n[r]=i.convertValueToType(i.getPropertyDataType(a),o)}else if(sap.ui.core.mvc.HTMLView._mAllowedSettings[r]){n[r]=o}}});this._oTemplate=u}if(this._oTemplate.content){var p=this._oTemplate.content;this._oTemplate=document.createElement("div");this._oTemplate.appendChild(p)}return t.runWithPreprocessors(function(){if(this.fnScopedRunWithOwner){this.fnScopedRunWithOwner(function(){i.compile(this._oTemplate,this)}.bind(this))}else{i.compile(this._oTemplate,this)}var e=this.getContent();if(e&&e.length===1){this._aContent=[e[0]];return new Promise(function(e,t){e(this._aContent[0])}.bind(this))}}.bind(this),{settings:this._oContainingView._fnSettingsPreprocessor})}})})();return p});