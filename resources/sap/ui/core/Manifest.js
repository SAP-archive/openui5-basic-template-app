/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/thirdparty/URI","sap/base/util/Version","sap/base/Log","sap/ui/dom/includeStylesheet","sap/base/i18n/ResourceBundle","sap/base/util/uid","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/LoaderExtensions","sap/base/util/isEmptyObject"],function(e,n,i,t,r,s,o,a,u,c,f){"use strict";function l(e){var n=i(e);return n.getSuffix()?i(n.getMajor()+"."+n.getMinor()+"."+n.getPatch()):n}function p(e,n){if(e&&n&&typeof n==="string"&&n[0]==="/"){var i=n.substring(1).split("/"),t;for(var r=0,s=i.length;r<s;r++){t=i[r];e=e.hasOwnProperty(t)?e[t]:undefined;if(e===null||typeof e!=="object"){if(r+1<s&&e!==undefined){e=undefined}break}}return e}return e&&e[n]}function h(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var n in e){if(e.hasOwnProperty(n)){h(e[n])}}}}var d=e.extend("sap.ui.core.Manifest",{constructor:function(i,t){e.apply(this,arguments);this._uid=o();this._iInstanceCount=0;this._oRawManifest=i;this._bProcess=!(t&&t.process===false);this._bAsync=!(t&&t.async===false);this._activeTerminologies=t&&t.activeTerminologies;this._bLoadManifestRequestFailed=t&&t._bLoadManifestRequestFailed;this._sComponentName=t&&t.componentName;var r=this.getComponentName(),s=t&&t.baseUrl||r&&sap.ui.require.toUrl(r.replace(/\./g,"/"))+"/";if(s){this._oBaseUri=new n(s).absoluteTo(new n(document.baseURI).search(""))}if(t&&typeof t.url==="string"){this._oManifestBaseUri=new n(t.url).absoluteTo(new n(document.baseURI).search("")).search("")}else{this._oManifestBaseUri=this._oBaseUri}h(this._oRawManifest);this._oManifest=a({},this._oRawManifest);if(this._bProcess){this._processI18n()}},_processI18n:function(e,n){if(!n){n=[];this._preprocess({i18nProperties:n})}if(n.length>0){var i=function(e){var i=function(n,i){return e.getText(i)};for(var t=0,r=n.length;t<r;t++){var s=n[t];s.object[s.key]=s.object[s.key].replace(d._rManifestTemplate,i)}};if(e){return this._loadI18n(e).then(i)}else{i(this._loadI18n(e))}}else{return e?Promise.resolve():undefined}},_loadI18n:function(e){var i=this._oRawManifest,t,r="manifest",o=i["sap.app"]&&i["sap.app"]["i18n"]||"i18n/i18n.properties";if(typeof o==="string"){t=new n(o);return s.create({url:this.resolveUri(t,r),async:e})}else if(typeof o==="object"){o=JSON.parse(JSON.stringify(o));r=o.bundleUrlRelativeTo||r;this._processResourceConfiguration(o,r);var a=Object.assign({activeTerminologies:this._activeTerminologies,async:e},o);return s.create(a)}},getJson:function(){return this._oManifest},getRawJson:function(){return this._oRawManifest},getEntry:function(e){if(!e||e.indexOf(".")<=0){t.warning("Manifest entries with keys without namespace prefix can not be read via getEntry. Key: "+e+", Component: "+this.getComponentName());return null}var n=this.getJson();var i=p(n,e);if(e&&e[0]!=="/"&&!u(i)){t.warning("Manifest entry with key '"+e+"' must be an object. Component: "+this.getComponentName());return null}return i},checkUI5Version:function(){var e=this.getEntry("/sap.ui5/dependencies/minUI5Version");if(e&&t.isLoggable(t.Level.WARNING)&&sap.ui.getCore().getConfiguration().getDebug()){sap.ui.getVersionInfo({async:true}).then(function(n){var i=l(e);var r=l(n&&n.version);if(i.compareTo(r)>0){t.warning('Component "'+this.getComponentName()+'" requires at least version "'+i.toString()+'" but running on "'+r.toString()+'"!')}}.bind(this),function(e){t.warning('The validation of the version for Component "'+this.getComponentName()+'" failed! Reasion: '+e)}.bind(this))}},_loadIncludes:function(e){var n=this.getEntry("/sap.ui5/resources"),i;if(!n){return}var s=this.getComponentName();var o=n["js"];if(o){var a=function(e){return function(){return new Promise(function(n,i){sap.ui.require([e],n,i)})}};i=Promise.resolve();for(var u=0;u<o.length;u++){var c=o[u];var f=c.uri;if(f){var l=f.match(/\.js$/i);if(l){var p=s.replace(/\./g,"/")+(f.slice(0,1)==="/"?"":"/")+f.slice(0,l.index);t.info('Component "'+s+'" is loading JS: "'+p+'"');if(e){i=i.then(a(p))}else{sap.ui.requireSync(p)}}}}}var h=n["css"];if(h){for(var d=0;d<h.length;d++){var v=h[d];if(v.uri){var g=this.resolveUri(v.uri);t.info('Component "'+s+'" is loading CSS: "'+g+'"');r(g,{id:v.id,"data-sap-ui-manifest-uid":this._uid})}}}return i},removeIncludes:function(){var e=this.getEntry("/sap.ui5/resources");if(!e){return}var n=this.getComponentName();var i=e["css"];if(i){var r=document.querySelectorAll("link[data-sap-ui-manifest-uid='"+this._uid+"']");for(var s=0;s<r.length;s++){var o=r[s];t.info('Component "'+n+'" is removing CSS: "'+o.href+'"');o.parentNode.removeChild(o)}}},_loadDependencies:function(e){var n=[];var i=this.getEntry("/sap.ui5/dependencies"),r=this.getComponentName();if(i){var s=i["libs"];if(s){for(var o in s){if(!s[o].lazy){t.info('Component "'+r+'" is loading library: "'+o+'"');n.push(sap.ui.getCore().loadLibrary(o,{async:e}))}}}var a=i["components"];var u=[];if(a){for(var c in a){if(!a[c].lazy){u.push(c)}}}if(e){var f=new Promise(function(e,n){sap.ui.require(["sap/ui/core/Component"],function(n){e(n)},n)}).then(function(e){return Promise.all(u.map(function(n){return e.load({name:n,manifest:false})}))});n.push(f)}else{u.forEach(function(e){var n=e.replace(/\./g,"/")+"/Component";var i=sap.ui.loader._.getModuleState(n+".js");if(i===-1){sap.ui.requireSync(n)}else if(i===0){t.info('Component "'+r+'" is loading component: "'+e+'.Component"');sap.ui.requireSync("sap/ui/core/Component");sap.ui.component.load({name:e})}})}}return Promise.all(n)},defineResourceRoots:function(){var e=this.getEntry("/sap.ui5/resourceRoots");if(e){for(var i in e){var r=e[i];var s=new n(r);if(s.is("absolute")||s.path()&&s.path()[0]==="/"){t.error('Resource root for "'+i+'" is absolute and therefore won\'t be registered! "'+r+'"',this.getComponentName());continue}r=this._resolveUri(s).toString();var o={};o[i.replace(/\./g,"/")]=r;sap.ui.loader.config({paths:o})}}},getComponentName:function(){var e=this.getRawJson();return this._sComponentName||p(e,"/sap.ui5/componentName")||p(e,"/sap.app/id")},resolveUri:function(e,i){var t=this._resolveUri(new n(e),i);return t&&t.toString()},_resolveUri:function(e,n){return d._resolveUriRelativeTo(e,n==="manifest"?this._oManifestBaseUri:this._oBaseUri)},_preprocess:function(e){d.processObject(this._oManifest,function(n,i,t){if(e.resolveUI5Urls&&t.startsWith("ui5:")){n[i]=c.resolveUI5Url(t)}else if(e.i18nProperties&&t.match(d._rManifestTemplate)){e.i18nProperties.push({object:n,key:i})}})},init:function(e){if(this._iInstanceCount===0){this.loadDependenciesAndIncludes()}this._iInstanceCount++},loadDependenciesAndIncludes:function(e){if(this._pDependenciesAndIncludes){return this._pDependenciesAndIncludes}this.checkUI5Version();this.defineResourceRoots();this._preprocess({resolveUI5Urls:true});this._pDependenciesAndIncludes=Promise.all([this._loadDependencies(e),this._loadIncludes(e)]);return this._pDependenciesAndIncludes},exit:function(e){var n=Math.max(this._iInstanceCount-1,0);if(n===0){this.removeIncludes();delete this._pDependenciesAndIncludes}this._iInstanceCount=n}});d._rManifestTemplate=/\{\{([^\}\}]+)\}\}/g;d._resolveUriRelativeTo=function(e,i){if(e.is("absolute")||e.path()&&e.path()[0]==="/"){return e}var t=new n(document.baseURI).search("");i=i.absoluteTo(t);return e.absoluteTo(i).relativeTo(t)};d.prototype._processResourceConfiguration=function(e,n,i){var t=this;Object.keys(e).forEach(function(r){if(r==="bundleUrl"&&!i){var s=e[r];e[r]=t.resolveUri(s,e["bundleUrlRelativeTo"]||n)}if(r==="terminologies"){var o=e[r];for(var a in e[r]){t._processResourceConfiguration(o[a],n)}}if(r==="enhanceWith"){var u=e[r];for(var c=0;c<u.length;c++){t._processResourceConfiguration(u[c],n)}}})};d.load=function(e){var i=e&&e.manifestUrl,r=e&&e.componentName,s=e&&e.async,o=e&&e.failOnError,a=e&&e.processJson;var u=new n(i);["sap-language","sap-client"].forEach(function(e){if(!u.hasQuery(e)){var n=sap.ui.getCore().getConfiguration().getSAPParam(e);if(n){u.addQuery(e,n)}}});i=u.toString();t.info("Loading manifest via URL: "+i);if(!s){t.warning("Synchronous loading of manifest, due to Manifest.load() call for '"+i+"'. Use parameter 'async' true to avoid this.","SyncXHR",null,function(){return{type:"SyncXHR",name:"Manifest"}})}var f=c.loadResource({url:i,dataType:"json",async:typeof s!=="undefined"?s:false,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},failOnError:typeof o!=="undefined"?o:true});var l={componentName:r,url:i,process:false};if(e.activeTerminologies){l["activeTerminologies"]=e.activeTerminologies}if(s){return f.then(function(e){if(a&&e){return a(e)}else{return e}}).then(function(e){if(!e){l._bLoadManifestRequestFailed=true}return new d(e,l)})}return new d(f,l)};d.processObject=function(e,n){for(var i in e){if(!e.hasOwnProperty(i)){continue}var t=e[i];switch(typeof t){case"object":if(t){d.processObject(t,n)}break;case"string":n(e,i,t);break;default:}}};return d});