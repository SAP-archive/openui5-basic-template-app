/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/thirdparty/URI","sap/base/util/Version","sap/base/Log","sap/ui/dom/includeStylesheet","sap/base/i18n/ResourceBundle","sap/base/util/uid","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/LoaderExtensions","sap/base/util/isEmptyObject"],function(e,i,t,n,r,o,s,a,u,c,f){"use strict";function p(e){var i=t(e);return i.getSuffix()?t(i.getMajor()+"."+i.getMinor()+"."+i.getPatch()):i}function l(e,i){if(e&&i&&typeof i==="string"&&i[0]==="/"){var t=i.substring(1).split("/"),n;for(var r=0,o=t.length;r<o;r++){n=t[r];e=e.hasOwnProperty(n)?e[n]:undefined;if(e===null||typeof e!=="object"){if(r+1<o&&e!==undefined){e=undefined}break}}return e}return e&&e[i]}function h(e){if(e&&typeof e==="object"&&!Object.isFrozen(e)){Object.freeze(e);for(var i in e){if(e.hasOwnProperty(i)){h(e[i])}}}}var g=e.extend("sap.ui.core.Manifest",{constructor:function(t,n){e.apply(this,arguments);this._uid=s();this._iInstanceCount=0;this._bIncludesLoaded=false;this._oRawManifest=t;this._bProcess=!(n&&n.process===false);this._bAsync=!(n&&n.async===false);this._activeTerminologies=n&&n.activeTerminologies;this._sComponentName=n&&n.componentName;var r=this.getComponentName(),o=n&&n.baseUrl||r&&sap.ui.require.toUrl(r.replace(/\./g,"/"))+"/";if(o){this._oBaseUri=new i(o).absoluteTo(new i(document.baseURI).search(""))}if(n&&typeof n.url==="string"){this._oManifestBaseUri=new i(n.url).absoluteTo(new i(document.baseURI).search("")).search("")}else{this._oManifestBaseUri=this._oBaseUri}h(this._oRawManifest);this._oManifest=a({},this._oRawManifest);if(this._bProcess){this._processI18n()}},_processI18n:function(e,i){if(!i){i=[];this._preprocess({i18nProperties:i})}if(i.length>0){var t=function(e){var t=function(i,t){return e.getText(t)};for(var n=0,r=i.length;n<r;n++){var o=i[n];o.object[o.key]=o.object[o.key].replace(g._rManifestTemplate,t)}};if(e){return this._loadI18n(e).then(t)}else{t(this._loadI18n(e))}}else{return e?Promise.resolve():undefined}},_loadI18n:function(e){var t=this._oRawManifest,n,r="manifest",s=t["sap.app"]&&t["sap.app"]["i18n"]||"i18n/i18n.properties";if(typeof s==="string"){n=new i(s);return o.create({url:this.resolveUri(n,r),async:e})}else if(typeof s==="object"){s=JSON.parse(JSON.stringify(s));r=s.bundleUrlRelativeTo||r;this._processResourceConfiguration(s,r);var a=Object.assign({activeTerminologies:this._activeTerminologies,async:e},s);return o.create(a)}},getJson:function(){return this._oManifest},getRawJson:function(){return this._oRawManifest},getEntry:function(e){if(!e||e.indexOf(".")<=0){n.warning("Manifest entries with keys without namespace prefix can not be read via getEntry. Key: "+e+", Component: "+this.getComponentName());return null}var i=this.getJson();var t=l(i,e);if(e&&e[0]!=="/"&&!u(t)){n.warning("Manifest entry with key '"+e+"' must be an object. Component: "+this.getComponentName());return null}return t},checkUI5Version:function(){var e=this.getEntry("/sap.ui5/dependencies/minUI5Version");if(e&&n.isLoggable(n.Level.WARNING)&&sap.ui.getCore().getConfiguration().getDebug()){sap.ui.getVersionInfo({async:true}).then(function(i){var t=p(e);var r=p(i&&i.version);if(t.compareTo(r)>0){n.warning('Component "'+this.getComponentName()+'" requires at least version "'+t.toString()+'" but running on "'+r.toString()+'"!')}}.bind(this),function(e){n.warning('The validation of the version for Component "'+this.getComponentName()+'" failed! Reasion: '+e)}.bind(this))}},loadIncludes:function(){if(this._bIncludesLoaded){return}var e=this.getEntry("/sap.ui5/resources");if(!e){return}var i=this.getComponentName();var t=e["js"];if(t){for(var o=0;o<t.length;o++){var s=t[o];var a=s.uri;if(a){var u=a.match(/\.js$/i);if(u){var c=i.replace(/\./g,"/")+(a.slice(0,1)==="/"?"":"/")+a.slice(0,u.index);n.info('Component "'+i+'" is loading JS: "'+c+'"');sap.ui.requireSync(c)}}}}var f=e["css"];if(f){for(var p=0;p<f.length;p++){var l=f[p];if(l.uri){var h=this.resolveUri(l.uri);n.info('Component "'+i+'" is loading CSS: "'+h+'"');r(h,{id:l.id,"data-sap-ui-manifest-uid":this._uid})}}}this._bIncludesLoaded=true},removeIncludes:function(){if(!this._bIncludesLoaded){return}var e=this.getEntry("/sap.ui5/resources");if(!e){return}var i=this.getComponentName();var t=e["css"];if(t){var r=document.querySelectorAll("link[data-sap-ui-manifest-uid='"+this._uid+"']");for(var o=0;o<r.length;o++){var s=r[o];n.info('Component "'+i+'" is removing CSS: "'+s.href+'"');s.parentNode.removeChild(s)}}this._bIncludesLoaded=false},loadDependencies:function(){var e=this.getEntry("/sap.ui5/dependencies"),i=this.getComponentName();if(e){var t=e["libs"];if(t){for(var r in t){if(!t[r].lazy){n.info('Component "'+i+'" is loading library: "'+r+'"');sap.ui.getCore().loadLibrary(r)}}}var o=e["components"];if(o){for(var s in o){if(!o[s].lazy){var a=s.replace(/\./g,"/")+"/Component";var u=sap.ui.loader._.getModuleState(a+".js");if(u===-1){sap.ui.requireSync(a)}else if(u===0){n.info('Component "'+i+'" is loading component: "'+s+'.Component"');sap.ui.requireSync("sap/ui/core/Component");sap.ui.component.load({name:s})}}}}}},defineResourceRoots:function(){var e=this.getEntry("/sap.ui5/resourceRoots");if(e){for(var t in e){var r=e[t];var o=new i(r);if(o.is("absolute")||o.path()&&o.path()[0]==="/"){n.error('Resource root for "'+t+'" is absolute and therefore won\'t be registered! "'+r+'"',this.getComponentName());continue}r=this._resolveUri(o).toString();var s={};s[t.replace(/\./g,"/")]=r;sap.ui.loader.config({paths:s})}}},getComponentName:function(){var e=this.getRawJson();return this._sComponentName||l(e,"/sap.ui5/componentName")||l(e,"/sap.app/id")},resolveUri:function(e,t){var n=this._resolveUri(new i(e),t);return n&&n.toString()},_resolveUri:function(e,i){return g._resolveUriRelativeTo(e,i==="manifest"?this._oManifestBaseUri:this._oBaseUri)},_preprocess:function(e){g.processObject(this._oManifest,function(i,t,n){if(e.resolveUI5Urls&&n.startsWith("ui5:")){i[t]=c.resolveUI5Url(n)}else if(e.i18nProperties&&n.match(g._rManifestTemplate)){e.i18nProperties.push({object:i,key:t})}})},init:function(e){if(this._iInstanceCount===0){this.checkUI5Version();this.defineResourceRoots();this._preprocess({resolveUI5Urls:true});this.loadDependencies();this.loadIncludes();this.activateCustomizing()}if(e){this.activateCustomizing(e)}this._iInstanceCount++},exit:function(e){var i=Math.max(this._iInstanceCount-1,0);if(e){this.deactivateCustomizing(e)}if(i===0){this.deactivateCustomizing();this.removeIncludes()}this._iInstanceCount=i},activateCustomizing:function(e){var i=this.getEntry("sap.ui5",true),t=i&&i["extends"]&&i["extends"].extensions;if(!f(t)){var n=sap.ui.requireSync("sap/ui/core/CustomizingConfiguration");if(!e){n.activateForComponent(this.getComponentName())}else{n.activateForComponentInstance(e)}}},deactivateCustomizing:function(e){var i=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(i){if(!e){i.deactivateForComponent(this.getComponentName())}else{i.deactivateForComponentInstance(e)}}}});g._rManifestTemplate=/\{\{([^\}\}]+)\}\}/g;g._resolveUriRelativeTo=function(e,t){if(e.is("absolute")||e.path()&&e.path()[0]==="/"){return e}var n=new i(document.baseURI).search("");t=t.absoluteTo(n);return e.absoluteTo(t).relativeTo(n)};g.prototype._processResourceConfiguration=function(e,i,t){var n=this;Object.keys(e).forEach(function(r){if(r==="bundleUrl"&&!t){var o=e[r];e[r]=n.resolveUri(o,e["bundleUrlRelativeTo"]||i)}if(r==="terminologies"){var s=e[r];for(var a in e[r]){n._processResourceConfiguration(s[a],i)}}if(r==="enhanceWith"){var u=e[r];for(var c=0;c<u.length;c++){n._processResourceConfiguration(u[c],i)}}})};g.load=function(e){var t=e&&e.manifestUrl,r=e&&e.componentName,o=e&&e.async,s=e&&e.failOnError,a=e&&e.processJson;var u=new i(t);["sap-language","sap-client"].forEach(function(e){if(!u.hasQuery(e)){var i=sap.ui.getCore().getConfiguration().getSAPParam(e);if(i){u.addQuery(e,i)}}});t=u.toString();n.info("Loading manifest via URL: "+t);if(!o){n.warning("Synchronous loading of manifest, due to Manifest.load() call for '"+t+"'. Use parameter 'async' true to avoid this.","SyncXHR",null,function(){return{type:"SyncXHR",name:"Manifest"}})}var f=c.loadResource({url:t,dataType:"json",async:typeof o!=="undefined"?o:false,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},failOnError:typeof s!=="undefined"?s:true});var p={componentName:r,url:t,process:false};if(e.activeTerminologies){p["activeTerminologies"]=e.activeTerminologies}if(o){return f.then(function(e){if(a){return a(e)}else{return e}}).then(function(e){return new g(e,p)})}return new g(f,p)};g.processObject=function(e,i){for(var t in e){if(!e.hasOwnProperty(t)){continue}var n=e[t];switch(typeof n){case"object":if(n){g.processObject(n,i)}break;case"string":i(e,t,n);break;default:}}};return g});