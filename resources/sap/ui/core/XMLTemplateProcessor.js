/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/DataType","sap/ui/base/ManagedObject","sap/ui/core/CustomData","./mvc/View","./mvc/XMLProcessingMode","./mvc/EventHandlerResolver","./ExtensionPoint","./StashedControlSupport","sap/ui/base/SyncPromise","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/values","sap/base/assert","sap/base/security/encodeXML","sap/base/util/LoaderExtensions","sap/base/util/JSTokenizer","sap/base/util/isEmptyObject"],function(e,n,t,r,i,a,o,s,u,l,f,c,p,d,g,m,v,h){"use strict";function w(e,r,i,a,o){var s=t.bindingParser(r,a,true,false,false,false,o);if(s&&typeof s==="object"){return s}var u=r=s||r;var l=n.getType(e);if(l){if(l instanceof n){u=l.parseValue(r,{context:a,locals:o});if(!l.isValid(u)){f.error("Value '"+r+"' is not valid for type '"+l.getName()+"'.")}}}else{throw new Error("Property "+i+" has unknown type "+e)}return typeof u==="string"?t.bindingParser.escape(u):u}function b(e){return e.localName||e.baseName||e.nodeName}var y="http://www.w3.org/1999/xhtml";var _="http://www.w3.org/2000/svg";var C="sap.ui.core";var M="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var x="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1";var I="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1";var A="http://schemas.sap.com/sapui5/preprocessorextension/";function P(e,n){function t(e,t,r,i,a){var o,s,u=[];for(o=e.firstChild;o;o=o.nextSibling){s=n(e,t,r,o,false,i,a);if(s){u.push(s.unwrap())}}return l.resolve(u)}function r(e,t,r,i,a){var o,s=Promise.resolve(),u=[i];for(o=e.firstChild;o;o=o.nextSibling){s=s.then(n.bind(null,e,t,r,o,false,i,a));u.push(s)}return Promise.all(u)}return e?r:t}var V={};V.loadTemplate=function(e,n){var t=e.replace(/\./g,"/")+("."+(n||"view")+".xml");return m.loadResource(t).documentElement};V.loadTemplatePromise=function(e,n){var t=e.replace(/\./g,"/")+("."+(n||"view")+".xml");return m.loadResource(t,{async:true}).then(function(e){return e.documentElement})};V.parseViewAttributes=function(e,n,t){var r=n.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var a=e.attributes[i];if(a.name==="controllerName"){n._controllerName=a.value}else if(a.name==="resourceBundleName"){n._resourceBundleName=a.value}else if(a.name==="resourceBundleUrl"){n._resourceBundleUrl=a.value}else if(a.name==="resourceBundleLocale"){n._resourceBundleLocale=a.value}else if(a.name==="resourceBundleAlias"){n._resourceBundleAlias=a.value}else if(a.name==="class"){n.addStyleClass(a.value)}else if(!t[a.name]&&r[a.name]){t[a.name]=w(r[a.name].type,a.value,a.name,n._oContainingView.oController)}}};V.enrichTemplateIds=function(e,n){V.enrichTemplateIdsPromise(e,n,false);return e};V.enrichTemplateIdsPromise=function(e,n,t){return T(e,n,true,t).then(function(){return e})};V.parseTemplate=function(e,n){return V.parseTemplatePromise(e,n,false).unwrap()};V.parseTemplatePromise=function(e,n,t,r){return T(e,n,false,t,r).then(function(){var e=l.resolve(arguments[0]);if(n.isA("sap.ui.core.Fragment")){return e}var r=arguments;if(n.isA("sap.ui.core.mvc.View")&&n._epInfo&&n._epInfo.all.length>0){e=E(t,n,{content:n._epInfo.all})}return e.then(function(){if(Array.isArray(r[0])){r[0]=r[0].filter(function(e){return!e._isExtensionPoint})}return r[0]})})};function S(e){var n,t=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!e||typeof e!=="object"){n="core:require in XMLView can't be parsed to a valid object"}else{Object.keys(e).some(function(r){if(!t.test(r)){n="core:require in XMLView contains invalid identifier: '"+r+"'";return true}if(!e[r]||typeof e[r]!=="string"){n="core:require in XMLView contains invalide value '"+e[r]+"'under key '"+r+"'";return true}})}return n}function R(e,n){var t=e.getAttributeNS(C,"require"),r,i,a;if(t){try{r=v.parseJS(t)}catch(n){f.error("Require attribute can't be parsed on Node: ",e.nodeName);throw n}a=S(r);if(a){throw new Error(a+" on Node: "+e.nodeName)}if(!h(r)){i={};if(n){return new Promise(function(e,n){var t=Object.keys(r).reduce(function(e,n){i[n]=sap.ui.require(r[n]);return e&&i[n]!==undefined},true);if(t){e(i);return}sap.ui.require(p(r),function(){var n=arguments;Object.keys(r).forEach(function(e,t){i[e]=n[t]});e(i)},n)})}else{Object.keys(r).forEach(function(e){i[e]=sap.ui.requireSync(r[e])});return l.resolve(i)}}}}function E(e,n,t){var r=l.resolve();if(!h(t)){var i=[];var a;if(e){r=new Promise(function(e){a=e})}Object.keys(t).forEach(function(e){var r=t[e];r.forEach(function(e){e.targetControl=n;var t=sap.ui.require(e.providerClass);if(t){i.push(t.applyExtensionPoint(e))}else{var r=new Promise(function(n,t){sap.ui.require([e.providerClass],function(e){n(e)},t)}).then(function(n){return n.applyExtensionPoint(e)});i.push(r)}})});if(e){Promise.all(i).then(a)}}return r}function T(n,p,m,v,S){var T=[],L=R(n,v)||l.resolve();v=v&&!!p._sProcessingMode;f.debug("XML processing mode is "+(p._sProcessingMode||"default")+".","","XMLTemplateProcessor");f.debug("XML will be processed "+v?"asynchronously":"synchronously"+".","","XMLTemplateProcessor");var O=sap.ui.getCore().getConfiguration().getDesignMode();if(O){p._sapui_declarativeSourceInfo={xmlNode:n,xmlRootNode:p._oContainingView===p?n:p._oContainingView._sapui_declarativeSourceInfo.xmlRootNode}}var q=p.sViewName||p._sFragmentName;if(!q){var X=p;var j=0;while(++j<1e3&&X&&X!==X._oContainingView){X=X._oContainingView}q=X.sViewName}if(p.isSubView()){D(n,true,false,L)}else{if(n.localName==="View"&&n.namespaceURI!=="sap.ui.core.mvc"){f.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+n.namespaceURI+"'"+(q?" (View name: "+q+")":""))}K(n,false,false,L)}var U=0;function B(){for(;U<T.length;U++){var e=T[U];if(e&&typeof e.then==="function"){return e.then(k).then(B)}}return T}function k(e){var n=[U,1].concat(e);Array.prototype.splice.apply(T,n)}return L.then(B);function W(e){return e}function F(e){return p._oContainingView.createId(e)}function D(e,n,t,r){if(e.nodeType===1){var i=b(e);if(e.namespaceURI===y||e.namespaceURI===_){T.push("<"+i+" ");var a=false;for(var o=0;o<e.attributes.length;o++){var s=e.attributes[o];var u=s.value;if(s.name==="id"){a=true;u=Z(p,e)}T.push(s.name+'="'+g(u)+'" ')}if(n===true){T.push("data-sap-ui-preserve"+'="'+p.getId()+'" ');if(!a){T.push("id"+'="'+p.getId()+'" ')}}T.push(">");var l=e;if(window.HTMLTemplateElement&&e instanceof HTMLTemplateElement&&e.content instanceof DocumentFragment){l=e.content}K(l,false,false,r);T.push("</"+i+">")}else if(i==="FragmentDefinition"&&e.namespaceURI===C){K(e,false,true,r)}else{L=L.then(function(){return z(e,r).then(function(e){for(var n=0;n<e.length;n++){var t=e[n];if(p.getMetadata().hasAggregation("content")){p._epInfo=p._epInfo||{contentControlsCount:0,last:null,all:[]};if(t._isExtensionPoint){t.index=p._epInfo.contentControlsCount;t.targetControl=p;t.aggregationName="content";if(p._epInfo.last){p._epInfo.last._nextSibling=t}p._epInfo.last=t;p._epInfo.all.push(t)}else{p._epInfo.contentControlsCount++;p.addAggregation("content",t)}}else if(p.getMetadata().hasAssociation("content")){p.addAssociation("content",t)}}return e})});T.push(L)}}else if(e.nodeType===3&&!t){var f=e.textContent||e.text,c=b(e.parentNode);if(f){if(c!="style"){f=g(f)}T.push(f)}}}function K(e,n,t,r){var i=e.childNodes;for(var a=0;a<i.length;a++){D(i[a],n,t,r)}}function H(n,t){var r;var i=sap.ui.getCore().getLoadedLibraries();e.each(i,function(e,i){if(n===i.namespace||n===i.name){r=i.name+"."+(i.tagNames&&i.tagNames[t]||t)}});r=r||n+"."+t;function a(e){if(!e){f.error("Control '"+r+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");e=c.get(r)}if(!e){f.error("Can't find object class '"+r+"' for XML-view","","XMLTemplateProcessor")}return e}var o=r.replace(/\./g,"/");var s=sap.ui.require(o);if(!s){if(v){return new Promise(function(e,n){sap.ui.require([o],function(n){n=a(n);e(n)},n)})}else{s=sap.ui.requireSync(o);s=a(s)}}return s}function J(e,n,t){if(e.namespaceURI===y||e.namespaceURI===_){var r=e.attributes["id"]?e.attributes["id"].textContent||e.attributes["id"].text:null;if(m){return V.enrichTemplateIdsPromise(e,p,v).then(function(){return[]})}else{var i=function(n){var t={id:r?Z(p,e,r):undefined,xmlNode:e,containingView:p._oContainingView,processingMode:p._sProcessingMode};if(p.fnScopedRunWithOwner){return p.fnScopedRunWithOwner(function(){return new n(t)})}return new n(t)};if(v){return new Promise(function(e,n){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(n){e([i(n)])},n)})}else{var a=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return l.resolve([i(a)])}}}else{return z(e,n,t)}}function z(e,n,t){if(b(e)==="ExtensionPoint"&&e.namespaceURI===C){if(m){return l.resolve([])}else{var r=p instanceof i?p._oContainingView:p;var a=s._factory.bind(null,r,e.getAttribute("name"),function(){var r=l.resolve();var i=[];var a=e.childNodes;for(var o=0;o<a.length;o++){var s=a[o];if(s.nodeType===1){r=r.then(J.bind(null,s,n,t));i.push(r)}}return l.all(i).then(function(e){var n=[];e.forEach(function(e){n=n.concat(e)});return n})});return l.resolve(p.fnScopedRunWithOwner?p.fnScopedRunWithOwner(a):a())}}else{var o=H(e.namespaceURI,b(e));if(o&&typeof o.then==="function"){return o.then(function(r){return $(e,r,n,t)})}else{return $(e,o,n,t)}}}function $(e,n,s,c){var g=e.namespaceURI,y={},_={},T="",L=[],q=null,X=null,j=e.getAttribute("stashed")==="true";if(!m){e.removeAttribute("stashed")}if(!n){return l.resolve([])}var U=n.getMetadata();var B=U.getAllSettings();var k=R(e,v);if(k){s=l.all([s,k]).then(function(e){return Object.assign({},e[0],e[1])})}s=s.then(function(a){if(h(a)){a=null}if(!m){for(var s=0;s<e.attributes.length;s++){var u=e.attributes[s],l=u.name,c,g=B[l],v=u.value;if(l==="id"){y[l]=Z(p,e,v)}else if(l==="class"){T+=v}else if(l==="viewName"){y[l]=v}else if(l==="fragmentName"){y[l]=v;y["containingView"]=p._oContainingView}else if(l==="binding"&&!g||l==="objectBindings"){if(!j){var _=t.bindingParser(v,p._oContainingView.oController);if(_){y.objectBindings=y.objectBindings||{};y.objectBindings[_.model||undefined]=_}}}else if(l==="metadataContexts"){if(!j){var I=null;try{I=V._calculatedModelMapping(v,p._oContainingView.oController,true)}catch(e){f.error(p+":"+e.message)}if(I){y.metadataContexts=I;if(V._preprocessMetadataContexts){V._preprocessMetadataContexts(n.getMetadata().getName(),y,p._oContainingView.oController)}}}}else if(l.indexOf(":")>-1){c=u.namespaceURI;if(c===M){var P=b(u);L.push(new r({key:P,value:w("any",v,P,p._oContainingView.oController)}))}else if(c===x){X=v}else if(c&&c.startsWith(A)){f.debug(p+": XMLView parser ignored preprocessor attribute '"+l+"' (value: '"+v+"')")}else if(c===C||c===N||l.startsWith("xmlns:")){}else{if(!q){q={}}if(!q.hasOwnProperty(u.namespaceURI)){q[u.namespaceURI]={}}q[u.namespaceURI][b(u)]=u.nodeValue;f.debug(p+": XMLView parser encountered unknown attribute '"+l+"' (value: '"+v+"') with unknown namespace, stored as sap-ui-custom-settings of customData")}}else if(g&&g._iKind===0){y[l]=w(g.type,v,l,p._oContainingView.oController,a)}else if(g&&g._iKind===1&&g.altTypes){if(!j){y[l]=w(g.altTypes[0],v,l,p._oContainingView.oController,a)}}else if(g&&g._iKind===2){if(!j){var _=t.bindingParser(v,p._oContainingView.oController,false,false,false,false,a);if(_){y[l]=_}else{f.error(p+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+l+"='"+v+"')")}}}else if(g&&g._iKind===3){if(!j){y[l]=F(v)}}else if(g&&g._iKind===4){if(!j){y[l]=v.split(/[\s,]+/g).filter(W).map(F)}}else if(g&&g._iKind===5){if(!j){var S=[];o.parse(v).forEach(function(e){var n=o.resolveEventHandler(e,p._oContainingView.oController,a);if(n){S.push(n)}else{f.warning(p+': event handler function "'+e+'" is not a function or does not exist in the controller.')}});if(S.length){y[l]=S}}}else if(g&&g._iKind===-1){if(i.prototype.isPrototypeOf(n.prototype)&&l=="async"){y[l]=w(g.type,v,l,p._oContainingView.oController,a)}else{f.warning(p+": setting '"+l+"' for class "+U.getName()+" (value:'"+v+"') is not supported")}}else{d(l==="xmlns",p+": encountered unknown setting '"+l+"' for class "+U.getName()+" (value:'"+v+"')");if(V._supportInfo){V._supportInfo({context:e,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+l+"' for class "+U.getName()}})}}}if(q){L.push(new r({key:"sap-ui-custom-settings",value:q}))}if(L.length>0){y.customData=L}}return a}).catch(function(n){if(!n.isEnriched){var t=p.getMetadata().isA("sap.ui.core.mvc.View")?"View":"Fragment";var r=e&&e.cloneNode().outerHTML;n=new Error("Error found in "+t+" (id: '"+p.getId()+"').\nXML node: '"+r+"':\n"+n);n.isEnriched=true;f.error(n)}if(v&&p._sProcessingMode!==a.SequentialLegacy){throw n}});var D=P(v,K);function K(e,n,t,r,i,a,o){var s,l;if(r.nodeType===1){if(r.namespaceURI===I){y[b(r)]=r.querySelector("*");return}s=r.namespaceURI===g&&t&&t[b(r)];if(s){return D(r,s,false,a,o)}else if(n){if(!i&&r.getAttribute("stashed")==="true"&&!m){var f=r;r=r.cloneNode();f.removeAttribute("stashed");l=function(){var i=Z(p,r);u.createStashedControl({wrapperId:i,fnCreate:function(){var r=v;v=false;try{return K(e,n,t,f,true,a,o).unwrap()}finally{v=r}}})};if(p.fnScopedRunWithOwner){p.fnScopedRunWithOwner(l)}else{l()}r.setAttribute("visible","false")}if(y[n.name]&&y[n.name].path&&typeof y[n.name].path==="string"){o={aggregation:n.name,id:y.id}}return J(r,a,o).then(function(e){for(var t=0;t<e.length;t++){var r=e[t];var i=n.name;if(r._isExtensionPoint){if(!y[i]){y[i]=[]}var a=_[i];if(!a){a=_[i]=[]}r.index=y[i].length;r.aggregationName=i;r.closestAggregationBindingCarrier=o&&o.id;r.closestAggregationBinding=o&&o.aggregation;var s=a[a.length-1];if(s){s._nextSibling=r}a.push(r)}else if(n.multiple){if(!y[i]){y[i]=[]}if(typeof y[i].path==="string"){d(!y[i].template,"list bindings support only a single template object");y[i].template=r}else{y[i].push(r)}}else{d(!y[i],"multiple aggregates defined for aggregation with cardinality 0..1");y[i]=r}}return e})}else if(b(e)!=="FragmentDefinition"||e.namespaceURI!==C){throw new Error("Cannot add direct child without default aggregation defined for control "+U.getElementName())}}else if(r.nodeType===3){var c=r.textContent||r.text;if(c&&c.trim()){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+c.trim())}}}var H=U.getDefaultAggregation();var z=U.getAllAggregations();return D(e,H,z,s,c).then(function(){var t;var r=l.resolve();var a=l.resolve();var o=e.getAttribute("type");if(m&&e.hasAttribute("id")){G(p,e)}else if(!m){if(n.getMetadata().isA("sap.ui.core.mvc.View")){var s=function(){if(n.getMetadata().isA("sap.ui.core.mvc.XMLView")&&p._sProcessingMode){y.processingMode=p._sProcessingMode}return i._legacyCreate(y,undefined,n._sType||o)};if(p.fnScopedRunWithOwner){t=p.fnScopedRunWithOwner(s)}else{t=s()}}else if(n.getMetadata().isA("sap.ui.core.Fragment")&&v&&["XML","JS","HTML"].indexOf(y.type)>-1){if(o!=="JS"){y.processingMode=p._sProcessingMode}var u="sap/ui/core/Fragment";var f=sap.ui.require(u);y.name=y.name||y.fragmentName;if(f){a=f.load(y)}else{a=new Promise(function(e,n){sap.ui.require([u],function(n){n.load(y).then(function(n){e(n)})},n)})}}else{var c=function(){var e;if(p.fnScopedRunWithOwner){e=p.fnScopedRunWithOwner(function(){var e=new n(y);return e})}else{e=new n(y)}r=E(v,e,_);return e};if(S&&S.fnRunWithPreprocessor){t=S.fnRunWithPreprocessor(c)}else{t=c()}}}return a.then(function(e){return e||t}).then(function(n){if(T&&n.addStyleClass){n.addStyleClass(T)}if(!n){n=[]}else if(!Array.isArray(n)){n=[n]}if(V._supportInfo&&n){for(var t=0,i=n.length;t<i;t++){var a=n[t];if(a&&a.getId()){var o=V._supportInfo({context:e,env:{caller:"createRegularControls",nodeid:e.getAttribute("id"),controlid:a.getId()}}),s=X?X+",":"";s+=o;V._supportInfo.addSupportInfo(a.getId(),s)}}}if(O){n.forEach(function(n){if(U.getCompositeAggregationName){var t=e.getElementsByTagName(n.getMetadata().getCompositeAggregationName());for(var r=0;r<t.length;r++){e.removeChild(t[0])}}n._sapui_declarativeSourceInfo={xmlNode:e,xmlRootNode:p._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:U.getName()==="sap.ui.core.Fragment"?y["fragmentName"]:null}})}return r.then(function(){return n})})})}function Z(e,n,t){if(n.getAttributeNS(N,"id")){return n.getAttribute("id")}else{return F(t?t:n.getAttribute("id"))}}function G(e,n){n.setAttribute("id",F(n.getAttribute("id")));n.setAttributeNS(N,"id",true)}}V._preprocessMetadataContexts=null;V._calculatedModelMapping=function(e,n,r){var i,a={},o=t.bindingParser(e,n);function s(e){if(e.length%2===0){throw new Error("The last entry is no binding")}for(var n=1;n<=e.length;n=n+2){if(typeof e[n-1]=="string"){throw new Error("Binding expected not a string")}if(e[n]){if(typeof e[n]!="string"||e[n]!=","){throw new Error("Missing delimiter ','")}}}}if(o){if(!o.formatter){i=o;o={parts:[i]}}else{s(o.formatter.textFragments)}for(var u=0;u<o.parts.length;u++){i=o.parts[u];a[i.model]=a[i.model]||(r?[]:null);if(Array.isArray(a[i.model])){a[i.model].push(i)}else{a[i.model]=i}}}return a};return V},true);