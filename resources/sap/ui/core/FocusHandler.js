/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../Device","../base/Object","sap/ui/dom/containsOrEquals","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(t,e,o,n,r){"use strict";var s=e.extend("sap.ui.core.FocusHandler",{constructor:function(o,s){e.apply(this);this.oCore=s;this.oCurrent=null;this.oLast=null;this.aEventQueue=[];this.oLastFocusedControlInfo=null;this.fEventHandler=r.proxy(this.onEvent,this);if(o.addEventListener&&!t.browser.msie){o.addEventListener("focus",this.fEventHandler,true);o.addEventListener("blur",this.fEventHandler,true)}else{r(o).bind("activate",this.fEventHandler);r(o).bind("deactivate",this.fEventHandler)}n.debug("FocusHandler setup on Root "+o.type+(o.id?": "+o.id:""),null,"sap.ui.core.FocusHandler")}});s.prototype.getCurrentFocusedControlId=function(){var t=null;try{var e=r(document.activeElement);if(e.is(":focus")){t=e.control()}}catch(t){}return t&&t.length>0?t[0].getId():null};s.prototype.getControlFocusInfo=function(t){t=t||this.getCurrentFocusedControlId();if(!t){return null}var e=this.oCore&&this.oCore.byId(t);if(e){return{id:t,control:e,info:e.getFocusInfo(),type:e.getMetadata().getName(),focusref:e.getFocusDomRef()}}return null};s.prototype.updateControlFocusInfo=function(t){if(t&&this.oLastFocusedControlInfo&&this.oLastFocusedControlInfo.control===t){var e=t.getId();this.oLastFocusedControlInfo=this.getControlFocusInfo(e);n.debug("Update focus info of control "+e,null,"sap.ui.core.FocusHandler")}};s.prototype.restoreFocus=function(t){var e=t||this.oLastFocusedControlInfo;if(!e){return}var o=this.oCore&&this.oCore.byId(e.id);if(o&&e.info&&o.getMetadata().getName()==e.type&&o.getFocusDomRef()!=e.focusref&&(t||o!==e.control)){n.debug("Apply focus info of control "+e.id,null,"sap.ui.core.FocusHandler");e.control=o;this.oLastFocusedControlInfo=e;o.applyFocusInfo(e.info)}else{n.debug("Apply focus info of control "+e.id+" not possible",null,"sap.ui.core.FocusHandler")}};s.prototype.destroy=function(e){var o=e.data.oRootRef;if(o){if(o.removeEventListener&&!t.browser.msie){o.removeEventListener("focus",this.fEventHandler,true);o.removeEventListener("blur",this.fEventHandler,true)}else{r(o).unbind("activate",this.fEventHandler);r(o).unbind("deactivate",this.fEventHandler)}}this.oCore=null};s.prototype.onEvent=function(t){var e=r.event.fix(t);n.debug("Event "+e.type+" reached Focus Handler (target: "+e.target+(e.target?e.target.id:"")+")",null,"sap.ui.core.FocusHandler");var o=e.type=="focus"||e.type=="focusin"||e.type=="activate"?"focus":"blur";this.aEventQueue.push({type:o,controlId:u(e.target)});if(this.aEventQueue.length==1){this.processEvent()}};s.prototype.processEvent=function(){var t=this.aEventQueue[0];if(!t){return}try{if(t.type=="focus"){this.onfocusEvent(t.controlId)}else if(t.type=="blur"){this.onblurEvent(t.controlId)}}finally{this.aEventQueue.shift();if(this.aEventQueue.length>0){this.processEvent()}}};s.prototype.onfocusEvent=function(t){var e=this.oCore&&this.oCore.byId(t);if(e){this.oLastFocusedControlInfo=this.getControlFocusInfo(t);n.debug("Store focus info of control "+t,null,"sap.ui.core.FocusHandler")}this.oCurrent=t;if(!this.oLast){return}if(this.oLast!=this.oCurrent){i(this.oLast,t,this.oCore)}this.oLast=null};s.prototype.onblurEvent=function(t){if(!this.oCurrent){return}this.oLast=t;this.oCurrent=null;setTimeout(this["checkForLostFocus"].bind(this),0)};s.prototype.checkForLostFocus=function(){if(this.oCurrent==null&&this.oLast!=null){i(this.oLast,null,this.oCore)}this.oLast=null};var u=function(t){var e=r(t).closest("[data-sap-ui]").attr("id");if(e){return e}return null};var i=function(t,e,n){var s=t?n&&n.byId(t):null;if(s){var u=e?n.byId(e):null;var i=r.Event("sapfocusleave");i.target=s.getDomRef();i.relatedControlId=u?u.getId():null;i.relatedControlFocusInfo=u?u.getFocusInfo():null;var a=s.getUIArea();var l=null;if(a){l=n.getUIArea(a.getId())}else{var c=n.getStaticAreaRef();if(o(c,i.target)){l=n.getUIArea(c.id)}}if(l){l._handleEvent(i)}}};return s});