/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExpressionParser","sap/ui/model/BindingMode","sap/ui/model/Filter","sap/ui/model/Sorter","sap/base/Log","sap/base/util/JSTokenizer","sap/base/util/resolveReference"],function(t,e,n,r,i,o,s){"use strict";var a={_keepBindingStrings:false};var f=/^\{\s*('|"|)[a-zA-Z$_][a-zA-Z0-9$_]*\1\s*:/;var u=/(\\[\\\{\}])|(\{)/g;var c=/([\\\{\}])/g;function p(t,e){function n(){var n,r=t.length,i=new Array(r);for(n=0;n<r;n+=1){i[n]=t[n].apply(this,arguments)}if(e){return e.apply(this,i)}return r>1?i.join(" "):i[0]}n.textFragments=e&&e.textFragments||"sap.ui.base.BindingParser: composeFormatters";return n}function l(t){var e=function(){var e=[],n=t.length,r;for(r=0;r<n;r++){if(typeof t[r]==="number"){e.push(arguments[t[r]])}else{e.push(t[r])}}return e.join("")};e.textFragments=t;return e}function d(t){var e=t.indexOf(">"),n={path:t};if(e>0){n.model=t.slice(0,e);n.path=t.slice(e+1)}return n}function h(t,e){try{a.mergeParts(t)}catch(t){i.error("Cannot merge parts: "+t.message,e,"sap.ui.base.BindingParser")}}function y(t,e){var o=Object.assign({".":t.oContext},t.mLocals);function a(e,n){if(typeof e[n]==="string"){var r=e[n];e[n]=s(e[n],o,{preferDotContext:t.bPreferContext,bindDotContext:!t.bStaticContext});if(typeof e[n]!=="function"){if(t.bTolerateFunctionsNotFound){t.aFunctionsNotFound=t.aFunctionsNotFound||[];t.aFunctionsNotFound.push(r)}else{i.error(n+" function "+r+" not found!")}}}}function f(t){var e;var n=t.type;if(typeof n==="string"){e=s(n,o,{bindContext:false});if(typeof e==="function"){t.type=new e(t.formatOptions,t.constraints)}else{t.type=e}if(!t.type){i.error("Failed to resolve type '"+n+"'. Maybe not loaded or a typo?")}delete t.formatOptions;delete t.constraints}}function u(t){if(t!=null&&typeof t==="object"){for(var e in t){a(t,e)}}}function c(t,e){var r=t[e];if(Array.isArray(r)){r.forEach(function(t,e){c(r,e)});return}if(r&&typeof r==="object"){a(r,"test");c(r,"filters");c(r,"condition");t[e]=new n(r)}}function p(t,e){var n=t[e];if(Array.isArray(n)){n.forEach(function(t,e){p(n,e)});return}if(n&&typeof n==="object"){a(n,"group");a(n,"comparator");t[e]=new r(n)}}if(typeof e==="object"){if(Array.isArray(e.parts)){e.parts.forEach(function(e){y(t,e)})}f(e);c(e,"filters");p(e,"sorter");u(e.events);a(e,"formatter");a(e,"factory");a(e,"groupHeaderFactory")}return e}function g(t,e,n){var r=o.parseJS,i,s;if(f.test(e.slice(n))){i=r(e,n);y(t,i.result);return i}s=e.indexOf("}",n);if(s<n){throw new SyntaxError("no closing braces found in '"+e+"' after pos:"+n)}return{result:d(e.slice(n+1,s)),at:s+1}}a.simpleParser=function(t,e){if(t.startsWith("{")&&t.endsWith("}")){return d(t.slice(1,-1))}};a.simpleParser.escape=function(t){return t};a.complexParser=function(n,r,i,o,s,f,c){var p=false,d={parts:[]},y=false,x={oContext:r,mLocals:c,aFunctionsNotFound:undefined,bPreferContext:f,bStaticContext:s,bTolerateFunctionsNotFound:o},m=[],b,F=0,v,A;function w(e,i,o){var a=t.parse(g.bind(null,x),n,i,null,c||(s?r:null));function f(t,e){if(t.parts){t.parts.forEach(function(e,n){if(typeof e==="string"){e=t.parts[n]={path:e}}f(e,n)});p=p||e!==undefined}else{t.mode=o}}if(e.charAt(a.at)!=="}"){throw new SyntaxError("Expected '}' and instead saw '"+e.charAt(a.at)+"' in expression binding "+e+" at position "+a.at)}a.at+=1;if(a.result){f(a.result)}else{m[m.length-1]=String(a.constant);b=true}return a}u.lastIndex=0;while((v=u.exec(n))!==null){if(F<v.index){m.push(n.slice(F,v.index))}if(v[1]){m.push(v[1].slice(1));b=true}else{m.push(d.parts.length);if(n.indexOf(":=",v.index)===v.index+1){A=w(n,v.index+3,e.OneTime)}else if(n.charAt(v.index+1)==="="){A=w(n,v.index+2,e.OneWay)}else{A=g(x,n,v.index)}if(A.result){d.parts.push(A.result);y=y||"parts"in A.result}u.lastIndex=A.at}F=u.lastIndex}if(F<n.length){m.push(n.slice(F))}if(d.parts.length>0){if(m.length===1){d=d.parts[0];y=p}else{d.formatter=l(m)}if(y){h(d,n)}if(a._keepBindingStrings){d.bindingString=n}if(x.aFunctionsNotFound){d.functionsNotFound=x.aFunctionsNotFound}return d}else if(i&&b){return m.join("")}};a.complexParser.escape=function(t){return t.replace(c,"\\$1")};a.mergeParts=function(t){var e=[],n=[];t.parts.forEach(function(t){var r,i=function(){return t},o,s=n.length;function a(){return arguments[s]}if(t&&typeof t==="object"){if(t.parts){for(o in t){if(o!=="formatter"&&o!=="parts"){throw new Error("Unsupported property: "+o)}}n=n.concat(t.parts);r=n.length;if(t.formatter){i=function(){return t.formatter.apply(this,Array.prototype.slice.call(arguments,s,r))}}else if(r-s>1){i=function(){return Array.prototype.slice.call(arguments,s,r).join(" ")}}else{i=a}}else if("path"in t){n.push(t);i=a}}e.push(i)});t.parts=n;t.formatter=p(e,t.formatter)};a.parseExpression=function(e,n,r,i){r=r||{};if(i){r.mLocals=i}return t.parse(g.bind(null,r),e,n,i)};return a},true);