/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/performance/trace/Passport","sap/ui/performance/trace/Interaction","sap/ui/performance/XHRInterceptor","sap/base/util/Version"],function(e,t,n,r,i,o){"use strict";var s=false,a=n.getRootId(),u=n.createGUID().substr(-8,8)+a,p=window.location.host,c=t.os.name+"_"+t.os.version,f=t.browser.name+"_"+t.browser.version,g=P(),m="",d="",S,l,R=0,v,h;function P(){var e=0;if(t.system.combi){e=1}else if(t.system.desktop){e=2}else if(t.system.tablet){e=4}else if(t.system.phone){e=3}return e}function A(e){var t=new Date(e);return t.toISOString().replace(/[^\d]/g,"")}function I(t){var n=new e(t).host();return n&&n!==p}function b(){i.register("PASSPORT_HEADER","open",function(){if(!I(arguments[1])){var e=r.getPending();if(e){if(d!=e.appVersion){d=e.appVersion;m=d?y(d):""}}this.setRequestHeader("SAP-PASSPORT",n.header(S,a,n.getTransactionId(),e?e.component+m:undefined,e?e.trigger+"_"+e.event+"_"+R:undefined))}});i.register("FESR","open",function(){if(!I(arguments[1])){if(!l){l=n.getTransactionId()}if(v){this.setRequestHeader("SAP-Perf-FESRec",v);this.setRequestHeader("SAP-Perf-FESRec-opt",h);v=null;h=null;l=n.getTransactionId();R++}}})}function N(e){return[E(a,32),E(l,32),E(e.navigation,16),E(e.roundtrip,16),E(e.duration,16),E(e.completeRoundtrips,8),E(u,40),E(e.networkTime,16),E(e.requestTime,16),E(c,20),"SAP_UI5"].join(",")}function T(e,t){return[E(t.appNameShort,20,true),E(t.stepName,20,true),"",E(f,20),E(e.bytesSent,16),E(e.bytesReceived,16),"","",E(e.processing,16),e.requestCompression?"X":"","","","","",E(e.busyDuration,16),"",E(g,1),"",E(A(e.start),20),E(t.appNameLong,70,true)].join(",")}function E(e,t,n){if(!e){e=e===0?"0":""}else if(typeof e==="number"){var r=e;e=Math.round(e).toString();if(e.length>t||r<0){e="-1"}}else{e=n?e.substr(-t,t):e.substr(0,t)}return e}function y(e){var t=new o(e);return"@"+t.getMajor()+"."+t.getMinor()+"."+t.getPatch()}function _(e,t){v=N(e);h=T(e,t)}var w={};w.setActive=function(e){if(e&&!s){s=true;n.setActive(true);r.setActive(true);S=n.traceFlags();b();r.onInteractionFinished=function(e,t){var n=w.onBeforeCreated({stepName:e.trigger+"_"+e.event,appNameLong:e.stepComponent||e.component,appNameShort:e.stepComponent||e.component},e);if(e.requests.length>0||t){_(e,n)}}}else if(!e&&s){s=false;r.setActive(false);i.unregister("FESR","open");if(i.isRegistered("PASSPORT_HEADER","open")){i.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",n.header(S,a,n.getTransactionId()))})}r.onInteractionFinished=null}};w.getActive=function(){return s};w.onBeforeCreated=function(e,t){return{stepName:e.stepName,appNameLong:e.appNameLong,appNameShort:e.appNameShort}};return w});