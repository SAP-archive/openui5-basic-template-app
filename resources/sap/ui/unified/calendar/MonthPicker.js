/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/Device","sap/ui/core/LocaleData","sap/ui/core/delegate/ItemNavigation","sap/ui/unified/library","sap/ui/core/Locale","./MonthPickerRenderer","sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/unified/DateRange","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/calendar/CalendarDate"],function(e,t,a,i,s,o,r,n,h,l,g,c){"use strict";var f=12,d=2,u={OneYearBackward:-1,OneYearForward:1};var p=e.extend("sap.ui.unified.calendar.MonthPicker",{metadata:{library:"sap.ui.unified",properties:{month:{type:"int",group:"Data",defaultValue:0},months:{type:"int",group:"Appearance",defaultValue:12},intervalSelection:{type:"boolean",group:"Behavior",defaultValue:false},columns:{type:"int",group:"Appearance",defaultValue:3},primaryCalendarType:{type:"sap.ui.core.CalendarType",group:"Appearance"}},aggregations:{selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"}},events:{select:{},pageChange:{}}}});p.prototype.init=function(){var e=sap.ui.getCore().getConfiguration().getCalendarType();this.setProperty("primaryCalendarType",e);this._iMinMonth=0;this._iMaxMonth=11};p.prototype.onAfterRendering=function(){m.call(this);S.call(this)};p.prototype.setMonth=function(e){this.setProperty("month",e,true);e=this.getProperty("month");if(e<0||e>11){throw new Error("Property month must be between 0 and 11; "+this)}if(this.getIntervalSelection()){this._oItemNavigation&&this._oItemNavigation.focusItem(e);return this}if(this.getDomRef()){if(this.getMonths()<12){var t=this.getStartMonth();if(e>=t&&e<=t+this.getMonths()-1){this._selectMonth(e,true);this._oItemNavigation.focusItem(e-t)}else{v.call(this,e)}}else{this._selectMonth(e,true);this._oItemNavigation.focusItem(e)}}return this};p.prototype.getSelectedDates=function(){if(this._oSelectedDatesControlOrigin){return this._oSelectedDatesControlOrigin.getSelectedDates()}return this.getAggregation("selectedDates")};p.prototype._getSelectedDates=function(){var e=this.getSelectedDates(),t;if(e){return e}else if(!this._aMPSelectedDates||!this._aMPSelectedDates.length){this._aMPSelectedDates=[new l];t=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());t.setMonth(this.getMonth(),1);this._iYear&&t.setYear(this._iYear);this._aMPSelectedDates[0].setStartDate(t.toLocalJSDate());return this._aMPSelectedDates}else{return this._aMPSelectedDates}};p.prototype.exit=function(){if(this._aMPSelectedDates&&this._aMPSelectedDates.length){this._aMPSelectedDates.forEach(function(e){e.destroy()});this._aMPSelectedDates=undefined}};p.prototype.getFocusDomRef=function(){return this._oItemNavigation.getItemDomRefs()[this._oItemNavigation.getFocusedIndex()]};p.prototype._setSelectedDatesControlOrigin=function(e){this._oSelectedDatesControlOrigin=e};p.prototype._setYear=function(e){this._iYear=e};p.prototype._getLocale=function(){var e=this.getParent();if(e&&e._getLocale){return e._getLocale()}else if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};p.prototype._getLocaleData=function(){var e=this.getParent();if(e&&e._getLocaleData){return e._getLocaleData()}else if(!this._oLocaleData){var t=this._getLocale();var i=new o(t);this._oLocaleData=a.getInstance(i)}return this._oLocaleData};p.prototype.onsapspace=function(e){e.preventDefault()};p.prototype.onsapselect=function(e){var t=this._oItemNavigation.getFocusedIndex();var a=t+this.getStartMonth();if(a>=this._iMinMonth&&a<=this._iMaxMonth){this._selectMonth(a);this.fireSelect()}};p.prototype.onmousedown=function(e){this._oMousedownPosition={clientX:e.clientX,clientY:e.clientY}};p.prototype.onmouseup=function(e){var a=e.target,i=this._getSelectedDates()[0],s,o,r;if(this._bMousedownChange){this._bMousedownChange=false;if(this.getIntervalSelection()&&a.classList.contains("sapUiCalItem")&&i){s=c.fromLocalJSDate(i.getStartDate(),this.getPrimaryCalendarType());o=i.getEndDate();r=this._extractMonth(a);if(r!==s.getMonth()&&!o){this._selectMonth(r);this._oItemNavigation.focusItem(r)}}this.fireSelect()}else if(t.support.touch&&this._isValueInThreshold(this._oMousedownPosition.clientX,e.clientX,10)&&this._isValueInThreshold(this._oMousedownPosition.clientY,e.clientY,10)){r=this._oItemNavigation.getFocusedIndex()+this.getStartMonth();if(r>=this._iMinMonth&&r<=this._iMaxMonth){this._selectMonth(r);this.fireSelect()}}};p.prototype.onmouseover=function(e){var t=e.target,a=this._getSelectedDates()[0],i,s;if(!a){return}if(a.getStartDate()){i=c.fromLocalJSDate(a.getStartDate(),this.getPrimaryCalendarType());i.setDate(1)}if(t.classList.contains("sapUiCalItem")){s=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());s.setMonth(this._extractMonth(t),1);this._iYear&&s.setYear(this._iYear);if(this._isSelectionInProgress()){this._markInterval(i,s)}}};p.prototype.onThemeChanged=function(){if(this._bNoThemeChange){return}if(!this.getDomRef()){return}var e=this._oItemNavigation.getItemDomRefs(),t=this._getLocaleData(),a=t.getMonthsStandAlone("wide",this.getPrimaryCalendarType()),i,s;this._bNamesLengthChecked=undefined;this._bLongMonth=false;for(i=0;i<e.length;i++){s=n(e[i]);s.text(a[i])}S.call(this)};p.prototype.nextPage=function(){var e=this.getStartMonth(),t=this._oItemNavigation.getFocusedIndex(),a=t+e,i=this.getMonths();a=a+i;if(a>f-1){a=f-1}v.call(this,a);return this};p.prototype.previousPage=function(){var e=this.getStartMonth(),t=this._oItemNavigation.getFocusedIndex(),a=t+e,i=this.getMonths();a=a-i;if(a<0){a=0}v.call(this,a);return this};p.prototype.setMinMax=function(e,t){var a,i,s,o;if(e==this._iMinMonth&&t==this._iMaxMonth){return this}e=parseInt(e);if(isNaN(e)||e<0||e>11){e=0}t=parseInt(t);if(isNaN(t)||t<0||t>11){t=11}if(e<=t){this._iMinMonth=e;this._iMaxMonth=t}else{this._iMaxMonth=e;this._iMinMonth=t}if(this.getDomRef()){a=this._oItemNavigation.getItemDomRefs();for(o=0;o<a.length;o++){i=n(a[o]);s=this._extractMonth(a[o]);if(s<this._iMinMonth||s>this._iMaxMonth){i.addClass("sapUiCalItemDsbl");i.attr("aria-disabled",true)}else{i.removeClass("sapUiCalItemDsbl");i.removeAttr("aria-disabled")}}}return this};p.prototype.getStartMonth=function(){if(this.getMonths()<f){var e=this._oItemNavigation.getItemDomRefs()[0];return parseInt(e.id.slice(this.getId().length+2))}else{return 0}};p.prototype._isValueInThreshold=function(e,t,a){var i=e-a,s=e+a;return t>=i&&t<=s};function m(){var e=this.getDomRef(),t=this.$().find(".sapUiCalItem"),a=this.getColumns();if(!this._oItemNavigation){this._oItemNavigation=new i;this._oItemNavigation.attachEvent(i.Events.AfterFocus,this._handleAfterFocus,this);this._oItemNavigation.attachEvent(i.Events.FocusAgain,_,this);this._oItemNavigation.attachEvent(i.Events.BorderReached,D,this);this.addDelegate(this._oItemNavigation);this._oItemNavigation.setHomeEndColumnMode(true,true);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]})}this._oItemNavigation.setRootDomRef(e);this._oItemNavigation.setItemDomRefs(t);this._oItemNavigation.setCycling(false);this._oItemNavigation.setColumns(a,true);var s=this.getMonth()-this.getStartMonth();this._oItemNavigation.setFocusedIndex(s);this._oItemNavigation.setPageSize(t.length)}p.prototype._handleAfterFocus=function(e){var t=e.getParameter("index"),a=e.getParameter("event"),i=this._oItemNavigation.aItemDomRefs[t],s=this._getSelectedDates()[0],o,r;if(!a){return}if(a.type==="mousedown"){this._handleMousedown(a,t)}else if(a.type==="sapnext"||a.type==="sapprevious"){if(!s){return}if(s.getStartDate()){o=c.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());o.setDate(1)}r=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());r.setMonth(this._extractMonth(i),1);this._iYear&&r.setYear(this._iYear);if(this._isSelectionInProgress()){this._markInterval(o,r)}}};function _(e){this._handleAfterFocus(e)}p.prototype._isSelectionInProgress=function(){var e=this._getSelectedDates()[0];if(!e){return false}return this.getIntervalSelection()&&e.getStartDate()&&!e.getEndDate()};p.prototype._extractMonth=function(e){var t=this.getId().length+d;return parseInt(e.id.slice(t))};p.prototype._markInterval=function(e,t){var a=this._oItemNavigation.getItemDomRefs(),i=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType()),s;if(e.isAfter(t)){t=[e,e=t][0]}if(this._bMousedownChange){n(a[t.getMonth()]).addClass("sapUiCalItemSel");n(a[e.getMonth()]).addClass("sapUiCalItemSel")}for(s=0;s<a.length;++s){i.setMonth(this._extractMonth(a[s]),1);this._iYear&&i.setYear(this._iYear);if(g._isBetween(i,e,t)){n(a[s]).addClass("sapUiCalItemSelBetween")}else{n(a[s]).removeClass("sapUiCalItemSelBetween")}if(this._bMousedownChange&&!i.isSame(e)&&!i.isSame(t)){n(a[s]).removeClass("sapUiCalItemSel")}}};p.prototype._handleMousedown=function(e,a){if(e.button||t.support.touch){return}var i=a+this.getStartMonth();if(i>=this._iMinMonth&&i<=this._iMaxMonth){this._selectMonth(i);this._bMousedownChange=true}e.preventDefault();e.setMark("cancelAutoClose")};function D(e){var t=e.getParameter("event"),a=this._oItemNavigation.getFocusedIndex()+this.getStartMonth(),i=this.getMonths(),s=this.getColumns(),o=this._getSelectedDates()[0],r,n=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());this._iYear&&n.setYear(this._iYear);if(o&&o.getStartDate()){r=c.fromLocalJSDate(o.getStartDate(),this.getPrimaryCalendarType());r.setDate(1)}if(t.type){switch(t.type){case"sapnext":case"sapnextmodifiers":if(t.keyCode===h.ARROW_DOWN&&s<=i){if(a<f-i){v.call(this,a+s,false,u.OneYearForward)}else if(i===f){this.firePageChange({offset:u.OneYearForward});this._oItemNavigation.focusItem(a%s);n.setMonth(a%s,1);this._isSelectionInProgress()&&this._markInterval(r,n)}else{v.call(this,a%s,true,u.OneYearForward)}}else{if(a<f-i){v.call(this,a+1,false,u.OneYearForward)}else if(i===f){this.firePageChange({offset:u.OneYearForward});this._oItemNavigation.focusItem(0);n.setMonth(0,1);this._isSelectionInProgress()&&this._markInterval(r,n)}else{v.call(this,0,true,u.OneYearForward)}}break;case"sapprevious":case"sappreviousmodifiers":if(t.keyCode===h.ARROW_UP&&s<=i){if(a>=i){v.call(this,a-s,false,u.OneYearBackward)}else if(i===f){this.firePageChange({offset:u.OneYearBackward});this._oItemNavigation.focusItem(i-s+a);n.setMonth(i-s+a,1);this._isSelectionInProgress()&&this._markInterval(r,n)}else{v.call(this,f-s+a,true,u.OneYearBackward)}}else{if(a>=i){v.call(this,a-1,false,u.OneYearBackward)}else if(i===f){this.firePageChange({offset:u.OneYearBackward});this._oItemNavigation.focusItem(i-1);n.setMonth(i-1,1);this._isSelectionInProgress()&&this._markInterval(r,n)}else{v.call(this,f-1,true,u.OneYearBackward)}}break;case"sappagedown":if(a<f-i){v.call(this,a+i,false,u.OneYearForward)}else if(i===f){this.firePageChange({offset:u.OneYearForward})}else{v.call(this,a,true,u.OneYearForward)}break;case"sappageup":if(a>i){v.call(this,a-i,false,u.OneYearBackward)}else if(i===f){this.firePageChange({offset:u.OneYearBackward})}else{v.call(this,a,true,u.OneYearBackward)}break;default:break}}}p.prototype._selectMonth=function(e,t){var a=this._oItemNavigation.getItemDomRefs(),i=this._getSelectedDates()[0],s=this.getAggregation("selectedDates"),o,r,h,l,g,f,d;this._focusedMonth=e;if(!i){return}!t&&this.setProperty("month",e,true);r=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());r.setMonth(e,1);this._iYear&&r.setYear(this._iYear);if(!this._oSelectedDatesControlOrigin){if(!s||!s.length){this.addAggregation("selectedDates",i,true)}!this.getIntervalSelection()&&i.setStartDate(r.toLocalJSDate())}if(this.getIntervalSelection()&&!t){if(!i.getStartDate()){i.setStartDate(r.toLocalJSDate())}else if(!i.getEndDate()){o=c.fromLocalJSDate(i.getStartDate(),this.getPrimaryCalendarType());if(r.isBefore(o)){i.setEndDate(o.toLocalJSDate());i.setStartDate(r.toLocalJSDate())}else{i.setEndDate(r.toLocalJSDate())}}else{i.setStartDate(r.toLocalJSDate());i.setEndDate(undefined)}}for(l=0;l<a.length;l++){h=n(a[l]);d=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());d.setMonth(this._extractMonth(a[l]),1);this._iYear&&d.setYear(this._iYear);g=this._fnShouldApplySelection(d);f=this._fnShouldApplySelectionBetween(d);if(g){h.addClass("sapUiCalItemSel");h.removeClass("sapUiCalItemSelBetween");h.attr("aria-selected","true")}if(f){h.addClass("sapUiCalItemSelBetween");h.attr("aria-selected","true")}if(!g&&!f){h.removeClass("sapUiCalItemSel");h.removeClass("sapUiCalItemSelBetween");h.attr("aria-selected","false")}}};function S(){if(!this._bNamesLengthChecked){var e=0,t=this._oItemNavigation.getItemDomRefs(),a=false,i=this.getMonths(),s=Math.ceil(f/i),o=i-1;for(var r=0;r<s;r++){if(i<f){v.call(this,o);o=o+i;if(o>f-1){o=f-1}}for(e=0;e<t.length;e++){var h=t[e];if(Math.abs(h.clientWidth-h.scrollWidth)>1){a=true;break}}if(a){break}}if(i<f){o=this.getMonth();v.call(this,o)}if(a){this._bLongMonth=false;var l=this._getLocaleData(),g=this.getPrimaryCalendarType(),c=l.getMonthsStandAlone("abbreviated",g),d=l.getMonthsStandAlone("wide",g);for(e=0;e<t.length;e++){var u=n(t[e]);u.text(c[e]);u.attr("aria-label",d[e])}}else{this._bLongMonth=true}this._bNamesLengthChecked=true}}function v(e,t,a){var i=this._oItemNavigation.getItemDomRefs(),s=this._getLocaleData(),o=[],r=[],h=this.getPrimaryCalendarType(),l=i.length,g=Math.floor(e/l)*l,d=this._getSelectedDates()[0],u,p,m,_,D,S,v,M;if(g+l>f){g=f-l}if(this._bLongMonth||!this._bNamesLengthChecked){o=s.getMonthsStandAlone("wide",h)}else{o=s.getMonthsStandAlone("abbreviated",h);r=s.getMonthsStandAlone("wide",h)}for(S=0;S<i.length;S++){D=n(i[S]);_=S+g;D.text(o[_]);D.attr("id",this.getId()+"-m"+_);m=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());m.setMonth(_,1);this._iYear&&m.setYear(this._iYear);if(!this._bLongMonth){D.attr("aria-label",r[_])}v=this._fnShouldApplySelection(m);M=this._fnShouldApplySelectionBetween(m);if(v){D.addClass("sapUiCalItemSel");D.removeClass("sapUiCalItemSelBetween");D.attr("aria-selected","true")}if(M){D.addClass("sapUiCalItemSelBetween");D.attr("aria-selected","true")}if(!v&&!M){D.removeClass("sapUiCalItemSel");D.removeClass("sapUiCalItemSelBetween");D.attr("aria-selected","false")}}if(d&&d.getStartDate()){u=c.fromLocalJSDate(d.getStartDate(),this.getPrimaryCalendarType());u.setDate(1)}if(d&&d.getEndDate()){p=c.fromLocalJSDate(d.getEndDate(),this.getPrimaryCalendarType());p.setDate(1)}else{p=c.fromLocalJSDate(new Date,this.getPrimaryCalendarType());this._iYear&&p.setYear(this._iYear);p.setMonth(e,1)}this._oItemNavigation.focusItem(e-g);this._isSelectionInProgress()&&this._markInterval(u,p);if(t){this.firePageChange({offset:a})}}p.prototype._fnShouldApplySelection=function(e){var t=this._getSelectedDates()[0],a,i;if(!t){return false}a=t.getStartDate();i=t.getEndDate();if(a){a=c.fromLocalJSDate(a,this.getPrimaryCalendarType());a.setDate(1)}if(this.getIntervalSelection()&&a&&i){i=c.fromLocalJSDate(i,this.getPrimaryCalendarType());i.setDate(1);if(e.isSame(a)||e.isSame(i)){return true}}else if(a&&e.isSame(a)){return true}return false};p.prototype._fnShouldApplySelectionBetween=function(e){var t=this._getSelectedDates()[0],a,i;if(!t){return false}a=t.getStartDate();i=t.getEndDate();if(this.getIntervalSelection()&&a&&i){a=c.fromLocalJSDate(a,this.getPrimaryCalendarType());a.setDate(1);i=c.fromLocalJSDate(i,this.getPrimaryCalendarType());i.setDate(1);if(g._isBetween(e,a,i)){return true}}return false};return p});