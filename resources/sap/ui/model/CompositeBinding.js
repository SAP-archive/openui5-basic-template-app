/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/DataType","./BindingMode","./ChangeReason","./PropertyBinding","./CompositeType","./CompositeDataState","sap/base/util/deepEqual","sap/base/assert","sap/base/Log","sap/ui/thirdparty/jquery"],function(t,e,a,n,i,s,r,h,u,o){"use strict";var l=n.extend("sap.ui.model.CompositeBinding",{constructor:function(t,e,a){n.apply(this,[null,""]);this.aBindings=t;this.aValues=null;this.bRawValues=e;this.bPreventUpdate=false;this.bInternalValues=a},metadata:{publicMethods:["getBindings","attachChange","detachChange"]}});l.prototype.getPath=function(){h(null,"Composite Binding has no path!");return null};l.prototype.getModel=function(){h(null,"Composite Binding has no model!");return null};l.prototype.getContext=function(){h(null,"Composite Binding has no context!");return null};l.prototype.isResolved=function(){var t=false;o.each(this.aBindings,function(e,a){t=a.isResolved();if(!t){return false}});return t};l.prototype.setType=function(t,e){if(t&&!(t instanceof i)){throw new Error("Only CompositeType can be used as type for composite bindings!")}n.prototype.setType.apply(this,arguments);if(this.oType){this.bRawValues=this.oType.getUseRawValues();this.bInternalValues=this.oType.getUseInternalValues();if(this.bRawValues&&this.bInternalValues){throw new Error(this.oType+" has both 'bUseRawValues' & 'bUseInternalValues' set to true. Only one of them is allowed to be true")}}};l.prototype.setContext=function(t){o.each(this.aBindings,function(e,a){if(!t||a.updateRequired(t.getModel())){a.setContext(t)}})};l.prototype.setValue=function(t){var e;if(this.bSuspended){return}o.each(this.aBindings,function(a,n){e=t[a];if(e!==undefined){n.setValue(e)}});this.getDataState().setValue(this.getValue())};l.prototype.getValue=function(){var t=[],e;o.each(this.aBindings,function(a,n){e=n.getValue();t.push(e)});return t};l.prototype.getOriginalValue=function(){var t=[],e;o.each(this.aBindings,function(a,n){e=n.getDataState().getOriginalValue();t.push(e)});return t};l.prototype.getExternalValue=function(){var e=[],a,n;switch(this.sInternalType){case"raw":return this.getRawValue();case"internal":return this.getInternalValue();default:a=this.sInternalType&&t.getType(this.sInternalType);if(this.bRawValues){e=this.getValue()}else{this.aBindings.forEach(function(t){e.push(this.bInternalValues?t.getInternalValue():t.getExternalValue())}.bind(this))}if(this.fnFormatter){n=this.fnFormatter.apply(this,e)}else if(this.oType){n=this.oType.formatValue(e,this.sInternalType)}else if(a instanceof t&&a.isArrayType()){n=e}else if(e.length>1){n=e.join(" ")}else{n=e[0]}return n}};l.prototype.setExternalValue=function(e){var a,n,i,s;if(this.sInternalType==="raw"){this.setRawValue(e);return}else if(this.sInternalType==="internal"){this.setInternalValue(e);return}i=this.sInternalType&&t.getType(this.sInternalType);if(this.fnFormatter){u.warning("Tried to use twoway binding, but a formatter function is used");return}s=this.getDataState();if(this.oType){try{if(this.oType.getParseWithValues()){n=[];if(this.bRawValues){n=this.getValue()}else{o.each(this.aBindings,function(t,e){n.push(e.getExternalValue())})}}a=this.oType.parseValue(e,this.sInternalType,n);this.oType.validateValue(a)}catch(t){s.setInvalidValue(e);this.checkDataState();throw t}}else if(Array.isArray(e)&&i instanceof t&&i.isArrayType()){a=e}else if(typeof e=="string"){a=e.split(" ")}else{a=[e]}this.aBindings.forEach(function(t,n){e=a[n];if(e!==undefined){if(this.bRawValues){t.setRawValue(e)}else if(this.bInternalValues){t.setInternalValue(e)}else{t.setExternalValue(e)}}}.bind(this));s.setValue(this.getValue());s.setInvalidValue(undefined)};l.prototype.getInternalValue=function(){return this.aBindings.map(function(t){return t.getInternalValue()})};l.prototype.setInternalValue=function(t){var e=this.getDataState(),a=t;if(this.oType){try{if(!this.bInternalValues){a=this.aBindings.map(function(t,e){return t._internalToRaw(a[e])});if(!this.bRawValues){a=this.aBindings.map(function(t,e){return t._rawToExternal(a[e])})}}this.oType.validateValue(a)}catch(a){e.setInvalidValue(t);this.checkDataState();throw a}}this.aBindings.forEach(function(e,a){var n=t[a];if(n!==undefined){e.setInternalValue(n)}});e.setValue(this.getValue());e.setInvalidValue(undefined)};l.prototype.getRawValue=function(){return this.aBindings.map(function(t){return t.getRawValue()})};l.prototype.setRawValue=function(t){var e=this.getDataState(),a=t;if(this.oType){try{if(!this.bRawValues){if(this.bInternalValues){a=this.aBindings.map(function(t,e){return t._rawToInternal(a[e])})}else{a=this.aBindings.map(function(t,e){return t._rawToExternal(a[e])})}}this.oType.validateValue(a)}catch(a){e.setInvalidValue(t);this.checkDataState();throw a}}this.aBindings.forEach(function(e,a){var n=t[a];if(n!==undefined){e.setRawValue(n)}});e.setValue(this.getValue());e.setInvalidValue(undefined)};l.prototype.getBindings=function(){return this.aBindings};l.prototype.hasValidation=function(){if(this.getType()){return true}var t=this.getBindings();for(var e=0;e<t.length;++e){if(t[e].hasValidation()){return true}}return false};l.prototype.attachChange=function(t,a){var n=this;this.fChangeHandler=function(t){if(n.bSuspended){return}var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachChange(n.fChangeHandler)}n.checkUpdate(true)};this.attachEvent("change",t,a);if(this.aBindings){o.each(this.aBindings,function(t,e){e.attachChange(n.fChangeHandler)})}};l.prototype.detachChange=function(t,e){var a=this;this.detachEvent("change",t,e);if(this.aBindings){o.each(this.aBindings,function(t,e){e.detachChange(a.fChangeHandler)})}};l.prototype.attachDataStateChange=function(t,a){var n=this;this.fDataStateChangeHandler=function(t){var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachDataStateChange(n.fChangeHandler)}n.checkDataState()};this.attachEvent("DataStateChange",t,a);if(this.aBindings){o.each(this.aBindings,function(t,e){e.attachEvent("DataStateChange",n.fDataStateChangeHandler)})}};l.prototype.detachDataStateChange=function(t,e){var a=this;this.detachEvent("DataStateChange",t,e);if(this.aBindings){o.each(this.aBindings,function(t,e){e.detachEvent("DataStateChange",a.fDataStateChangeHandler)})}};l.prototype.attachAggregatedDataStateChange=function(t,a){var n=this;if(!this.fDataStateChangeHandler){this.fDataStateChangeHandler=function(t){var a=t.getSource();if(a.getBindingMode()==e.OneTime){a.detachDataStateChange(n.fChangeHandler)}n.checkDataState()}}this.attachEvent("AggregatedDataStateChange",t,a);if(this.aBindings){o.each(this.aBindings,function(t,e){e.attachEvent("DataStateChange",n.fDataStateChangeHandler)})}};l.prototype.detachAggregatedDataStateChange=function(t,e){var a=this;this.detachEvent("AggregatedDataStateChange",t,e);if(this.aBindings){o.each(this.aBindings,function(t,e){e.detachEvent("DataStateChange",a.fDataStateChangeHandler)})}};l.prototype.updateRequired=function(t){var e=false;o.each(this.aBindings,function(a,n){e=e||n.updateRequired(t)});return e};l.prototype.initialize=function(){this.bPreventUpdate=true;if(this.aBindings){o.each(this.aBindings,function(t,e){e.initialize()})}this.bPreventUpdate=false;if(!this.bSuspended){this.checkUpdate(true)}return this};l.prototype.getDataState=function(){if(!this.oDataState){this.oDataState=new s(this.aBindings.map(function(t){return t.getDataState()}))}return this.oDataState};l.prototype.suspend=function(){this.bSuspended=true;o.each(this.aBindings,function(t,e){e.suspend()})};l.prototype.resume=function(){o.each(this.aBindings,function(t,e){e.resume()});this.bSuspended=false;this.checkUpdate(true)};l.prototype.checkUpdate=function(t){var e=false;if(this.bPreventUpdate||this.bSuspended&&!t){return}var n=this.getDataState();var i=this.getOriginalValue();if(t||!r(i,this.aOriginalValues)){this.aOriginalValues=i;n.setOriginalValue(i);e=true}var s=this.getValue();if(!r(s,this.aValues)||t){this.aValues=s;n.setValue(s);this._fireChange({reason:a.Change});e=true}if(e){this.checkDataState()}};return l});