/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BindingMode","./ChangeReason","./CompositeDataState","./CompositeType","./Context","./PropertyBinding","sap/base/assert","sap/base/Log","sap/base/util/deepEqual","sap/ui/base/DataType","sap/ui/base/SyncPromise"],function(t,e,n,a,i,s,r,o,u,h,l){"use strict";var f=s.extend("sap.ui.model.CompositeBinding",{constructor:function(t,e,n){var a;s.apply(this,[null,""]);this.aBindings=t;this.aValues=null;this.bRawValues=e;this.bPreventUpdate=false;this.bInternalValues=n;this.bMultipleModels=this.aBindings.some(function(t){var e=t.getModel();a=a||e;return a&&e&&e!==a})},metadata:{publicMethods:["getBindings","attachChange","detachChange"]}});f.prototype.destroy=function(){this.aBindings.forEach(function(t){t.destroy()});s.prototype.destroy.apply(this)};f.prototype.getPath=function(){r(null,"Composite Binding has no path!");return null};f.prototype.getModel=function(){r(null,"Composite Binding has no model!");return null};f.prototype.getContext=function(){r(null,"Composite Binding has no context!");return null};f.prototype.isResolved=function(){return this.aBindings.every(function(t){return t.isResolved()})};f.prototype.setType=function(t,e){var n=this;if(t&&!(t instanceof a)){throw new Error("Only CompositeType can be used as type for composite bindings!")}s.prototype.setType.apply(this,arguments);if(this.oType){t.getPartsIgnoringMessages().forEach(function(t){var e=n.aBindings[t];if(e&&e.supportsIgnoreMessages()&&e.getIgnoreMessages()===undefined){e.setIgnoreMessages(true)}});this.bRawValues=this.oType.getUseRawValues();this.bInternalValues=this.oType.getUseInternalValues();if(this.bRawValues&&this.bInternalValues){throw new Error(this.oType+" has both 'bUseRawValues' & 'bUseInternalValues' set to true. Only one of them is allowed to be true")}}};f.prototype.setContext=function(t,e){var n,a,s=this.aBindings,r=t&&t.getModel(),o=e&&e.fnIsBindingRelevant?e.fnIsBindingRelevant:function(e){return!t||r&&r===s[e].getModel()};s.forEach(function(e,s){var r;if(o(s)){r=e.getContext();n=n||e.isRelative()&&i.hasChanged(r,t);a=a||n&&r!==t;e.setContext(t)}});if(n){this.checkUpdate(a&&this.getDataState().getControlMessages().length)}};f.prototype.setValue=function(e){if(this.bSuspended){return}this.aBindings.forEach(function(n,a){var i=e[a],s=n.getBindingMode();if(i!==undefined&&s!==t.OneWay&&s!==t.OneTime){n.setValue(i)}});this.getDataState().setValue(this.getValue())};f.prototype.getValue=function(){return this.aBindings.map(function(t){return t.getValue()})};f.prototype.getOriginalValue=function(){return this.aBindings.map(function(t){return t.getDataState().getOriginalValue()})};f.prototype.getExternalValue=function(){var t=[],e,n;switch(this.sInternalType){case"raw":return this.getRawValue();case"internal":return this.getInternalValue();default:e=this.sInternalType&&h.getType(this.sInternalType);t=this.getCurrentValues();if(this.fnFormatter){n=this.fnFormatter.apply(this,t)}else if(this.oType){n=this.oType.formatValue(t,this.sInternalType)}else if(e instanceof h&&e.isArrayType()){n=t}else if(t.length>1){n=t.join(" ")}else{n=t[0]}return n}};f.prototype.setExternalValue=function(e){var n,a,i,s,r=this;if(this.sInternalType==="raw"){this.setRawValue(e);return undefined}else if(this.sInternalType==="internal"){this.setInternalValue(e);return undefined}n=this.sInternalType&&h.getType(this.sInternalType);if(this.fnFormatter){o.warning("Tried to use twoway binding, but a formatter function is used");return undefined}a=this.getDataState();if(this.oType){s=l.resolve().then(function(){var t;if(r.oType.getParseWithValues()){t=r.getCurrentValues()}return r.oType.parseValue(e,r.sInternalType,t)}).then(function(t){var e=r.getValidateValues(t);return l.all([t,r.oType.validateValue(e)])}).then(function(t){return t[0]}).catch(function(t){a.setInvalidValue(e);r.checkDataState();throw t})}else if(Array.isArray(e)&&n instanceof h&&n.isArrayType()){s=l.resolve(e)}else if(typeof e=="string"){s=l.resolve(e.split(" "))}else{s=l.resolve([e])}i=s.then(function(n){r.aBindings.forEach(function(a,i){var s=a.getBindingMode();e=n[i];if(e!==undefined&&s!==t.OneWay&&s!==t.OneTime){if(r.bRawValues){a.setRawValue(e)}else if(r.bInternalValues){a.setInternalValue(e)}else{a.setExternalValue(e)}}});a.setValue(r.getValue());a.setInvalidValue(undefined)});i.catch(function(){});return i.unwrap()};f.prototype.getInternalValue=function(){return this.aBindings.map(function(t){return t.getInternalValue()})};f.prototype.setInternalValue=function(e){var n=this.getDataState(),a,i=this;if(this.oType){a=l.resolve(e).then(function(t){if(!i.bInternalValues){t=i.aBindings.map(function(e,n){return e._internalToRaw(t[n])});if(!i.bRawValues){t=i.aBindings.map(function(e,n){return e._rawToExternal(t[n])})}}return i.oType.validateValue(t)}).then(function(){return e}).catch(function(t){n.setInvalidValue(e);i.checkDataState();throw t})}else{a=l.resolve(e)}return a.then(function(){i.aBindings.forEach(function(n,a){var i=e[a],s=n.getBindingMode();if(i!==undefined&&s!==t.OneWay&&s!==t.OneTime){n.setInternalValue(i)}});n.setValue(i.getValue());n.setInvalidValue(undefined)}).unwrap()};f.prototype.getRawValue=function(){return this.aBindings.map(function(t){return t.getRawValue()})};f.prototype.setRawValue=function(e){var n=this.getDataState(),a,i=this;if(this.oType){a=l.resolve(e).then(function(t){if(!i.bRawValues){if(i.bInternalValues){t=i.aBindings.map(function(e,n){return e._rawToInternal(t[n])})}else{t=i.aBindings.map(function(e,n){return e._rawToExternal(t[n])})}}return i.oType.validateValue(t)}).then(function(){return e}).catch(function(t){n.setInvalidValue(e);i.checkDataState();throw t})}else{a=l.resolve(e)}return a.then(function(){i.aBindings.forEach(function(n,a){var i=e[a],s=n.getBindingMode();if(i!==undefined&&s!==t.OneWay&&s!==t.OneTime){n.setRawValue(i)}});n.setValue(i.getValue());n.setInvalidValue(undefined)}).unwrap()};f.prototype.getCurrentValues=function(){if(this.bRawValues){return this.getRawValue()}else if(this.bInternalValues){return this.getInternalValue()}else{return this.aBindings.map(function(t){return t.getExternalValue()})}};f.prototype.getValidateValues=function(t){var e,n,a=t;n=this.aBindings.some(function(e,n){return t[n]===undefined});if(n){e=this.getCurrentValues();a=e.map(function(e,n){return t[n]===undefined?e:t[n]})}return a};f.prototype.getBindings=function(){return this.aBindings};f.prototype.hasValidation=function(){if(this.getType()){return true}var t=this.getBindings();for(var e=0;e<t.length;++e){if(t[e].hasValidation()){return true}}return false};f.prototype.attachChange=function(e,n){var a=this;this.fChangeHandler=function(e){if(a.bSuspended){return}var n=e.getSource();if(n.getBindingMode()==t.OneTime){n.detachChange(a.fChangeHandler)}a.checkUpdate(true)};this.attachEvent("change",e,n);if(this.aBindings){this.aBindings.forEach(function(t){t.attachChange(a.fChangeHandler)})}};f.prototype.detachChange=function(t,e){var n=this;this.detachEvent("change",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachChange(n.fChangeHandler)})}};f.prototype.attachDataStateChange=function(e,n){var a=this;this.fDataStateChangeHandler=function(e){var n=e.getSource();if(n.getBindingMode()==t.OneTime){n.detachDataStateChange(a.fChangeHandler)}a.checkDataState()};this.attachEvent("DataStateChange",e,n);if(this.aBindings){this.aBindings.forEach(function(t){t.attachEvent("DataStateChange",a.fDataStateChangeHandler)})}};f.prototype.detachDataStateChange=function(t,e){var n=this;this.detachEvent("DataStateChange",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachEvent("DataStateChange",n.fDataStateChangeHandler)})}};f.prototype.attachAggregatedDataStateChange=function(e,n){var a=this;if(!this.fDataStateChangeHandler){this.fDataStateChangeHandler=function(e){var n=e.getSource();if(n.getBindingMode()==t.OneTime){n.detachDataStateChange(a.fChangeHandler)}a.checkDataState()}}this.attachEvent("AggregatedDataStateChange",e,n);if(this.aBindings){this.aBindings.forEach(function(t){t.attachEvent("DataStateChange",a.fDataStateChangeHandler)})}};f.prototype.detachAggregatedDataStateChange=function(t,e){var n=this;this.detachEvent("AggregatedDataStateChange",t,e);if(this.aBindings){this.aBindings.forEach(function(t){t.detachEvent("DataStateChange",n.fDataStateChangeHandler)})}};f.prototype.updateRequired=function(t){var e=false;this.aBindings.forEach(function(n){e=e||n.updateRequired(t)});return e};f.prototype.initialize=function(){this.bPreventUpdate=true;if(this.aBindings){this.aBindings.forEach(function(t){t.initialize()})}this.bPreventUpdate=false;if(!this.bSuspended){this.checkUpdate(true)}return this};f.prototype.getDataState=function(){if(!this.oDataState){this.oDataState=new n(this.aBindings.map(function(t){return t.getDataState()}))}return this.oDataState};f.prototype.suspend=function(){this.bSuspended=true;this.aBindings.forEach(function(t){t.suspend()})};f.prototype.resume=function(){this.aBindings.forEach(function(t){t.resume()});this.bSuspended=false;this.checkUpdate(true)};f.prototype.checkUpdate=function(t){var n=false;if(this.bPreventUpdate||this.bSuspended&&!t){return}if(this.bMultipleModels&&this.aBindings.some(function(t){var e=t.getModel();return e&&e.bDestroyed})){return}var a=this.getDataState();var i=this.getOriginalValue();if(t||!u(i,this.aOriginalValues)){this.aOriginalValues=i;a.setOriginalValue(i);n=true}var s=this.getValue();if(!u(s,this.aValues)||t){this.aValues=s;a.setValue(s);this._fireChange({reason:e.Change});n=true}if(n){this.checkDataState()}};return f});