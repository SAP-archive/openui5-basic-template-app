/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../json/JSONModel","../json/JSONPropertyBinding","../json/JSONListBinding","sap/ui/base/ManagedObject","sap/ui/base/ManagedObjectObserver","../Context","../ChangeReason","sap/base/util/uid","sap/base/Log","sap/base/util/isPlainObject"],function(e,t,i,r,n,s,o,a,g,p){"use strict";var f=i.extend("sap.ui.model.base.ManagedObjectModelAggregationBinding"),d=t.extend("sap.ui.model.base.ManagedObjectModelPropertyBinding"),u="@custom",l="--";var h=e.extend("sap.ui.model.base.ManagedObjectModel",{constructor:function(t,i){if(!i&&typeof i!="object"){i={}}i[u]={};this._oObject=t;this._mObservedCount={properties:{},aggregations:{}};this.mListBinding={};e.apply(this,[i]);this._oObserver=new n(this.observerChanges.bind(this))}});h.prototype.getAggregation=e.prototype.getProperty;h.prototype.setData=function(t,i){var r={};r[u]=t;e.prototype.setData.apply(this,[r,i])};h.prototype.getJSON=function(){return JSON.stringify(this.oData[u])};h.prototype.setProperty=function(t,i,n,s){var o=this.resolve(t,n),a,p,f;if(!o){return false}if(o.indexOf("/"+u)===0){return e.prototype.setProperty.apply(this,arguments)}a=o.lastIndexOf("/");p=o.substring(0,a||1);f=o.substr(a+1);var d=this._getObject(p);if(d){if(d instanceof r){var l=d.getMetadata().getManagedProperty(f);if(l){if(l.get(d)!==i){l.set(d,i);this.checkUpdate(false,s);return true}}else{g.warning("The setProperty method only supports properties, the path "+o+" does not point to a property",null,"sap.ui.model.base.ManagedObjectModel")}}else if(d[f]!==i){d[f]=i;this.checkUpdate(false,s);return true}}return false};h.prototype.addBinding=function(t){e.prototype.addBinding.apply(this,arguments);if(t instanceof f){var i=t.sPath.replace("/","");this.mListBinding[i]=t}t.checkUpdate(false)};h.prototype.removeBinding=function(t){e.prototype.removeBinding.apply(this,arguments);if(t instanceof f){var i=t.sPath.replace("/","");delete this.mListBinding[i]}this._observeBeforeEvaluating(t,false)};h.prototype.firePropertyChange=function(t){if(t.reason===o.Binding){t.resolvedPath=this.resolve(t.path,t.context)}e.prototype.firePropertyChange.call(this,t)};h.prototype.bindAggregation=function(t,i,r){return e.prototype.bindProperty.apply(this,arguments)};h.prototype.bindProperty=function(e,t,i){var r=new d(this,e,t,i);return r};h.prototype.bindList=function(e,t,i,r,n){var s=new f(this,e,t,i,r,n);s.enableExtendedChangeDetection();return s};h.prototype.getManagedObject=function(e,t){if(e instanceof s){t=e;e=t.getPath()}var i=this.getProperty(e,t);if(i instanceof r){return i}return null};h.prototype.getRootObject=function(){return this._oObject};h.prototype._observePropertyChange=function(e,t){if(!e||!t){return}var i=e.getId()+"/@"+t.name;if(!this._oObserver.isObserved(e,{properties:[t.name]})){this._oObserver.observe(e,{properties:[t.name]});this._mObservedCount.properties[i]=1}else{this._mObservedCount.properties[i]++}};h.prototype._unobservePropertyChange=function(e,t){if(!e||!t){return}var i=e.getId()+"/@"+t.name;this._mObservedCount.properties[i]--;if(this._mObservedCount.properties[i]==0){this._oObserver.unobserve(e,{properties:[t.name]});delete this._mObservedCount.properties[i]}};h.prototype._observeAggregationChange=function(e,t){if(!e||!t){return}var i=e.getId()+"/@"+t.name;if(!this._oObserver.isObserved(e,{aggregations:[t.name]})){this._oObserver.observe(e,{aggregations:[t.name]});this._mObservedCount.aggregations[i]=1}else{this._mObservedCount.aggregations[i]++}};h.prototype._unobserveAggregationChange=function(e,t){if(!e||!t){return}var i=e.getId()+"/@"+t.name;this._mObservedCount.aggregations[i]--;if(this._mObservedCount.aggregations[i]==0){this._oObserver.unobserve(e,{aggregations:[t.name]});delete this._mObservedCount.aggregations[i]}};h.prototype._createId=function(e){var t=this._oObject;if(typeof t.createId==="function"){return t.createId(e)}if(!e){return t.getId()+l+a()}if(e.indexOf(t.getId()+l)!=0){return t.getId()+l+e}return e};h.prototype._getSpecialNode=function(e,t,i,n){if(e instanceof r){if(t==="className"){if(e.getMetadata){return e.getMetadata().getName()}else{return typeof e}}else if(t==="id"){return e.getId()}else if(t==="metadataContexts"){return e._oProviderData}}else if(t==="binding"&&i&&n){return i.getBinding(n)}else if(t==="bound"&&i&&n){return i.isBound(n)}else if(t==="bindingInfo"&&i&&n){return i.getBindingInfo(n)}else if(Array.isArray(e)){if(t==="length"){return e.length}else if(t.indexOf("id=")===0){var s=t.substring(3),o=null;for(var a=0;a<e.length;a++){if(e[a].getId()===this._createId(s)||e[a].getId()===s){o=e[a];break}}return o}}return null};h.prototype._getObject=function(t,i){var n=this._oObject,o="",a=this;this.aBindings.forEach(function(e){if(!e._bAttached){a._observeBeforeEvaluating(e,true)}});if(typeof t==="string"&&t.indexOf("/")!=0&&!i){return null}if(i instanceof r){n=i;o=t}else if(!i||i instanceof s){o=this.resolve(t,i);if(!o){return n}if(o.indexOf("/"+u)===0){return e.prototype._getObject.apply(this,[t,i])}}else{n=i;o=t}if(!n){return null}var g=o.split("/"),f=0;if(!g[0]){f++}var d=null,l=null,h;while(n!==null&&g[f]){h=g[f];if(h=="id"){h="@id"}if(h.indexOf("@")===0){n=this._getSpecialNode(n,h.substring(1),d,l)}else if(n instanceof r){var c=n.getMetadata();if(c.isInstanceOf("sap.ui.core.IDScope")&&h.indexOf("#")===0){n=n.byId(h.substring(1))}else{d=n;l=h;var b=c.getManagedProperty(h);if(b){n=b.get(n)}else{var v=c.getManagedAggregation(h);if(v){n=v.get(n)}else{if(n&&n[h]&&typeof n[h]==="function"){n=n[h]()}else{n=null}}}}}else if(Array.isArray(n)||p(n)){n=n[h]}else{if(n&&n[h]&&typeof n[h]==="function"){n=n[h]()}else{n=null}}f++}return n};h.prototype.destroy=function(){for(var t in this._mAggregationObjects){var i=this._mAggregationObjects[t];if(i.object.invalidate.fn){i.object.invalidate=i.object.invalidate.fn}}e.prototype.destroy.apply(this,arguments)};h.prototype._observeBeforeEvaluating=function(e,t){if(!e.isResolved()){return}var i=e.getPath();var n=e.getContext(),o=this._oObject,a;if(n instanceof r){o=n;a=i}else if(!n||n instanceof s){a=this.resolve(i,n);if(!a){return}if(a.indexOf("/"+u)===0){return}}else{return}var g=a.split("/");if(!g[0]){g.shift()}var p=g[0];if(o.getMetadata().isInstanceOf("sap.ui.core.IDScope")&&p.indexOf("#")===0){o=o.byId(p.substring(1));p=g[1]}if(o instanceof r){var f=o.getMetadata(),d=f.getManagedProperty(p);if(d){if(t===true){this._observePropertyChange(o,d)}else if(t===false){this._unobservePropertyChange(o,d)}}else{var l=f.getAggregation(p)||f.getAllPrivateAggregations()[p];if(l){if(t===true){this._observeAggregationChange(o,l)}else if(t===false){this._unobserveAggregationChange(o,l)}}}e._bAttached=t}};h.prototype.observerChanges=function(e){if(e.type=="aggregation"){if(e.mutation=="insert"){if(e.child instanceof r){this._oObserver.observe(e.child,{properties:true,aggegations:true})}if(this.mListBinding[e.name]){var t=this._oObject.getBinding(e.name);var i=this._oObject.getAggregation(e.name);if(t&&t.getLength()!=i.length){return}}}else{if(e.child instanceof r){this._oObserver.unobserve(e.child,{properties:true,aggegations:true})}}}this.checkUpdate()};h.prototype.checkUpdate=function(e,t,i){if(t){if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){this.checkUpdate(e,false,i)}.bind(this),0)}return}if(this.sUpdateTimer){clearTimeout(this.sUpdateTimer);this.sUpdateTimer=null}var r=this.aBindings.slice(0);jQuery.each(r,function(t,r){if(!i||i(r)){r.checkUpdate(e)}})};return h});