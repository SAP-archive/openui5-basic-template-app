/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../_AnnotationHelperBasics","sap/base/Log","sap/ui/base/BindingParser","sap/ui/base/ManagedObject","sap/ui/base/SyncPromise","sap/ui/performance/Measurement"],function(e,t,r,n,a,i){"use strict";var s="sap.ui.model.odata.v4.AnnotationHelper",u=[s],o=s+"/getExpression",l=/^{@i18n>[^\\{}:]+}$/,c={And:"&&",Eq:"===",Ge:">=",Gt:">",Le:"<=",Lt:"<",Ne:"!==",Not:"!",Or:"||"},p=false,f={"Edm.Boolean":"boolean","Edm.Byte":"number","Edm.Date":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"number","Edm.Guid":"string","Edm.Int16":"number","Edm.Int32":"number","Edm.Int64":"Decimal","Edm.SByte":"number","Edm.Single":"number","Edm.String":"string","Edm.TimeOfDay":"TimeOfDay"},m={Bool:"Edm.Boolean",Float:"Edm.Double",Date:"Edm.Date",DateTimeOffset:"Edm.DateTimeOffset",Decimal:"Edm.Decimal",Guid:"Edm.Guid",Int:"Edm.Int64",Int32:"Edm.Int32",String:"Edm.String",TimeOfDay:"Edm.TimeOfDay"},d={boolean:false,Date:false,DateTimeOffset:true,Decimal:true,number:false,string:false,TimeOfDay:false},y;function g(e,t){return a.resolve().then(function(){E(e,t)})}function E(t,r){e.error(t,r,s)}y={adjustOperands:function(e,t){if(e.result!=="constant"&&e.category==="number"&&t.result==="constant"&&t.type==="Edm.Int64"){t.category="number"}if(e.result!=="constant"&&e.category==="Decimal"&&t.result==="constant"&&t.type==="Edm.Int32"){t.category="Decimal";t.type=e.type}},apply:function(t,r){var n=e.descend(t,"$Function","string");switch(n.value){case"odata.concat":return y.concat(r);case"odata.fillUriTemplate":return y.fillUriTemplate(r);case"odata.uriEncode":return y.uriEncode(r);default:return g(n,"unknown function: "+n.value)}},collection:function(t){var r;e.expectType(t,"array");r=t.value.map(function(r,n){return y.expression(e.descend(t,n,true),true)});return a.all(r).then(function(t){t=t.map(function(t){return e.resultToString(t,true,false,true)});return{result:"expression",value:"odata.collection(["+t.join(",")+"])"}})},concat:function(t){var r;e.expectType(t,"array");r=t.value.map(function(e,r){return y.parameter(t,r)});return a.all(r).then(function(r){var n,a,i;n=t.asExpression||r.some(function(e){return e.result==="expression"});a=r.filter(function(e){return e.type!=="edm:Null"}).map(function(r){if(n){y.wrapExpression(r)}return e.resultToString(r,n,t.complexBinding)});i=n?{result:"expression",value:a.join("+")}:{result:"composite",value:a.join("")};i.type="Edm.String";return i})},conditional:function(t,r){var n=t.complexBinding,i=n?Object.assign({},t,{complexBinding:false}):t;function s(t,r,n){return e.resultToString(y.wrapExpression(t),true,r,n)}return a.all([y.parameter(i,0,"Edm.Boolean"),y.parameter(t,1),r&&t.value.length===2?{result:"constant",type:"edm:Null",value:undefined}:y.parameter(t,2)]).then(function(e){var r=e[0],a=e[1],i=e[2],u=a.type;if(a.type==="edm:Null"){u=i.type}else if(i.type!=="edm:Null"&&a.type!==i.type){E(t,"Expected same type for second and third parameter, types are '"+a.type+"' and '"+i.type+"'")}return{result:"expression",type:u,value:s(r,false,true)+"?"+s(a,n)+":"+s(i,n)}})},constant:function(e,t){var r=e.value;if(t==="String"){if(l.test(r)){return{ignoreTypeInPath:true,result:"binding",type:"Edm.String",value:r.slice(1,-1)}}}return{result:"constant",type:m[t],value:r}},expression:function(t,r){var n=t.value,i=t,s;if(n===null){s="Null"}else if(typeof n==="boolean"){s="Bool"}else if(typeof n==="number"){s=isFinite(n)&&Math.floor(n)===n?"Int32":"Float"}else if(typeof n==="string"){s="String"}else if(Array.isArray(n)){return y.collection(t)}else{e.expectType(t,"object");if(n.$kind==="Property"){t.value=t.model.getObject(t.path+"@sapui.name");return y.path(t)}["$And","$Apply","$Date","$DateTimeOffset","$Decimal","$Float","$Eq","$Ge","$Gt","$Guid","$If","$Int","$Le","$Lt","$Name","$Ne","$Not","$Null","$Or","$Path","$PropertyPath","$TimeOfDay","$LabeledElement"].forEach(function(r){if(n.hasOwnProperty(r)){s=r.slice(1);i=e.descend(t,r)}})}switch(s){case"Apply":return y.apply(t,i);case"If":return y.conditional(i,r);case"Name":case"Path":case"PropertyPath":return y.path(i);case"Date":case"DateTimeOffset":case"Decimal":case"Guid":case"Int":case"String":case"TimeOfDay":e.expectType(i,"string");case"Bool":case"Float":case"Int32":return a.resolve(y.constant(i,s));case"And":case"Eq":case"Ge":case"Gt":case"Le":case"Lt":case"Ne":case"Or":return y.operator(i,s);case"Not":return y.not(i);case"Null":return a.resolve({result:"constant",type:"edm:Null",value:null});default:return g(t,"Unsupported OData expression")}},fetchCurrencyOrUnit:function(t,r,n,a){var i="sap.ui.model.odata.type.Unit",s="@@requestUnitsOfMeasure",u=t.model,o=t.path+"@Org.OData.Measures.V1.Unit/$Path",l=u.getObject(o);function c(r,n,a){return e.resultToString(y.pathResult(t,n,a,r),false,true)}if(!l){i="sap.ui.model.odata.type.Currency";s="@@requestCurrencyCodes";o=t.path+"@Org.OData.Measures.V1.ISOCurrency/$Path";l=u.getObject(o)}if(!l){return undefined}return u.fetchObject(o+"/$").then(function(e){var p=u.getObject(t.path+"@com.sap.vocabularies.UI.v1.DoNotCheckScaleOfMeasureQuantity")?",constraints:{'skipDecimalsValidation':true}":"";return{result:"composite",type:i,value:(f[n]==="number"?"{formatOptions:{parseAsString:false},":"{")+"mode:'TwoWay',parts:["+c(a,n,r)+","+c(u.getConstraints(e,o),e.$Type,l)+",{mode:'OneTime',path:'/##"+s+"',targetType:'any'}"+"],type:'"+i+"'"+p+"}"}})},fillUriTemplate:function(t){var r=[],n,i;t.complexBinding=false;n=[y.parameter(t,0,"Edm.String")];for(i=1;i<t.value.length;i+=1){r[i]=e.descend(t,i,"object");n.push(y.expression(e.descend(r[i],"$LabeledElement",true)))}return a.all(n).then(function(n){var a,s=[],u="";s.push("odata.fillUriTemplate(",e.resultToString(n[0],true,false,true),",{");for(i=1;i<t.value.length;i+=1){a=e.property(r[i],"$Name","string");s.push(u,e.toJSON(a),":",e.resultToString(n[i],true,false,true));u=","}s.push("})");return{result:"expression",type:"Edm.String",value:s.join("")}})},formatOperand:function(t,r){if(t.result==="constant"){switch(t.category){case"boolean":case"number":return String(t.value)}}if(r){y.wrapExpression(t)}return e.resultToString(t,true,false,true)},getExpression:function(a){if(a.value===undefined){return undefined}i.average(o,"",u);if(!p&&n.bindingParser===r.simpleParser){t.warning("Complex binding syntax not active",null,s);p=true}return y.expression(a).then(function(t){return e.resultToString(t,false,a.complexBinding)},function(t){if(t instanceof SyntaxError){return"Unsupported: "+r.complexParser.escape(e.toErrorString(a.value))}throw t}).finally(function(){i.end(o)}).unwrap()},not:function(t){t.asExpression=true;t.complexBinding=false;return y.expression(t).then(function(t){return{result:"expression",type:"Edm.Boolean",value:"!"+e.resultToString(y.wrapExpression(t),true,false,true)}})},operator:function(e,t){var r=t==="And"||t==="Or"?"Edm.Boolean":undefined;e.complexBinding=false;return a.all([y.parameter(e,0,r),y.parameter(e,1,r)]).then(function(r){var n,a=r[0],i=r[1],s="",u,o;if(a.type!=="edm:Null"&&i.type!=="edm:Null"){a.category=f[a.type];i.category=f[i.type];y.adjustOperands(a,i);y.adjustOperands(i,a);if(a.category!==i.category){E(e,"Expected two comparable parameters but instead saw "+a.type+" and "+i.type)}switch(a.category){case"Decimal":s=",'Decimal'";break;case"DateTimeOffset":s=",'DateTime'";break}n=d[a.category]}u=y.formatOperand(a,!n);o=y.formatOperand(i,!n);return{result:"expression",type:"Edm.Boolean",value:n?"odata.compare("+u+","+o+s+")"+c[t]+"0":u+c[t]+o}})},parameter:function(t,r,n){var a=e.descend(t,r,true);return y.expression(a).then(function(e){if(n&&n!==e.type){E(a,"Expected "+n+" but instead saw "+e.type)}return e})},path:function(t){var r=t.ignoreAsPrefix,n=t.model,i,s=t.value;if(r&&s.startsWith(r)){s=s.slice(r.length)}e.expectType(t,"string");i=n.fetchObject(t.path+"/$");if(i.isPending()&&!t.$$valueAsPromise){i.caught();i=a.resolve()}return i.then(function(e){var r,a,i=e&&e.$Type;if(e&&t.complexBinding){r=n.getConstraints(e,t.path);a=y.fetchCurrencyOrUnit(t,s,i,r)}return a||y.pathResult(t,i,s,r)})},pathResult:function(e,t,r,n){return{constraints:n,formatOptions:t==="Edm.String"?Object.assign({parseKeepsEmptyString:true},e.formatOptions):e.formatOptions,parameters:e.parameters,result:"binding",type:t,value:e.prefix+r}},uriEncode:function(t){return y.parameter(t,0).then(function(t){return{result:"expression",type:"Edm.String",value:t.type==="Edm.String"?"odata.uriEncode("+e.resultToString(t,true,false,true)+","+e.toJSON(t.type)+")":"String("+e.resultToString(t,true,false,true)+")"}})},wrapExpression:function(e){if(e.result==="expression"){e.value="("+e.value+")"}return e}};return y},false);