/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Context","./ODataParentBinding","./lib/_AggregationCache","./lib/_AggregationHelper","./lib/_Cache","./lib/_GroupLock","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/Sorter","sap/ui/model/odata/OperationMode","sap/ui/thirdparty/jquery"],function(e,t,i,n,o,r,s,a,h,u,d,f,l,c,p,g,C,x){"use strict";var y="sap.ui.model.odata.v4.ODataListBinding",v={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true,patchCompleted:true,patchSent:true,refresh:true};var m=p.extend("sap.ui.model.odata.v4.ODataListBinding",{constructor:function(i,n,o,r,a,u){p.call(this,i,n);t.call(this);if(n.slice(-1)==="/"){throw new Error("Invalid path: "+n)}this.oAggregation=null;this.aApplicationFilters=s.toArray(a);m.checkCaseSensitiveFilters(this.aApplicationFilters);this.oCachePromise=h.resolve();this.sChangeReason=i.bAutoExpandSelect?"AddVirtualContext":undefined;this.oDiff=undefined;this.aFilters=[];this.bHasAnalyticalInfo=false;this.mPreviousContextsByPath={};this.aPreviousData=[];this.oReadGroupLock=undefined;this.aSorters=s.toArray(r);this.applyParameters(x.extend(true,{},u));this.oHeaderContext=this.bRelative?null:e.create(this.oModel,this,n);if(!this.bRelative||o&&!o.fetchValue){this.createReadGroupLock(this.getGroupId(),true)}this.setContext(o);i.bindingCreated(this)}});t(m.prototype);m.checkCaseSensitiveFilters=function(e){function t(e){if(e.bCaseSensitive===false){throw new Error("Filter for path '"+e.sPath+"' has unsupported value for 'caseSensitive' : false")}if(e.aFilters){m.checkCaseSensitiveFilters(e.aFilters)}if(e.oCondition){t(e.oCondition)}}e.forEach(t)};m.prototype._delete=function(t,i,n){var o=this;if(!n.isTransient()&&this.hasPendingChanges()){throw new Error("Cannot delete due to pending changes")}return this.deleteFromCache(t,i,String(n.iIndex),function(t,i){var r,a,h,u;if(t===-1){n.destroy();delete o.aContexts[-1]}else{for(a=t;a<o.aContexts.length;a+=1){n=o.aContexts[a];if(n){o.mPreviousContextsByPath[n.getPath()]=n}}u=o.oModel.resolve(o.sPath,o.oContext);o.aContexts.splice(t,1);for(a=t;a<o.aContexts.length;a+=1){if(o.aContexts[a]){h=s.getPrivateAnnotation(i[a],"predicate");r=u+(h||"/"+a);n=o.mPreviousContextsByPath[r];if(n){delete o.mPreviousContextsByPath[r];if(n.getIndex()===a){n.checkUpdate()}else{n.setIndex(a)}}else{n=e.create(o.oModel,o,r,a)}o.aContexts[a]=n}}}o.iMaxLength-=1;o._fireChange({reason:d.Remove})})};m.prototype.applyParameters=function(e,t){var i,o;this.checkBindingParameters(e,["$$aggregation","$$canonicalPath","$$groupId","$$operationMode","$$ownRequest","$$updateGroupId"]);o=e.$$operationMode||this.oModel.sOperationMode;if(!o&&(this.aSorters.length||this.aApplicationFilters.length)){throw new Error("Unsupported operation mode: "+o)}this.sOperationMode=o;this.sGroupId=e.$$groupId;this.sUpdateGroupId=e.$$updateGroupId;this.mQueryOptions=this.oModel.buildQueryOptions(e,true);this.mParameters=e;if("$$aggregation"in e){if("$apply"in this.mQueryOptions){throw new Error("Cannot combine $$aggregation and $apply")}i=s.clone(e.$$aggregation);this.mQueryOptions.$apply=n.buildApply(i).$apply;this.oAggregation=i}this.removeCachesAndMessages();this.fetchCache(this.oContext);this.reset(t)};m.prototype.attachEvent=function(e){if(!(e in v)){throw new Error("Unsupported event '"+e+"': v4.ODataListBinding#attachEvent")}return p.prototype.attachEvent.apply(this,arguments)};m.prototype.create=function(t,i){var n,o,r,a=this.oModel.resolve(this.sPath,this.oContext),h=this;if(!a){throw new Error("Binding is not yet resolved: "+this)}if(this.aContexts[-1]){throw new Error("Must not create twice")}this.checkSuspended();r=this.lockGroup(this.getUpdateGroupId(),true);o=this.createInCache(r,this.fetchResourcePath(),"",t,function(){n.destroy();delete h.aContexts[-1];h._fireChange({reason:d.Remove})}).then(function(e){var t;h.iMaxLength+=1;if(!i&&h.isRefreshable()){t=h.getGroupId();if(!h.oModel.isDirectGroup(t)&&!h.oModel.isAutoGroup(t)){t="$auto"}return h.refreshSingle(n,h.lockGroup(t))}return e},function(e){r.unlock(true);throw e}).then(function(e){var i;if(!(t&&t["@$ui5.keepTransientPath"])){i=s.getPrivateAnnotation(e,"predicate");if(i){n.sPath=a+i}}});n=e.create(this.oModel,this,a+"/-1",-1,o);this.aContexts[-1]=n;this._fireChange({reason:d.Add});return n};m.prototype.createContexts=function(t,i,n){var o=false,r=this.oContext,a,h,u=n.$count,d=this.aContexts.length,f=this.bLengthFinal,l=this.oModel,c=l.resolve(this.sPath,r),p,g=this;function C(e){var t;for(t=e;t<g.aContexts.length;t+=1){if(g.aContexts[t]){g.aContexts[t].destroy()}}while(e>0&&!g.aContexts[e-1]){e-=1}g.aContexts.length=e;o=true}for(h=t;h<t+n.length;h+=1){if(this.aContexts[h]===undefined){o=true;p=s.getPrivateAnnotation(n[h-t],"predicate");a=c+(p||"/"+h);if(a in this.mPreviousContextsByPath){this.aContexts[h]=this.mPreviousContextsByPath[a];delete this.mPreviousContextsByPath[a];this.aContexts[h].setIndex(h);this.aContexts[h].checkUpdate()}else{this.aContexts[h]=e.create(l,this,a,h)}}}if(Object.keys(this.mPreviousContextsByPath).length){sap.ui.getCore().addPrerenderingTask(function(){Object.keys(g.mPreviousContextsByPath).forEach(function(e){g.mPreviousContextsByPath[e].destroy();delete g.mPreviousContextsByPath[e]})})}if(u!==undefined){if(this.aContexts.length>u){C(u)}this.iMaxLength=u;this.bLengthFinal=true}else{if(this.aContexts.length>this.iMaxLength){this.iMaxLength=Infinity}if(n.length<i){this.iMaxLength=t+n.length;if(this.aContexts.length>this.iMaxLength){C(this.iMaxLength)}}if(!(t>d&&n.length===0)){this.bLengthFinal=this.aContexts.length===this.iMaxLength}}if(this.bLengthFinal!==f){o=true}return o};m.prototype.destroy=function(){if(this.bHasAnalyticalInfo&&this.aContexts===undefined){return}this.aContexts.forEach(function(e){e.destroy()});if(this.oHeaderContext){this.oHeaderContext.destroy()}if(this.aContexts[-1]){this.aContexts[-1].destroy()}this.oModel.bindingDestroyed(this);this.removeReadGroupLock();this.mAggregatedQueryOptions=undefined;this.oAggregation=undefined;this.aApplicationFilters=undefined;this.oCachePromise=h.resolve();this.oContext=undefined;this.aContexts=undefined;this.aFilters=undefined;this.oHeaderContext=undefined;this.mPreviousContextsByPath=undefined;this.aPreviousData=undefined;this.aSorters=undefined;t.prototype.destroy.apply(this);p.prototype.destroy.apply(this)};m.prototype.doCreateCache=function(e,t,r){var s=this.oAggregation&&(this.oAggregation.groupLevels.length||n.hasMinOrMax(this.oAggregation.aggregate)||n.hasGrandTotal(this.oAggregation.aggregate));t=this.inheritQueryOptions(t,r);return s?i.create(this.oModel.oRequestor,e,this.oAggregation,t):o.create(this.oModel.oRequestor,e,t,this.oModel.bAutoExpandSelect)};m.prototype.doFetchQueryOptions=function(e){var t=this.getOrderby(this.mQueryOptions.$orderby),i=this;return this.fetchFilter(e,this.mQueryOptions.$filter).then(function(e){return i.mergeQueryOptions(i.mQueryOptions,t,e)})};m.prototype.enableExtendedChangeDetection=function(e,t){if(t!==undefined){throw new Error("Unsupported property 'key' with value '"+t+"' in binding info for "+this)}return p.prototype.enableExtendedChangeDetection.apply(this,arguments)};m.prototype.fetchFilter=function(e,t){var i,n,o;function r(e,t,i){var n,o=s.formatLiteral(e.oValue1,t),r=decodeURIComponent(e.sPath);switch(e.sOperator){case f.BT:n=r+" ge "+o+" and "+r+" le "+s.formatLiteral(e.oValue2,t);break;case f.NB:n=d(r+" lt "+o+" or "+r+" gt "+s.formatLiteral(e.oValue2,t),i);break;case f.EQ:case f.GE:case f.GT:case f.LE:case f.LT:case f.NE:n=r+" "+e.sOperator.toLowerCase()+" "+o;break;case f.Contains:case f.EndsWith:case f.NotContains:case f.NotEndsWith:case f.NotStartsWith:case f.StartsWith:n=e.sOperator.toLowerCase().replace("not","not ")+"("+r+","+o+")";break;default:throw new Error("Unsupported operator: "+e.sOperator)}return n}function a(e,t,i){if(e.aFilters){return h.all(e.aFilters.map(function(i){return a(i,t,e.bAnd)})).then(function(t){return d(t.join(e.bAnd?" and ":" or "),i&&!e.bAnd)})}return n.fetchObject(u(e.sPath,t),o).then(function(n){var s,h,d;if(!n){throw new Error("Type cannot be determined, no metadata for path: "+o.getPath())}d=e.sOperator;if(d===f.All||d===f.Any){s=e.oCondition;h=e.sVariable;if(d===f.Any&&!s){return e.sPath+"/any()"}t=Object.create(t);t[h]=u(e.sPath,t);return a(s,t).then(function(t){return e.sPath+"/"+e.sOperator.toLowerCase()+"("+h+":"+t+")"})}return r(e,n.$Type,i)})}function u(e,t){var i=e.split("/");i[0]=t[i[0]];return i[0]?i.join("/"):e}function d(e,t){return t?"("+e+")":e}i=l.combineFilters(this.aFilters,this.aApplicationFilters);if(!i){return h.resolve(t)}n=this.oModel.getMetaModel();o=n.getMetaContext(this.oModel.resolve(this.sPath,e));return a(i,{},t).then(function(e){if(t){e+=" and ("+t+")"}return e})};m.prototype.fetchValue=function(e,t,i){var n=this;return this.oCachePromise.then(function(o){var s;if(o){s=n.getRelativePath(e);if(s!==undefined){return o.fetchValue(r.$cached,s,undefined,t)}}if(n.oContext){return n.oContext.fetchValue(e,t,i)}})};m.prototype.filter=function(e,t){var i=s.toArray(e);m.checkCaseSensitiveFilters(i);this.checkSuspended();if(this.sOperationMode!==C.Server){throw new Error("Operation mode has to be sap.ui.model.odata.OperationMode.Server")}if(this.hasPendingChanges()){throw new Error("Cannot filter due to pending changes")}this.createReadGroupLock(this.getGroupId(),true);if(t===c.Control){this.aFilters=i}else{this.aApplicationFilters=i}this.removeCachesAndMessages();this.fetchCache(this.oContext);this.reset(d.Filter);return this};m.prototype.getContexts=function(t,i,n){var o,r=this.oContext,s,h=false,u=false,f,l,c=!!this.sChangeReason,p,g,C=this;a.debug(this+"#getContexts("+t+", "+i+", "+n+")",undefined,y);this.checkSuspended();if(t!==0&&this.bUseExtendedChangeDetection){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" first parameter must be 0 if extended change detection is enabled, but is "+t)}if(n!==undefined&&this.bUseExtendedChangeDetection){throw new Error("Unsupported operation: v4.ODataListBinding#getContexts,"+" third parameter must not be set if extended change detection is enabled")}if(this.bRelative&&!r){this.aPreviousData=[];return[]}o=this.sChangeReason||d.Change;this.sChangeReason=undefined;if(o==="AddVirtualContext"){sap.ui.getCore().addPrerenderingTask(function(){C.sChangeReason="RemoveVirtualContext";C._fireChange({reason:d.Change});C.reset(d.Refresh)},true);g=e.create(this.oModel,this,this.oModel.resolve(this.sPath,this.oContext)+"/"+e.VIRTUAL,e.VIRTUAL);return[g]}if(o==="RemoveVirtualContext"){return[]}t=t||0;i=i||this.oModel.iSizeLimit;if(!n||n<0){n=0}p=this.aContexts[-1]?t-1:t;f=this.oReadGroupLock;this.oReadGroupLock=undefined;if(!this.bUseExtendedChangeDetection||!this.oDiff){l=this.oCachePromise.then(function(e){if(e){f=C.lockGroup(C.getGroupId(),f);return e.read(p,i,n,f,function(){h=true;C.fireDataRequested()})}else{if(f){f.unlock()}return r.fetchValue(C.sPath).then(function(e){var t;e=e||[];t=e.$count;if(p<0){e=[e[-1]].concat(e.slice(0,i-1))}else{e=e.slice(p,p+i)}e.$count=t;return{value:e}})}});if(l.isFulfilled()&&c){l=Promise.resolve(l)}l.then(function(e){var t;if(!C.bRelative||C.oContext===r){t=C.createContexts(p,i,e.value);if(C.bUseExtendedChangeDetection){C.oDiff={aDiff:C.getDiff(e.value,p),iLength:i}}if(u){if(t){C._fireChange({reason:o})}else{C.oDiff=undefined}}}if(h){C.fireDataReceived({data:{}})}},function(e){if(h){C.fireDataReceived(e.canceled?{data:{}}:{error:e})}throw e}).catch(function(e){if(f){f.unlock(true)}C.oModel.reportError("Failed to get contexts for "+C.oModel.sServiceUrl+C.oModel.resolve(C.sPath,C.oContext).slice(1)+" with start index "+t+" and length "+i,y,e)});u=true}this.iCurrentBegin=p;this.iCurrentEnd=p+i;if(p===-1){s=this.aContexts.slice(0,p+i);s.unshift(this.aContexts[-1])}else{s=this.aContexts.slice(p,p+i)}if(this.bUseExtendedChangeDetection){if(this.oDiff&&i!==this.oDiff.iLength){throw new Error("Extended change detection protocol violation: Expected "+"getContexts(0,"+this.oDiff.iLength+"), but got getContexts(0,"+i+")")}s.dataRequested=!this.oDiff;s.diff=this.oDiff?this.oDiff.aDiff:[]}this.oDiff=undefined;return s};m.prototype.getCurrentContexts=function(){var e,t=Math.min(this.iCurrentEnd,this.iMaxLength)-this.iCurrentBegin;if(this.iCurrentBegin===-1){e=this.aContexts.slice(0,this.iCurrentBegin+t);e.unshift(this.aContexts[-1])}else{e=this.aContexts.slice(this.iCurrentBegin,this.iCurrentBegin+t)}while(e.length<t){e.push(undefined)}return e};m.prototype.getDependentBindings=function(){var e=this;return this.oModel.getDependentBindings(this).filter(function(t){return!(t.oContext.getPath()in e.mPreviousContextsByPath)})};m.prototype.getDiff=function(e,t){var i,n,o=this;n=e.map(function(e,i){return o.bDetectUpdates?JSON.stringify(e):o.aContexts[t+i].getPath()});i=x.sap.arraySymbolDiff(this.aPreviousData,n);this.aPreviousData=n;return i};m.prototype.getDistinctValues=function(){throw new Error("Unsupported operation: v4.ODataListBinding#getDistinctValues")};m.prototype.getFilterInfo=function(e){var t=l.combineFilters(this.aFilters,this.aApplicationFilters),i=null,n;if(t){i=t.getAST(e)}if(this.mQueryOptions.$filter){n={expression:this.mQueryOptions.$filter,syntax:"OData "+this.oModel.getODataVersion(),type:"Custom"};if(i){i={left:i,op:"&&",right:n,type:"Logical"}}else{i=n}}return i};m.prototype.getHeaderContext=function(){return this.bRelative&&!this.oContext?null:this.oHeaderContext};m.prototype.getLength=function(){var e;if(this.bLengthFinal){e=this.iMaxLength}else{e=this.aContexts.length?this.aContexts.length+10:0}if(this.aContexts[-1]){e+=1}return e};m.prototype.getOrderby=function(e){var t=[],i=this;this.aSorters.forEach(function(e){if(e instanceof g){t.push(e.sPath+(e.bDescending?" desc":""))}else{throw new Error("Unsupported sorter: "+e+" - "+i)}});if(e){t.push(e)}return t.join(",")};m.prototype.inheritQueryOptions=function(e,t){var i;if(!Object.keys(this.mParameters).length){i=this.getQueryOptionsForPath("",t);if(e.$orderby&&i.$orderby){e.$orderby+=","+i.$orderby}if(e.$filter&&i.$filter){e.$filter="("+e.$filter+") and ("+i.$filter+")"}e=x.extend({},i,e)}return e};m.prototype.isLengthFinal=function(){return this.bLengthFinal};m.prototype.mergeQueryOptions=function(e,t,i){var n;function o(t,i){if(i&&(!e||e[t]!==i)){if(!n){n=e?s.clone(e):{}}n[t]=i}}o("$orderby",t);o("$filter",i);return n||e};m.prototype.refreshInternal=function(e){var t=this.aContexts,i=this;this.createReadGroupLock(e,this.isRefreshable());return this.oCachePromise.then(function(n){if(n){i.removeCachesAndMessages();i.fetchCache(i.oContext)}i.reset(d.Refresh);t.forEach(function(t){i.oModel.getDependentBindings(t).forEach(function(t){t.refreshInternal(e,false)})})})};m.prototype.refreshSingle=function(e,t,i){var n=this;return this.oCachePromise.then(function(o){var r=false,s=[];function a(e){if(r){n.fireDataReceived(e)}}function u(){r=true;n.fireDataRequested()}function f(e){var t=n.aContexts[e],i;if(e===-1){delete n.aContexts[-1]}else{n.aContexts.splice(e,1);for(i=e;i<n.aContexts.length;i+=1){if(n.aContexts[i]){n.aContexts[i].setIndex(i)}}}t.destroy();n.iMaxLength-=1;n._fireChange({reason:d.Remove})}t.setGroupId(n.getGroupId());s.push((i?o.refreshSingleWithRemove(t,e.iIndex,u,f):o.refreshSingle(t,e.iIndex,u)).then(function(o){var r=[];a({data:{}});if(e.oBinding){r.push(e.checkUpdate());if(i){r.push(n.refreshDependentBindings(t.getGroupId(),false))}}return h.all(r).then(function(){return o})},function(e){a({error:e});throw e}).catch(function(i){t.unlock(true);n.oModel.reportError("Failed to refresh entity: "+e,y,i)}));if(!i){s.push(n.refreshDependentBindings(t.getGroupId(),false))}return h.all(s).then(function(e){return e[0]})})};m.prototype.requestSideEffects=function(e,t,i){return this.refreshInternal(e)};m.prototype.reset=function(e){var t=this.iCurrentEnd===0,i=this;if(this.aContexts){this.aContexts.forEach(function(e){i.mPreviousContextsByPath[e.getPath()]=e});if(this.aContexts[-1]){this.aContexts[-1].destroy()}}this.aContexts=[];this.iCurrentBegin=this.iCurrentEnd=0;this.iMaxLength=Infinity;this.bLengthFinal=false;if(e&&!(t&&e===d.Change)){this.sChangeReason=e;this._fireRefresh({reason:e})}if(this.getHeaderContext()){this.oModel.getDependentBindings(this.oHeaderContext).forEach(function(e){e.checkUpdate()})}};m.prototype.resumeInternal=function(){var e=this.getDependentBindings();this.reset();this.fetchCache(this.oContext);e.forEach(function(e){e.resumeInternal(false)});this._fireChange({reason:d.Change})};m.prototype.setAggregation=function(e){this.checkSuspended();if(this.hasPendingChanges()){throw new Error("Cannot set $$aggregation due to pending changes")}if(!this.oAggregation&&"$apply"in this.mQueryOptions){throw new Error("Cannot override existing $apply : '"+this.mQueryOptions.$apply+"'")}e=s.clone(e);this.mQueryOptions.$apply=n.buildApply(e).$apply;this.oAggregation=e;this.removeCachesAndMessages();this.fetchCache(this.oContext);this.reset(d.Change)};m.prototype.setContext=function(t){var i;if(this.oContext!==t){if(this.bRelative){if(this.aContexts[-1]&&this.aContexts[-1].isTransient()){throw new Error("setContext on relative binding is forbidden if a transient "+"entity exists: "+this)}this.reset();this.fetchCache(t);if(t){i=this.oModel.resolve(this.sPath,t);if(this.oHeaderContext&&this.oHeaderContext.getPath()!==i){this.oHeaderContext.destroy();this.oHeaderContext=null}if(!this.oHeaderContext){this.oHeaderContext=e.create(this.oModel,this,i)}}u.prototype.setContext.call(this,t)}else{this.oContext=t}}};m.prototype.sort=function(e){this.checkSuspended();if(this.sOperationMode!==C.Server){throw new Error("Operation mode has to be sap.ui.model.odata.OperationMode.Server")}if(this.hasPendingChanges()){throw new Error("Cannot sort due to pending changes")}this.aSorters=s.toArray(e);this.removeCachesAndMessages();this.createReadGroupLock(this.getGroupId(),true);this.fetchCache(this.oContext);this.reset(d.Sort);return this};m.prototype.updateAnalyticalInfo=function(e){var t={aggregate:{},group:{}},i=false;e.forEach(function(e){var n={};if("total"in e){if("grouped"in e){throw new Error("Both dimension and measure: "+e.name)}if(e.as){n.name=e.name;t.aggregate[e.as]=n}else{t.aggregate[e.name]=n}if(e.min){n.min=true;i=true}if(e.max){n.max=true;i=true}if(e.with){n.with=e.with}}else if(!("grouped"in e)||e.inResult||e.visible){t.group[e.name]=n}});this.oAggregation=t;this.changeParameters(n.buildApply(t));this.bHasAnalyticalInfo=true;if(i){return{measureRangePromise:Promise.resolve(this.oCachePromise.then(function(e){return e.getMeasureRangePromise()}))}}};return m});