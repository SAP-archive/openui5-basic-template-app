/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","sap/base/strings/escapeRegExp"],function(e,n){"use strict";var t={POST:true,PUT:true,PATCH:true,DELETE:true},r,i=/^\$\d+/,o=/(\S*?)=(?:"(.+)"|(\S+))/;function a(e){var t=s(e,"boundary"),r=e.trim().indexOf("multipart/mixed");if(r!==0||!t){throw new Error('Invalid $batch response header "Content-Type": '+e)}t=n(t);return new RegExp("--"+t+"(?:[ \t]*\r\n|--)")}function s(e,n){var t,r=e.split(";"),i;n=n.toLowerCase();for(t=1;t<r.length;t+=1){i=o.exec(r[t]);if(i[1].toLowerCase()===n){return i[2]||i[3]}}}function c(e){var n=f(e,"content-type");return n.startsWith("multipart/mixed;")?n:undefined}function u(e){var n=f(e,"content-id"),t;if(!n){throw new Error("Content-ID MIME header missing for the change set response.")}t=parseInt(n);if(isNaN(t)){throw new Error("Invalid Content-ID value in change set response.")}return t}function f(e,n){var t,r,i=e.split("\r\n");for(t=0;t<i.length;t+=1){r=i[t].split(":");if(r[0].toLowerCase().trim()===n){return r[1].trim()}}}function d(e,n,t){var r=n.split(a(e)),i=[];r=r.slice(1,-1);r.forEach(function(e){var n,r,o,a,f,h,p,l,y,m,C,T,E,w={},v;E=e.indexOf("\r\n\r\n");T=e.slice(0,E);y=e.indexOf("\r\n\r\n",E+4);l=e.slice(E+4,y);n=c(T);if(n){i.push(d(n,e.slice(E+4),true));return}p=l.split("\r\n");m=p[0].split(" ");w.status=parseInt(m[1]);w.statusText=m.slice(2).join(" ");w.headers={};for(C=1;C<p.length;C+=1){a=p[C];o=a.indexOf(":");f=a.slice(0,o).trim();h=a.slice(o+1).trim();w.headers[f]=h;if(f.toLowerCase()==="content-type"){r=s(h,"charset");if(r&&r.toLowerCase()!=="utf-8"){throw new Error('Unsupported "Content-Type" charset: '+r)}}}w.responseText=e.slice(y+4,-2);if(t){v=u(T);i[v]=w}else{i.push(w)}});return i}function h(e){var n,t=[];for(n in e){t=t.concat(n,":",e[n],"\r\n")}return t}function p(n,r){var o=(r!==undefined?"changeset_":"batch_")+e.uid(),a=r!==undefined,s=[];if(a){s=s.concat("Content-Type: multipart/mixed;boundary=",o,"\r\n\r\n")}n.forEach(function(n,c){var u="",f=n.url;if(a){n.$ContentID=c+"."+r;u="Content-ID:"+n.$ContentID+"\r\n"}s=s.concat("--",o,"\r\n");if(Array.isArray(n)){if(a){throw new Error("Change set must not contain a nested change set.")}s=s.concat(p(n,c).body)}else{if(a&&!t[n.method]){throw new Error("Invalid HTTP request method: "+n.method+". Change set must contain only POST, PUT, PATCH or DELETE requests.")}if(r!==undefined&&f[0]==="$"){f=f.replace(i,"$&."+r)}s=s.concat("Content-Type:application/http\r\n","Content-Transfer-Encoding:binary\r\n",u,"\r\n",n.method," ",f," HTTP/1.1\r\n",h(e.resolveIfMatchHeader(n.headers)),"\r\n",JSON.stringify(n.body)||"","\r\n")}});s=s.concat("--",o,"--\r\n");return{body:s,batchBoundary:o}}r={deserializeBatchResponse:function(e,n){return d(e,n,false)},serializeBatchRequest:function(e){var n=p(e);return{body:n.body.join(""),headers:{"Content-Type":"multipart/mixed; boundary="+n.batchBoundary,"MIME-Version":"1.0"}}}};return r},false);