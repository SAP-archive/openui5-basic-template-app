/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_GroupLock","./_Helper","./_Parser","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,n,i,r,o,s){"use strict";var a=/,|%2C|%2c/,l=new RegExp("^"+r.sODataIdentifier+"(?:"+r.sWhitespace+"+(?:asc|desc))?$"),u=new RegExp(r.sWhitespace+"+");function c(n,i,r,o){var s={},a,l;t.call(this,n,i,o,true);this.oAggregation=r;if("$expand"in o){throw new Error("Unsupported system query option: $expand")}if("$select"in o){throw new Error("Unsupported system query option: $select")}if(e.hasMinOrMax(r.aggregate)){if(r.groupLevels.length){throw new Error("Unsupported group levels together with min/max")}this.oMeasureRangePromise=new Promise(function(e,t){l=e});a=e.buildApply(r,o,s);this.oFirstLevel=t.create(n,i,a,true);this.oFirstLevel.getResourcePathWithQuery=c.getResourcePathWithQuery.bind(this.oFirstLevel,r,o);this.oFirstLevel.handleResponse=c.handleResponse.bind(this.oFirstLevel,null,s,l,this.oFirstLevel.handleResponse)}else if(r.groupLevels.length){this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;if(o.$count){throw new Error("Unsupported system query option: $count")}if(o.$filter){throw new Error("Unsupported system query option: $filter")}this.oFirstLevel=this.createGroupLevelCache()}else{this.oFirstLevel=t.create(n,i,o,true);this.oFirstLevel.getResourcePathWithQuery=c.getResourcePathWithQuery.bind(this.oFirstLevel,r,o);this.oFirstLevel.handleResponse=c.handleResponse.bind(this.oFirstLevel,r,null,null,this.oFirstLevel.handleResponse)}}c.prototype=Object.create(t.prototype);c.prototype.addElements=function(e,t,n,r){var o=this.aElements;if(t<0){throw new Error("Illegal offset: "+t)}e.forEach(function(e,s){var a=o[t+s],l,u=i.getPrivateAnnotation(e,"predicate");if(a){if(a===e){return}l=i.getPrivateAnnotation(a,"parent");if(!l){throw new Error("Unexpected element")}if(l!==n||i.getPrivateAnnotation(a,"index")!==r+s){throw new Error("Wrong placeholder")}}else if(t+s>=o.length){throw new Error("Array index out of bounds: "+(t+s))}o[t+s]=e;o.$byPredicate[u]=e})};c.prototype.collapse=function(e){var t=0,r=this.aElements,o=this.fetchValue(n.$cached,e).getResult(),s=o["@$ui5.node.level"],a=r.indexOf(o),l=a+1;i.updateAll(this.mChangeListeners,e,o,{"@$ui5.node.isExpanded":false});while(l<r.length&&r[l]["@$ui5.node.level"]>s){delete r.$byPredicate[i.getPrivateAnnotation(r[l],"predicate")];t+=1;l+=1}i.setPrivateAnnotation(o,"spliced",r.splice(a+1,t));r.$count-=t;return t};c.prototype.createGroupLevelCache=function(n){var r,o,s,a,l,u,h,d,g;u=n?n["@$ui5.node.level"]+1:1;o=c.filterAggregation(this.oAggregation,u);a=o.$groupBy;delete o.$groupBy;h=o.$missing;delete o.$missing;d=Object.assign({},this.mQueryOptions);s=c.filterOrderby(this.mQueryOptions.$orderby,o);if(s){d.$orderby=s}else{delete d.$orderby}if(n){d.$$filterBeforeAggregate=i.getPrivateAnnotation(n,"filter")}delete d.$count;d=e.buildApply(o,d);d.$count=true;r=t.create(this.oRequestor,this.sResourcePath,d,true);l=!o.groupLevels.length;g=!l&&Object.keys(o.aggregate).length>0;r.calculateKeyPredicate=c.calculateKeyPredicate.bind(null,n,a,h,l,g,this.aElements.$byPredicate);return r};c.prototype.expand=function(t,r){var o,a,l=typeof r==="string"?this.fetchValue(n.$cached,r).getResult():r,u=i.getPrivateAnnotation(l,"spliced"),c=this;if(r!==l){i.updateAll(this.mChangeListeners,r,l,{"@$ui5.node.isExpanded":true})}if(u){i.deletePrivateAnnotation(l,"spliced");this.aElements.splice.apply(this.aElements,[this.aElements.indexOf(l)+1,0].concat(u));a=u.length;this.aElements.$count+=a;u.forEach(function(e){var t=i.getPrivateAnnotation(e,"predicate");if(t){c.aElements.$byPredicate[t]=e;if(i.getPrivateAnnotation(e,"expanding")){i.deletePrivateAnnotation(e,"expanding");a+=c.expand(n.$cached,e).getResult()}}});return s.resolve(a)}o=i.getPrivateAnnotation(l,"cache");if(!o){o=this.createGroupLevelCache(l);i.setPrivateAnnotation(l,"cache",o)}return o.read(0,this.iReadLength,0,t).then(function(t){var n=c.aElements.indexOf(l)+1,r;if(!l["@$ui5.node.isExpanded"]){i.deletePrivateAnnotation(l,"spliced");return 0}if(!n){i.setPrivateAnnotation(l,"expanding",true);return 0}a=t.value.$count;if(n===c.aElements.length){c.aElements.length+=a}else{for(r=c.aElements.length-1;r>=n;r-=1){c.aElements[r+a]=c.aElements[r];delete c.aElements[r]}}c.addElements(t.value,n,o,0);c.aElements.$count+=a;for(r=n+t.value.length;r<n+a;r+=1){c.aElements[r]=e.createPlaceholder(l["@$ui5.node.level"]+1,r-n,o)}return a},function(e){i.updateAll(c.mChangeListeners,r,l,{"@$ui5.node.isExpanded":false});throw e})};c.prototype.fetchValue=function(e,t,n,i){var r=this;if(t==="$count"){if(!this.mQueryOptions.$count){o.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return s.resolve()}if(!this.oMeasureRangePromise){return this.oFirstLevel.fetchValue(e,t).then(function(){return r.oFirstLevel.iLeafCount})}}if(this.oAggregation.groupLevels.length){this.registerChange(t,i);return this.drillDown(this.aElements,t,e)}return this.oFirstLevel.fetchValue(e,t,n,i)};c.prototype.getMeasureRangePromise=function(){return this.oMeasureRangePromise};c.prototype.read=function(t,n,r,o,a){var l,u,c,h,d,g=this.oAggregation.groupLevels.length,f=[],p=this;function v(e,t){var n=h,r=i.getPrivateAnnotation(p.aElements[e],"index"),s=p.aElements[e];f.push(h.read(r,t-e,0,o.getUnlockedCopy(),a).then(function(t){var i;if(s!==p.aElements[e]&&t.value[0]!==p.aElements[e]){e=p.aElements.indexOf(s);if(e<0){e=p.aElements.indexOf(t.value[0]);if(e<0){i=new Error("Collapse before read has finished");i.canceled=true;throw i}}}p.addElements(t.value,e,n,r)}))}if(g&&this.aElements.length){for(l=t,u=Math.min(t+n,this.aElements.length);l<u;l+=1){c=i.getPrivateAnnotation(this.aElements[l],"parent");if(c!==h){if(d){v(d,l);h=d=undefined}if(c){d=l;h=c}}}if(d){v(d,l)}o.unlock();return s.all(f).then(function(){var e=p.aElements.slice(t,t+n);e.$count=p.aElements.$count;return{value:e}})}return this.oFirstLevel.read(t,n,r,o,a).then(function(i){var o;if(g){p.aElements.length=p.aElements.$count=i.value.$count;p.addElements(i.value,t,p.oFirstLevel,t);for(o=0;o<p.aElements.$count;o+=1){if(!p.aElements[o]){p.aElements[o]=e.createPlaceholder(0,o,p.oFirstLevel)}}p.iReadLength=n+r}else if(!p.oMeasureRangePromise){i.value.forEach(function(e){if(!("@$ui5.node.level"in e)){e["@$ui5.node.isExpanded"]=undefined;e["@$ui5.node.isTotal"]=false;e["@$ui5.node.level"]=1}})}return i})};c.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,e.buildApply(this.oAggregation,this.mQueryOptions),false,true)};c.calculateKeyPredicate=function(e,t,n,r,o,s,a,l,u){var c;function h(e){return JSON.stringify(i.publicClone(e))}t.forEach(function(t){if(!(t in a)){a[t]=e[t]}});n.forEach(function(e){a[e]=null});c=i.getKeyPredicate(a,u,l,t,true);if(c in s){throw new Error("Multi-unit situation detected: "+h(a)+" vs. "+h(s[c]))}i.setPrivateAnnotation(a,"predicate",c);if(!r){i.setPrivateAnnotation(a,"filter",i.getKeyFilter(a,u,l,t))}if(a["@$ui5.node.level"]!==0){a["@$ui5.node.isExpanded"]=r?undefined:false;a["@$ui5.node.isTotal"]=o;a["@$ui5.node.level"]=e?e["@$ui5.node.level"]+1:1}};c.create=function(e,t,n,i){return new c(e,t,n,i)};c.filterAggregation=function(e,t){var n,i,r;function o(e,t){e[t]=this[t];return e}function s(e,t){return t.reduce(o.bind(e),{})}function a(e,t){return Object.keys(e).filter(t)}function l(t){return!e.aggregate[t].subtotals}function u(t){return e.aggregate[t].subtotals}function c(t){return e.groupLevels.indexOf(t)<0}i=e.groupLevels.slice(t-1,t);n={aggregate:i.length?s(e.aggregate,a(e.aggregate,u)):e.aggregate,groupLevels:i,$groupBy:e.groupLevels.slice(0,t)};r=a(e.group,c).sort();if(i.length){n.group={};n.$missing=e.groupLevels.slice(t).concat(r).concat(Object.keys(e.aggregate).filter(l))}else{n.group=s(e.group,r);n.$groupBy=n.$groupBy.concat(r);n.$missing=[]}return n};c.filterOrderby=function(e,t){if(e){return e.split(a).filter(function(e){var n;if(l.test(e)){n=e.split(u)[0];return n in t.aggregate||n in t.group||t.groupLevels.indexOf(n)>=0}return true}).join(",")}};c.getResourcePathWithQuery=function(t,n,i,r){n=Object.assign({},n,{$skip:i,$top:r-i});n=e.buildApply(t,n,null,this.bFollowUp);this.bFollowUp=true;return this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,n,false,true)};c.handleResponse=function(e,t,n,i,r,o,s,a){var l,u={},c;function h(e){u[e]=u[e]||{};return u[e]}if(t){c=s.value.shift();s["@odata.count"]=c.UI5__count;for(l in t){h(t[l].measure)[t[l].method]=c[l]}n(u);this.handleResponse=i}else{c=s.value[0];if("UI5__count"in c){this.iLeafCount=parseInt(c.UI5__count);s["@odata.count"]=this.iLeafCount+1;if(r>0){s.value.shift()}}if(r===0){c["@$ui5.node.isExpanded"]=true;c["@$ui5.node.isTotal"]=true;c["@$ui5.node.level"]=0;Object.keys(c).forEach(function(e){if(e.startsWith("UI5grand__")){c[e.slice(10)]=c[e]}});Object.keys(e.aggregate).forEach(function(e){c[e]=c[e]||null});Object.keys(e.group).forEach(function(e){c[e]=null})}}i.call(this,r,o,s,a)};return c},false);