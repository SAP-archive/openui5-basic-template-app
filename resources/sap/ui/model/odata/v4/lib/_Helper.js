/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/uid","sap/ui/base/SyncPromise","sap/ui/thirdparty/URI"],function(e,t,n,r,i,a,u){"use strict";var o=/&/g,f="sap.ui.model.odata.v4.lib._Helper",s=/\=/g,c=/%29/g,l=/%28/g,d=/%27/g,p=/#/g,h,g=/\([^/]*|\/-?\d+/g,y=/\+/g,m=/'/g;h={addByPath:function(e,t,n){if(n){if(!e[t]){e[t]=[n]}else if(e[t].indexOf(n)<0){e[t].push(n)}}},addChildrenWithAncestor:function(e,t,n){if(t.length){e.forEach(function(e){var r;if(t.indexOf(e)>=0){n[e]=true;return}r=e.split("/");r.pop();while(r.length){if(t.indexOf(r.join("/"))>=0){n[e]=true;break}r.pop()}})}},addToSelect:function(e,t){e.$select=e.$select||[];t.forEach(function(t){if(e.$select.indexOf(t)<0){e.$select.push(t)}})},aggregateQueryOptions:function(e,t){if(t.$select){h.addToSelect(e,t.$select)}if(t.$expand){e.$expand=e.$expand||{};Object.keys(t.$expand).forEach(function(n){if(e.$expand[n]){h.aggregateQueryOptions(e.$expand[n],t.$expand[n])}else{e.$expand[n]=t.$expand[n]}})}},buildPath:function(){var e,t="",n;for(e=0;e<arguments.length;e+=1){n=arguments[e];if(n||n===0){if(t&&t!=="/"&&n[0]!=="("){t+="/"}t+=n}}return t},buildQuery:function(e){var t,n;if(!e){return""}t=Object.keys(e);if(t.length===0){return""}n=[];t.forEach(function(t){var r=e[t];if(Array.isArray(r)){r.forEach(function(e){n.push(h.encodePair(t,e))})}else{n.push(h.encodePair(t,r))}});return"?"+n.join("&")},clone:function e(t,n){return t===undefined||t===Infinity||t===-Infinity||t!==t?t:JSON.parse(JSON.stringify(t,n))},createError:function(t,n,r,i){var a=t.responseText,u=t.getResponseHeader("Content-Type"),o=new Error(n+": "+t.status+" "+t.statusText);o.status=t.status;o.statusText=t.statusText;o.requestUrl=r;o.resourcePath=i;if(t.status===0){o.message="Network error";return o}if(u){u=u.split(";")[0]}if(t.status===412){o.isConcurrentModification=true}if(u==="application/json"){try{o.error=JSON.parse(a).error;o.message=o.error.message;if(typeof o.message==="object"){o.message=o.error.message.value}}catch(t){e.warning(t.toString(),a,f)}}else if(u==="text/plain"){o.message=a}return o},createGetMethod:function(e,t){return function(){var n=this[e].apply(this,arguments);if(n.isFulfilled()){return n.getResult()}else if(t){if(n.isRejected()){n.caught();throw n.getResult()}else{throw new Error("Result pending")}}}},createRequestMethod:function(e){return function(){return Promise.resolve(this[e].apply(this,arguments))}},createTechnicalDetails:function(e){var t,n=e["@$ui5.error"],r=e["@$ui5.originalMessage"]||e,i={};if(n&&(n.status||n.cause)){n=n.cause||n;i.httpStatus=n.status;if(n.isConcurrentModification){i.isConcurrentModification=true}}if(!(r instanceof Error)){Object.defineProperty(i,"originalMessage",{enumerable:true,get:function(){if(!t){t=h.publicClone(r)}return t}})}return i},decomposeError:function(e,t){var n=e.error.details&&e.error.details.map(function(e){return h.getContentID(e)}),r=h.getContentID(e.error);return t.map(function(t,i){var a=new Error(e.message);function u(e,n){if(i===0&&!n){if(e.target){e.message=e.target+": "+e.message}delete e.target;return true}return n===t.$ContentID}a.error=h.clone(e.error);a.requestUrl=t.url;a.resourcePath=t.$resourcePath;a.status=e.status;a.statusText=e.statusText;if(!u(a.error,r)){a.error.$ignoreTopLevel=true}if(a.error.details){a.error.details=a.error.details.filter(function(e,t){return u(e,n[t])})}return a})},deepEqual:t,deletePrivateAnnotation:function(e,t){var n=e["@$ui5._"];if(n){delete n[t]}},drillDown:function(e,t){return t.reduce(function(e,t){return e&&t in e?e[t]:undefined},e)},encode:function(e,t){var n=encodeURI(e).replace(o,"%26").replace(p,"%23").replace(y,"%2B");if(t){n=n.replace(s,"%3D")}return n},encodePair:function(e,t){return h.encode(e,true)+"="+h.encode(t,false)},extractMergeableQueryOptions:function(e){var t={};if("$expand"in e){t.$expand=e.$expand;e.$expand="~"}if("$select"in e){t.$select=e.$select;e.$select="~"}return t},fetchPropertyAndType:function(e,t){return e(t).then(function(n){if(n&&n.$kind==="NavigationProperty"){return e(t+"/").then(function(){return n})}return n})},fireChange:function(e,t,n){var r=e[t],i;if(r){for(i=0;i<r.length;i+=1){r[i].onChange(n)}}},fireChanges:function(e,t,n,r){Object.keys(n).forEach(function(i){var a=h.buildPath(t,i),u=n[i];if(u&&typeof u==="object"){h.fireChanges(e,a,u,r)}else{h.fireChange(e,a,r?undefined:u)}});h.fireChange(e,t,r?undefined:n)},formatLiteral:function(e,t){if(e===undefined){throw new Error("Illegal value: undefined")}if(e===null){return"null"}switch(t){case"Edm.Binary":return"binary'"+e+"'";case"Edm.Boolean":case"Edm.Byte":case"Edm.Double":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":case"Edm.Single":return String(e);case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Duration":return"duration'"+e+"'";case"Edm.String":return"'"+e.replace(m,"''")+"'";default:throw new Error("Unsupported type: "+t)}},getContentID:function(t){var n,r,i;Object.keys(t).forEach(function(a){if(a[0]==="@"&&a.endsWith(".ContentID")){if(n){e.warning("Cannot distinguish "+r+" from "+a,undefined,f);i=true}n=t[a];r=a}});return i?undefined:n},getKeyFilter:function(e,t,n,r){var i=[],a,u=h.getKeyProperties(e,t,n,r);if(!u){return undefined}for(a in u){i.push(a+" eq "+u[a])}return i.join(" and ")},getKeyPredicate:function(e,t,n,r,i){var a=h.getKeyProperties(e,t,n,r,true);if(!a){return undefined}r=Object.keys(a).map(function(e,t,n){var r=encodeURIComponent(a[e]);return i||n.length>1?encodeURIComponent(e)+"="+r:r});return"("+r.join(",")+")"},getKeyProperties:function(e,t,n,r,i){var a,u={};r=r||n[t].$Key;a=r.some(function(r){var a,o,f,s,c,l;if(typeof r==="string"){a=o=r}else{a=Object.keys(r)[0];o=r[a];if(!i){a=o}}f=o.split("/");l=h.drillDown(e,f);if(l===undefined){return true}s=f.pop();c=n[h.buildPath(t,f.join("/"))];l=h.formatLiteral(l,c[s].$Type);u[a]=l});return a?undefined:u},getMetaPath:function(e){if(e[0]==="/"){return e.replace(g,"")}if(e[0]!=="("){e="/"+e}return e.replace(g,"").slice(1)},getPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n&&n[t]},getQueryOptionsForPath:function(e,t){t=h.getMetaPath(t);if(t){t.split("/").some(function(t){e=e&&e.$expand&&e.$expand[t];if(!e||e===true){e={};return true}})}return e||{}},getRelativePath:function(e,t){if(!e.startsWith(t)){return undefined}e=e.slice(t.length);if(e){if(e[0]==="/"){return e.slice(1)}if(e[0]!=="("){return undefined}}return e},hasPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n?t in n:false},informAll:function(e,t,n,r){if(r===n){return}if(r&&typeof r==="object"){Object.keys(r).forEach(function(i){h.informAll(e,h.buildPath(t,i),n&&n[i],r[i])})}else{h.fireChange(e,t,r===undefined?null:r);r={}}if(n&&typeof n==="object"){Object.keys(n).forEach(function(i){if(!r.hasOwnProperty(i)){h.informAll(e,h.buildPath(t,i),n[i],undefined)}})}},intersectQueryOptions:function(e,t,r,i,a,u,o){var f=[],s={},c,l,d,p={};function g(e,t){var n=t.split("/");return n.every(function(t,a){return a===0&&e||r(i+"/"+n.slice(0,a+1).join("/")).getResult().$kind==="Property"})}if(t.indexOf("")>=0){throw new Error("Unsupported empty navigation property path")}if(t.indexOf("*")>=0){d=e&&e.$select||[]}else if(e&&e.$select&&e.$select.indexOf("*")<0){h.addChildrenWithAncestor(t,e.$select,p);h.addChildrenWithAncestor(e.$select,t,p);d=Object.keys(p).filter(g.bind(null,true))}else{d=t.filter(g.bind(null,false))}if(e&&e.$expand){f=Object.keys(e.$expand);f.forEach(function(o){var f,c=i+"/"+o,l=h.buildPath(u,o),d={},p;h.addChildrenWithAncestor([o],t,d);if(!n(d)){if(r(c).getResult().$isCollection){a[l]=true}s[o]=e.$expand[o];return}p=h.stripPathPrefix(o,t);if(p.length){if(r(c).getResult().$isCollection){throw new Error("Unsupported collection-valued navigation property "+c)}f=h.intersectQueryOptions(e.$expand[o]||{},p,r,c,a,l);if(f){s[o]=f}}})}if(!d.length&&n(s)){return null}c=Object.assign({},e,{$select:d});l=r(i).getResult();if(l.$kind==="NavigationProperty"&&!l.$isCollection){h.selectKeyProperties(c,r(i+"/").getResult())}else if(!d.length&&!o){c.$select=Object.keys(s).slice(0,1)}if(n(s)){delete c.$expand}else{c.$expand=s}return c},hasPathPrefix:function(e,t){return h.getRelativePath(e,t)!==undefined},isSafeInteger:function(e){if(typeof e!=="number"||!isFinite(e)){return false}e=Math.abs(e);return e<=9007199254740991&&Math.floor(e)===e},makeAbsolute:function(e,t){return new u(e).absoluteTo(t).toString().replace(d,"'").replace(l,"(").replace(c,")")},merge:r,mergeQueryOptions:function(e,t,n){var r;function i(t,n){if(n&&(!e||e[t]!==n)){if(!r){r=e?h.clone(e):{}}r[t]=n}}i("$orderby",t);if(n){i("$filter",n[0]);i("$$filterBeforeAggregate",n[1])}return r||e},namespace:function(e){var t;e=e.split("/")[0].split("(")[0];t=e.lastIndexOf(".");return t<0?"":e.slice(0,t)},parseLiteral:function(e,t,n){function r(r){if(!isFinite(r)){throw new Error(n+": Not a valid "+t+" literal: "+e)}return r}if(e==="null"){return null}switch(t){case"Edm.Boolean":return e==="true";case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":return r(parseInt(e));case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Double":case"Edm.Single":return e==="INF"||e==="-INF"||e==="NaN"?e:r(parseFloat(e));default:throw new Error(n+": Unsupported type: "+t)}},publicClone:function(e){return h.clone(e,function(e,t){if(e!=="@$ui5._"){return t}})},removeByPath:function(e,t,n){var r=e[t],i;if(r){i=r.indexOf(n);if(i>=0){if(r.length===1){delete e[t]}else{r.splice(i,1)}}}},resolveIfMatchHeader:function(e){var t=e&&e["If-Match"];if(t&&typeof t==="object"){t=t["@odata.etag"];e=Object.assign({},e);if(t===undefined){delete e["If-Match"]}else{e["If-Match"]=t}}return e},selectKeyProperties:function(e,t){if(t&&t.$Key){h.addToSelect(e,t.$Key.map(function(e){if(typeof e==="object"){return e[Object.keys(e)[0]]}return e}))}},setPrivateAnnotation:function(e,t,n){var r=e["@$ui5._"];if(!r){r=e["@$ui5._"]={}}r[t]=n},stripPathPrefix:function(e,t){var n=e+"/";if(e===""){return t}return t.filter(function(t){return t===e||t.startsWith(n)}).map(function(e){return e.slice(n.length)})},toArray:function(e){if(e===undefined||e===null){return[]}if(Array.isArray(e)){return e}return[e]},uid:i,updateAll:function(e,t,n,r,i){Object.keys(r).forEach(function(a){var u=h.buildPath(t,a),o,f=r[a],s,c=n[a];if(a==="@$ui5._"){o=h.getPrivateAnnotation(r,"predicate");if(i&&i(t)){s=h.getPrivateAnnotation(n,"predicate");if(o!==s){throw new Error("Key predicate of '"+t+"' changed from "+s+" to "+o)}}else{h.setPrivateAnnotation(n,"predicate",o)}}else if(Array.isArray(f)){n[a]=f}else if(f&&typeof f==="object"){n[a]=h.updateAll(e,u,c||{},f,i)}else if(c!==f){n[a]=f;if(c&&typeof c==="object"){h.fireChanges(e,u,c,true)}else{h.fireChange(e,u,f)}}});return n},updateExisting:function(e,t,n,r){if(!r){return}Object.keys(n).forEach(function(i){var a=h.buildPath(t,i),u=n[i],o=r[i];if(i in r||i[0]==="#"){if(Array.isArray(o)){n[i]=o}else if(o&&typeof o==="object"){if(u){h.updateExisting(e,a,u,o)}else{n[i]=o;h.fireChanges(e,a,o,false)}}else if(u!==o){n[i]=o;if(u&&typeof u==="object"){h.fireChanges(e,a,u,true)}else{h.fireChange(e,a,o)}}}});Object.keys(r).filter(function(e){return e[0]==="#"}).filter(function(e){return!(e in n)}).forEach(function(i){var a=r[i],u=h.buildPath(t,i);n[i]=a;h.fireChanges(e,u,a,false)})},updateSelected:function(e,t,n,r,i){var a;function u(n,r,i){var a=n.split("/");a.every(function(u,o){var f=r[u],s=i[u];if(Array.isArray(f)){i[u]=f}else if(f&&typeof f==="object"){i=i[u]=s||{};r=f;return true}else if(s!==f){i[u]=f;if(s&&typeof s==="object"){h.fireChanges(e,h.buildPath(t,a.slice(0,o+1).join("/")),s,true)}else if(o===a.length-1){h.fireChange(e,h.buildPath(t,n),f)}}return false})}if(!i||i.indexOf("*")>=0){h.updateAll(e,t,n,r);return}i=i.concat("@odata.etag");i.forEach(function(e){u(e,r,n)});a=h.getPrivateAnnotation(r,"predicate");if(a){h.setPrivateAnnotation(n,"predicate",a)}},updateTransientPaths:function(e,t,n){var r;for(r in e){if(r.includes(t)){e[r.replace(t,n)]=e[r];delete e[r]}}},wrapChildQueryOptions:function(t,n,r,i){var a="",u,o=n.split("/"),s,c=t,l={},d=l;if(n===""){return r}for(u=0;u<o.length;u+=1){c=h.buildPath(c,o[u]);a=h.buildPath(a,o[u]);s=i(c).getResult();if(s.$kind==="NavigationProperty"){d.$expand={};d=d.$expand[a]=u===o.length-1?r:{};h.selectKeyProperties(d,i(c+"/").getResult());a=""}else if(s.$kind!=="Property"){return undefined}}if(s.$kind==="Property"){if(Object.keys(r).length>0){e.error("Failed to enhance query options for auto-$expand/$select as the"+" child binding has query options, but its path '"+n+"' points to a structural property",JSON.stringify(r),f);return undefined}h.addToSelect(d,[a])}if("$apply"in r){e.debug("Cannot wrap $apply into $expand: "+n,JSON.stringify(r),f);return undefined}return l}};return h},false);