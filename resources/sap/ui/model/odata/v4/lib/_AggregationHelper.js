/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","./_Parser","sap/ui/model/Filter"],function(e,t,r){"use strict";var n={aggregate:{"*":{grandTotal:"boolean",max:"boolean",min:"boolean",name:"string",subtotals:"boolean",unit:"string",with:"string"}},"grandTotal like 1.84":"boolean",grandTotalAtBottomOnly:"boolean",group:{"*":{additionally:["string"]}},groupLevels:["string"],search:"string",subtotalsAtBottomOnly:"boolean"},i=/,|%2C|%2c/,o=new RegExp("^("+t.sODataIdentifier+"(?:/"+t.sODataIdentifier+")*"+")(?:"+t.sWhitespace+"+(?:asc|desc))?$"),a;function u(e,t,r,n,i,o,a){var u=e.aggregate[i],g=u.name||i,s=u.unit,f=u.with;if(n){if(f==="average"||f==="countdistinct"){throw new Error("Cannot aggregate totals with '"+f+"'")}g=i;i="UI5grand__"+i}if(f){g+=" with "+f+" as "+i}else if(u.name){g+=" as "+i}r.push(g);if(s&&r.indexOf(s)<0&&a.indexOf(s,o+1)<0&&t.indexOf(s)<0){r.push(s)}}function g(e){var t=[];if(e.$skip){t.push("skip("+e.$skip+")")}delete e.$skip;if(e.$top<Infinity){t.push("top("+e.$top+")")}delete e.$top;return t.join("/")}a={buildApply:function(e,t,r,i,o){var s,f="",l=[],c=e["grandTotal like 1.84"],d,p,h,y=[],b,v=[];function $(t,r){var n,i=e.aggregate[t];if(i[r]){n="UI5"+r+"__"+t;y.push(t+" with "+r+" as "+n);if(o){o[n]={measure:t,method:r}}}}t=Object.assign({},t);a.checkTypeof(e,n,"$$aggregation");e.groupLevels=e.groupLevels||[];p=!r||r>e.groupLevels.length;e.group=e.group||{};e.groupLevels.forEach(function(t){e.group[t]=e.group[t]||{}});d=p?Object.keys(e.group).sort().filter(function(t){return e.groupLevels.indexOf(t)<0}):[e.groupLevels[r-1]];if(!r){d=e.groupLevels.concat(d)}e.aggregate=e.aggregate||{};s=Object.keys(e.aggregate).sort();if(r===1&&!i){s.filter(function(t){return e.aggregate[t].grandTotal}).forEach(u.bind(null,e,[],l,c))}if(!i){s.forEach(function(e){$(e,"min");$(e,"max")})}s.filter(function(t){return p||e.aggregate[t].subtotals}).forEach(u.bind(null,e,d,v,false));if(v.length){f="aggregate("+v.join(",")+")"}if(d.length){d.forEach(function(t){var r=e.group[t].additionally;if(r){d.push.apply(d,r)}});f="groupby(("+d.join(",")+(f?"),"+f+")":"))")}if(i){delete t.$count}else if(t.$count){y.push("$count as UI5__count");delete t.$count}if(t.$filter){f+="/filter("+t.$filter+")";delete t.$filter}if(t.$orderby){f+="/orderby("+t.$orderby+")";delete t.$orderby}b=g(t);if(c&&l.length){if(e.groupLevels.length){throw new Error("Cannot combine visual grouping with grand total")}f+="/concat(aggregate("+l.join(",")+"),aggregate("+y.join(",")+"),"+(b||"identity")+")"}else{if(y.length){f+="/concat(aggregate("+y.join(",")+"),"+(b||"identity")+")"}else if(b){f+="/"+b}if(r===1&&t.$$leaves&&!i){h="groupby(("+Object.keys(e.group).sort().join(",")+"))/aggregate($count as UI5__leaves)"}delete t.$$leaves;if(l.length){f="concat("+(h?h+",":"")+"aggregate("+l.join(",")+"),"+f+")"}else if(h){f="concat("+h+","+f+")"}}if(e.search){f="search("+e.search+")/"+f}if(t.$$filterBeforeAggregate){f="filter("+t.$$filterBeforeAggregate+")/"+f;delete t.$$filterBeforeAggregate}if(f){t.$apply=f}return t},checkTypeof:function(e,t,r){if(Array.isArray(t)){if(!Array.isArray(e)){throw new Error("Not an array value for '"+r+"'")}e.forEach(function(e,n){a.checkTypeof(e,t[0],r+"/"+n)})}else if(typeof t==="object"){var n="*"in t;if(typeof e!=="object"||!e||Array.isArray(e)){throw new Error("Not an object value for '"+r+"'")}Object.keys(e).forEach(function(i){if(!n&&!(i in t)){throw new Error("Unsupported property: '"+r+"/"+i+"'")}a.checkTypeof(e[i],t[n?"*":i],r+"/"+i)})}else if(typeof e!==t){throw new Error("Not a "+t+" value for '"+r+"'")}},createPlaceholder:function(t,r,n){var i={"@$ui5.node.level":t};e.setPrivateAnnotation(i,"index",r);e.setPrivateAnnotation(i,"parent",n);return i},extractSubtotals:function(e,t,r,n){var i=t["@$ui5.node.level"];Object.keys(e.aggregate).forEach(function(o){var a=e.aggregate[o],u,g=a.unit;if(!a.subtotals){return}r[o]=t[o];if(n){n[o]=null}if(g){r[g]=t[g];if(n){u=e.groupLevels.indexOf(g);if(u<0||u>=i){n[g]=null}}}})},filterOrderby:function(e,t,r){var n=a.getFilteredOrderby(e.$orderby,t,r);e=Object.assign({},e);if(n){e.$orderby=n}else{delete e.$orderby}return e},getAllProperties:function(e){var t=Object.keys(e.aggregate),r=Object.keys(e.group),n=t.concat(r);t.forEach(function(t){var r=e.aggregate[t].unit;if(r){n.push(r)}});r.forEach(function(t){var r=e.group[t].additionally;if(r){r.forEach(function(e){n.push(e.includes("/")?e.split("/"):e)})}});return n},getFilteredOrderby:function(e,t,r){var n=!r||r>t.groupLevels.length;function a(e){return Object.keys(t.aggregate).some(function(r){var n=t.aggregate[r];return n.subtotals&&e===n.unit})}function u(e){if(e in t.group&&(!r||t.groupLevels.indexOf(e)<0)){return true}return Object.keys(t.aggregate).some(function(r){return e===t.aggregate[r].unit})||Object.keys(t.group).some(function(n){return(!r||t.groupLevels.indexOf(n)<0)&&g(e,n)})}function g(e,r){return e===r||t.group[r].additionally&&t.group[r].additionally.indexOf(e)>=0}if(e){return e.split(i).filter(function(e){var i=o.exec(e),s;if(i){s=i[1];return s in t.aggregate&&(n||t.aggregate[s].subtotals)||n&&u(s)||!n&&(g(s,t.groupLevels[r-1])||a(s))}return true}).join(",")}},getOrCreateExpandedObject:function(t,r){var n,i=e.getPrivateAnnotation(r,"expanded");if(!i){n={"@$ui5.node.isExpanded":false};e.setPrivateAnnotation(r,"collapsed",n);i={"@$ui5.node.isExpanded":true};e.setPrivateAnnotation(r,"expanded",i);if(t.subtotalsAtBottomOnly!==undefined){a.extractSubtotals(t,r,n,t.subtotalsAtBottomOnly?i:null)}}return i},hasGrandTotal:function(e){return Object.keys(e).some(function(t){return e[t].grandTotal})},hasMinOrMax:function(e){return Object.keys(e).some(function(t){var r=e[t];return r.min||r.max})},isAffected:function(t,r,n){function i(t,r){if(t.endsWith("/*")){t=t.slice(0,-2)}return e.hasPathPrefix(r,t)||e.hasPathPrefix(t,r)}function o(e,t){return t.some(function(t){return t.aFilters?o(e,t.aFilters):i(e,t.sPath)})}return n.some(function(e){var n=i.bind(null,e);return e===""||e==="*"||Object.keys(t.aggregate).some(function(r){var n=t.aggregate[r];return i(e,n.name||r)})||Object.keys(t.group).some(n)||t.groupLevels.some(n)||o(e,r)})},removeUI5grand__:function(e){Object.keys(e).forEach(function(t){if(t.startsWith("UI5grand__")){e[t.slice(10)]=e[t];delete e[t]}})},setAnnotations:function(t,r,n,i,o){t["@$ui5.node.isExpanded"]=r;t["@$ui5.node.isTotal"]=n;t["@$ui5.node.level"]=i;if(o){o.forEach(function(r){if(Array.isArray(r)){e.createMissing(t,r)}else if(!(r in t)){t[r]=null}})}},splitFilter:function(e,t){var n=[],i=[];function o(e){return e.aFilters?e.aFilters.some(o):e.sPath in t.aggregate}function a(e){if(e.aFilters&&e.bAnd){e.aFilters.forEach(a)}else{(o(e)?n:i).push(e)}}function u(e){return e.length>1?new r(e,true):e[0]}if(!t||!t.aggregate){return[e]}a(e);return[u(n),u(i)]}};return a},false);