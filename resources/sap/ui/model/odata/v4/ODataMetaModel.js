/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ValueListType","./lib/_Helper","sap/base/assert","sap/base/Log","sap/base/util/ObjectPath","sap/ui/base/SyncPromise","sap/ui/model/BindingMode","sap/ui/model/ChangeReason","sap/ui/model/ClientListBinding","sap/ui/model/Context","sap/ui/model/ContextBinding","sap/ui/model/MetaModel","sap/ui/model/PropertyBinding","sap/ui/model/odata/OperationMode","sap/ui/model/odata/type/Int64","sap/ui/model/odata/type/Raw","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI"],function(e,t,n,i,o,r,a,s,u,f,c,d,p,l,h,m,y,g){"use strict";var v,M=i.Level.DEBUG,$=/^-?\d+$/,O,C,b="sap.ui.model.odata.v4.ODataMetaModel",w,E=new m,x={messageChange:true},U={"Edm.Boolean":{type:"sap.ui.model.odata.type.Boolean"},"Edm.Byte":{type:"sap.ui.model.odata.type.Byte"},"Edm.Date":{type:"sap.ui.model.odata.type.Date"},"Edm.DateTimeOffset":{constraints:{$Precision:"precision"},type:"sap.ui.model.odata.type.DateTimeOffset"},"Edm.Decimal":{constraints:{"@Org.OData.Validation.V1.Minimum/$Decimal":"minimum","@Org.OData.Validation.V1.Minimum@Org.OData.Validation.V1.Exclusive":"minimumExclusive","@Org.OData.Validation.V1.Maximum/$Decimal":"maximum","@Org.OData.Validation.V1.Maximum@Org.OData.Validation.V1.Exclusive":"maximumExclusive",$Precision:"precision",$Scale:"scale"},type:"sap.ui.model.odata.type.Decimal"},"Edm.Double":{type:"sap.ui.model.odata.type.Double"},"Edm.Guid":{type:"sap.ui.model.odata.type.Guid"},"Edm.Int16":{type:"sap.ui.model.odata.type.Int16"},"Edm.Int32":{type:"sap.ui.model.odata.type.Int32"},"Edm.Int64":{type:"sap.ui.model.odata.type.Int64"},"Edm.SByte":{type:"sap.ui.model.odata.type.SByte"},"Edm.Single":{type:"sap.ui.model.odata.type.Single"},"Edm.Stream":{type:"sap.ui.model.odata.type.Stream"},"Edm.String":{constraints:{"@com.sap.vocabularies.Common.v1.IsDigitSequence":"isDigitSequence",$MaxLength:"maxLength"},type:"sap.ui.model.odata.type.String"},"Edm.TimeOfDay":{constraints:{$Precision:"precision"},type:"sap.ui.model.odata.type.TimeOfDay"}},P={},S="@com.sap.vocabularies.Common.v1.ValueList",L="@com.sap.vocabularies.Common.v1.ValueListMapping",D={},A="@com.sap.vocabularies.Common.v1.ValueListReferences",T="@com.sap.vocabularies.Common.v1.ValueListWithFixedValues",I=i.Level.WARNING;function R(e,t,n,i){var o,r=e.mSchema2MetadataUrl[t];if(!r){r=e.mSchema2MetadataUrl[t]={};r[n]=false}else if(!(n in r)){o=Object.keys(r)[0];if(r[o]){B(e,"A schema cannot span more than one document: "+t+" - expected reference URI "+o+" but instead saw "+n,i)}r[n]=false}}function V(e,t,n,i){var o,a,s,u;function f(e){var o,r;if(!(n in e)){i(I,a," does not contain ",n);return}i(M,"Including ",n," from ",a);for(r in e){if(r[0]!=="$"&&N(r)===n){o=e[r];t[r]=o;k(o,t.$Annotations)}}}if(n in t){return t[n]}u=e.mSchema2MetadataUrl[n];if(u){s=Object.keys(u);if(s.length>1){B(e,"A schema cannot span more than one document: "+"schema is referenced by following URLs: "+s.join(", "),n)}a=s[0];u[a]=true;i(M,"Namespace ",n," found in $Include of ",a);o=e.mMetadataUrl2Promise[a];if(!o){i(M,"Reading ",a);o=e.mMetadataUrl2Promise[a]=r.resolve(e.oRequestor.read(a)).then(e.validate.bind(e,a))}o=o.then(f);if(n in t){return t[n]}t[n]=o;return o}}function j(e,t){if(e===t){return""}if(e.indexOf(t)===0&&e[t.length]==="#"&&e.indexOf("@",t.length)<0){return e.slice(t.length+1)}}function q(e){var t=j(e,L);return t!==undefined?t:j(e,S)}function k(e,t,n){var i;function o(e,t){var i;for(i in t){if(n||!(i in e)){e[i]=t[i]}}}for(i in e.$Annotations){if(!(i in t)){t[i]={}}o(t[i],e.$Annotations[i])}delete e.$Annotations}function B(e,t,n){var i=new Error(n+": "+t);e.oModel.reportError(t,b,i);throw i}function N(e){return e.slice(0,e.lastIndexOf(".")+1)}O=c.extend("sap.ui.model.odata.v4.ODataMetaContextBinding",{constructor:function(e,t,i){n(!i||i.getModel()===e,"oContext must belong to this model");c.call(this,e,t,i)},initialize:function(){var e=this.oModel.createBindingContext(this.sPath,this.oContext);this.bInitial=false;if(e!==this.oElementContext){this.oElementContext=e;this._fireChange()}},setContext:function(e){n(!e||e.getModel()===this.oModel,"oContext must belong to this model");if(e!==this.oContext){this.oContext=e;if(!this.bInitial){this.initialize()}}}});C=u.extend("sap.ui.model.odata.v4.ODataMetaListBinding",{constructor:function(){u.apply(this,arguments)},_fireFilter:function(){},_fireSort:function(){},checkUpdate:function(e){var t=this.oList.length;this.update();if(e||this.oList.length!==t){this._fireChange({reason:s.Change})}},fetchContexts:function(){var e,t=this.oModel.resolve(this.sPath,this.oContext),n=this;if(!t){return r.resolve([])}e=t.slice(-1)==="@";if(!e&&!t.endsWith("/")){t+="/"}return this.oModel.fetchObject(t).then(function(i){if(!i){return[]}if(e){t=t.slice(0,-1)}return Object.keys(i).filter(function(t){return t[0]!=="$"&&e!==(t[0]!=="@")}).map(function(e){return new f(n.oModel,t+e)})})},getContexts:function(e,t){this.iCurrentStart=e||0;this.iCurrentLength=Math.min(t||Infinity,this.iLength-this.iCurrentStart,this.oModel.iSizeLimit);return this.getCurrentContexts()},getCurrentContexts:function(){var e=[],t,n=this.iCurrentStart+this.iCurrentLength;for(t=this.iCurrentStart;t<n;t++){e.push(this.oList[this.aIndices[t]])}if(this.oList.dataRequested){e.dataRequested=true}return e},setContexts:function(e){this.oList=e;this.updateIndices();this.applyFilter();this.applySort();this.iLength=this._getLength()},update:function(){var e=[],t=this.fetchContexts(),n=this;if(t.isFulfilled()){e=t.getResult()}else{t.then(function(e){n.setContexts(e);n._fireChange({reason:s.Change})});e.dataRequested=true}this.setContexts(e)}});w=p.extend("sap.ui.model.odata.v4.ODataMetaPropertyBinding",{constructor:function(){p.apply(this,arguments);this.vValue=undefined},checkUpdate:function(e,t){var n,i=this;function o(n){if(e||n!==i.vValue){i.vValue=n;i._fireChange({reason:t||s.Change})}return n}n=this.oModel.fetchObject(this.sPath,this.oContext,this.mParameters).then(o);if(this.mParameters&&this.mParameters.$$valueAsPromise&&n.isPending()){o(n.unwrap())}},getValue:function(){return this.vValue},setContext:function(e){if(this.oContext!=e){this.oContext=e;if(this.bRelative){this.checkUpdate(false,s.Context)}}},setValue:function(){throw new Error("Unsupported operation: ODataMetaPropertyBinding#setValue")}});var F=d.extend("sap.ui.model.odata.v4.ODataMetaModel",{constructor:function(e,t,n,i,o){d.call(this);this.aAnnotationUris=n&&!Array.isArray(n)?[n]:n;this.sDefaultBindingMode=a.OneTime;this.mETags={};this.dLastModified=new Date(0);this.oMetadataPromise=null;this.oModel=i;this.mMetadataUrl2Promise={};this.oRequestor=e;this.mSchema2MetadataUrl={};this.mSupportedBindingModes={OneTime:true,OneWay:true};this.bSupportReferences=o!==false;this.sUrl=t}});F.prototype.$$valueAsPromise=true;F.prototype._mergeAnnotations=function(e,t){var n=this;this.validate(this.sUrl,e);e.$Annotations={};Object.keys(e).forEach(function(t){if(e[t].$kind==="Schema"){R(n,t,n.sUrl);k(e[t],e.$Annotations)}});t.forEach(function(t,i){var o,r;n.validate(n.aAnnotationUris[i],t);for(r in t){if(r[0]!=="$"){if(r in e){B(n,"A schema cannot span more than one document: "+r,n.aAnnotationUris[i])}o=t[r];e[r]=o;if(o.$kind==="Schema"){R(n,r,n.aAnnotationUris[i]);k(o,e.$Annotations,true)}}}})};F.prototype.attachEvent=function(e){if(!(e in x)){throw new Error("Unsupported event '"+e+"': v4.ODataMetaModel#attachEvent")}return d.prototype.attachEvent.apply(this,arguments)};F.prototype.bindContext=function(e,t){return new O(this,e,t)};F.prototype.bindList=function(e,t,n,i){return new C(this,e,t,n,i)};F.prototype.bindProperty=function(e,t,n){return new w(this,e,t,n)};F.prototype.bindTree=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#bindTree")};F.prototype.fetchCanonicalPath=function(e){return this.fetchUpdateData("",e).then(function(t){if(t.propertyPath){throw new Error("Context "+e.getPath()+" does not point to an entity. It should be "+t.entityPath)}return"/"+t.editUrl})};F.prototype.fetchData=function(){return this.fetchEntityContainer().then(function(e){return JSON.parse(JSON.stringify(e))})};F.prototype.fetchEntityContainer=function(e){var t,n=this;if(!this.oMetadataPromise){t=[r.resolve(this.oRequestor.read(this.sUrl,false,e))];if(this.aAnnotationUris){this.aAnnotationUris.forEach(function(i){t.push(r.resolve(n.oRequestor.read(i,true,e)))})}if(!e){this.oMetadataPromise=r.all(t).then(function(e){var t=e[0];n._mergeAnnotations(t,e.slice(1));return t})}}return this.oMetadataPromise};F.prototype.fetchModule=function(e){var t;e=e.replace(/\./g,"/");t=sap.ui.require(e);if(t){return r.resolve(t)}return r.resolve(new Promise(function(t,n){sap.ui.require([e],t)}))};F.prototype.fetchObject=function(e,t,n){var a=this.resolve(e,t),s=this;if(!a){i.error("Invalid relative path w/o context",e,b);return r.resolve(null)}return this.fetchEntityContainer().then(function(r){var u,c,d,p=true,l,h,m,y=r;function g(e,t){var i,r=e.indexOf("@",2);if(r>-1){return C(I,"Unsupported path after ",e.slice(0,r))}e=e.slice(2);i=e[0]==="."?o.get(e.slice(1),n.scope):n&&o.get(e,n.scope)||o.get(e);if(typeof i!=="function"){return C(I,e," is not a function but: "+i)}try{y=i(y,{$$valueAsPromise:n&&n.$$valueAsPromise,context:new f(s,t),schemaChildName:h})}catch(t){C(I,"Error calling ",e,": ",t)}return true}function v(e){return e.$kind!=="Action"||(!e.$IsBound&&u===P||e.$IsBound&&u===e.$Parameter[0].$Type)}function O(e){return e&&typeof e.then==="function"}function C(e){var t;if(i.isLoggable(e,b)){t=Array.isArray(c)?c.join("/"):c;i[e===M?"debug":"warning"](Array.prototype.slice.call(arguments,1).join("")+(t?" at /"+t:""),a,b)}if(e===I){y=undefined}return false}function w(e,t){var n;function i(){c=c||m&&t&&m+"/"+t;return C.apply(this,arguments)}u=y&&y.$Type;if(s.bSupportReferences&&!(e in r)){n=N(e);y=V(s,r,n,i)}if(e in r){m=d=h=e;y=l=r[h];if(!O(y)){return true}}if(O(y)&&y.isPending()){return i(M,"Waiting for ",n)}return i(I,"Unknown qualified name ",e)}function E(e,t,n){var i,o;if(e==="$Annotations"){return C(I,"Invalid segment: $Annotations")}if(y!==r&&typeof y==="object"&&e in y){if(e[0]==="$"||$.test(e)){p=false}}else{i=e.indexOf("@@");if(i<0){if(e.length>11&&e.slice(-11)==="@sapui.name"){i=e.length-11}else{i=e.indexOf("@")}}if(i>0){if(!E(e.slice(0,i),t,n)){return false}e=e.slice(i);o=true}if(typeof y==="string"&&!(o&&(e==="@sapui.name"||e[1]==="@"))&&!x(y,n.slice(0,t))){return false}if(p){if(e[0]==="$"||$.test(e)){p=false}else if(!o){if(e[0]!=="@"&&e.indexOf(".")>0){return w(e)}else if(y&&"$Type"in y){if(!w(y.$Type,"$Type")){return false}}else if(y&&"$Action"in y){if(!w(y.$Action,"$Action")){return false}u=P}else if(y&&"$Function"in y){if(!w(y.$Function,"$Function")){return false}}else if(t===0){m=d=h=h||r.$EntityContainer;y=l=l||r[h];if(e&&e[0]!=="@"&&!(e in l)){return C(I,"Unknown child ",e," of ",h)}}if(Array.isArray(y)){y=y.filter(v);if(e==="@$ui5.overload"){return true}if(y.length!==1){return C(I,"Unsupported overloads")}y=y[0].$ReturnType;m=m+"/0/$ReturnType";if(y){if(e==="value"&&!(r[y.$Type]&&r[y.$Type].value)){d=undefined;return true}if(!w(y.$Type,"$Type")){return false}}}}}if(!e){return t+1>=n.length||C(I,"Invalid empty segment")}if(e[0]==="@"){if(e==="@sapui.name"){y=d;if(y===undefined){C(I,"Unsupported path before @sapui.name")}else if(t+1<n.length){C(I,"Unsupported path after @sapui.name")}return false}if(e[1]==="@"){if(t+1<n.length){return C(I,"Unsupported path after ",e)}return g(e,[""].concat(n.slice(0,t),n[t].slice(0,i)).join("/"))}}if(!y||typeof y!=="object"){y=undefined;return C(M,"Invalid segment: ",e)}if(p&&e[0]==="@"){y=(r.$Annotations||{})[m]||{};p=false}}if(e!=="@"){d=p||e[0]==="@"?e:undefined;m=p?m+"/"+e:undefined;y=y[e]}return true}function x(e,t){var n;if(c){return C(I,"Invalid recursion")}c=t;p=true;y=r;n=e.split("/").every(E);c=undefined;return n}if(!x(a.slice(1))&&O(y)){y=y.then(function(){return s.fetchObject(e,t,n)})}return y})};F.prototype.fetchUI5Type=function(e){var t=this.getMetaContext(e),n=this;if(e.endsWith("/$count")){v=v||new h;return r.resolve(v)}return this.fetchObject(undefined,t).then(function(o){var r,a,s,u,f=E.getName();function c(e,t){if(t!==undefined){r=r||{};r[e]=t}}if(!o){i.warning("No metadata for path '"+e+"', using "+f,undefined,b);return E}s=o["$ui5.type"];if(s){return s}if(o.$isCollection){i.warning("Unsupported collection type, using "+f,e,b)}else{u=U[o.$Type];if(u){f=u.type;for(a in u.constraints){c(u.constraints[a],a[0]==="@"?n.getObject(a,t):o[a])}if(o.$Nullable===false){c("nullable",false)}}else{i.warning("Unsupported type '"+o.$Type+"', using "+f,e,b)}}if(f===E.getName()){o["$ui5.type"]=E}else{o["$ui5.type"]=n.fetchModule(f).then(function(e){s=new e(undefined,r);o["$ui5.type"]=s;return s})}return o["$ui5.type"]})};F.prototype.fetchUpdateData=function(e,n){var i=n.getModel(),o=i.resolve(e,n),a=this;function s(e){var t=new Error(o+": "+e);i.reportError(e,b,t);throw t}return this.fetchObject(this.getMetaPath(o)).then(function(){return a.fetchEntityContainer()}).then(function(i){var a,u=i[i.$EntityContainer],f,c,d,p,l,h,m=false,y;function g(e){var t=e.indexOf("(");return t>=0?e.slice(t):""}function v(){a.push({path:p,prefix:a.pop(),type:y})}function M(e){var t=e.indexOf("(");return t>=0?e.slice(0,t):e}h=o.slice(1).split("/");a=[h.shift()];p="/"+a[0];f=p;d=decodeURIComponent(M(a[0]));c=u[d];if(!c){s("Not an entity set: "+d)}y=i[c.$Type];e="";l="";h.forEach(function(n){var o,r;p+="/"+n;if($.test(n)){v();f+="/"+n}else{r=decodeURIComponent(M(n));l=t.buildPath(l,r);o=y[r];if(!o){s("Not a (navigation) property: "+r)}y=i[o.$Type];if(o.$kind==="NavigationProperty"){if(c.$NavigationPropertyBinding&&l in c.$NavigationPropertyBinding){d=c.$NavigationPropertyBinding[l];c=u[d];l="";a=[encodeURIComponent(d)+g(n)];if(!o.$isCollection){v()}}else{a.push(n)}f=p;e=""}else{e=t.buildPath(e,n)}}});return r.all(a.map(function(e){if(typeof e==="string"){return e}return n.fetchValue(e.path).then(function(n){var i;if(!n){s("No instance to calculate key predicate at "+e.path)}if(t.hasPrivateAnnotation(n,"transient")){m=true;return undefined}i=t.getPrivateAnnotation(n,"predicate");if(!i){s("No key predicate known at "+e.path)}return e.prefix+i},function(t){s(t.message+" at "+e.path)})})).then(function(t){return{editUrl:m?undefined:t.join("/"),entityPath:f,propertyPath:e}})})};F.prototype.fetchValueListMappings=function(e,n,i){var o=this,r=e.getMetaModel();return r.fetchEntityContainer().then(function(a){var s,u=a.$Annotations,f={},c=o===r,d;d=Object.keys(u).filter(function(r){if(t.namespace(r)===n){if(o.getObject("/"+r)===i){return true}if(!c){throw new Error("Unexpected annotation target '"+r+"' with namespace of data service in "+e.sServiceUrl)}}return false});if(!d.length){throw new Error("No annotation '"+S.slice(1)+"' in "+e.sServiceUrl)}s=u[d[0]];Object.keys(s).forEach(function(t){var n=q(t);if(n!==undefined){f[n]=s[t];["CollectionRoot","SearchSupported"].forEach(function(n){if(n in s[t]){throw new Error("Property '"+n+"' is not allowed in annotation '"+t.slice(1)+"' for target '"+d[0]+"' in "+e.sServiceUrl)}})}else if(!c){throw new Error("Unexpected annotation '"+t.slice(1)+"' for target '"+d[0]+"' with namespace of data service in "+e.sServiceUrl)}});return f})};F.prototype.fetchValueListType=function(t){var n=this.getMetaContext(t),i=this;return this.fetchObject(undefined,n).then(function(o){var r,a;if(!o){throw new Error("No metadata for "+t)}r=i.getObject("@",n);if(r[T]){return e.Fixed}for(a in r){if(j(a,A)!==undefined||j(a,L)!==undefined){return e.Standard}if(j(a,S)!==undefined){return r[a].SearchSupported===false?e.Fixed:e.Standard}}return e.None})};F.prototype.getAdapterFactoryModulePath=function(){return"sap/ui/mdc/experimental/adapter/odata/v4/ODataAdapterFactory"};F.prototype.getData=t.createGetMethod("fetchData");F.prototype.getETags=function(){return this.mETags};F.prototype.getLastModified=function(){return this.dLastModified};F.prototype.getMetaContext=function(e){return new f(this,this.getMetaPath(e))};F.prototype.getMetaPath=function(e){return t.getMetaPath(e)};F.prototype.getObject=t.createGetMethod("fetchObject");F.prototype.getOrCreateValueListModel=function(e){var t=new g(this.sUrl).absoluteTo(document.baseURI).pathname().toString(),n,i;i=new g(e).absoluteTo(t).filename("").toString();n=D[i];if(!n){n=new this.oModel.constructor({operationMode:l.Server,serviceUrl:i,synchronizationMode:"None"});n.setDefaultBindingMode(a.OneWay);D[i]=n;n.oRequestor.mHeaders["X-CSRF-Token"]=this.oModel.oRequestor.mHeaders["X-CSRF-Token"]}return n};F.prototype.getOriginalProperty=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#getOriginalProperty")};F.prototype.getProperty=F.prototype.getObject;F.prototype.getUI5Type=t.createGetMethod("fetchUI5Type",true);F.prototype.getValueListType=t.createGetMethod("fetchValueListType",true);F.prototype.isList=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#isList")};F.prototype.refresh=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#refresh")};F.prototype.requestData=t.createRequestMethod("fetchData");F.prototype.requestObject=t.createRequestMethod("fetchObject");F.prototype.requestUI5Type=t.createRequestMethod("fetchUI5Type");F.prototype.requestValueListInfo=function(e){var n=this.getMetaPath(e),i=n.slice(0,n.lastIndexOf("/")+1),o=this;return Promise.all([this.requestObject(i+"@sapui.name"),this.requestObject(n),this.requestObject(n+"@"),this.requestObject(n+T)]).then(function(n){var i=n[2],r=n[3],a={},s=t.namespace(n[0]),u=n[1],f={};function c(t,n,i,s){if(r!==undefined&&"SearchSupported"in t){throw new Error("Must not set 'SearchSupported' in annotation "+"'com.sap.vocabularies.Common.v1.ValueList' and annotation "+"'com.sap.vocabularies.Common.v1.ValueListWithFixedValues'")}if("CollectionRoot"in t){s=o.getOrCreateValueListModel(t.CollectionRoot);if(f[n]&&f[n].$model===s){a[n]=undefined}}if(a[n]){throw new Error("Annotations '"+S.slice(1)+"' with identical qualifier '"+n+"' for property "+e+" in "+a[n]+" and "+i)}a[n]=i;t=y.extend(true,{$model:s},t);delete t.CollectionRoot;delete t.SearchSupported;f[n]=t}if(!u){throw new Error("No metadata for "+e)}return Promise.all(Object.keys(i).filter(function(e){return j(e,A)!==undefined}).map(function(e){var t=i[e];return Promise.all(t.map(function(e){var t=o.getOrCreateValueListModel(e);return o.fetchValueListMappings(t,s,u).then(function(n){Object.keys(n).forEach(function(i){c(n[i],i,e,t)})})}))})).then(function(){var t;Object.keys(i).filter(function(e){return q(e)!==undefined}).forEach(function(e){c(i[e],q(e),o.sUrl,o.oModel)});t=Object.keys(f);if(!t.length){throw new Error("No annotation '"+A.slice(1)+"' for "+e)}if(r){if(t.length>1){throw new Error("Annotation '"+T.slice(1)+"' but multiple '"+S.slice(1)+"' for property "+e)}return{"":f[t[0]]}}return f})})};F.prototype.requestValueListType=t.createRequestMethod("fetchValueListType");F.prototype.resolve=function(e,t){var n,i;if(!e){return t?t.getPath():undefined}i=e[0];if(i==="/"){return e}if(!t){return undefined}if(i==="."){if(e[1]!=="/"){throw new Error("Unsupported relative path: "+e)}e=e.slice(2)}n=t.getPath();return i==="@"||n.slice(-1)==="/"?n+e:n+"/"+e};F.prototype.setLegacySyntax=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#setLegacySyntax")};F.prototype.toString=function(){return b+": "+this.sUrl};F.prototype.validate=function(e,t){var n,i,o,r,a,s;if(!this.bSupportReferences){return t}for(s in t.$Reference){a=t.$Reference[s];s=new g(s).absoluteTo(this.sUrl).toString();if("$IncludeAnnotations"in a){B(this,"Unsupported IncludeAnnotations",e)}for(n in a.$Include){r=a.$Include[n];if(r in t){B(this,"A schema cannot span more than one document: "+r+" - is both included and defined",e)}R(this,r,s,e)}}o=t.$LastModified?new Date(t.$LastModified):null;this.mETags[e]=t.$ETag?t.$ETag:o;i=t.$Date?new Date(t.$Date):new Date;o=o||i;if(this.dLastModified<o){this.dLastModified=o}delete t.$Date;delete t.$ETag;delete t.$LastModified;return t};return F});