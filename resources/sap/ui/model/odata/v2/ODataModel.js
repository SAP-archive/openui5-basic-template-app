/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_CreatedContextsCache","./Context","./ODataAnnotations","./ODataContextBinding","./ODataListBinding","./ODataTreeBinding","sap/base/assert","sap/base/Log","sap/base/security/encodeURL","sap/base/util/deepEqual","sap/base/util/deepExtend","sap/base/util/each","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/isPlainObject","sap/base/util/merge","sap/base/util/uid","sap/base/util/UriParameters","sap/ui/base/SyncPromise","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/message/MessageParser","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/model/FilterProcessor","sap/ui/model/Model","sap/ui/model/odata/CountMode","sap/ui/model/odata/MessageScope","sap/ui/model/odata/ODataMetadata","sap/ui/model/odata/ODataMetaModel","sap/ui/model/odata/ODataMessageParser","sap/ui/model/odata/ODataPropertyBinding","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/OperationMode","sap/ui/model/odata/UpdateMethod","sap/ui/thirdparty/datajs","sap/ui/thirdparty/URI","sap/ui/util/isCrossOriginURL"],function(e,t,a,s,r,i,n,o,d,u,h,f,c,p,l,g,_,m,y,v,b,C,P,q,R,M,S,E,T,D,U,x,A,I,O,k,H,L){"use strict";var B="sap.ui.model.odata.v2.ODataModel",F=v.MessageType,G={};G[F.Error]=0;G[F.Warning]=1;G[F.Success]=2;G[F.Information]=3;G[F.None]=4;var w=M.extend("sap.ui.model.odata.v2.ODataModel",{constructor:function(t,s){M.apply(this,arguments);var r,i,n,o,d,u,h,f,c,p,l,g,_,m,y,v,b,C,q,R,D,U,x,k,H,B,F,G,j,N,W=this;if(typeof t==="object"){s=t;this.sServiceUrl=s.serviceUrl}else{this.sServiceUrl=t}this.mCodeListModelParams=this.createCodeListModelParameters(s);if(s){r=s.user;i=s.password;n=s.headers;o=s.tokenHandling;d=s.withCredentials;u=s.maxDataServiceVersion;h=s.useBatch;f=s.refreshAfterChange;c=s.annotationURI;p=s.loadAnnotationsJoined;_=s.defaultBindingMode;l=s.defaultCountMode;g=s.preliminaryContext;m=s.defaultOperationMode;y=s.metadataNamespaces;v=s.serviceUrlParams;b=s.metadataUrlParams;C=s.json;q=s.messageParser;R=s.skipMetadataAnnotationParsing;D=s.defaultUpdateMethod;U=s.disableHeadRequestForToken;x=s.sequentializeRequests;k=s.disableSoftStateHeader;H=s.bindableResponseHeaders;B=s.warmupUrl;F=s.canonicalRequests;G=s.tokenHandlingForGet;j=s.earlyTokenRequest;N=s.persistTechnicalMessages}this.mPathCache={};this.mInvalidatedPaths={};this.bCanonicalRequests=!!F;this.bTokenHandlingForGet=!!G;this.sMessageScope=E.RequestedObjects;this.sWarmupUrl=B;this.bWarmup=!!B;this.mSupportedBindingModes={OneWay:true,OneTime:true,TwoWay:true};this.mUnsupportedFilterOperators={Any:true,All:true};this.sDefaultBindingMode=_||P.OneWay;this.bIsMessageScopeSupported=false;this.iPendingDeferredRequests=0;this.bJSON=C!==false;this.aPendingRequestHandles=[];this.aCallAfterUpdate=[];this.mRequests={};this.mDeferredRequests={};this.mChangedEntities={};this.mChangeHandles={};this.mDeferredGroups={};this.mLaunderingState={};this.sDefaultUpdateMethod=D||O.Merge;this.bTokenHandling=o!==false;this.bWithCredentials=d===true;this.bUseBatch=h!==false;this.bRefreshAfterChange=f!==false;this.sMaxDataServiceVersion=u;this.bLoadAnnotationsJoined=p!==false;this.sAnnotationURI=c;this.sDefaultCountMode=l||S.Request;this.sDefaultOperationMode=m||I.Default;this.sMetadataLoadEvent=null;this.oMetadataFailedEvent=null;this.sRefreshGroupId=undefined;this.bIncludeInCurrentBatch=false;this.bSkipMetadataAnnotationParsing=!!R;this.bDisableHeadRequestForToken=!!U;this.bSequentializeRequests=!!x;this.bDisableSoftStateHeader=!!k;this.aBindableResponseHeaders=H?H:null;this.bPreliminaryContext=g||false;this.mMetadataUrlParams=b||{};this.mChangedEntities4checkUpdate={};this.bPersistTechnicalMessages=N===undefined?undefined:!!N;this.oCreatedContextsCache=new e;if(q){q.setProcessor(this)}this.oMessageParser=q;this.sDefaultChangeGroup="changes";this.setDeferredGroups([this.sDefaultChangeGroup]);this.setChangeGroups({"*":{groupId:this.sDefaultChangeGroup}});this.oData={};this.oMetadata=null;this.oAnnotations=null;this.aUrlParams=[];this.pSequentialRequestCompleted=Promise.resolve();this.pReadyForRequest=Promise.resolve();var K=this.sServiceUrl.split("?");if(K.length>1){this.sServiceUrl=K[0];if(K[1]){this.aUrlParams.push(K[1])}}this.sServiceUrl=this.sServiceUrl.replace(/\/$/,"");this.sUser=r;this.sPassword=i;if(sap.ui.getCore().getConfiguration().getStatistics()){this.aUrlParams.push("sap-statistics=true")}this.oHeaders={};this.setHeaders(n);if(!this.bDisableSoftStateHeader){this.oHeaders["sap-contextid-accept"]="header";this.mCustomHeaders["sap-contextid-accept"]="header"}var $=this._getServerUrl();this.sMetadataUrl=this.sWarmupUrl||this._createMetadataUrl("/$metadata");this.oSharedServerData=w._getSharedData("server",$);this.oSharedServiceData=w._getSharedData("service",this.sServiceUrl);this.oSharedMetaData=w._getSharedData("meta",this.sMetadataUrl);this.bUseCache=this._cacheSupported(this.sMetadataUrl);if(!this.oSharedMetaData.oMetadata||this.oSharedMetaData.oMetadata.bFailed){this.oMetadata=new T(this.sMetadataUrl,{async:true,cacheKey:this.bUseCache?this.sMetadataUrl:undefined,user:this.sUser,password:this.sPassword,headers:this.mCustomHeaders,namespaces:y,withCredentials:this.bWithCredentials});if(!this.bWarmup){this.oSharedMetaData.oMetadata=this.oMetadata}}else{this.oMetadata=this.oSharedMetaData.oMetadata}this.oAnnotations=new a(this.oMetadata,{source:this.sAnnotationURI,skipMetadata:this.bSkipMetadataAnnotationParsing,headers:this.mCustomHeaders,combineEvents:true,cacheKey:this._getAnnotationCacheKey(this.sMetadataUrl),useCache:this.bUseCache});if(!this.bDisableSoftStateHeader){delete this.mCustomHeaders["sap-contextid-accept"]}this.oAnnotations.attachAllFailed(this.onAnnotationsFailed,this);this.oAnnotations.attachSomeLoaded(this.onAnnotationsLoaded,this);this.pAnnotationsLoaded=this.oAnnotations.loaded();if(v){this.aUrlParams=this.aUrlParams.concat(A._createUrlParamsArray(v))}this.onMetadataFailed=function(e){W.fireMetadataFailed(e.getParameters())};if(!this.oMetadata.isLoaded()){this.oMetadata.attachFailed(this.onMetadataFailed)}this.oMetadata.loaded().then(function(){W._initializeMetadata()});if(this.bJSON){if(this.sMaxDataServiceVersion==="3.0"){this.oHeaders["Accept"]="application/json;odata=fullmetadata"}else{this.oHeaders["Accept"]="application/json"}}else{this.oHeaders["Accept"]="application/atom+xml,application/atomsvc+xml,application/xml"}if(this.bTokenHandling){if(this.oSharedServiceData.securityToken){this.oHeaders["x-csrf-token"]=this.oSharedServiceData.securityToken}else if(this.oSharedServerData.securityToken){this.oSharedServiceData.securityToken=this.oSharedServerData.securityToken;this.oHeaders["x-csrf-token"]=this.oSharedServiceData.securityToken}if(j){this.securityTokenAvailable()}}this.oHeaders["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();this.oHeaders["DataServiceVersion"]="2.0";this.oHeaders["MaxDataServiceVersion"]="2.0";if(this.sMaxDataServiceVersion){this.oHeaders["MaxDataServiceVersion"]=this.sMaxDataServiceVersion}if(!this.mCustomHeaders["X-Requested-With"]&&!L(this.sServiceUrl)){this.oHeaders["X-Requested-With"]="XMLHttpRequest"}},metadata:{publicMethods:["read","create","update","remove","submitChanges","getServiceMetadata","metadataLoaded","hasPendingChanges","getPendingChanges","refresh","refreshMetadata","resetChanges","setDefaultCountMode","setDefaultBindingMode","getDefaultBindingMode","getDefaultCountMode","setProperty","getSecurityToken","refreshSecurityToken","setHeaders","getHeaders","setUseBatch","setDeferredBatchGroups","getDeferredBatchGroups","setChangeBatchGroups","getChangeBatchGroups"]}});w.M_EVENTS={MetadataLoaded:"metadataLoaded",MetadataFailed:"metadataFailed",AnnotationsLoaded:"annotationsLoaded",AnnotationsFailed:"annotationsFailed",BatchRequestFailed:"batchRequestFailed",BatchRequestSent:"batchRequestSent",BatchRequestCompleted:"batchRequestCompleted"};w.prototype.attachBatchRequestFailed=function(e,t,a){this.attachEvent("batchRequestFailed",e,t,a);return this};w.prototype.detachBatchRequestFailed=function(e,t){this.detachEvent("batchRequestFailed",e,t);return this};w.prototype.fireBatchRequestFailed=function(e){this.fireEvent("batchRequestFailed",e);return this};w.prototype.attachBatchRequestSent=function(e,t,a){this.attachEvent("batchRequestSent",e,t,a);return this};w.prototype.detachBatchRequestSent=function(e,t){this.detachEvent("batchRequestSent",e,t);return this};w.prototype.fireBatchRequestSent=function(e){this.fireEvent("batchRequestSent",e);return this};w.prototype.attachBatchRequestCompleted=function(e,t,a){this.attachEvent("batchRequestCompleted",e,t,a);return this};w.prototype.detachBatchRequestCompleted=function(e,t){this.detachEvent("batchRequestCompleted",e,t);return this};w.prototype.fireBatchRequestCompleted=function(e){this.fireEvent("batchRequestCompleted",e);return this};w.mSharedData={server:{},service:{},meta:{}};w._getSharedData=function(e,t){var a=this.mSharedData[e][t];if(!a){a={};this.mSharedData[e][t]=a}return a};w.prototype._initializeMetadata=function(){if(this.bDestroyed){return}this.bIsMessageScopeSupported=this.oMetadata._isMessageScopeSupported();var e=function(){this.fireMetadataLoaded({metadata:this.oMetadata});o.debug(this+" - metadataloaded fired")}.bind(this);this.initialize();if(this.bLoadAnnotationsJoined){this.oAnnotations.loaded().then(e,this.fireMetadataFailed.bind(this))}else{e()}};w.prototype.refreshMetadata=function(){if(this.oMetadata&&this.oMetadata.refresh){return this.oMetadata.refresh()}};w.prototype.fireAnnotationsLoaded=function(e){this.fireEvent("annotationsLoaded",e);return this};w.prototype.attachAnnotationsLoaded=function(e,t,a){this.attachEvent("annotationsLoaded",e,t,a);return this};w.prototype.detachAnnotationsLoaded=function(e,t){this.detachEvent("annotationsLoaded",e,t);return this};w.prototype.fireAnnotationsFailed=function(e){this.fireEvent("annotationsFailed",e);o.debug(this+" - annotationsfailed fired");return this};w.prototype.attachAnnotationsFailed=function(e,t,a){this.attachEvent("annotationsFailed",e,t,a);return this};w.prototype.detachAnnotationsFailed=function(e,t){this.detachEvent("annotationsFailed",e,t);return this};w.prototype.fireMetadataLoaded=function(e){this.fireEvent("metadataLoaded",e);return this};w.prototype.attachMetadataLoaded=function(e,t,a){this.attachEvent("metadataLoaded",e,t,a);return this};w.prototype.detachMetadataLoaded=function(e,t){this.detachEvent("metadataLoaded",e,t);return this};w.prototype.fireMetadataFailed=function(e){this.fireEvent("metadataFailed",e);return this};w.prototype.attachMetadataFailed=function(e,t,a){this.attachEvent("metadataFailed",e,t,a);return this};w.prototype.detachMetadataFailed=function(e,t){this.detachEvent("metadataFailed",e,t);return this};w.prototype._createEventInfo=function(e,t,a){var s={};s.url=e.requestUri;s.method=e.method;s.async=e.async;s.headers=e.headers;if(a){s.requests=[];for(var r=0;r<a.length;r++){var i={};if(Array.isArray(a[r])){var n=a[r];for(var o=0;o<n.length;o++){var e=n[o].request;var d=a[r][o].response;i={};i.url=e.requestUri;i.method=e.method;i.headers=e.headers;if(d){i.response={};if(e._aborted){i.success=false;i.response.statusCode=0;i.response.statusText="abort"}else{i.success=true;if(d.message){i.response.message=d.message;d=d.response;i.response.responseText=d.body;i.success=false}i.response.headers=d.headers;i.response.statusCode=d.statusCode;i.response.statusText=d.statusText}}s.requests.push(i)}}else{var e=a[r].request;var d=a[r].response;i.url=e.requestUri;i.method=e.method;i.headers=e.headers;if(d){i.response={};if(e._aborted){i.success=false;i.response.statusCode=0;i.response.statusText="abort"}else{i.success=true;if(d.message){i.response.message=d.message;d=d.response;i.response.responseText=d.body;i.success=false}i.response.headers=d.headers;i.response.statusCode=d.statusCode;i.response.statusText=d.statusText}}s.requests.push(i)}}}if(t){s.response={};s.success=true;if(t.message){s.response.message=t.message;s.success=false}if(t.response){t=t.response}if(t&&t.statusCode!=undefined){s.response.headers=t.headers;s.response.statusCode=t.statusCode;s.response.statusText=t.statusText;s.response.responseText=t.body!==undefined?t.body:t.responseText;if(t.expandAfterCreateFailed){s.response.expandAfterCreateFailed=true}if(t.expandAfterFunctionCallFailed){s.response.expandAfterFunctionCallFailed=true}}}s.ID=e.requestID;return s};w.prototype._createRequestID=function(){var e;e=_();return e};w.prototype._getServerUrl=function(){var e,t;e=new H(this.sServiceUrl).absoluteTo(document.baseURI);t=new H("/").absoluteTo(e).toString();return t};w.prototype._createMetadataUrl=function(e){if(e.indexOf(this.sServiceUrl)==-1){if(!e.startsWith("/")){e="/"+e}e=this.sServiceUrl+e}var t=m.fromURL(e||window.location.href);var a=Object.assign({},this.mMetadataUrlParams);Array.from(t.keys()).forEach(function(e){a[e]=t.get(e)});var s=A._createUrlParamsArray(a);var r=e.split("?");if(r.length>1){e=r[0]}return this._addUrlParams(e,s)};w.prototype._addUrlParams=function(e,t){var a=[];if(this.aUrlParams){a=a.concat(this.aUrlParams)}if(t){a=a.concat(t)}if(a.length>0){e+="?"+a.join("&")}return e};w.prototype._createRequestUrl=function(e,t,a,s){return this._createRequestUrlWithNormalizedPath(this._normalizePath(e,t),a,s)};w.prototype._createRequestUrlWithNormalizedPath=function(e,t,a){var s="";if(!a){s=this.sServiceUrl+e}else{s=e.substr(e.indexOf("/")+1)}return this._addUrlParams(s,t)};w.prototype._importData=function(e,t,a,s,r,i,n,o){var d=this,u,h,c,l;s=s||"";i=i||"";if(e.results&&Array.isArray(e.results)){u=[];f(e.results,function(e,i){var n=d._getKey(i);n=d._importData(i,t,a,s.substr(0,s.lastIndexOf("/")),r,n);if(n){u.push(n)}});return u}else{if(i){s="/"+i;r+=i.substr(i.indexOf("("))}else{i=this._getKey(e)}if(!i){return i}c=this._getEntity(i);l=c;if(!c||c.__metadata&&c.__metadata.invalid){if(!l){l=e}c=e;i=this._addEntity(c)}if(this.aBindableResponseHeaders){var g={};for(var _ in a.headers){var m=_.toLowerCase();if(this.aBindableResponseHeaders.indexOf(m)>-1){g[m]=a.headers[_]}}if(!p(g)){if(!e.__metadata){e.__metadata={}}e.__metadata.headers=g}}f(e,function(e,n){if(n&&(n.__metadata&&n.__metadata.uri||n.results)&&!n.__deferred){var o=s+"/"+e;var u=r+"/"+e;h=d._importData(n,t,a,o,u,undefined,false,"/"+i+"/"+e);if(Array.isArray(h)){c[e]={__list:h}}else{if(l[e]&&l[e].__ref){if(l[e].__ref!==h){d.mInvalidatedPaths[s.substr(s.lastIndexOf("("))+"/"+e]="/"+h}}c[e]={__ref:h}}}else if(!n||!n.__deferred){if(l[e]&&n===null){d.mInvalidatedPaths[s.substr(s.lastIndexOf("("))+"/"+e]=null}c[e]=n}});var y={};y[i]=c;if(this.hasContext("/"+i)&&this.getContext("/"+i).isPreliminary()){var v=this.getContext("/"+i);v.setUpdated(true);v.setPreliminary(false)}this._updateChangedEntities(y);t[i]=true;s=s||"/"+i;r=r||s;var b=this.resolveFromCache(r);if(b==="/"+i||b&&b.split("/").length>2){this._writePathCache(b,"/"+i,n)}this._writePathCache(s,"/"+i,n);this._writePathCache(r,"/"+i,n,true);if(o){this._writePathCache(o,"/"+i,n)}return i}};w.prototype._writePathCache=function(e,t,a,s){var r,i,n,o,d,u;if(e&&t){if(!this.mPathCache[e]){this.mPathCache[e]={}}if(!a&&e.lastIndexOf("/")===0){t=e}this.mPathCache[e].canonicalPath=t;if(s){d=e.split("/");for(u=3;u<d.length;u+=1){n=d.slice(0,u).join("/");o=this.mPathCache[n];if(o){r=o.canonicalPath+e.slice(n.length);i=this.mPathCache[r];if(i){i.canonicalPath=t}}}}}};w.prototype._removeReferences=function(e){var t=this,a;if(!e){return e}if(e.results){a=[];f(e.results,function(e,s){a.push(t._removeReferences(s))});return a}else{f(e,function(t,a){if(a){if(a["__ref"]||a["__list"]){delete e[t]}}});return e}};w.prototype._restoreReferences=function(e,t){var a=this,s,r,i;function o(e){var s=t[e];if(!s){s=a._getObject("/"+e);n(s,"ODataModel inconsistent: "+e+" not found!");if(s){s=g({},s);t[e]=s;a._restoreReferences(s,t)}}return s}if(!t){t={}}f(e,function(t,a){if(a){if(a.__ref){s=a.__ref;r=o(s);if(r){e[t]=r}delete a.__ref}else if(a.__list){i=[];f(a.__list,function(e,t){r=o(t);if(r){i.push(r)}});delete a.__list;a.results=i}}});return e};w.prototype.removeData=function(){this.oData={}};w.prototype.initialize=function(){var e=this.getBindings();e.forEach(function(e){e.initialize()})};w.prototype.invalidate=function(e){var t;for(var a in this.oData){t=this.oData[a];if(!e||e(a,t)){t.__metadata.invalid=true}}};w.prototype.invalidateEntry=function(e){var t;if(typeof e==="string"){if(e.indexOf("/")===0){t=this._getObject(e)}else{t=this.oData[e]}}else if(e instanceof q){t=this._getObject(e.getPath())}if(t&&t.__metadata){t.__metadata.invalid=true}};w.prototype.invalidateEntityType=function(e){var t;for(var a in this.oData){t=this.oData[a];if(t.__metadata.type===e){t.__metadata.invalid=true}}};w.prototype.refresh=function(e,t,a){if(typeof e==="string"){a=e;e=false;t=false}if(t){this.removeData()}this._refresh(e,a)};w.prototype._refresh=function(e,t,a,s){var r=this.getBindings();this.sRefreshGroupId=t;r.forEach(function(t){t._refresh(e,a,s)});this.sRefreshGroupId=undefined};w.prototype.checkUpdate=function(e,t,a,s){if(t){this.bForceUpdate=this.bForceUpdate||e;Object.assign(this.mChangedEntities4checkUpdate,a);if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){this.checkUpdate(this.bForceUpdate,false,this.mChangedEntities4checkUpdate)}.bind(this),0)}return}e=this.bForceUpdate||e;if(this.sUpdateTimer){clearTimeout(this.sUpdateTimer);this.sUpdateTimer=null;this.bForceUpdate=undefined;this.mChangedEntities4checkUpdate={}}var r=this.getBindings();r.forEach(function(t){if(!s||this.isMetaModelPath(t.getPath())){t.checkUpdate(e,a)}}.bind(this));this._processAfterUpdate()};w.prototype.checkDataState=function(e){var t=this.getBindings();t.forEach(function(t){if(t.checkDataState){t.checkDataState(e)}})};w.prototype.bindProperty=function(e,t,a){var s=new x(this,e,t,a);return s};w.prototype.bindList=function(e,t,a,s,i){var n=new r(this,e,t,a,s,i);return n};w.prototype.bindTree=function(e,t,a,s,r){var n=new i(this,e,t,a,s,r);return n};w.prototype.createBindingContext=function(e,t,a,s,r){var i,n,o,d,u,h=this,f;if(t!==null&&typeof t==="object"&&!(t instanceof q)){r=s;s=a;a=t;t=undefined}if(typeof t=="function"){r=a;s=t;a=undefined;t=undefined}if(typeof t=="boolean"){r=t;s=undefined;a=undefined;t=undefined}if(typeof a=="function"){r=s;s=a;a=undefined}if(typeof a=="boolean"){r=a;s=undefined;a=undefined}if(typeof s=="boolean"){r=s;s=undefined}if(a){f=a.canonicalRequest}f=this._isCanonicalRequestNeeded(f);i=this.resolve(e,t,f);if(!i&&f){i=this.resolve(e,t)}u=this.resolveDeep(e,t);if(!i){if(s){s(null)}return null}if(r===undefined){r=this._isReloadNeeded(i,a)}if(!r){n=this.resolve(e,t,true);if(n){o=this.getContext(n,u)}else{o=null}if(s){s(o)}return o}function c(a){var r=a?h._getKey(a):null,i=!(e===""||e.indexOf("/")>0),n=null,d,f;o=null;if(r){o=h.getContext("/"+r,u);n={__ref:r}}if(t&&l&&i){d=t.getPath();d=d.substr(1);f=h._getEntity(d);if(f){f[e]=n}}s(o)}function p(a){var r;if(a.statusCode=="404"&&t&&l){var i=t.getPath();i=i.substr(1);r=h._getEntity(i);if(r){r[e]={__ref:null}}}s(null)}if(s){var l=!e.startsWith("/");var g=[],_=this.createCustomParams(a);if(_){g.push(_)}if(a&&(a.batchGroupId||a.groupId)){d=a.groupId||a.batchGroupId}this.read(e,{canonicalRequest:f,context:t,error:p,groupId:d,success:c,updateAggregatedMessages:true,urlParameters:g})}if(a&&a.createPreliminaryContext){i=this.resolve(e,t,f);if(!i&&f){i=this.resolve(e,t)}o=this.getContext(i,u);return o}};w.prototype._updateContext=function(e,t,a){e.sPath=t;if(a!==undefined){e.sDeepPath=a}this.mContexts[t]=e};w.prototype._splitEntries=function(e){return e.replace(/\s/g,"").split(",").map(function(e){return e.split("/")})};w.prototype._filterOwnSelect=function(e,t){var a,s;if(!t){return[]}s=t.map(function(e){return e.name});a=e.filter(function(e){return e.length===1}).map(function(e){return e[0]});if(e.length===0||a.indexOf("*")!==-1||a.indexOf("**")!==-1){return s}else{return a.filter(function(e){return s.indexOf(e)!==-1})}};w.prototype._filterOwnExpand=function(e,t){return e.map(function(e){return e[0]}).filter(function(e,t,a){return a.indexOf(e)===t}).filter(function(e){return t.length===0||t.some(function(t){return t.indexOf(e)===0||t.indexOf("**")===0})})};w.prototype._filterSelectByNavProp=function(e,t){return e.filter(function(e){return e[0]===t}).map(function(e){return e.length>1?e.slice(1):["**"]})};w.prototype._filterExpandByNavProp=function(e,t){return e.filter(function(e){return e.length>1&&e[0]===t}).map(function(e){return e.slice(1)})};w.prototype._isReloadNeeded=function(e,t){var a=this,s=this.oMetadata,r,i=this._getObject(e),n=[],o=[];if(!this.oMetadata.isLoaded()){return true}r=this.oMetadata._getEntityTypeByPath(e);if(this._isCreatedEntity(i)){return false}function d(e,t,r,i){var n,o,u,h,f,c,p,l,g;if(!e){return false}if(t===null){return false}if(!t){return true}if(t.__metadata&&t.__metadata.invalid){return true}n=a._filterOwnSelect(r,e.property);for(var _=0;_<n.length;_++){g=n[_];if(t[g]===undefined){return true}}o=a._filterOwnExpand(i,r);for(var _=0;_<o.length;_++){l=o[_];u=t[l];if(u===null){continue}if(u===undefined||u.__deferred){return true}h=s._getEntityTypeByNavProperty(e,l);c=a._filterSelectByNavProp(r,l);p=a._filterExpandByNavProp(i,l);if(u.__ref){f=a._getEntity(u.__ref);if(d(h,f,c,p)){return true}}if(u.__list){for(var m=0;m<u.__list.length;m++){f=a._getEntity(u.__list[m]);if(d(h,f,c,p)){return true}}}}return false}if(t){if(t.select){o=this._splitEntries(t.select)}if(t.expand){n=this._splitEntries(t.expand)}}return d(r,i,o,n)};w.prototype.createCustomParams=function(e){var t=[],a,s={expand:true,select:true};for(var r in e){if(r in s){t.push("$"+r+"="+d(e[r]))}if(r==="custom"){a=e[r];for(r in a){if(r.indexOf("$")===0){o.warning(this+" - Trying to set OData parameter '"+r+"' as custom query option!")}else if(typeof a[r]==="string"){t.push(r+"="+d(a[r]))}else{t.push(r)}}}}return t.join("&")};w.prototype.bindContext=function(e,t,a){var r=new s(this,e,t,a);return r};w.prototype.setDefaultCountMode=function(e){this.sDefaultCountMode=e};w.prototype.getDefaultCountMode=function(){return this.sDefaultCountMode};w.prototype._addEntity=function(e){var t=this._getKey(e);this.oData[t]=e;return t};w.prototype._removeEntity=function(e){e=e&&A._normalizeKey(e);delete this.oData[e];delete this.mChangedEntities[e];delete this.mContexts["/"+e]};w.prototype._getEntity=function(e){var t=this.oData[e];if(!t){e=e&&A._normalizeKey(e);t=this.oData[e]}return t};w.prototype._getKey=function(e){var t,a;if(e instanceof q){t=e.getPath().substr(1)}else if(e&&e.__metadata&&e.__metadata.uri){a=e.__metadata.uri;t=a.substr(a.lastIndexOf("/")+1)}else if(typeof e==="string"){t=e.substr(e.lastIndexOf("/")+1)}if(!this.oData[t]){t=t&&A._normalizeKey(t)}return t};w.prototype.getKey=function(e){return this._getKey(e)};w.prototype.createKey=function(e,t){var a=this.oMetadata._getEntityTypeByPath(e),s=e,r=this,i,o;n(a,'Could not find entity type of collection "'+e+'" in service metadata!');s+="(";if(a.key.propertyRef.length===1){i=a.key.propertyRef[0].name;n(i in t,'Key property "'+i+'" is missing in object!');o=this.oMetadata._getPropertyMetadata(a,i);s+=encodeURIComponent(A.formatValue(t[i],o.type))}else{f(a.key.propertyRef,function(e,d){if(e>0){s+=","}i=d.name;n(i in t,'Key property "'+i+'" is missing in object!');o=r.oMetadata._getPropertyMetadata(a,i);s+=i;s+="=";s+=encodeURIComponent(A.formatValue(t[i],o.type))})}s+=")";return s};w.prototype.getProperty=function(e,t,a){var s=this._getObject(e,t);if(!a){return s}if(!l(s)){return s}s=g({},s);if(a===true){return this._restoreReferences(s)}else{return this._removeReferences(s)}};w.prototype.getObject=function(e,t,a){if(l(t)){a=t;t=undefined}var s=this,r=this.resolve(e,t),i=this._getObject(r),n=this.oMetadata._getEntityTypeByPath(r),d=[],u=[];if(!n||!l(i)||!i.__metadata||!i.__metadata.uri){return i}if(!a||!(a.select||a.expand)){return g({},i)}function h(e,t,a,r){var i,n,d,u,f,c,p,l,g,_,m,y,v;if(!t){return undefined}if(!e){return undefined}d=s._filterOwnSelect(a,e.property);n={};for(var b=0;b<d.length;b++){y=d[b];if(t[y]!==undefined){n[y]=t[y]}else{o.fatal("No data loaded for select property: "+y+" of entry: "+s.getKey(t));return undefined}}if(t.__metadata){n.__metadata=t.__metadata}i=s._filterOwnExpand(r,a);for(var b=0;b<i.length;b++){m=i[b];f=t[m];c=s.oMetadata._getEntityTypeByNavProperty(e,m);g=s._filterSelectByNavProp(a,m);_=s._filterExpandByNavProp(r,m);if(f&&f.__ref){l=s._getObject("/"+f.__ref);p=h(c,l,g,_);if(p!==undefined){n[m]=p}else{o.fatal("No data loaded for expand property: "+m+" of entry: "+s.getKey(p));return undefined}}if(f&&f.__list){v=[];for(var C=0;C<f.__list.length;C++){l=s._getObject("/"+f.__list[C]);p=h(c,l,g,_);if(p!==undefined){v.push(p)}else{o.fatal("No data loaded for expand property: "+m+" of entry: "+s.getKey(p));return undefined}}n[m]=v}}u=s._filterOwnSelect(a,e.navigationProperty);for(var P=0;P<u.length;P++){m=u[P];if(i.indexOf(m)===-1){var q=n.__metadata.uri+"/"+m;n[m]={__deferred:{uri:q}}}}return n}if(a.select){u=this._splitEntries(a.select)}if(a.expand){d=this._splitEntries(a.expand)}i=h(n,i,u,d);return i};w.prototype._getObject=function(e,t,a){var s,r,i,n,o,d,u,h,f,c,p,_=this.isLegacySyntax()?this.oData:null;c=this.resolve(e,t,this.bCanonicalRequests);if(!c&&this.bCanonicalRequests){c=this.resolve(e,t)}if(!c){return _}if(this._isMetadataPath(c)){if(this.oMetadata&&this.oMetadata.isLoaded()){if(this.isMetaModelPath(c)){u=this.getMetaModel();i=D.getCodeListTerm(c);if(i){r=u.fetchCodeList(i);if(r.isFulfilled()){return r.getResult()}if(r.isRejected()){r.caught()}return undefined}if(!this.bMetaModelLoaded){return null}p=c.indexOf("/##");n=c.substr(0,p);h=c.substr(p+3);d=u.getMetaContext(n);_=u.getProperty(h,d)}else{_=this.oMetadata._getAnnotation(c)}}else if(D.getCodeListTerm(c)){return undefined}}else{if(c==="/"){return this.oData}var m=c.split("/"),y=0;o=m[1];m.splice(0,2);s=this.mChangedEntities[o];f=this._getEntity(o);_=a?f:s||f;while(_&&m[y]){var v=s&&s.hasOwnProperty(m[y]);s=s&&s[m[y]];f=f&&f[m[y]];_=a||!v?f:s;if(_){if(_.__ref){s=this.mChangedEntities[_.__ref];f=this._getEntity(_.__ref);_=a?f:s||f}else if(_.__list){_=_.__list}else if(_.__deferred){_=undefined}}y++}}if(l(s)){_=a?f:g({},f,s)}return _};w.prototype.updateSecurityToken=function(){if(this.bTokenHandling){if(!this.oSharedServiceData.securityToken){this.refreshSecurityToken()}if(this.bTokenHandling){this.oHeaders["x-csrf-token"]=this.oSharedServiceData.securityToken}}};w.prototype.resetSecurityToken=function(){delete this.oSharedServiceData.securityToken;delete this.oHeaders["x-csrf-token"];delete this.pSecurityToken};w.prototype.getSecurityToken=function(){var e=this.oSharedServiceData.securityToken;if(!e){this.refreshSecurityToken();e=this.oSharedServiceData.securityToken}return e};w.prototype.securityTokenAvailable=function(){if(!this.pSecurityToken){if(this.oSharedServiceData.securityToken){this.pSecurityToken=Promise.resolve(this.oSharedServiceData.securityToken)}else{this.pSecurityToken=new Promise(function(e,t){this.refreshSecurityToken(function(){e(this.oSharedServiceData.securityToken)}.bind(this),function(){t()},true)}.bind(this))}}return this.pSecurityToken};w.prototype.refreshSecurityToken=function(e,t,a){var s,r,i={abort:function(){this.request.abort()}},n=this._createRequestUrlWithNormalizedPath("/"),o=this;function d(t,a){if(a){r=o._getHeader("x-csrf-token",a.headers);o._setSessionContextIdHeader(o._getHeader("sap-contextid",a.headers));if(r){o.oSharedServerData.securityToken=r;o.oSharedServiceData.securityToken=r;o.pSecurityToken=Promise.resolve(r);o.oHeaders["x-csrf-token"]=r}else{o.resetSecurityToken();o.bTokenHandling=false}}if(e){e(t,a)}}function u(e){o.resetSecurityToken();o.bTokenHandling=false;o._handleError(e,s);if(t){t(e)}}function h(e){i.request=f("GET",u)}function f(e,t){s=o._createRequest(n,"",e,o._getHeaders(undefined,true),null,null,!!a);s.headers["x-csrf-token"]="Fetch";return o._request(s,d,t,undefined,undefined,o.getServiceMetadata())}if(this.bDisableHeadRequestForToken){i.request=f("GET",u)}else{i.request=f("HEAD",h)}return i};w.prototype._submitRequest=function(e,t,a){var s=this,r,i,n,o,d;o=new Promise(function(e,t){d=e});function u(e,a){if(t){t(e,a)}d()}function h(t){if(s.bTokenHandling&&t.response){var r=s._getHeader("x-csrf-token",t.response.headers);if(!e.bTokenReset&&t.response.statusCode=="403"&&r&&r.toLowerCase()==="required"){s.resetSecurityToken();e.bTokenReset=true;p();return}}if(a){a(t)}d()}function c(e){if(s.bTokenHandling&&(e.method!=="GET"||s.bTokenHandlingForGet)){s.pReadyForRequest=s.securityTokenAvailable()}return s.pReadyForRequest}function p(){if(s.bTokenHandling){delete e.headers["x-csrf-token"]}c(e).then(function(t){if(s.bTokenHandling&&(e.method!=="GET"||s.bTokenHandlingForGet)){e.headers["x-csrf-token"]=t}g()},function(){g()})}function l(e,t,a){var r,i=t.eventInfo.requests;if(i){f(i,function(t,a){if(Array.isArray(a)){a.forEach(function(t){f(t.parts,function(a,i){r=s._createEventInfo(t.request,i.fnError);s["fireRequest"+e](r)})})}else{if(a.parts){f(a.parts,function(t,i){r=s._createEventInfo(a.request,i.fnError);s["fireRequest"+e](r)})}else{r=s._createEventInfo(a.request,a.fnError);s["fireRequest"+e](r)}}});if(t.eventInfo.batch){r=s._createEventInfo(t,a,i);s["fireBatchRequest"+e](r)}}}function g(){if(s.sSessionContextId){e.headers["sap-contextid"]=s.sSessionContextId}i=s._request(e,u,h,r,undefined,s.getServiceMetadata());if(e.eventInfo){l("Sent",e,null);delete e.eventInfo}if(n&&i){i.abort()}}r=s._getODataHandler(e.requestUri);if(this.bSequentializeRequests){this.pSequentialRequestCompleted.then(function(){p()});this.pSequentialRequestCompleted=o}else{p()}return{abort:function(){if(i){i.abort()}n=true}}};w.prototype._setSessionContextIdHeader=function(e){if(e){this.sSessionContextId=e}};w.prototype._submitSingleRequest=function(e){var t=this,a,s={},r={},i={};function n(a,n){if(a===undefined&&n.statusCode===200){o({message:"Response did not contain a valid OData result",response:n});return}function d(a,n){for(var o=0;o<e.parts.length;o++){if(e.parts[o].request._aborted){t._processAborted(e.parts[o].request,n)}else if(e.parts[o].fnSuccess){e.parts[o].fnSuccess(a,n)}}if(e.request.requestUri.indexOf("$count")===-1){t.checkUpdate(false,false,r);if(e.bRefreshAfterChange){t._refresh(false,undefined,s,i)}}}t._processSuccess(e.request,n,d,r,s,i);t._invalidatePathCache();t._setSessionContextIdHeader(t._getHeader("sap-contextid",n.headers))}function o(a){if(a.message=="Request aborted"){for(var s=0;s<e.parts.length;s++){t._processAborted(e.parts[s].request,a)}}else{for(var s=0;s<e.parts.length;s++){t._processError(e.parts[s].request,a,e.parts[s].fnError)}}t._processAfterUpdate()}e.request.eventInfo={requests:e.parts,batch:false};a=this._submitRequest(e.request,n,o);return a};w.prototype._submitBatchRequest=function(e,t,a,s){var r=this,i={},n={},o={},d={};function u(e,t,a){var s,u,h;for(h=0;h<e.parts.length;h++){if(a||e.parts[h].request._aborted){r._processAborted(e.parts[h].request,t)}else if(t.message){r._processError(e.parts[h].request,t,e.parts[h].fnError)}else{if(e.request.contentID){s=e.request.contentID;if(e.request.created||e.request.functionMetadata){u=r._getKey(t.data);n[s]={key:u,deepPath:e.request.deepPath.replace("('"+s+"')",u.slice(u.indexOf("(")))}}else{u=n[s].key;e.request.requestUri=e.request.requestUri.replace("$"+s,u);e.request.deepPath=n[s].deepPath}}r._processSuccess(e.parts[h].request,t,e.parts[h].fnSuccess,o,i,d,false,undefined,n)}}}function h(s,n){if(s===undefined&&n.statusCode===200){c({message:"Response did not contain a valid OData batch result",response:n});return}var h,f,p,l=s.__batchResponses;if(l){var g,_;for(g=0;g<l.length;g++){h=l[g];if(Array.isArray(t[g])){if(h.message){for(_=0;_<t[g].length;_++){h.$reported=false;f=t[g][_];u(f,h);f.response=h}}else{p=h.__changeResponses;for(_=0;_<p.length;_++){var m=p[_];f=t[g][_];u(f,m);f.response=m}}}else{f=t[g];u(f,h);f.response=h}}r._invalidatePathCache();r.checkUpdate(false,false,o)}r._processSuccess(e,n,a,o,i,d,true,t);r._setSessionContextIdHeader(r._getHeader("sap-contextid",n.headers))}function c(a){var i=a.message=="Request aborted";a.$reported=true;f(t,function(e,t){if(Array.isArray(t)){t.forEach(function(e){u(e,a,i)})}else{u(t,a,i)}});r._processAfterUpdate();if(i){r._processAborted(e,a,true)}else{a.$reported=false;r._processError(e,a,s,true,t)}}e.eventInfo={requests:t,batch:true};var p=this._submitRequest(e,h,c);function l(e){var t;for(var a=0;a<e.parts.length;a++){t=e.parts[a].fnError;if(!e.parts[a].request._aborted&&t){t(w._createAbortedError())}}}var g={abort:function(e){f(t,function(e,t){if(Array.isArray(t)){t.forEach(function(e){l(e)})}else{l(t)}});if(s&&!e){s(w._createAbortedError())}p.abort()}};return g};w.prototype._invalidatePathCache=function(){var e=this,t;if(Object.keys(this.mInvalidatedPaths).length>0){Object.keys(this.mPathCache).forEach(function(a){for(var s in e.mInvalidatedPaths){t=a.indexOf(s);if(t>-1){if(t+s.length!==a.length){var r=a.substr(t+s.length);e.mPathCache[a].canonicalPath=e.mInvalidatedPaths[s]===null?null:e.mInvalidatedPaths[s]+r}else{e.mPathCache[a].canonicalPath=e.mInvalidatedPaths[s]}}}})}this.mInvalidatedPaths={}};w.prototype._createBatchRequest=function(e){var t,a,s={},r={},i=true;r.__batchRequests=e;for(var n in e){if(e[n]&&e[n].__changeRequests||e[n]&&e[n].headers&&!e[n].headers["sap-cancel-on-close"]){i=false;break}}t=this.sServiceUrl+"/$batch";if(this.aUrlParams.length>0){t+="?"+this.aUrlParams.join("&")}c(s,this.mCustomHeaders,this.oHeaders);s["Accept"]="multipart/mixed";delete s["Content-Type"];s["sap-cancel-on-close"]=i;a={headers:s,requestUri:t,method:"POST",data:r,user:this.sUser,password:this.sPassword,async:true};a.withCredentials=this.bWithCredentials;return a};w.prototype.abortInternalRequest=function(e,t){var a=this.mRequests;var s,r;if(t){s=t.requestKey;r=t.path}if(e in this.mDeferredGroups){a=this.mDeferredRequests}var i=function(e){for(var t=0;t<e.parts.length;t++){e.parts[t].requestHandle.abort()}};var n=a[e];if(n){if(s in n.map){i(n.map[s])}else if(r){f(n.map,function(e,t){if(e.indexOf(r)>=0){i(t)}})}else if(e&&!t){f(n.map,function(e,t){i(t)})}}};w.prototype._pushToRequestQueue=function(e,t,a,s,r,i,n,o){var d=e[t],u=s.key?s.key:s.method+":"+s.requestUri;if(this.bWarmup){return}if(!d){d={};d.map={};d.requests=[];e[t]=d}if(u in d.map&&(s.key||s.method==="GET")){var h=d.map[u];var f=h.request;s.deepPath=f.deepPath;if(this.sMessageScope===E.BusinessObject){s.headers["sap-message-scope"]=f.headers["sap-message-scope"]}if(h.bRefreshAfterChange===undefined){h.bRefreshAfterChange=o}if(!s.key){h.parts.push({request:s,fnSuccess:r,fnError:i,requestHandle:n})}if(s.method==="GET"){delete f.data}else{f.method=s.method;f.headers=s.headers;f.data=s.data;if(s.method==="PUT"){delete f.headers["x-http-method"]}if(f._aborted){delete f._aborted}}if(f.functionMetadata){f.requestUri=s.requestUri;f.functionTarget=s.functionTarget}}else{var h={request:s,bRefreshAfterChange:o,parts:[{request:s,fnSuccess:r,fnError:i,requestHandle:n}]};if(s.method==="GET"){d.requests.push(h)}else{if(!d.changes){d.changes={}}var c=d.changes[a];if(!c){c=[];d.changes[a]=c}h.changeSetId=a;c.push(h)}d.map[u]=h}};w.prototype._collectChangedEntities=function(e,t,a){var s=this;if(e.changes){f(e.changes,function(e,r){for(var i=0;i<r.length;i++){if(r[i].bRefreshAfterChange){var n=r[i].request,o="/"+n.requestUri.split("?")[0],d,u;if(n.method==="POST"||n.method==="DELETE"){var h=s.oMetadata._getEntityTypeByPath(o);if(h){a[h.entityType]=true}}else{d=s._getObject(o);if(d){u=s._getKey(d)}else if(o.lastIndexOf("/")===0){u=s._getKey(o)}if(u){t[u]=true}}}}})}};w.prototype._processRequestQueue=function(e,t,a,s){var r=this,i,n=[];function o(e,t){for(var a=0;a<e.parts.length;a++){var s=e.parts[a];if(s.request._aborted){r._processAborted(e.request,null);e.parts.splice(a,1);a--}else if(t){s.request._handle=t;t.iRelevantRequests++}}}function d(){return{iRelevantRequests:0,oRequestHandle:{},abort:function(){this.iRelevantRequests--;if(this.iRelevantRequests===0&&this.oRequestHandle){this.oRequestHandle.abort(true);if(a){a({},undefined)}}}}}if(this.bUseBatch){f(e,function(e,a){if(e===t||!t){var s={},i={};r._collectChangedEntities(a,s,i);if(Object.keys(s).length||Object.keys(i).length){r.bIncludeInCurrentBatch=true;r._refresh(false,e,s,i);r.bIncludeInCurrentBatch=false}}});f(e,function(u,h){if(u===t||!t){var c=[],p=[],l,g;var _=d();if(h.changes){f(h.changes,function(t,a){var s,n,d;l={__changeRequests:[]};g=[];for(n=0;n<a.length;n++){s=a[n].request;i="/"+r.getKey(s.data);r.increaseLaundering(i,s.data);o(a[n],_);if(a[n].parts.length>0){r.removeInternalMetadata(s.data);l.__changeRequests.push(s);if(s.expandRequest){d=a[n].parts[0];r._pushToRequestQueue(e,u,undefined,s.expandRequest,d.fnSuccess,d.fnError,d.requestHandle,false)}g.push(a[n])}}if(l.__changeRequests&&l.__changeRequests.length>0){c.push(l);p.push(g)}})}if(h.requests){var m=h.requests;for(var y=0;y<m.length;y++){o(m[y],_);if(m[y].parts.length>0){c.push(m[y].request);p.push(m[y])}}}if(c.length>0){var v=r._createBatchRequest(c);_.oRequestHandle=r._submitBatchRequest(v,p,a,s);n.push(_.oRequestHandle)}delete e[u]}})}else{f(e,function(a,s){if(a===t||!t){if(s.changes){f(s.changes,function(e,t){for(var a=0;a<t.length;a++){var s=d();i="/"+r.getKey(t[a].request.data);r.increaseLaundering(i,t[a].request.data);o(t[a],s);if(t[a].parts.length>0){r.removeInternalMetadata(t[a].request.data);s.oRequestHandle=r._submitSingleRequest(t[a]);n.push(s.oRequestHandle)}}})}if(s.requests){var u=s.requests;for(var h=0;h<u.length;h++){var c=d();o(u[h],c);if(u[h].parts.length>0){c.oRequestHandle=r._submitSingleRequest(u[h]);n.push(c.oRequestHandle)}}}delete e[a]}})}this.checkDataState(this.mLaunderingState);return n.length==1?n[0]:n};w.prototype._processRequestQueueAsync=function(e){var t=this;if(!this.pCallAsync){this.pCallAsync=this.oMetadata.loaded().then(function(){return Promise.resolve().then(function(){t._processRequestQueue(e);t.pCallAsync=undefined})})}};w.prototype._processSuccess=function(e,t,a,s,r,i,n,d,u){var h,p,l,_,m,y,v,b,C,P,q,R,M,S={},E={},T=t.data,D=this;if(!n){p=!(t.statusCode===204||t.statusCode==="204");M=e.requestUri;q=M.replace(this.sServiceUrl,"");if(!q.startsWith("/")){q="/"+q}C=this._normalizePath(q);m=this.oMetadata._getEntityTypeByPath(C);b=m&&m.isFunction;q=this._normalizePath(q,undefined,!b);this.decreaseLaundering(q,e.data);this._decreaseDeferredRequestCount(e);if(e.functionMetadata){if(t.headers&&t.headers.location){y=t.headers.location;R=y.lastIndexOf(this.sServiceUrl);if(R>-1){h=y.slice(R+this.sServiceUrl.length);if(e.functionTarget===h){l=this.getDeepPathForCanonicalPath(h);if(l){e.deepPath=l}}e.functionTarget=h}}if(e.adjustDeepPath){e.deepPath=e.adjustDeepPath({deepPath:l||e.functionTarget,response:g({},t)})}else if(!l){e.deepPath=e.functionTarget}if(u&&e.contentID){u[e.contentID].deepPath=e.deepPath}}if(p&&T===undefined&&t){this._parseResponse(t,e);o.fatal(this+" - No data was retrieved by service: '"+t.requestUri+"'");D.fireRequestCompleted({url:t.requestUri,type:"GET",async:t.async,info:"Accept headers:"+this.oHeaders["Accept"],infoObject:{acceptHeaders:this.oHeaders["Accept"]},success:false});return false}if(T&&!T.__metadata&&T.results&&!Array.isArray(T.results)){T=T.results}if(!t._imported&&T&&(Array.isArray(T)||typeof T=="object")){v=g({},T);if(e.key||e.created){D._importData(v,E,t,undefined,undefined,undefined,b)}else{D._importData(v,E,t,q,e.deepPath,undefined,b)}t._imported=true}_=this._getEntity(e.key);if(E&&_&&_.__metadata.created&&_.__metadata.created.functionImport){var U=[];var x=_["$result"];if(x&&x.__list){f(E,function(e){U.push(e)});x.__list=U}else if(x&&x.__ref){f(E,function(e){x.__ref=e})}}if(!p){P=q.split("/");if(P[1]){S[P[1]]=e;var A={};A[P[1]]=e.data;this._updateChangedEntities(A)}if(e.method==="DELETE"&&P[2]!=="$links"){this._removeEntity(P[1])}}if(p&&e.method==="POST"||e.functionMetadata){if(m){i[m.entityType]=true}if(e.key){if(e.created){var I=this._getKey(T);var O=this.getContext("/"+e.key);l=e.deepPath;if(O.isTransient()&&l.endsWith(")")){e.deepPath=l.slice(0,l.lastIndexOf("("))+I.slice(I.indexOf("("))}this._updateContext(O,"/"+I,e.deepPath);O.setUpdated(true);this.callAfterUpdate(function(){O.setUpdated(false)});_=this._getEntity(I);if(_){delete _.__metadata.created}this._removeEntity(e.key)}else{delete this.mChangedEntities[e.key]}}}this._parseResponse(t,e,E,S);c(s,E);c(r,S);this._updateETag(e,t)}if(a){a(T,t)}var k=this._createEventInfo(e,t,d);if(n){this.fireBatchRequestCompleted(k)}else{this.fireRequestCompleted(k)}return true};w.prototype._processError=function(e,t,a,s,r){var i,n;if(e.functionMetadata){e.deepPath=e.functionTarget}i=this._handleError(t,e);if(!s){n="/"+this.getKey(e.data);this.decreaseLaundering(n,e.data);this._decreaseDeferredRequestCount(e)}if(a){a(i)}var o=this._createEventInfo(e,i,r);if(s){this.fireBatchRequestCompleted(o);this.fireBatchRequestFailed(o)}else{this.fireRequestCompleted(o);this.fireRequestFailed(o)}};w.prototype._processAborted=function(e,t,a){var s,r;if(!a){r="/"+this.getKey(e.data);this.decreaseLaundering(r,e.data);this._decreaseDeferredRequestCount(e)}if(t){s=this._createEventInfo(e,w._createAbortedError());s.success=false;if(a){this.fireBatchRequestCompleted(s)}else{this.fireRequestCompleted(s)}}};w.prototype._processAfterUpdate=function(){var e=this.aCallAfterUpdate;this.aCallAfterUpdate=[];for(var t=0;t<e.length;t++){e[t]()}};w.prototype._processChange=function(e,t,a,s){var r,i,n,o,d,h,c,p,l,_,m,y,v,b=this;if(s&&this.mChangedEntities[e]&&this.mChangedEntities[e].__metadata){this.mChangedEntities[e].__metadata.deepPath=s}else if(!s&&this.mChangedEntities[e]&&this.mChangedEntities[e].__metadata&&this.mChangedEntities[e].__metadata.deepPath){s=this.mChangedEntities[e].__metadata.deepPath}n=this.oMetadata._getEntityTypeByPath(e);if(!a){a="MERGE"}l=g({},this._getObject("/"+e,true),t);if(t.__metadata&&t.__metadata.created){c=t.__metadata.created.method?t.__metadata.created.method:"POST";e=t.__metadata.created.key;i=true;p=t.__metadata.created;d=t.__metadata.created.expandRequest;r=t.__metadata.created.contentID;if(t.__metadata.created.functionImport){p.urlParameters=this._createFunctionImportParameters(t.__metadata.created.key,c,l);l=undefined}else{delete l.__metadata["uri"]}}else if(a==="MERGE"){c="MERGE";m=this._getEntity(e)}else{c="PUT"}if(l&&l.__metadata){for(var C in l.__metadata){if(C!=="type"&&C!=="uri"&&C!=="etag"&&C!=="content_type"&&C!=="media_src"){delete l.__metadata[C]}}}if(l&&n){var P=this.oMetadata._getNavigationPropertyNames(n);P.forEach(function(e){delete l[e]})}if(c==="MERGE"&&n&&m){f(l,function(t,a){if(t!=="__metadata"){if(u(m[t],a)&&!b.isLaundering("/"+e+"/"+t)){delete l[t]}}});var q="/"+e,R;f(l,function(e,t){if(e!=="__metadata"){R=b.getProperty(q+"/"+e+"/#@sap:unit");if(R){if(l[R]===undefined){l[R]=m[R]}}}});if(m.__metadata.etag){l.__metadata.etag=m.__metadata.etag}}l=this._removeReferences(l);v=p&&p.urlParameters?A._createUrlParamsArray(p.urlParameters):undefined;h=p?this._getHeaders(p.headers):this._getHeaders();o=p&&p.eTag?p.eTag:this.getETag(l);y=this._createRequestUrl("/"+e,null,v,this.bUseBatch);_=this._createRequest(y,s,c,h,l,o,undefined,true);if(i){_.created=true;if(d){_.expandRequest=d;_.contentID=r}if(t.__metadata.created.functionMetadata){_.functionTarget=this.oMetadata._getCanonicalPathOfFunctionImport(t.__metadata.created.functionMetadata,p.urlParameters)}}if(this.bUseBatch){_.requestUri=_.requestUri.replace(this.sServiceUrl+"/","")}return _};w.prototype._resolveGroup=function(e){var t,a,s,r,i,n;a=this.oMetadata._getEntityTypeByPath(e);n=this._getObject("/"+e);if(n){s=n.__metadata.created;if(s){return{groupId:s.groupId,changeSetId:s.changeSetId}}}if(this.mChangeGroups[a.name]){t=this.mChangeGroups[a.name];r=t.groupId;i=t.single?_():t.changeSetId}else if(this.mChangeGroups["*"]){t=this.mChangeGroups["*"];r=t.groupId;i=t.single?_():t.changeSetId}return{groupId:r,changeSetId:i}};w.prototype._updateETag=function(e,t){var a,s,r;a=e.requestUri.replace(this.sServiceUrl+"/","");if(!a.startsWith("/")){a="/"+a}s=this._getObject(a.split("?")[0],undefined,true);r=this._getHeader("etag",t.headers);if(s&&s.__metadata&&r){s.__metadata.etag=r}};w.prototype._handleError=function(e,t){var a,s={message:e.message};if(e.response){if(!e.$reported){this._parseResponse(e.response,t);if(this.bTokenHandling){a=this._getHeader("x-csrf-token",e.response.headers);if(e.response.statusCode=="403"&&a&&a.toLowerCase()==="required"){this.resetSecurityToken()}}}s.statusCode=e.response.statusCode;s.statusText=e.response.statusText;s.headers=e.response.headers;s.responseText=e.response.body}else if(!e.$reported){o.error("The following problem occurred: "+e.message,undefined,B)}e.$reported=true;return s};w.prototype.getData=function(e,t,a){return this.getProperty(e,t,a)};w.prototype._getODataHandler=function(e){if(e.indexOf("$batch")>-1){return k.batchHandler}else if(e.indexOf("$count")>-1){return undefined}else if(this.bJSON){return k.jsonHandler}else{return k.atomHandler}};w.prototype.getETag=function(e,t,a){if(typeof e=="object"){a=e;e=""}return this._getETag(e,t,a)};w.prototype._getETag=function(e,t,a){if(!a||!a.__metadata){a=this._getObject(e,t)}if(a&&a.__metadata){return a.__metadata.etag}return null};w.prototype.forceEntityUpdate=function(e){var t=this.mChangedEntities[e];if(t&&t.__metadata){t.__metadata.etag="*"}else{o.error(this+" - Entity with key "+e+" does not exist or has no change")}};w.prototype._createRequest=function(e,t,a,s,r,i,n,d){var u;n=n!==false;if(i&&a!=="GET"){s["If-Match"]=i}if(!s["Content-Type"]&&a!=="DELETE"&&a!=="GET"){if(this.bJSON){s["Content-Type"]="application/json"}else{s["Content-Type"]="application/atom+xml"}}if(e.indexOf("$count")>-1){s["Accept"]="text/plain, */*;q=0.5"}if(a==="MERGE"&&!this.bUseBatch){s["x-http-method"]="MERGE";a="POST"}if(this.sMessageScope===E.BusinessObject){if(this.bIsMessageScopeSupported){s["sap-message-scope"]=this.sMessageScope}else{o.error("Message scope 'sap.ui.model.odata.MessageScope.BusinessObject' is not"+" supported by the service: "+this.sServiceUrl,undefined,B)}}d=d&&this.sMessageScope===E.BusinessObject&&this.bIsMessageScopeSupported;if(this.bUseBatch&&a!=="GET"&&a!=="HEAD"&&!s["Content-ID"]){s["Content-ID"]=_()}u={headers:s,requestUri:e,method:a,user:this.sUser,password:this.sPassword,async:n,deepPath:t,updateAggregatedMessages:d};if(r){u.data=r}if(this.bWithCredentials){u.withCredentials=this.bWithCredentials}u.requestID=this._createRequestID();return u};w.prototype._processRequest=function(e,t,a){var s,r,i=false,n=this;if(this.bWarmup){return{abort:function(){}}}if(a){this.iPendingDeferredRequests+=1}r={abort:function(){if(a&&!i){n.iPendingDeferredRequests-=1}if(!i&&t){t(w._createAbortedError())}if(s){s._aborted=true;if(s._handle){s._handle.abort()}}i=true}};this.oMetadata.loaded().then(function(){s=e(r);if(s){s.deferred=!!a}n._processRequestQueueAsync(n.mRequests);if(i){r.abort()}});return r};w.prototype.update=function(e,t,a){var s,r,i,n,o,d,u,h,f,c,p,l,g,_,m,y=this,v,b,C;if(a){h=a.groupId||a.batchGroupId;f=a.changeSetId;o=a.context;s=a.success;r=a.error;d=a.eTag;p=a.headers;c=a.urlParameters;_=a.refreshAfterChange;C=a.canonicalRequest;if(a.merge!==undefined){l=a.merge?"MERGE":"PUT"}}C=this._isCanonicalRequestNeeded(C);m=h in y.mDeferredGroups;_=this._getRefreshAfterChange(_,h);u=A._createUrlParamsArray(c);p=this._getHeaders(p);l=l?l:this.sDefaultUpdateMethod;d=d||this._getETag(e,o,t);v=this._normalizePath(e,o,C);b=this.resolveDeep(e,o);return this._processRequest(function(e){n=y._createRequestUrlWithNormalizedPath(v,u,y.bUseBatch);i=y._createRequest(n,b,l,p,t,d);g=y.mRequests;if(m){g=y.mDeferredRequests}y._pushToRequestQueue(g,h,f,i,s,r,e,_);return i},r,m)};w.prototype.create=function(e,t,a){var s,r,i,n,o,d,u,h,f,c,p,l,g,_,m,y,v=this,b,C,P;if(a){n=a.context;u=a.urlParameters;o=a.success;d=a.error;l=a.groupId||a.batchGroupId;_=a.changeSetId;p=a.eTag;f=a.headers;m=a.refreshAfterChange;P=a.canonicalRequest}P=this._isCanonicalRequestNeeded(P);m=this._getRefreshAfterChange(m,l);c=A._createUrlParamsArray(u);f=this._getHeaders(f);g="POST";y=l in v.mDeferredGroups;b=v._normalizePath(e,n,P);C=this.resolveDeep(e,n);return this._processRequest(function(e){r=v._createRequestUrlWithNormalizedPath(b,c,v.bUseBatch);s=v._createRequest(r,C,g,f,t,p);s.created=true;i=v.oMetadata._getEntityTypeByPath(b);s.entityTypes={};if(i){s.entityTypes[i.entityType]=true}h=v.mRequests;if(y){h=v.mDeferredRequests}v._pushToRequestQueue(h,l,_,s,o,d,e,m);return s},d,y)};w.prototype.remove=function(e,t){var a,s,r,i,n,o,d,u,h,f,c,p,l,g,_,m,y,v,b,C=this.bCanonicalRequests,P=this;if(t){u=t.groupId||t.batchGroupId;a=t.changeSetId;s=t.context;m=t.success;o=t.error;d=t.eTag;h=t.headers;b=t.urlParameters;l=t.refreshAfterChange;C=t.canonicalRequest}C=this._isCanonicalRequestNeeded(C);l=this._getRefreshAfterChange(l,u);v=A._createUrlParamsArray(b);h=this._getHeaders(h);c="DELETE";d=d||this._getETag(e,s);n=u in P.mDeferredGroups;p=this._normalizePath(e,s,C);i=this.resolveDeep(e,s);function q(e,t){P._removeEntity(f);if(r&&r.isTransient()===false){P.oCreatedContextsCache.findAndRemoveContext(r)}if(m){m(e,t)}}return this._processRequest(function(e){y=P._createRequestUrlWithNormalizedPath(p,v,P.bUseBatch);f=y.substr(y.lastIndexOf("/")+1);f=f.split("?")[0];r=P.mContexts["/"+f];g=P._createRequest(y,i,c,h,undefined,d,undefined,true);_=P.mRequests;if(n){_=P.mDeferredRequests}P._pushToRequestQueue(_,u,a,g,q,o,e,l);return g},o,n)};w.prototype.callFunction=function(e,t){var a,s,r,i,n,d,u,h,f,c,p,l,g,m,y=this;if(!e.startsWith("/")){o.fatal("callFunction: sFunctionName has to be absolute, but the given '"+e+"' is not absolute",this,B);return undefined}t=t||{};a=t.changeSetId;r=t.error;i=t.eTag;n=t.expand;d=t.groupId||t.batchGroupId;u=t.headers;h=t.method||"GET";f=t.refreshAfterChange;g=t.success;m=Object.assign({},t.urlParameters);if(n){if(!this.bUseBatch){throw new Error("Use 'expand' parameter only with 'useBatch' set to 'true'")}if(h!=="POST"){throw new Error("Use 'expand' parameter only with HTTP method 'POST'")}}f=this._getRefreshAfterChange(f,d);s=new Promise(function(e,t){l=e;c=t});p=this._processRequest(function(s){var p,v,b,C,P,q,R,M,S,E,T,D={},U=r,x=false,I=g;b=y.oMetadata._getFunctionImportMetadata(e,h);if(!b){o.error("Function '"+e+"' not found in the metadata",y,B);c();return undefined}if(b.entitySet||b.entitySetPath){D.$result={__list:[]};if(b.returnType&&!b.returnType.startsWith("Collection")){D.$result={__ref:{}}}}if(n&&(!D.$result||!D.$result.__ref)){c(new Error("Use 'expand' parameter only for functions returning a single"+" entity"));return undefined}if(b.parameter!=null){b.parameter.forEach(function(t){D[t.name]=y._createPropertyValue(t.type);if(m[t.name]!==undefined){D[t.name]=m[t.name];m[t.name]=A.formatValue(m[t.name],t.type)}else{o.warning("No value given for parameter '"+t.name+"' of function import '"+e+"'",y,B)}})}S=_();if(n){u=Object.assign({},u,{"Content-ID":S,"sap-messages":"transientOnly"});g=function(e,t){if(!P){P=e;C=t;return}if(I){e=Object.assign({},P,e);I(e,C)}};r=function(t){if(P){C.expandAfterFunctionCallFailed=true;t.expandAfterFunctionCallFailed=true;o.error("Function '"+e+"' was called successfully, but"+" expansion of navigation properties ("+n+") failed",t,B);if(I){I(P,C)}return}if(!x){x=true;if(U){U(t)}}else{t.expandAfterFunctionCallFailed=true}}}D.__metadata={uri:y.sServiceUrl+e+"('"+S+"')",created:{changeSetId:a,error:r,eTag:i,functionImport:true,groupId:d,headers:Object.assign({},u),key:e.substring(1),method:h,success:g}};q=y._addEntity(D);p=y.getContext("/"+q);y._writePathCache("/"+q,"/"+q);l(p);T=A._createUrlParamsArray(m);E=y._createRequestUrlWithNormalizedPath(e,T,y.bUseBatch);R=y._createRequest(E,e,h,y._getHeaders(u),undefined,i,undefined,true);R.adjustDeepPath=t.adjustDeepPath;R.functionMetadata=b;D.__metadata.created.functionMetadata=b;R.functionTarget=y.oMetadata._getCanonicalPathOfFunctionImport(b,m);R.key=q;if(n){v=y._createRequest("$"+S+"?"+A._encodeURLParameters({$expand:n,$select:n}),"/$"+S,"GET",y._getHeaders(undefined,true),undefined,undefined,undefined,true);v.contentID=S;R.expandRequest=v;R.contentID=S}M=y.mRequests;if(d in y.mDeferredGroups){M=y.mDeferredRequests}y._pushToRequestQueue(M,d,a,R,g,r,s,f);return R},r);p.contextCreated=function(){return s};return p};w.prototype._createFunctionImportParameters=function(e,t,a){var s=h({},a);delete s.__metadata;delete s["$result"];var r=this.oMetadata._getFunctionImportMetadata(e,t);n(r,this+": Function "+e+" not found in the metadata !");if(!r){return}if(r.parameter!=null){f(r.parameter,function(e,t){if(s&&s[t.name]!==undefined){s[t.name]=A.formatValue(s[t.name],t.type)}})}return s};w.prototype._getResourcePath=function(e,t,a,s){var r,i,n,o;if(!e){return this.resolve(a,s)}n=this.oMetadata._splitByLastNavigationProperty(t);i=n.pathBeforeLastNavigationProperty;r=n.lastNavigationProperty;if(r.includes("(")&&n.addressable){o=this.resolve(i+r,undefined,true);if(o){return o+n.pathAfterLastNavigationProperty}}o=this.resolve(i,undefined,true)||i;return o+r+n.pathAfterLastNavigationProperty};w.prototype.read=function(e,t){var a,s,r,i,n,o,d,u,h,f,c,p,l,g,_=this;if(t){a=t.canonicalRequest;s=t.context;r=t.error;n=t.filters;o=t.groupId||t.batchGroupId;d=t.headers;f=t.sorters;c=t.success;p=t.updateAggregatedMessages;g=t.urlParameters}a=this._isCanonicalRequestNeeded(a);if(e&&e.indexOf("?")!==-1){e=e.slice(0,e.indexOf("?"))}if(this.sRefreshGroupId){o=this.sRefreshGroupId}l=A._createUrlParamsArray(g);d=this._getHeaders(d,true);u="GET";i=this._getETag(e,s);var m={abort:function(){if(h){h._aborted=true}}};function y(t){var g,m,y,v,b,C,P=_.resolveDeep(e,s),q=_._getResourcePath(a,P,e,s);b=A.createSortParams(f);if(b){l.push(b)}g=_.oMetadata._getEntityTypeByPath(q);m=R.groupFilters(n);y=A.createFilterParams(m,_.oMetadata,g);if(y){l.push(y)}C=_._createRequestUrlWithNormalizedPath(q,l,_.bUseBatch);h=_._createRequest(C,P,u,d,null,i,undefined,p);v=_.mRequests;if(o in _.mDeferredGroups){v=_.mDeferredRequests}_._pushToRequestQueue(v,o,null,h,c,r,t,false);return h}if(this.bUseBatch&&this.bIncludeInCurrentBatch){h=y(m);return m}else{return this._processRequest(y,r)}};w.prototype.getServiceMetadata=function(){if(this.oMetadata&&this.oMetadata.isLoaded()){return this.oMetadata.getServiceMetadata()}};w.prototype.metadataLoaded=function(e){var t=this.oMetadata.loaded(e);if(this.bLoadAnnotationsJoined){if(e){return Promise.all([t,this.pAnnotationsLoaded])}var a=function(){return t};return this.pAnnotationsLoaded.then(a,a)}else{return t}};w.prototype.annotationsLoaded=function(){return this.pAnnotationsLoaded};w.prototype.isMetadataLoadingFailed=function(){return this.oMetadata.isFailed()};w.prototype.getServiceAnnotations=function(){var e=this.oAnnotations.getData();return p(e)?null:e};w.prototype.onAnnotationsFailed=function(e){this.fireAnnotationsFailed(e.getParameters())};w.prototype.onAnnotationsLoaded=function(e){this.fireAnnotationsLoaded(e.getParameters())};w.prototype.addAnnotationUrl=function(e){var t=[].concat(e),a=[],s=[],r=[],i=this;t.forEach(function(e){var t=e.indexOf("$metadata");if(t>=0){e=i._createMetadataUrl(e);a.push(e)}else{s.push(e)}});return this.oMetadata._addUrl(a).then(function(e){return Promise.all(e.map(function(e){r=r.concat(e.entitySets);return i.oAnnotations.addSource({type:"xml",data:e["metadataString"]})}))}).then(function(){return i.oAnnotations.addSource(s)}).then(function(e){return{annotations:i.oAnnotations.getData(),entitySets:r}})};w.prototype.addAnnotationXML=function(e,t){return this.oAnnotations.addSource({type:"xml",data:e})};w.prototype.submitChanges=function(e){var t,a,s,r,i,n,d,u=false,h,c,p=this.bRefreshAfterChange,l,_=this;if(e){a=e.groupId||e.batchGroupId;r=e.success;i=e.error;if(e.merge!==undefined){h=e.merge?"MERGE":"PUT"}}if(a&&!this.mDeferredGroups[a]){o.fatal(this+' submitChanges: "'+a+'" is not a deferred group!')}c=g({},_.mChangedEntities);this.oMetadata.loaded().then(function(){f(c,function(e,r){s=_._resolveGroup(e);if(s.groupId===a||!a){t=_._processChange(e,r,h||_.sDefaultUpdateMethod);t.key=e;l=r.__metadata&&r.__metadata.created?r.__metadata.created:{};var i={abort:function(){t._aborted=true}};if(s.groupId in _.mDeferredGroups){_._pushToRequestQueue(_.mDeferredRequests,s.groupId,s.changeSetId,t,l.success,l.error,i,p)}}});var e,o,g,m,y,v;for(e in _.mDeferredRequests){g=_.mDeferredRequests[e];for(o in g.changes){m=g.changes[o];for(v=m.length-1;v>=0;v--){y=m[v];if(y.bRefreshAfterChange===undefined){y.bRefreshAfterChange=p}}}}d=_._processRequestQueue(_.mDeferredRequests,a,r,i);if(u){n.abort()}if(Array.isArray(d)&&d.length==0&&r){r({},undefined)}});n={abort:function(){if(d){if(Array.isArray(d)){d.forEach(function(e){e.abort()})}else{d.abort()}}else{u=true}}};return n};w.prototype._updateChangedEntities=function(e){var t=this,a,s,r;function i(e,n,o){f(n,function(d){var h=o+"/"+d;if(l(n[d])&&l(e[d])){i(e[d],n[d],h);if(p(n[d])){delete n[d]}}else if(o.endsWith("__metadata")||u(n[d],e[d])&&!t.isLaundering(h)){delete n[d];if(o===a){s=t.oMetadata._getEntityTypeByPath(a);r=s&&t.oMetadata._getNavPropertyRefInfo(s,d);if(r&&n[r.name]){e[r.name]=n[r.name];delete n[r.name]}}}})}f(e,function(e,s){if(e in t.mChangedEntities){var r=t._getObject("/"+e,null,true);var n=t._getObject("/"+e);g(r,s);a="/"+e;var o=t.removeInternalMetadata(n).deepPath;i(r,n,a);if(p(n)){delete t.mChangedEntities[e];t.abortInternalRequest(t._resolveGroup(e).groupId,{requestKey:e})}else{t.mChangedEntities[e]=n;n.__metadata={deepPath:o};c(n.__metadata,r.__metadata)}}})};w.prototype._discardEntityChanges=function(e,t,a){var s=a&&a.created,r=true,i=this._resolveGroup(e).groupId,n=this.oMetadata.loaded(),o=this;n.then(function(){o.abortInternalRequest(i,{requestKey:e})});if(t&&s){this._removeEntity(e);if(s.abort){s.abort(w._createAbortedError())}r=false}else{delete this.mChangedEntities[e]}sap.ui.getCore().getMessageManager().removeMessages(this.getMessagesByEntity(e,r));return n};w.prototype.resetChanges=function(e,t,a){var s=this.oMetadata.loaded(),r=this;if(t){s.then(function(){f(r.mDeferredGroups,function(t){if(e){e.forEach(function(e){r.abortInternalRequest(t,{path:e.substring(1)})})}else{r.abortInternalRequest(t)}})})}if(e){f(e,function(e,t){var s,i,n,o,d,u,h={};if(r.getEntityByPath(t,null,h)){u=h.propertyPath.split("/");d=u[u.length-1];o=h.key;s=r.mChangedEntities[o];if(s){for(n=0;n<u.length-1;n+=1){if(s&&s.hasOwnProperty(u[n])){s=s[u[n]]}else{s=undefined;break}}if(s&&s.hasOwnProperty(d)){delete s[d]}i=r.mChangedEntities[o].__metadata;delete r.mChangedEntities[o].__metadata;if(p(r.mChangedEntities[o])||!h.propertyPath){r._discardEntityChanges(o,a,i)}else{r.mChangedEntities[o].__metadata=i}}}})}else{f(this.mChangedEntities,function(e,t){r._discardEntityChanges(e,a,t.__metadata)})}this.checkUpdate(true);return s};w.prototype.setProperty=function(e,t,a,s){var r,i,n,o,d,h,c,g,_,m,y,v,b={},C={},P,q,R,M=false,S=this,E,T,D,U,x,A,I;function O(e,t){f(t,function(a){if(l(t[a])&&l(e[a])){O(e[a],t[a]);if(p(t[a])){delete t[a]}}else if(u(t[a],e[a])){delete t[a]}})}c=this.resolve(e,a);I=this.resolveDeep(e,a);h=this.getEntityByPath(c,null,C);if(!h){return false}i=c.substring(c.lastIndexOf("/")+1);_=C.key;d=this._getObject("/"+_,null,true);r=this._getObject(e,a,true);if(!this.mChangedEntities[_]){v=h.__metadata;h={};h.__metadata=Object.assign({},v);if(C.propertyPath.length>0){var k=I.lastIndexOf(C.propertyPath);h.__metadata.deepPath=I.substring(0,k-1)}this.mChangedEntities[_]=h}q=this.mChangedEntities[_];g=C.propertyPath.split("/");for(var H=0;H<g.length-1;H++){if(!q.hasOwnProperty(g[H])){q[g[H]]={}}q=q[g[H]]}M=d.__metadata.created&&d.__metadata.created.functionImport;q[i]=t;T=this.oMetadata._getEntityTypeByPath(C.key);D=T&&this.oMetadata._getNavPropertyRefInfo(T,i);U=D&&d[D.name]&&d[D.name].__ref;if(U&&D.keys.length===1){if(t===null){A=null}else{x={};D.keys.forEach(function(e){x[e]=h[e]!==undefined?h[e]:d[e]});x[D.keys[0]]=t;A=this.createKey(D.entitySet,x)}q[D.name]={__ref:A}}if(u(t,r)&&!this.isLaundering("/"+_)&&!M){v=this.mChangedEntities[_].__metadata;E=v&&v.created;delete this.mChangedEntities[_].__metadata;if(!E){O(d,this.mChangedEntities[_])}if(p(this.mChangedEntities[_])){delete this.mChangedEntities[_];b[_]=true;this.checkUpdate(false,s,b);S.oMetadata.loaded().then(function(){S.abortInternalRequest(S._resolveGroup(_).groupId,{requestKey:_})});return true}this.mChangedEntities[_].__metadata=v}m=this._resolveGroup(_);n=this.mRequests;if(m.groupId in this.mDeferredGroups){n=this.mDeferredRequests;o=this._processChange(_,{__metadata:h.__metadata},this.sDefaultUpdateMethod)}else{o=this._processChange(_,this._getObject("/"+_),this.sDefaultUpdateMethod)}o.key=_;P=q.__metadata&&q.__metadata.created?q.__metadata.created:{};R=this._getRefreshAfterChange(undefined,m.groupId);this.oMetadata.loaded().then(function(){y={abort:function(){o._aborted=true}};S._pushToRequestQueue(n,m.groupId,m.changeSetId,o,P.success,P.error,y,R);S._processRequestQueueAsync(S.mRequests)});b[_]=true;this.checkUpdate(false,s,b);return true};w.prototype._isHeaderPrivate=function(e){switch(e.toLowerCase()){case"accept":case"accept-language":case"maxdataserviceversion":case"dataserviceversion":return true;case"x-csrf-token":return this.bTokenHandling;case"sap-contextid-accept":case"sap-contextid":return!this.bDisableSoftStateHeader;default:return false}};w.prototype.setHeaders=function(e){var t={},a=this;this.mCustomHeaders={};if(e){f(e,function(e,s){if(a._isHeaderPrivate(e)){o.warning(this+" - modifying private header: '"+e+"' not allowed!")}else{t[e]=s}});this.mCustomHeaders=t}if(this.oAnnotations){this.oAnnotations.setHeaders(this.mCustomHeaders)}};w.prototype._getHeaders=function(e,t){var a={},s=this;if(e){f(e,function(e,t){if(s._isHeaderPrivate(e)){o.warning(this+" - modifying private header: '"+e+"' not allowed!")}else{a[e]=t}})}return c({"sap-cancel-on-close":!!t},this.mCustomHeaders,a,this.oHeaders)};w.prototype.getHeaders=function(){return c({},this.mCustomHeaders,this.oHeaders)};w.prototype._getHeader=function(e,t){var a;for(a in t){if(a.toLowerCase()===e.toLowerCase()){return t[a]}}return null};w.prototype.hasPendingChanges=function(e){var t=!p(this.mChangedEntities);if(e){t=t||this.iPendingDeferredRequests>0}return t};w.prototype.hasPendingRequests=function(){return this.aPendingRequestHandles.length>0};w.prototype.getPendingChanges=function(){return g({},this.mChangedEntities)};w.prototype.updateBindings=function(e){this.checkUpdate(e)};w.prototype.setTokenHandlingEnabled=function(e){this.bTokenHandling=e};w.prototype.setUseBatch=function(e){this.bUseBatch=e};w.prototype.formatValue=function(e,t){return A.formatValue(e,t)};w.prototype.deleteCreatedEntry=function(e){var t=this,a,s;if(e){var a=e.getPath().substr(1);s=this._resolveGroup(a).groupId;t.oMetadata.loaded().then(function(){t.abortInternalRequest(s,{requestKey:a})});t._removeEntity(a);sap.ui.getCore().getMessageManager().removeMessages(this.getMessagesByEntity(e.getPath(),true))}};w.prototype.createEntry=function(e,t){var a,s,r,i,d,u,h,f,c,p,l,m,v,b,C,P,q,R,M,S,E,T,D={},U="POST",x=this;if(t){C=t.properties;l=t.groupId||t.batchGroupId;s=t.changeSetId;r=t.context;M=t.success;f=t.error;i=t.created;c=t.eTag;m=t.headers;T=t.urlParameters;P=t.refreshAfterChange;a=t.canonicalRequest;p=t.expand}if(p&&!this.bUseBatch){throw new Error("The 'expand' parameter is only supported if batch mode is used")}a=this._isCanonicalRequestNeeded(a);m=m||{};P=this._getRefreshAfterChange(P,l);l=l?l:this.sDefaultChangeGroup;E=A._createUrlParamsArray(T);var I={abort:function(){if(q){q._aborted=true;if(q.expandRequest){q.expandRequest._aborted=true}}}};if(!e.startsWith("/")&&!r){e="/"+e}b=x._normalizePath(e,r,a);h=x.resolveDeep(e,r);function O(){var e,t,a,r,i,O,k=false,H=f,L=M;var F=x.oMetadata._getEntityTypeByPath(b);if(!F){n(F,"No Metadata for collection "+b+" found");return undefined}if(typeof C==="object"&&!Array.isArray(C)){D=g({},C)}else{for(var G=0;G<F.property.length;G++){var w=F.property[G];var j=(C?C.indexOf(w.name):-1)>-1;if(!C||j){D[w.name]=x._createPropertyValue(w.type);if(j){C.splice(C.indexOf(w.name),1)}}}if(C){n(C.length===0,"No metadata for the following properties found: "+C.join(","))}}r=x.oMetadata._getEntitySetByType(F);O=_();v=r.name+"('"+O+"')";if(h&&x.oMetadata._isCollection(h)){h=h+"('"+O+"')"}if(p){m=Object.assign({},m,{"Content-ID":O,"sap-messages":"transientOnly"});M=function(t,s){if(!e){e=t;a=s;return}if(L){t=Object.assign({},e,t);L(t,a)}u()};f=function(t){if(e){a.expandAfterCreateFailed=true;t.expandAfterCreateFailed=true;o.error("Entity creation was successful but expansion of navigation"+" properties failed",t,B);if(L){L(e,a)}u();return}if(!k){k=true;if(H){H(t)}}else{t.expandAfterCreateFailed=true;k=false}}}else{M=function(e,t){if(L){L(e,t)}u()}}D.__metadata={type:""+F.entityType,uri:x.sServiceUrl+"/"+v,created:{key:b.substring(1),success:M,error:f,headers:m,urlParameters:T,groupId:l,changeSetId:s,eTag:c},deepPath:h};d=new y(function(e,t){u=e;D.__metadata.created.abort=t});d.catch(function(){});v=x._addEntity(g({},D));x.mChangedEntities[v]=D;S=x._createRequestUrlWithNormalizedPath(b,E,x.bUseBatch);q=x._createRequest(S,h,U,m,D,c);if(p){i=x._createRequest("$"+O+"?"+A._encodeURLParameters({$expand:p,$select:p}),"/$"+O,"GET",x._getHeaders(undefined,true),null,undefined,undefined,true);i.contentID=O;q.expandRequest=i;q.contentID=O;D.__metadata.created.expandRequest=i;D.__metadata.created.contentID=O}t=x.getContext("/"+v,h,d);q.key=v;q.created=true;R=x.mRequests;if(l in x.mDeferredGroups){R=x.mDeferredRequests}x.oMetadata.loaded().then(function(){x._pushToRequestQueue(R,l,s,q,M,f,I,P);x._processRequestQueueAsync(x.mRequests)});return t}if(i){this.oMetadata.loaded().then(function(){i(O())})}else if(this.oMetadata.isLoaded()){return O()}else{o.error("Tried to use createEntry without created-callback, before metadata is available!")}};w.prototype._isCreatedEntity=function(e){return!!(e&&e.__metadata&&e.__metadata.created)};w.prototype._createPropertyValue=function(e){var t=this.oMetadata._splitName(e);var a=t.namespace;var s=t.name;if(a.toUpperCase()!=="EDM"){var r={};var i=this.oMetadata._getObjectMetadata("complexType",s,a);n(i,"Complex type "+e+" not found in the metadata !");for(var o=0;o<i.property.length;o++){var d=i.property[o];r[d.name]=this._createPropertyValue(d.type)}return r}else{return this._getDefaultPropertyValue(s,a)}};w.prototype._getDefaultPropertyValue=function(e,t){return undefined};w.prototype._normalizePath=function(e,t,a){if(e&&e.indexOf("?")!==-1){e=e.substr(0,e.indexOf("?"))}if(!t&&!e.startsWith("/")){o.fatal(this+" path "+e+" must be absolute if no Context is set")}return this.resolve(e,t,a)||this.resolve(e,t)};w.prototype.getRefreshAfterChange=function(){return this.bRefreshAfterChange};w.prototype.setRefreshAfterChange=function(e){this.bRefreshAfterChange=e};w.prototype.isList=function(e,t){e=this.resolve(e,t);return e&&e.substr(e.lastIndexOf("/")).indexOf("(")===-1};w.prototype._isMetadataPath=function(e){var t=false;if(e&&e.indexOf("/#")>-1){t=true}return t};w.prototype.isMetaModelPath=function(e){return e.indexOf("##")==0||e.indexOf("/##")>-1};w.prototype._request=function(e,t,a,s,r,i){var n;if(this.bDestroyed){return{abort:function(){}}}var o=this;function d(e){return function(){if(o.aPendingRequestHandles){var t=o.aPendingRequestHandles.indexOf(n);if(t>-1){o.aPendingRequestHandles.splice(t,1)}}if(!(n&&n.bSuppressErrorHandlerCall)){e.apply(this,arguments)}}}n=k.request(e,d(t||k.defaultSuccess),d(a||k.defaultError),s,r,i);if(e.async!==false){this.aPendingRequestHandles.push(n)}return n};w.prototype.destroy=function(){this.bDestroyed=true;M.prototype.destroy.apply(this,arguments);if(this.aPendingRequestHandles){for(var e=this.aPendingRequestHandles.length-1;e>=0;e--){var t=this.aPendingRequestHandles[e];if(t&&t.abort){t.bSuppressErrorHandlerCall=true;t.abort()}}delete this.aPendingRequestHandles}if(this.sMetadataLoadEvent){clearTimeout(this.sMetadataLoadEvent)}if(this.oMetadataFailedEvent){clearTimeout(this.oMetadataFailedEvent)}if(this.oMetadata){this.oMetadata.detachFailed(this.onMetadataFailed);if(!this.oMetadata.isLoaded()&&!this.oMetadata.hasListeners("loaded")){this.oMetadata.destroy();delete this.oSharedMetaData.oMetadata}delete this.oMetadata;delete this.pMetadataLoaded}if(this.oMetaModel){this.oMetaModel.destroy();delete this.oMetaModel}if(this.oAnnotations){this.oAnnotations.detachSomeLoaded(this.onAnnotationsLoaded);this.oAnnotations.detachAllFailed(this.onAnnotationsFailed);this.oAnnotations.destroy();delete this.oAnnotations;delete this.pAnnotationsLoaded}};w.prototype.setDeferredBatchGroups=function(e){this.setDeferredGroups(e)};w.prototype.setDeferredGroups=function(e){var t=this;this.mDeferredGroups={};f(e,function(e,a){t.mDeferredGroups[a]=a})};w.prototype.getDeferredBatchGroups=function(){return this.getDeferredGroups()};w.prototype.getDeferredGroups=function(){return Object.keys(this.mDeferredGroups)};w.prototype.setChangeBatchGroups=function(e){f(e,function(e,t){t.groupId=t.batchGroupId});this.setChangeGroups(e)};w.prototype.setChangeGroups=function(e){this.mChangeGroups=e};w.prototype.getChangeBatchGroups=function(){return this.getChangeGroups()};w.prototype.getChangeGroups=function(){return this.mChangeGroups};w.prototype.setMessageParser=function(e){if(!(e instanceof C)){o.error("Given MessageParser is not of type sap.ui.core.message.MessageParser");return this}e.setProcessor(this);this.oMessageParser=e;return this};w.prototype._parseResponse=function(e,t,a,s){try{if(!this.oMessageParser){this.oMessageParser=new U(this.sServiceUrl,this.oMetadata,!!this.bPersistTechnicalMessages);this.oMessageParser.setProcessor(this)}this.oMessageParser.parse(e,t,a,s,this.bIsMessageScopeSupported)}catch(e){o.error("Error parsing OData messages: "+e)}};w.prototype.callAfterUpdate=function(e){this.aCallAfterUpdate.push(e)};w.prototype.getMetaModel=function(){var e=this;if(!this.oMetaModel){this.oMetaModel=new D(this.oMetadata,this.oAnnotations,this);this.oMetaModel.loaded().then(function(){e.bMetaModelLoaded=true;e.checkUpdate(false,false,null,true)},function(e){var t=e.message,a;if(!t&&e.xmlDoc&&e.xmlDoc.parseError){t=e.xmlDoc.parseError.reason;a=e.xmlDoc.parseError.srcText}o.error("error in ODataMetaModel.loaded(): "+t,a,B)})}return this.oMetaModel};w.prototype.getOriginalProperty=function(e,t){return this._getObject(e,t,true)};w.prototype.getEntityByPath=function(e,t,a){var s=M.prototype.resolve.call(this,e,t);if(!s){return null}var r=s.split("/"),i=null,n=[];while(r.length>0){var o=r.join("/"),d=this._getObject(o);if(l(d)){var u=this._getKey(d);if(u){i=d;break}}n.unshift(r.pop())}if(i){a.propertyPath=n.join("/");a.key=u;return i}return null};w.prototype.resolveFromCache=function(e){if(!this.mPathCache){return undefined}var t,a="",s,r,i;s=this.mPathCache[e]?this.mPathCache[e].canonicalPath:undefined;if(e&&s!==e){t=s||e;if(!s){i=t.lastIndexOf("/");a=t.substr(i);t=t.substr(0,i)}r=this.resolveFromCache(t);if(r&&r!==t){s=r+a}}return s};w.prototype.resolve=function(e,t,a){var s=M.prototype.resolve.call(this,e,t);if(s&&!this._isMetadataPath(s)&&a){var r=this.resolveFromCache(s);if(!r){r=this.oMetadata._calculateCanonicalPath(s);r=this.resolveFromCache(r)||r}this._writePathCache(s,r);return r}return s};w.prototype.resolveDeep=function(e,t){var a=M.prototype.resolve.call(this,e,t);if(e&&!e.startsWith("/")){a=t?t.sDeepPath+"/"+e:a}if(e===""){a=t?t.sDeepPath:a}return a};w.prototype.isLaundering=function(e,t){var a=this.resolve(e,t);return a in this.mLaunderingState&&this.mLaunderingState[a]>0};w.prototype.increaseLaundering=function(e,t){if(!l(t)){return}for(var a in t){if(a==="__metadata"){continue}var s=t[a];if(l(s)){this.increaseLaundering(e+"/"+a,s)}else{var r=e+"/"+a;if(!(r in this.mLaunderingState)){this.mLaunderingState[r]=0}this.mLaunderingState[r]++}}if(!(e in this.mLaunderingState)){this.mLaunderingState[e]=0}this.mLaunderingState[e]++};w.prototype.decreaseLaundering=function(e,t){if(!l(t)){return}for(var a in t){if(a==="__metadata"){continue}var s=t[a],r=e+"/"+a;if(l(s)){this.decreaseLaundering(r,s)}else{if(r in this.mLaunderingState){this.mLaunderingState[r]--;if(this.mLaunderingState[r]===0){delete this.mLaunderingState[r]}}}}this.mLaunderingState[e]--;if(this.mLaunderingState[e]===0){delete this.mLaunderingState[e]}};w.prototype._getRefreshAfterChange=function(e,t){if(e===undefined&&!(t in this.mDeferredGroups)){return this.bRefreshAfterChange}return e};w.prototype.getMessagesByEntity=function(e,t){var a=e,s=[],r;function i(e){var a=[];for(var s=0;s<e.length;s++){if(!t||t&&!e[s].persistent){a.push(e[s])}}return a}if(!a.startsWith("/")){a="/"+a}if(this.mMessages){for(r in this.mMessages){if(typeof a=="string"&&a.length>0&&r.startsWith(a)){s=s.concat(i(this.mMessages[r]))}}return s}return null};w.prototype._cacheSupported=function(e){var t=/\/~[\w\-]+~[A-Z0-9]?/;var a=[e];if(this.sAnnotationURI){if(!Array.isArray(this.sAnnotationURI)){this.sAnnotationURI=[this.sAnnotationURI]}a=a.concat(this.sAnnotationURI)}a=a.filter(function(e){return e.indexOf("sap-context-token")===-1});a=a.filter(function(e){return!t.test(e)});return a.length===0?true:false};w.prototype._getAnnotationCacheKey=function(e){var t;if(this.bUseCache){if(!this.bSkipMetadataAnnotationParsing){t=e+"#annotations"}if(this.sAnnotationURI){if(!Array.isArray(this.sAnnotationURI)){this.sAnnotationURI=[this.sAnnotationURI]}this.sAnnotationURI=this.sAnnotationURI.map(function(e){return e+"#annotations"});t=this.bSkipMetadataAnnotationParsing?this.sAnnotationURI.join("_"):t+"_"+this.sAnnotationURI.join("_")}}return t};w.prototype.canonicalRequestsEnabled=function(){return this.bCanonicalRequests};w.prototype._decreaseDeferredRequestCount=function(e){if(e.deferred){this.iPendingDeferredRequests--}};w.prototype.enableCanonicalRequests=function(e){this.bCanonicalRequests=!!e};w.prototype.getMessageScope=function(){return this.sMessageScope};w.prototype.setMessageScope=function(e){if(e!==E.RequestedObjects&&e!==E.BusinessObject){throw new Error("Unsupported message scope: "+e)}this.sMessageScope=e};w.prototype.messageScopeSupported=function(){var e=this;return this.metadataLoaded().then(function(){return e.bIsMessageScopeSupported})};w.prototype.getContext=function(e,a,s){var r=this.mContexts[e];if(!r){r=this.mContexts[e]=new t(this,e,a,s)}else{r.setDeepPath(a||r.getDeepPath()||e)}return r};w.prototype.hasContext=function(e){return this.mContexts[e]};w.prototype.removeInternalMetadata=function(e){var t,a,s,r,i;if(e&&e.__metadata){t=e.__metadata.created;a=e.__metadata.deepPath;s=e.__metadata.invalid;delete e.__metadata.created;delete e.__metadata.deepPath;delete e.__metadata.invalid}for(r in e){i=e[r];if(Array.isArray(i)){i.forEach(w.prototype.removeInternalMetadata)}else if(typeof i==="object"){w.prototype.removeInternalMetadata(i)}}return{created:t,deepPath:a,invalid:s}};w.prototype._isCanonicalRequestNeeded=function(e){if(e!==undefined){return!!e}else{return!!this.bCanonicalRequests}};w.prototype.filterMatchingMessages=function(e,t){var a=this;return this.mMessages[e].filter(function(e){return a.isMessageMatching(e,t)})};w.prototype.isMessageMatching=function(e,t){var a=t.length;return e.aFullTargets.some(function(e){return e===t||e.startsWith(t)&&(t==="/"||e[a]==="/"||e[a]==="(")})};w.prototype.getMessages=function(e){return this.getMessagesByPath(e.sDeepPath,true).sort(b.compare)};w.prototype.getDeepPathForCanonicalPath=function(e){var t,a,i,n,o,d,u,h=e.slice(e.indexOf("("));o=this.aBindings.filter(function(e){return(e instanceof s||e instanceof r)&&e.isResolved()});for(d=0,u=o.length;d<u;d+=1){t=o[d];i=this.resolveDeep(t instanceof r?t.sPath+h:t.sPath,t.oContext);a=this.resolveFromCache(i);if(a===e){if(n&&n!==i){return undefined}n=i}}return n};w.prototype.getPersistTechnicalMessages=function(){return this.bPersistTechnicalMessages};w.prototype.setPersistTechnicalMessages=function(e){e=!!e;if(this.bPersistTechnicalMessages===e){return}if(this.bPersistTechnicalMessages!==undefined){o.warning("The flag whether technical messages should always be treated as persistent"+" has been overwritten to "+e,undefined,B)}this.bPersistTechnicalMessages=e;if(this.oMessageParser){this.oMessageParser._setPersistTechnicalMessages(e)}};w.prototype.createCodeListModelParameters=function(e){e=e||{};return{defaultCountMode:S.None,disableSoftStateHeader:true,headers:e.headers&&Object.assign({},e.headers),json:e.json,metadataUrlParams:e.metadataUrlParams&&Object.assign({},e.metadataUrlParams),persistTechnicalMessages:e.persistTechnicalMessages,serviceUrl:this.sServiceUrl,serviceUrlParams:e.serviceUrlParams&&Object.assign({},e.serviceUrlParams),tokenHandling:false,useBatch:false,warmupUrl:e.warmupUrl}};w.prototype.getCodeListModelParameters=function(){return this.mCodeListModelParams};w.prototype.getMetadataUrl=function(){return this.sMetadataUrl};w._createAbortedError=function(){return{aborted:true,headers:{},message:"Request aborted",responseText:"",statusCode:0,statusText:"abort"}};w.prototype._getCreatedContextsCache=function(){return this.oCreatedContextsCache};return w});