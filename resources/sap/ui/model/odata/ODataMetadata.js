/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/EventProvider","sap/ui/thirdparty/datajs","sap/ui/core/cache/CacheManager","./_ODataMetaModelUtils","sap/base/util/uid","sap/base/Log","sap/base/assert","sap/base/util/each","sap/ui/thirdparty/jquery"],function(t,e,a,n,i,s,r,o,h){"use strict";var d=t.extend("sap.ui.model.odata.ODataMetadata",{constructor:function(e,n){t.apply(this,arguments);this.bLoaded=false;this.bFailed=false;this.mEntityTypes={};this.mRequestHandles={};this.sUrl=e;this.bAsync=n.async;this.sUser=n.user;this.bWithCredentials=n.withCredentials;this.sPassword=n.password;this.mHeaders=n.headers;this.sCacheKey=n.cacheKey;this.oLoadEvent=null;this.oFailedEvent=null;this.oMetadata=null;this.mNamespaces=n.namespaces||{sap:"http://www.sap.com/Protocols/SAPData",m:"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","":"http://schemas.microsoft.com/ado/2007/06/edmx"};var i=this;this.fnResolve;this.pLoaded=new Promise(function(t,e){i.fnResolve=t});function r(t){a.set(i.sCacheKey,JSON.stringify({metadata:i.oMetadata,params:t}))}function o(){s.error("[ODataMetadata] initial loading of metadata failed")}if(this.sCacheKey){a.get(this.sCacheKey).then(function(t){if(t){var e=JSON.parse(t);this.oMetadata=e.metadata;this._handleLoaded(this.oMetadata,e.params,false)}else{this._loadMetadata().then(r).catch(o)}}.bind(this)).catch(o)}else{this._loadMetadata().catch(o)}},metadata:{publicMethods:["getServiceMetadata","attachFailed","detachFailed","attachLoaded","detachLoaded","refresh"]}});d.prototype._setNamespaces=function(t){this.mNamespaces=t};d.prototype._handleLoaded=function(t,e,a){var n=[];this.oMetadata=this.oMetadata?this.merge(this.oMetadata,t,n):t;this.oRequestHandle=null;e.entitySets=n;this.fnResolve(e);if(this.bAsync&&!a){this.fireLoaded(this)}else if(!this.bAsync&&!a){this.bLoaded=true;this.bFailed=false;this.oLoadEvent=setTimeout(this.fireLoaded.bind(this,e),0)}};d.prototype._loadMetadata=function(t,a){var n=this;t=t||this.sUrl;var s=this._createRequest(t);return new Promise(function(t,r){var o;function h(e,i){if(!e||!e.dataServices){var r={message:"Invalid metadata document",request:s,response:i};d(r);return}n.sMetadataBody=i.body;n.oRequestHandle=null;var o={metadataString:n.sMetadataBody};var h=i.headers["Last-Modified"];if(h){o.lastModified=h}var p=i.headers["eTag"];if(p){o.eTag=p}n._handleLoaded(e,o,a);t(o)}function d(t){var e={message:t.message,request:t.request,response:t.response};if(t.response){e.statusCode=t.response.statusCode;e.statusText=t.response.statusText;e.responseText=t.response.body}if(o&&o.bSuppressErrorHandlerCall){return}if(n.bAsync){delete n.mRequestHandles[o.id]}r(e);if(n.bAsync&&!a){n.fireFailed(e)}else if(!n.bAsync&&!a){n.bFailed=true;n.oFailedEvent=setTimeout(n.fireFailed.bind(n,e),0)}}o=e.request(s,h,d,e.metadataHandler);if(n.bAsync){o.id=i();n.mRequestHandles[o.id]=o}})};d.prototype.refresh=function(){return this._loadMetadata()};d.prototype.getServiceMetadata=function(){return this.oMetadata};d.prototype.isLoaded=function(){return this.bLoaded};d.prototype.loaded=function(){return this.pLoaded};d.prototype.isFailed=function(){return this.bFailed};d.prototype.fireLoaded=function(t){this.bLoaded=true;this.bFailed=false;this.fireEvent("loaded",t);s.debug(this+" - loaded was fired");return this};d.prototype.attachLoaded=function(t,e,a){this.attachEvent("loaded",t,e,a);return this};d.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};d.prototype.fireFailed=function(t){this.bFailed=true;this.fireEvent("failed",t);return this};d.prototype.attachFailed=function(t,e,a){this.attachEvent("failed",t,e,a);return this};d.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};d.prototype._getEntityAssociationEnd=function(t,e){if(!this.oMetadata||h.isEmptyObject(this.oMetadata)){r(undefined,"No metadata loaded!");return null}if(!this._mGetEntityAssociationEndCache||!this._mGetEntityAssociationEndCache[t.name+"|"+e]){this._mGetEntityAssociationEndCache={};var a=t?n.findObject(t.navigationProperty,e):null,i=a?n.getObject(this.oMetadata.dataServices.schema,"association",a.relationship):null,s=i?n.findObject(i.end,a.toRole,"role"):null;this._mGetEntityAssociationEndCache[t.name+"|"+e]=s}return this._mGetEntityAssociationEndCache[t.name+"|"+e]};function p(t){var e={};for(var a=0;a<t.length;a++){var n=t[a];if(n.entityContainer){for(var i=0;i<n.entityContainer.length;i++){var s=n.entityContainer[i];if(s.entitySet){for(var r=0;r<s.entitySet.length;r++){if(s.entitySet[r].name!=null){e[s.entitySet[r].name]=s.entitySet[r]}}}}}}return e}d.prototype._findEntitySetByName=function(t){if(!this.mEntitySets){this.mEntitySets=p(this.oMetadata.dataServices.schema)}return this.mEntitySets[t]};d.prototype._getEntityTypeByPath=function(t){if(!t){r(undefined,"sPath not defined!");return null}if(!this.oMetadata||h.isEmptyObject(this.oMetadata)){r(undefined,"No metadata loaded!");return null}if(this.mEntityTypes[t]){return this.mEntityTypes[t]}var e=t.replace(/^\/|\/$/g,""),a=e.split("/"),n=a.length,i,s,o,d,p=this;if(a[0].indexOf("(")!=-1){a[0]=a[0].substring(0,a[0].indexOf("("))}if(n>1){i=p._getEntityTypeByPath(a[0]);for(var y=1;y<a.length;y++){if(i){if(a[y].indexOf("(")!=-1){a[y]=a[y].substring(0,a[y].indexOf("("))}d=p._getEntityTypeByNavProperty(i,a[y]);if(d){i=d}o=i}}}else{s=this._splitName(this._getEntityTypeName(a[0]));o=this._getObjectMetadata("entityType",s.name,s.namespace);if(o){o.entityType=this._getEntityTypeName(a[0])}}if(!o){var f=a[a.length-1];var c=this._getFunctionImportMetadata(f,"GET");if(!c){c=this._getFunctionImportMetadata(f,"POST")}if(c&&c.entitySet){o=this._getEntityTypeByPath(c.entitySet);if(o){o.entityType=this._getEntityTypeName(c.entitySet)}}}if(o){this.mEntityTypes[t]=o}return o};d.prototype._getEntityTypeByName=function(t){var e,a=this,n,i,s;if(!t){r(undefined,"sName not defined!");return null}s=this._splitName(t);i=s.namespace;n=s.name;if(!this.oMetadata||h.isEmptyObject(this.oMetadata)){r(undefined,"No metadata loaded!");return null}if(this.mEntityTypes[t]){e=this.mEntityTypes[t]}else{h.each(this.oMetadata.dataServices.schema,function(s,r){if(r.entityType&&(!i||r.namespace===i)){h.each(r.entityType,function(i,s){if(s.name===n){e=s;a.mEntityTypes[t]=e;e.namespace=r.namespace;return false}})}})}return e};d.prototype._getAnnotation=function(t){var e,a,n,i,s,o,h;a=t.split("/#");i=a[1].split("/");if(!a[0]){s=this._getEntityTypeByName(i[0]);r(s,i[0]+" is not a valid EntityType");if(!s){return}o=a[1].substr(a[1].indexOf("/")+1);h=this._getPropertyMetadata(s,o);r(h,o+" is not a valid property path");if(!h){return}n=o.substr(o.indexOf(h.name));n=n.substr(n.indexOf("/")+1)}else{s=this._getEntityTypeByPath(a[0]);r(s,a[0]+" is not a valid path");if(!s){return}t=a[0].replace(/^\/|\/$/g,"");o=t;while(!h&&o.indexOf("/")>0){o=o.substr(o.indexOf("/")+1);h=this._getPropertyMetadata(s,o)}r(h,o+" is not a valid property path");if(!h){return}n=i.join("/")}e=this._getAnnotationObject(s,h,n);return e};d.prototype._getAnnotationObject=function(t,e,a){var n,i,s,r,o;if(!e){return}r=e;i=a.split("/");if(i[0].indexOf(".")>-1){return this._getV4AnnotationObject(t,e,i)}else{if(i.length>1){r=r[i[0]];if(!r&&e.extensions){for(var h=0;h<e.extensions.length;h++){var d=e.extensions[h];if(d.name==i[0]){r=d;break}}}a=i.splice(0,1);s=this._getAnnotationObject(t,r,i.join("/"))}else{if(i[0].indexOf("@")>-1){o=i[0].substr(1);n=o.split(":");s=r[n[0]];if(!s&&r.extensions){for(var h=0;h<r.extensions.length;h++){var d=r.extensions[h];if(d.name===n[1]&&d.namespace===this.mNamespaces[n[0]]){s=d.value;break}}}}else{n=i[0].split(":");s=r[n[0]];s=r[i[0]];if(!s&&r.extensions){for(var h=0;h<r.extensions.length;h++){var d=r.extensions[h];if(d.name===n[1]&&d.namespace===this.mNamespaces[n[0]]){s=d;break}}}}}}return s};d.prototype._getV4AnnotationObject=function(t,e,a){var n,i=[];if(a.length>1){r(a.length==1,"'"+a.join("/")+"' is not a valid annotation path");return}var s=t.namespace?t.namespace+".":"";s+=t.name+"/"+e.name;h.each(this.oMetadata.dataServices.schema,function(t,e){if(e.annotations){h.each(e.annotations,function(t,e){if(e.target===s&&!e.qualifier){i.push(e.annotation);return false}})}});if(i){h.each(i,function(t,e){h.each(e,function(t,e){if(e.term===a[0]){n=e}})})}return n};d.prototype._splitName=function(t){var e={};if(t){var a=t.lastIndexOf(".");e.name=t.substr(a+1);e.namespace=t.substr(0,a)}return e};d.prototype._getEntityTypeName=function(t){var e,a;if(t){a=this._findEntitySetByName(t);if(a){e=a.entityType}}return e};d.prototype._getObjectMetadata=function(t,e,a){var n;if(e&&a){h.each(this.oMetadata.dataServices.schema,function(i,s){if(s[t]&&s.namespace===a){h.each(s[t],function(t,a){if(a.name===e){n=a;n.namespace=s.namespace;return false}});return!n}})}return n};d.prototype.getUseBatch=function(){var t=false;h.each(this.oMetadata.dataServices.schema,function(e,a){if(a.entityContainer){h.each(a.entityContainer,function(e,a){if(a.extensions){h.each(a.extensions,function(e,a){if(a.name==="use-batch"&&a.namespace==="http://www.sap.com/Protocols/SAPData"){t=typeof a.value==="string"?a.value.toLowerCase()==="true":!!a.value;return false}})}})}});return t};d.prototype._getFunctionImportMetadataIterate=function(t,e){var a=[];o(this.oMetadata.dataServices.schema,function(n,i){if(i["entityContainer"]){o(i["entityContainer"],function(n,i){if(i["functionImport"]){o(i["functionImport"],function(n,i){if(t(i)){a.push(i);if(e){return false}}})}return!(e&&a.length===1)})}return!(e&&a.length===1)});return a};d.prototype._getFirstMatchingFunctionImportMetadata=function(t){var e=this._getFunctionImportMetadataIterate(t,true);return e.length===1?e[0]:null};d.prototype._getFunctionImportMetadataByName=function(t){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFunctionImportMetadataIterate(function(e){return e.name===t})};d.prototype._getFunctionImportMetadata=function(t,e){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFirstMatchingFunctionImportMetadata(function(a){return a.name===t&&a.httpMethod===e})};d.prototype._getEntityTypeByNavProperty=function(t,e){if(!t.navigationProperty){return undefined}for(var a=0;a<t.navigationProperty.length;++a){var n=t.navigationProperty[a];if(n.name===e){return this._getEntityTypeByNavPropertyObject(n)}}return undefined};d.prototype._getEntityTypeByNavPropertyObject=function(t){var e;var a=this._splitName(t.relationship);var n=this._getObjectMetadata("association",a.name,a.namespace);if(n){var i=n.end[0];if(i.role!==t.toRole){i=n.end[1]}var s=this._splitName(i.type);e=this._getObjectMetadata("entityType",s.name,s.namespace);if(e){e.entityType=i.type}}return e};d.prototype._getNavigationPropertyNames=function(t){var e=[];if(t.navigationProperty){h.each(t.navigationProperty,function(t,a){e.push(a.name)})}return e};d.prototype._getPropertyMetadata=function(t,e){var a,n=this;if(!t){return}e=e.replace(/^\/|\/$/g,"");var i=e.split("/");h.each(t.property,function(t,e){if(e.name===i[0]){a=e;return false}});if(i.length>1){if(!a){while(t&&i.length>1){t=this._getEntityTypeByNavProperty(t,i[0]);i.shift()}if(t){a=n._getPropertyMetadata(t,i[0])}}else if(!a.type.toLowerCase().startsWith("edm.")){var s=this._splitName(a.type);a=this._getPropertyMetadata(this._getObjectMetadata("complexType",s.name,s.namespace),i[1])}}return a};d.prototype.destroy=function(){delete this.oMetadata;var e=this;h.each(this.mRequestHandles,function(t,a){a.bSuppressErrorHandlerCall=true;a.abort();delete e.mRequestHandles[t]});if(!!this.oLoadEvent){clearTimeout(this.oLoadEvent)}if(!!this.oFailedEvent){clearTimeout(this.oFailedEvent)}t.prototype.destroy.apply(this,arguments)};d.prototype._createRequest=function(t){var e={"sap-cancel-on-close":true},a={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()};h.extend(e,this.mHeaders,a);var n={headers:e,requestUri:t,method:"GET",user:this.sUser,password:this.sPassword,async:this.bAsync};if(this.bAsync){n.withCredentials=this.bWithCredentials}return n};d.prototype._getEntitySetByPath=function(t){if(!this._entitySetMap){this._entitySetMap={};this.oMetadata.dataServices.schema.forEach(function(t){if(t.entityContainer){t.entityContainer.forEach(function(t){if(t.entitySet){t.entitySet.forEach(function(t){this._entitySetMap[t.entityType]=t},this)}},this)}},this)}var e=this._getEntityTypeByPath(t);if(e){return this._entitySetMap[e.entityType]}return};d.prototype._addUrl=function(t){var e=[].concat(t);return Promise.all(e.map(function(t){return this._loadMetadata(t,true)},this))};d.prototype.merge=function(t,e,a){var n=this;if(this.mEntitySets){delete this.mEntitySets}h.each(t.dataServices.schema,function(t,i){h.each(e.dataServices.schema,function(t,e){if(e.namespace===i.namespace){if(e.entityType){if(!n.mEntityTypeNames){n.mEntityTypeNames={};i.entityType.map(function(t){n.mEntityTypeNames[t.name]=true})}i.entityType=!i.entityType?[]:i.entityType;for(var s=0;s<e.entityType.length;s++){if(!(e.entityType[s].name in n.mEntityTypeNames)){i.entityType.push(e.entityType[s]);n.mEntityTypeNames[e.entityType[s].name]=true}}}if(i.entityContainer&&e.entityContainer){h.each(i.entityContainer,function(t,i){h.each(e.entityContainer,function(t,e){if(e.entitySet){if(e.name===i.name){if(!n.mEntitySetNames){n.mEntitySetNames={};i.entitySet.map(function(t){n.mEntitySetNames[t.name]=true})}i.entitySet=!i.entitySet?[]:i.entitySet;for(var s=0;s<e.entitySet.length;s++){if(!(e.entitySet[s].name in n.mEntitySetNames)){i.entitySet.push(e.entitySet[s]);n.mEntitySetNames[e.entitySet[s].name]=true}}e.entitySet.forEach(function(t){a.push(t)})}}})})}if(e.annotations){i.annotations=!i.annotations?[]:i.annotations;i.annotations=i.annotations.concat(e.annotations)}}})});return t};d.prototype._getEntitySetByType=function(t){var e=t.namespace+"."+t.name;var a=this.oMetadata.dataServices.schema;for(var n=0;n<a.length;++n){var i=a[n].entityContainer;if(i){for(var s=0;s<i.length;++s){var r=i[s].entitySet;if(r){for(var o=0;o<r.length;++o){if(r[o].entityType===e){return r[o]}}}}}}return null};return d});