/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./AnalyticalVersionInfo","./BatchResponseCollector","./odata4analytics","sap/base/Log","sap/base/util/deepExtend","sap/base/util/each","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/uid","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/TreeAutoExpandMode","sap/ui/model/TreeBinding","sap/ui/model/odata/CountMode","sap/ui/model/odata/ODataUtils"],function(e,t,i,r,s,n,a,o,u,l,d,h,p,f,g,y,c,v,m){"use strict";var _="sap.ui.model.analytics.AnalyticalBinding",I=0,R=r.getLogger(_);function M(e){var t=new i.QueryResultRequest(e.oAnalyticalQueryResult),r,s,n,a,o,u,l,d,h=e.mParameters.select.split(","),p=b(h,e.sPath);t.setAggregationLevel(e.aMaxAggregationLevel);t.setMeasures(e.aMeasureName);Object.keys(e.oDimensionDetailsSet).forEach(function(i){n=e.oDimensionDetailsSet[i];t.includeDimensionKeyTextAttributes(i,true,n.textPropertyName!==undefined,n.aAttributeName)});Object.keys(e.oMeasureDetailsSet).forEach(function(i){u=e.oMeasureDetailsSet[i];t.includeMeasureRawFormattedValueUnit(i,u.rawValuePropertyName!==undefined,u.formattedValuePropertyName!==undefined,u.unitPropertyName!==undefined)});s=t.getURIQueryOptionValue("$select");if(s){r=s.split(",");for(a=0,l=r.length;a<l;a++){d=r[a];o=h.indexOf(d);if(o<0){R.warning("Ignored the 'select' binding parameter, because"+" it does not contain the property '"+d+"'",e.sPath);p=true}else{h.splice(o,1)}}}for(a=0,l=h.length;a<l;a++){d=h[a];n=e.oAnalyticalQueryResult.findDimensionByPropertyName(d);if(n&&e.oDimensionDetailsSet[n.getName()]===undefined){q(e.sPath,d,n);p=true}u=e.oAnalyticalQueryResult.findMeasureByPropertyName(d);if(u&&e.oMeasureDetailsSet[u.getName()]===undefined){q(e.sPath,d,u);p=true}}return p?[]:h}function q(e,t,i){var r=i instanceof sap.ui.model.analytics.odata4analytics.Dimension?"dimension":"measure";if(i.getName()===t){R.warning("Ignored the 'select' binding parameter, because it contains"+" the "+r+" property '"+t+"' which is not contained in the analytical info (see updateAnalyticalInfo)",e)}else{R.warning("Ignored the 'select' binding parameter, because the property '"+t+"' is associated with the "+r+" property '"+i.getName()+"' which is not contained in the analytical"+" info (see updateAnalyticalInfo)",e)}}function b(e,t){var i,r=false,s,n;for(s=0,n=e.length;s<n;s++){e[s]=e[s].trim()}for(s=e.length-1;s>=0;s--){i=e[s];if(e.indexOf(i)!==s){R.warning("Ignored the 'select' binding parameter, because it"+" contains the property '"+i+"' multiple times",t);e.splice(s,1);r=true}}return r}var x=c.extend("sap.ui.model.analytics.AnalyticalBinding",{constructor:function(t,i,r,s,n,a){c.call(this,t,i,r,n,a);this.aAdditionalSelects=[];this.sEntitySetName=a&&a.entitySet?a.entitySet:undefined;this.bArtificalRootContext=false;this.aApplicationFilter=this._convertDeprecatedFilterObjects(n);this.aControlFilter=undefined;this.aSorter=s?s:[];this.aMaxAggregationLevel=[];this.aAggregationLevel=[];this.oPendingRequests={};this.oPendingRequestHandle=[];this.oGroupedRequests={};this.bUseBatchRequests=a&&a.useBatchRequests===true?true:false;this.bProvideTotalSize=a&&a.provideTotalResultSize===false?false:true;this.bProvideGrandTotals=a&&a.provideGrandTotals===false?false:true;this.bReloadSingleUnitMeasures=a&&a.reloadSingleUnitMeasures===false?false:true;this.bUseAcceleratedAutoExpand=a&&a.useAcceleratedAutoExpand===false?false:true;this.bNoPaging=a&&a.noPaging===true?true:false;I+=1;this._iId=I;this.iTotalSize=-1;this.mServiceKey={};this.mServiceLength={};this.mServiceFinalLength={};this.mKeyIndex={};this.mFinalLength=this.mServiceFinalLength;this.mLength={};this.mMultiUnitKey={};this.aMultiUnitLoadFactor={};this.bNeedsUpdate=false;this.bApplySortersToGroups=true;this.sLastAutoExpandMode=undefined;this.mEntityKey={};this.sCustomParams=this.oModel.createCustomParams({custom:this.mParameters.custom});this.oAnalyticalQueryResult=null;this.aAnalyticalInfo=[];this.mAnalyticalInfoByProperty={};this.aBatchRequestQueue=[];if(a&&a.countMode==v.None){R.fatal("requested count mode is ignored; OData requests will include"+" $inlinecount options")}else if(a&&(a.countMode==v.Request||a.countMode==v.Both)){R.warning("default count mode is ignored; OData requests will include"+" $inlinecount options")}else if(this.oModel.sDefaultCountMode==v.Request){R.warning("default count mode is ignored; OData requests will include"+" $inlinecount options")}this.iModelVersion=e.getVersion(this.oModel);if(this.iModelVersion===null){R.error("The AnalyticalBinding does not support Models other than sap.ui.model.odata.ODataModel version 1 or 2.");return}this.aAllDimensionSortedByName=null;this.aInitialAnalyticalInfo=a==undefined?[]:a.analyticalInfo;this.bInitial=true}});function S(e,t){return function(){if(!e.__supportUID){e.__supportUID=u()}return{type:_,analyticalError:t,analyticalBindingId:e.__supportUID}}}x.prototype.setContext=function(e){var t;if(this.oContext!==e){this.oContext=e;if(!this.isRelative()){return}this.oDataState=null;this.bApplySortersToGroups=true;this.iTotalSize=-1;this._abortAllPendingRequests();t=this.getResolvedPath();if(t){this.resetData();this._initialize();this._fireChange({reason:l.Context})}else{this.bInitial=true}}};x.prototype.initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.isInitial()){var e=this.isRelative();if(!e||e&&this.oContext){this._initialize()}this._fireRefresh({reason:l.Refresh})}return this};x.prototype._initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()){this.bInitial=false;this.oAnalyticalQueryResult=this.oModel.getAnalyticalExtensions().findQueryResultByName(this._getEntitySet());if(!this.oAnalyticalQueryResult){throw"Error in AnalyticalBinding - The QueryResult '"+this._getEntitySet()+"' could not be retrieved. Please check your service definition."}this.updateAnalyticalInfo(this.aInitialAnalyticalInfo);this.aAllDimensionSortedByName=this.oAnalyticalQueryResult.getAllDimensionNames().concat([]).sort();this._fireRefresh({reason:l.Refresh})}};x.prototype.getRootContexts=function(e,t,i,r){if(typeof e!=="object"){e={length:t,numberOfExpandedLevels:i,startIndex:e,threshold:r}}if(this.isInitial()){return[]}var s=e&&e.numberOfExpandedLevels?e.numberOfExpandedLevels+1:1;var n=null;var a=this._getRequestId(x._requestType.groupMembersQuery,{groupId:null});if(this.bArtificalRootContext&&!this._cleanupGroupingForCompletedRequest(a)){return n}n=this._getContextsForParentContext(null);if(n.length==1){return n}if(s<=1){if(s==1){this._considerRequestGrouping([a,this._getRequestId(x._requestType.groupMembersQuery,{groupId:"/"})]);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:e.startIndex,length:e.length,threshold:e.threshold,level:0,numberOfExpandedLevels:0})}}else{var o=this._prepareGroupMembersAutoExpansionRequestIds("/",e.numberOfExpandedLevels);o.push(a);this._considerRequestGrouping(o);this.getNodeContexts(this.getModel().getContext("/"),{startIndex:e.startIndex,length:e.length,threshold:e.threshold,level:0,numberOfExpandedLevels:e.numberOfExpandedLevels})}if(n.length>1){R.fatal("assertion failed: grand total represented by a single entry")}return n};x.prototype.getNodeContexts=function(e,t){if(this.isInitial()){return[]}var i,r,s,n,a,o;if(typeof t=="object"){i=t.startIndex;r=t.length;s=t.threshold;n=t.level;a=t.numberOfExpandedLevels;o=t.supressRequest}else{i=arguments[1];r=arguments[2];s=arguments[3];n=arguments[4];a=arguments[5];o=arguments[6]}var u=this._getContextsForParentContext(e,i,r,s,n,a,o);return u};x.prototype.ContextsAvailabilityStatus={ALL:2,SOME:1,NONE:0};x.prototype.hasAvailableNodeContexts=function(e,t){var i=this._getGroupIdFromContext(e,t);if(this._getKeys(i)!=undefined){if(this.mFinalLength[i]==true){return x.prototype.ContextsAvailabilityStatus.ALL}else{return x.prototype.ContextsAvailabilityStatus.SOME}}else{return x.prototype.ContextsAvailabilityStatus.NONE}};x.prototype.getGroupSize=function(e,t){if(e===undefined){return 0}var i=this._getGroupIdFromContext(e,t);return this.mFinalLength[i]?this.mLength[i]:-1};x.prototype.getCount=function(){return this.iTotalSize>=0?this.iTotalSize:undefined};x.prototype.getTotalSize=function(){if(!this.bProvideTotalSize){R.fatal("total size of result explicitly turned off, but getter invoked")}return this.iTotalSize};x.prototype.hasChildren=function(e,t){t=t||{level:1};if(e===undefined){return false}if(e==null){return true}var i=t.level;if(i==0){return true}if(this.aAggregationLevel.length<i){return false}return this.aMaxAggregationLevel.indexOf(this.aAggregationLevel[i-1])<this.aMaxAggregationLevel.length-1};x.prototype.hasMeasures=function(){var e=false;for(var t in this.oMeasureDetailsSet){if(this.oMeasureDetailsSet.hasOwnProperty(t)){e=true;break}}return e};x.prototype.getDimensionDetails=function(){return this.oDimensionDetailsSet};x.prototype.getMeasureDetails=function(){return this.oMeasureDetailsSet};x.prototype.providesGrandTotal=function(){return this.bProvideGrandTotals};x.prototype.getProperty=function(e){if(this.isInitial()){return{}}return this.oAnalyticalQueryResult.getEntityType().findPropertyByName(e)};x.prototype.getFilterablePropertyNames=function(){if(this.isInitial()){return[]}return this.oAnalyticalQueryResult.getEntityType().getFilterablePropertyNames()};x.prototype.getSortablePropertyNames=function(){if(this.isInitial()){return[]}return this.oAnalyticalQueryResult.getEntityType().getSortablePropertyNames()};x.prototype.getPropertyLabel=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getLabelOfProperty(e)};x.prototype.getPropertyHeading=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getHeadingOfProperty(e)};x.prototype.getPropertyQuickInfo=function(e){if(this.isInitial()){return""}return this.oAnalyticalQueryResult.getEntityType().getQuickInfoOfProperty(e)};x.prototype.isMeasure=function(e){return this.aMeasureName&&this.aMeasureName.indexOf(e)!==-1};x.prototype.filter=function(e,t){if(!e){e=[]}if(e instanceof d){e=[e]}e=this._convertDeprecatedFilterObjects(e);if(t==f.Application){this.aApplicationFilter=e}else{this.aControlFilter=e}this.iTotalSize=-1;this._abortAllPendingRequests();this.resetData();this.bApplySortersToGroups=true;this._fireRefresh({reason:l.Filter});return this};x.prototype.getFilterInfo=function(e){var t=p.combineFilters(this.aControlFilter,this.aApplicationFilter);if(t){return t.getAST(e)}return null};x.prototype.sort=function(e){if(e instanceof g){e=[e]}this.aSorter=e?e:[];this._abortAllPendingRequests();this.resetData(undefined,{reason:l.Sort});this._fireRefresh({reason:l.Sort});return this};x.prototype.getGroupName=function(e,t){if(e===undefined){return""}var i=this.aAggregationLevel[t-1],r=this.oAnalyticalQueryResult.findDimensionByPropertyName(i),s=this.mAnalyticalInfoByProperty[i]&&this.mAnalyticalInfoByProperty[i].formatter,n=e.getProperty(i),a,o,u,l,d,h,p,f;if(r&&this.oDimensionDetailsSet[i].textPropertyName){d=r.getTextProperty()}if(d){h=d.name;f=this.mAnalyticalInfoByProperty[h]&&this.mAnalyticalInfoByProperty[h].formatter;p=e.getProperty(h);a=s?s(n,p):n;o=f?f(p,n):p}else{a=s?s(n):n}l=r.getLabelText&&r.getLabelText();u=(l?l+": ":"")+a;if(o){u+=" - "+o}return u};x.prototype.updateAnalyticalInfo=function(e,t){var s,n,o,u,d=this;function h(e){var t=e.level,i=e.name;u=u||o.getAllHierarchyPropertyNames();u.forEach(function(r){var s=d.oAnalyticalQueryResult.findDimensionByPropertyName(r).getHierarchy(),n=null,a=s.getNodeIDProperty().name,u;if(a===i){n=p(s)}else{u=s.getNodeExternalKeyProperty();if(u&&u.name===i){n=p(s);n.nodeExternalKeyName=i}else{u=o.getTextPropertyOfProperty(a);if(u&&u.name===i){n=p(s);n.nodeTextName=i}}}if(n&&"level"in e){if(typeof t==="number"){if("level"in n&&n.level!==t){throw new Error("Multiple different level filter for hierarchy '"+a+"' defined")}n.level=t;n.grouped=!!e.grouped}else{throw new Error("The level of '"+a+"' has to be an integer value")}}})}function p(e){var t=e.getNodeIDProperty().name,i,r=d.mHierarchyDetailsByName[t];if(!r){i=e.getNodeLevelProperty();r={dimensionName:e.getNodeValueProperty().name,nodeIDName:t,nodeLevelName:i&&i.name};d.mHierarchyDetailsByName[t]=r}return r}if(!this.oModel.oMetadata||!this.oModel.oMetadata.isLoaded()||this.isInitial()){this.aInitialAnalyticalInfo=e;return}s=i.helper.deepEqual(this._aLastChangedAnalyticalInfo,e,function(e){d.mAnalyticalInfoByProperty[e.name].formatter=e.formatter});if(s){this._aLastChangedAnalyticalInfo=[];for(var f=0;f<e.length;f++){this._aLastChangedAnalyticalInfo[f]=a({},e[f])}}if(s<2){if(t||s){setTimeout(function(){this._fireChange({reason:l.Change})}.bind(this),0)}return}var g=this.oDimensionDetailsSet||{},y=this.oMeasureDetailsSet||{};this.mAnalyticalInfoByProperty={};this.aMaxAggregationLevel=[];this.aAggregationLevel=[];this.aMeasureName=[];if(this.iAnalyticalInfoVersionNumber==undefined){this.iAnalyticalInfoVersionNumber=1}else if(this.iAnalyticalInfoVersionNumber>999){this.iAnalyticalInfoVersionNumber=1}else{this.iAnalyticalInfoVersionNumber=this.iAnalyticalInfoVersionNumber+1}this.oMeasureDetailsSet={};this.oDimensionDetailsSet={};this.aAdditionalSelects=[];this.mHierarchyDetailsByName={};o=this.oAnalyticalQueryResult.getEntityType();for(var c=0;c<e.length;c++){var v=this.oAnalyticalQueryResult.findDimensionByPropertyName(e[c].name);if(v&&(e[c].inResult==true||e[c].visible==true)){e[c].dimensionPropertyName=v.getName();n=this.oDimensionDetailsSet[v.getName()];if(!n){n={};n.name=v.getName();n.aAttributeName=[];n.grouped=false;this.oDimensionDetailsSet[v.getName()]=n;this.aMaxAggregationLevel.push(n.name);if(e[c].grouped==true){this.aAggregationLevel.push(n.name)}}if(e[c].grouped==true){if(!this.getSortablePropertyNames()||this.getSortablePropertyNames().indexOf(v.getName())==-1){R.fatal("property "+v.getName()+" must be sortable in order to be used as grouped dimension")}n.grouped=true}if(v.getName()==e[c].name){n.keyPropertyName=e[c].name}var m=v.getTextProperty();if(m&&m.name==e[c].name){n.textPropertyName=e[c].name}if(v.findAttributeByName(e[c].name)){n.aAttributeName.push(e[c].name)}n.analyticalInfo=e[c]}var _=this.oAnalyticalQueryResult.findMeasureByPropertyName(e[c].name);if(_&&(e[c].inResult==true||e[c].visible==true)){e[c].measurePropertyName=_.getName();var I=this.oMeasureDetailsSet[_.getName()];if(!I){I={};I.name=_.getName();this.oMeasureDetailsSet[_.getName()]=I;this.aMeasureName.push(I.name)}if(_.getRawValueProperty().name==e[c].name){I.rawValuePropertyName=e[c].name}var q=_.getFormattedValueProperty();if(q&&q.name==e[c].name){I.formattedValuePropertyName=e[c].name}I.analyticalInfo=e[c]}if(!v&&!_){h(e[c])}this.mAnalyticalInfoByProperty[e[c].name]=e[c]}Object.keys(this.mHierarchyDetailsByName).forEach(function(e){var t=d.mHierarchyDetailsByName[e];if(!("level"in t)){delete d.mHierarchyDetailsByName[e];if(R.isLoggable(r.Level.INFO)){R.info("No level specified for hierarchy node '"+e+"'; ignoring hierarchy","")}}else if(!d.oDimensionDetailsSet[e]){d.oDimensionDetailsSet[e]={aAttributeName:[],grouped:t.grouped,isHierarchyDimension:true,name:e};d.aMaxAggregationLevel.push(e);if(t.grouped){d.aAggregationLevel.push(e)}}});for(var b in this.oMeasureDetailsSet){var x=this.oAnalyticalQueryResult.findMeasureByName(b).getUnitProperty();if(x){this.oMeasureDetailsSet[b].unitPropertyName=x.name}}var S=Object.keys(g).sort().join(";")!==Object.keys(this.oDimensionDetailsSet).sort().join(";");if(S){this.iTotalSize=-1}if(S||Object.keys(y).sort().join(";")!==Object.keys(this.oMeasureDetailsSet).sort().join(";")){this.bApplySortersToGroups=true}this.aAnalyticalInfo=e;this.resetData();this.bNeedsUpdate=false;if(this.mParameters.select){this.aAdditionalSelects=M(this)}if(t){this._fireChange({reason:l.Change})}};x.prototype.getAnalyticalInfoForColumn=function(e){return this.mAnalyticalInfoByProperty[e]};x.prototype.loadGroups=function(e){var t=[];for(var i in e){t.push(i);this._resetData(i);var r=e[i];for(var s=0;s<r.length;s++){var n=r[s];this._getContextsForParentGroupId(i,n.startIndex,n.length,n.threshold)}var a=[];for(var o=-1,u;(u=t[++o])!==undefined;){a.push(this._getRequestId(x._requestType.groupMembersQuery,{groupId:u}))}this._considerRequestGrouping(a)}};x.prototype.getAnalyticalQueryResult=function(){return this.oAnalyticalQueryResult};x._requestType={groupMembersQuery:1,totalSizeQuery:2,groupMembersAutoExpansionQuery:3,levelMembersQuery:4,reloadMeasuresQuery:5};x._artificialRootContextGroupId="artificialRootContext";x._addHierarchyLevelFilters=function(e,t){e.forEach(function(e){t.removeConditions(e.propertyName);t.addCondition(e.propertyName,h.EQ,e.level)})};x.prototype._getContextsForParentContext=function(e,t,i,r,s,n,a){if(e===undefined){return[]}if(e&&e.getPath()=="/"+x._artificialRootContextGroupId){e=this.getModel().getContext("/")}var o=this._getGroupIdFromContext(e,s);return this._getContextsForParentGroupId(o,t,i,r,n,a)};x.prototype._getContextsForParentGroupId=function(e,t,i,r,s,n){if(e===undefined){return[]}if(!t){t=0}if(!i){i=this.oModel.iSizeLimit}if(this.mFinalLength[e]&&this.mLength[e]<t+i){i=this.mLength[e]-t;if(i<0){R.fatal("invalid start index greater than total group length passed")}}if(!r){r=0}if(!s){s=0}if(e==null){if(s>0){R.fatal("invalid request to determine nodes of root context");return null}}else{if(this._getGroupIdLevel(e)>=this.aAggregationLevel.length&&s>0){R.fatal("invalid request to determine nodes of context with group ID "+e);return null}if(this._getGroupIdLevel(e)+s>this.aAggregationLevel.length){s=this.aAggregationLevel.length-this._getGroupIdLevel(e)-1}}var a=[],o,u,l,d;var h=e==null?0:this._getGroupIdLevel(e)+1;if(!this.aMultiUnitLoadFactor[h]){this.aMultiUnitLoadFactor[h]=1}var p=s>0&&e!=null;if(p){var f=this._getGroupIdLevel(e);var g=f+s;var y=true;if(!n){l=this._calculateRequiredGroupExpansion(e,g,t,i+r);y=l.groupId_Missing==null;y=y||l.groupId_Missing.length<e.length||l.groupId_Missing.substring(0,e.length)!=e}if(y){a=this._getLoadedContextsForGroup(e,t,i)}else{d=i+r}o=!y;d=Math.ceil(d*this.aMultiUnitLoadFactor[h])}else{a=this._getLoadedContextsForGroup(e,t,i,n);o=false;if(!n){if(this._oWatermark&&e===this._oWatermark.groupID){r=1e4}u=this._calculateRequiredGroupSection(e,t,i,r);var c=u.length>0&&i<u.length;o=a.length!=i&&!(this.mFinalLength[e]&&a.length>=this.mLength[e]-t)||c;u.length=Math.ceil(u.length*this.aMultiUnitLoadFactor[h])}}if(!o){this._cleanupGroupingForCompletedRequest(this._getRequestId(x._requestType.groupMembersQuery,{groupId:e}))}var v=false;if(this.oModel.getServiceMetadata()){if(o){var m=this.bProvideTotalSize&&this.iTotalSize==-1&&!this._isRequestPending(this._getRequestId(x._requestType.totalSizeQuery));v=true;var _;if(this.bUseBatchRequests){if(p){_=this._prepareGroupMembersAutoExpansionRequestIds(e,s);for(var I=-1,M;(M=_[++I])!==undefined;){if(this._isRequestPending(M)){v=false;break}}if(v){this.aBatchRequestQueue.push([x._requestType.groupMembersAutoExpansionQuery,e,l,d,s])}}else{v=u.length&&!this._isRequestPending(this._getRequestId(x._requestType.groupMembersQuery,{groupId:e}));if(v){this.aBatchRequestQueue.push([x._requestType.groupMembersQuery,e,u.startIndex,u.length]);_=[this._getRequestId(x._requestType.groupMembersQuery,{groupId:e})]}}if(v&&m){_.push(this._getRequestId(x._requestType.totalSizeQuery));this._considerRequestGrouping(_);this.aBatchRequestQueue.push([x._requestType.totalSizeQuery])}if(v){if(e==null){this._abortAllPendingRequests()}Promise.resolve().then(x.prototype._processRequestQueue.bind(this))}}else{var q;if(p){_=this._prepareGroupMembersAutoExpansionRequestIds(e,s);for(var b=-1,S;(S=_[++b])!==undefined;){if(this._isRequestPending(S)){v=false;break}}if(v){q=this._prepareGroupMembersAutoExpansionQueryRequest(x._requestType.groupMembersAutoExpansionQuery,e,l,d,s)}}else{v=u.length&&!this._isRequestPending(this._getRequestId(x._requestType.groupMembersQuery,{groupId:e}));if(v){q=this._prepareGroupMembersQueryRequest(x._requestType.groupMembersQuery,e,u.startIndex,u.length);_=[q.sRequestId]}}if(v){if(e==null){this._abortAllPendingRequests()}this._executeQueryRequest(q);if(m&&!q.bIsFlatListRequest){_.push(this._getRequestId(x._requestType.totalSizeQuery));this._considerRequestGrouping(_);this._executeQueryRequest(this._prepareTotalSizeQueryRequest(x._requestType.totalSizeQuery))}}}}}return a};x.prototype._getHierarchyLevelFiltersAndAddRecursiveHierarchy=function(e,t){var i,r=[],s=this;if(t===null){return r}i=Object.keys(this.mHierarchyDetailsByName);if(i.length>0&&t!=="/"){R.error("Hierarchy cannot be requested for members of a group",t);return r}i.forEach(function(t){var i=s.mHierarchyDetailsByName[t];e.addRecursiveHierarchy(i.dimensionName,!!i.nodeExternalKeyName,!!i.nodeTextName);r.push({propertyName:i.nodeLevelName,level:i.level})});return r};x.prototype._getNonHierarchyDimensions=function(e){var t=this;return e.filter(function(e){return!t.oDimensionDetailsSet[e].isHierarchyDimension})};x.prototype._processRequestQueue=function(e){if(e===undefined||e===null){e=this.aBatchRequestQueue||[]}if(e.length==0){return}var t=[];var i=false;var r,s,n;for(r=-1;(n=e[++r])!==undefined;){if(n[0]==x._requestType.groupMembersQuery){s=x.prototype._prepareGroupMembersQueryRequest.apply(this,n);i=i||s.bIsFlatListRequest;t.push(s)}}for(r=-1;(n=e[++r])!==undefined;){s=null;switch(n[0]){case x._requestType.groupMembersQuery:continue;case x._requestType.totalSizeQuery:if(!i){s=x.prototype._prepareTotalSizeQueryRequest.apply(this,n);t.push(s)}break;case x._requestType.groupMembersAutoExpansionQuery:s=x.prototype._prepareGroupMembersAutoExpansionQueryRequest.apply(this,n);for(var a=-1,o;(o=s.aGroupMembersAutoExpansionRequestDetails[++a])!==undefined;){t.push(o)}break;case x._requestType.reloadMeasuresQuery:{var u=n[1];for(var l=-1,d;(d=u[++l])!==undefined;){t.push(d)}break}default:R.fatal("unhandled request type "+e[r][0]);continue}}if(t.length>1){this._executeBatchRequest(t)}else{this._executeQueryRequest(t[0])}if(e===this.aBatchRequestQueue){this.aBatchRequestQueue=[]}};x.prototype._prepareGroupMembersQueryRequest=function(e,t,r,s){var n=[],a=[],o;var u=new i.QueryResultRequest(this.oAnalyticalQueryResult);u.setResourcePath(this._getResourcePath());u.getSortExpression().clear();var l=0,d=-1;if(t){n=this._getGroupIdComponents(t);l=d=n.length;var p=0;for(var f=0,g=0;f<l;g++){if(this.oDimensionDetailsSet[this.aMaxAggregationLevel[g]].grouped==false){++p}else{++f}}l=d=l+p;if(this.aMaxAggregationLevel.length>0){while(this.oDimensionDetailsSet[this.aMaxAggregationLevel[d]].grouped==false){if(++d==this.aMaxAggregationLevel.length){break}}}}var y=d>=this.aMaxAggregationLevel.length-1;o=this._getHierarchyLevelFiltersAndAddRecursiveHierarchy(u,t);var c=this.aMaxAggregationLevel.slice(0,d+1);var v=this._getNonHierarchyDimensions(c);u.setAggregationLevel(v);for(var m=0;m<v.length;m++){var _=this.oDimensionDetailsSet[v[m]];var I=_.textPropertyName!=undefined;u.includeDimensionKeyTextAttributes(_.name,true,I,_.aAttributeName);if(_.grouped){a.push({sPath:v[m],bDescending:false})}}var M=u.getFilterExpression();M.clear();if(this.aApplicationFilter){M.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){M.addUI5FilterConditions(this.aControlFilter)}if(l>=1){for(var q=0,b=n.length;q<b;q++){M.removeConditions(this.aAggregationLevel[q]);M.addCondition(this.aAggregationLevel[q],h.EQ,n[q])}}x._addHierarchyLevelFilters(o,M);var S;var A;var P;var L;var N=[];if(t!=null||this.bProvideGrandTotals||this._canApplySortersToGroups()&&this.aSorter.length>0){u.setMeasures(this.aMeasureName);for(var D in this.oMeasureDetailsSet){L=this.oMeasureDetailsSet[D];if(!y&&this._isSkippingTotalForMeasure(D)){S=false;A=false;P=false}else{S=L.rawValuePropertyName!=undefined;A=L.formattedValuePropertyName!=undefined;P=L.unitPropertyName!=undefined;if(P){if(N.indexOf(L.unitPropertyName)==-1){N.push(L.unitPropertyName)}}}u.includeMeasureRawFormattedValueUnit(L.name,S,A,P)}for(var G in v){var Q;if((Q=N.indexOf(v[G]))!=-1){N.splice(Q,1)}}}if(t){this._addSorters(u.getSortExpression(),a)}if(s==0){R.fatal("unhandled case: load 0 entities of sub group")}var F=this._getKeyIndexMapping(t,r);if(!this.bNoPaging){u.setResultPageBoundaries(F.iServiceKeyIndex+1,F.iServiceKeyIndex+s)}u.setRequestOptions(null,!this.mFinalLength[t]);return{iRequestType:e,sRequestId:this._getRequestId(x._requestType.groupMembersQuery,{groupId:t}),oAnalyticalQueryRequest:u,sGroupId:t,aSelectedUnitPropertyName:N,aAggregationLevel:c,bIsFlatListRequest:y&&l==0,bIsLeafGroupsRequest:y,iStartIndex:r,iLength:s,oKeyIndexMapping:F}};x.prototype._prepareTotalSizeQueryRequest=function(e){var t;var r=new i.QueryResultRequest(this.oAnalyticalQueryResult);r.setResourcePath(this._getResourcePath());t=this._getHierarchyLevelFiltersAndAddRecursiveHierarchy(r,"/");r.setAggregationLevel(this._getNonHierarchyDimensions(this.aMaxAggregationLevel));r.setMeasures([]);var s=r.getFilterExpression();s.clear();if(this.aApplicationFilter){s.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){s.addUI5FilterConditions(this.aControlFilter)}x._addHierarchyLevelFilters(t,s);r.setRequestOptions(null,null,true);r.setRequestOptions(null,true);return{iRequestType:e,sRequestId:this._getRequestId(x._requestType.totalSizeQuery),oAnalyticalQueryRequest:r}};x.prototype._prepareGroupMembersAutoExpansionQueryRequest=function(e,t,r,n,a){var o=this;var u=function(e,t){var i=[];if(e.groupId_Missing==null){R.fatal("missing group Id not present");return i}var r=o._getGroupIdComponents(e.groupId_Missing);var n=r.length;if(n>t){R.fatal("the given group ID is too deep for requested level for auto expansion");return i}var a=[];for(var u=0;u<n;u++){var l=o.aAggregationLevel[u];var p=r[u];var f=o._getFilterOperatorMatchingPropertySortOrder(l);a[u]=new d(l,f,p)}var g=null;if(e.startIndex_Missing>0){var y=o._getKey(e.groupId_Missing,e.startIndex_Missing-1);var c=o.oModel.getObject("/"+y);var v=o.aAggregationLevel[n];var m=c[v];g=new d(v,o._getFilterOperatorMatchingPropertySortOrder(v,false),m)}for(var _=0;_<t;_++){var I=[];var M=Math.min(n,_+1);for(var q=0;q<M;q++){var b=[];var x=Math.min(n,q+1);var S=e.startIndex_Missing>0;for(var A=0;A<x;A++){var P=new d("x",h.EQ,"x");P=s(P,a[A]);if(x>1&&A<x-1){P.sOperator=h.EQ}if(A==n-1&&_>n-1&&!S){if(P.sOperator==h.GT){P.sOperator=h.GE}else{P.sOperator=h.LE}}b.push(P)}if(b.length>0){I.push(new d(b,true));if(_>n-1&&q==n-1&&S){var L=[];for(var N=0;N<b.length;N++){var D=new d("x",h.EQ,"x");D=s(D,b[N]);L.push(D)}L[n-1].sOperator=h.EQ;L.push(g);I.push(new d(L,true));break}}}if(I.length>0){i[_]=new d(I,false)}else{i[_]=null}}return i};var l=function(e,t,r,s,n,a,u,l){var d;var h=new i.QueryResultRequest(o.oAnalyticalQueryResult);h.setResourcePath(o._getResourcePath());h.getSortExpression().clear();var p=0,f=-1;p=f=r-1;var g=0;for(var y=0,c=0;y<p;c++){if(o.oDimensionDetailsSet[o.aMaxAggregationLevel[c]].grouped==false){++g}else{++y}}p=f=p+g;if(o.aMaxAggregationLevel.length>0){while(o.aMaxAggregationLevel[f]&&o.oDimensionDetailsSet[o.aMaxAggregationLevel[f]].grouped==false){if(++f==o.aMaxAggregationLevel.length){break}}}var v=f>=o.aMaxAggregationLevel.length-1;d=o._getHierarchyLevelFiltersAndAddRecursiveHierarchy(h,t);var m=o.aMaxAggregationLevel.slice(0,f+1);h.setAggregationLevel(m);for(var _=0;_<m.length;_++){var I=o.oDimensionDetailsSet[m[_]];var M=I.textPropertyName!=undefined;h.includeDimensionKeyTextAttributes(I.name,true,M,I.aAttributeName);if(I.grouped){h.getSortExpression().addSorter(m[_],i.SortOrder.Ascending)}}var q=h.getFilterExpression();q.clear();if(o.aApplicationFilter){q.addUI5FilterConditions(o.aApplicationFilter)}if(o.aControlFilter){q.addUI5FilterConditions(o.aControlFilter)}if(s){q.addUI5FilterConditions([s])}x._addHierarchyLevelFilters(d,q);var b;var S;var A;var P;var L=[];h.setMeasures(o.aMeasureName);for(var N in o.oMeasureDetailsSet){P=o.oMeasureDetailsSet[N];if(!v&&o._isSkippingTotalForMeasure(N)){b=false;S=false;A=false}else{b=P.rawValuePropertyName!=undefined;S=P.formattedValuePropertyName!=undefined;A=P.unitPropertyName!=undefined;if(A){if(L.indexOf(P.unitPropertyName)==-1){L.push(P.unitPropertyName)}}}h.includeMeasureRawFormattedValueUnit(P.name,b,S,A)}for(var D in m){var G;if((G=L.indexOf(m[D]))!=-1){L.splice(G,1)}}var Q=h.getSortExpression();for(var F=0;F<o.aSorter.length;F++){if(o.aSorter[F]){Q.addSorter(o.aSorter[F].sPath,o.aSorter[F].bDescending?i.SortOrder.Descending:i.SortOrder.Ascending)}}if(a==0){R.fatal("unhandled case: load 0 entities of sub group")}var T=n;if(!l){T=0}else{var C=0;for(var E in o.mServiceKey){if(E.split("/").length===r+1){C+=o.mServiceKey[E].length}}T=Math.max(T,C)}if(!o.bNoPaging){h.setResultPageBoundaries(T+1,T+a)}return{iRequestType:e,sRequestId:null,oAnalyticalQueryRequest:h,iLevel:r,aSelectedUnitPropertyName:L,aAggregationLevel:m,bIsFlatListRequest:v,bIsLeafGroupsRequest:v,iStartIndex:n,iLength:a,bAvoidLengthUpdate:u}};var p=[];var f=[];if(!r){R.fatal("no first missing group member specified")}var g=this._getGroupIdLevel(t)+a+1;var y=o._getGroupIdComponents(r.groupId_Missing);var c=y.length;var v=u(r,g);var m;for(var _=1;_<=g;_++){var I;if(_>=c+2){I=0;m=undefined}else if(_==c+1){I=r.startIndex_Missing;m=r.groupId_Missing}else if(c>0){if(_==c){m=r.groupId_Missing}else{m=this._getGroupIdAncestors(r.groupId_Missing,-(c-_))[0]}var M=this._getGroupIdAncestors(r.groupId_Missing,-(c-_+1))[0];if(!M){R.fatal("failed to determine group id at parent level; group ID = "+t+", level = "+_)}I=this._findKeyIndex(M,this.mEntityKey[m]);if(I==-1){R.fatal("failed to determine position of value "+m+" in group "+M)}m=M;I++}var q=n>_?Math.ceil((n-_)/(g-_+1)):n;var b=v[_-1];if(this.bUseAcceleratedAutoExpand){var S=l(x._requestType.levelMembersQuery,t,_,b,I,q,false,b==null?true:false);S.sGroupId_Missing_AtLevel=m;S.sRequestId=this._getRequestId(x._requestType.levelMembersQuery,{groupId:t,level:_});p.push(S);f.push(S.sRequestId)}else if(b&&b.aFilters.length>0){if(!b._bMultiFilter||b.bAnd){R.fatal("level filter in wrong shape; cannot break it up")}for(var A=0;A<b.aFilters.length;A++){var P=b.aFilters[A];var L=l(x._requestType.levelMembersQuery,t,_,P,I,q,false,b==null?true:false);L.sGroupId_Missing_AtLevel=m;L.sRequestId=this._getRequestId(x._requestType.levelMembersQuery,{groupId:t,level:_,tupleIndex:A});p.push(L);f.push(L.sRequestId)}}else{var N=l(x._requestType.levelMembersQuery,t,_,null,I,q,false,b==null?true:false);N.sGroupId_Missing_AtLevel=m;N.sRequestId=this._getRequestId(x._requestType.levelMembersQuery,{groupId:t,level:_});p.push(N);f.push(N.sRequestId)}}return{iRequestType:e,aRequestId:f,aGroupMembersAutoExpansionRequestDetails:p,sGroupId:t,iLength:n}};x.prototype._prepareReloadMeasurePropertiesQueryRequest=function(e,t,r){var s=new i.QueryResultRequest(this.oAnalyticalQueryResult);s.setResourcePath(this._getResourcePath());s.getSortExpression().clear();var n=t.aAggregationLevel;s.setAggregationLevel(n);var a=t.bIsLeafGroupsRequest;var o=s.getFilterExpression();o.clear();if(this.aApplicationFilter){o.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){o.addUI5FilterConditions(this.aControlFilter)}var u=[];for(var l=0;l<n.length;l++){var p=new d(n[l],h.EQ,r.oEntry[n[l]]);u.push(p)}o.addUI5FilterConditions(u);var f;var g;var y;var c;var v=[];s.setMeasures(r.aReloadMeasurePropertyName);for(var m in this.oMeasureDetailsSet){c=this.oMeasureDetailsSet[m];if(!r.aReloadMeasurePropertyName||r.aReloadMeasurePropertyName.indexOf(c.name)==-1){continue}if(!a&&this._isSkippingTotalForMeasure(m)){f=false;g=false;y=false}else{f=c.rawValuePropertyName!=undefined;g=c.formattedValuePropertyName!=undefined;y=c.unitPropertyName!=undefined;if(y){if(v.indexOf(c.unitPropertyName)==-1){v.push(c.unitPropertyName)}}}s.includeMeasureRawFormattedValueUnit(c.name,f,g,y)}for(var _ in n){var I;if((I=v.indexOf(n[_]))!=-1){v.splice(I,1)}}return{iRequestType:e,sRequestId:this._getRequestId(x._requestType.reloadMeasuresQuery,{multiUnitEntryKey:this.oModel.getKey(r.oEntry)}),oAnalyticalQueryRequest:s,aSelectedUnitPropertyName:v,aAggregationLevel:n,oMultiUnitRepresentative:r}};x.prototype._prepareGroupMembersAutoExpansionRequestIds=function(e,t){var i=this._getGroupIdLevel(e)+1;var r=i+t;var s=[];for(var n=i;n<=r;n++){s.push(this._getRequestId(x._requestType.levelMembersQuery,{groupId:e,level:n}))}return s};x.prototype._getQueryODataRequestOptions=function(e,t,i){var r;i=i||{};try{e.getFilterExpression().checkValidity()}catch(e){R.fatal("filter expression is not valid",e.toString());return undefined}var s=e.getURIQueryOptionValue("$select");var n=e.getURIQueryOptionValue("$filter");var a=e.getURIQueryOptionValue("$orderby");var o=e.getURIQueryOptionValue("$skip");var u=e.getURIQueryOptionValue("$top");var l=e.getURIQueryOptionValue("$inlinecount");if(t&&this.aAdditionalSelects.length>0){s=(s?s.split(","):[]).concat(this.aAdditionalSelects).join(",")}if(this.mParameters&&this.mParameters["filter"]){if(n===null){n=this.mParameters["filter"]}else{n+="and ("+this.mParameters["filter"]+")"}}var d=[];if(s!==null){d.push("$select="+s)}if(n!==null){d.push("$filter="+n)}if(a!==null){d.push("$orderby="+a)}if(o!==null){d.push("$skip="+o)}if(u!==null){d.push("$top="+u)}if(l!==null){d.push("$inlinecount="+l)}if(i.encode===true){for(r=0;r<d.length;r++){d[r]=d[r].replace(/\ /g,"%20")}}return d};x.prototype._executeBatchRequest=function(i){var r=this.iAnalyticalInfoVersionNumber,s,n=this;var a=[],o=[];function u(){n.fireDataReceived({__simulateAsyncAnalyticalBinding:true})}var l=new t;function d(e,t){l.success(t)}function h(e,t){l.error(t||e)}this.bNeedsUpdate=true;for(var p=0;p<i.length;p++){var f=i[p];if(f.aAggregationLevel&&f.aAggregationLevel.length>0){this.bNeedsUpdate=false}}for(var g=-1,y;(y=i[++g])!==undefined;){var c=y.oAnalyticalQueryRequest,v=y.sGroupId;if(c.getURIQueryOptionValue("$select")==null){this.fireDataRequested({__simulateAsyncAnalyticalBinding:true});v=null;this.mServiceLength[v]=this.mLength[v]=1;this.mServiceFinalLength[v]=true;this._setServiceKey(this._getKeyIndexMapping(v,0),x._artificialRootContextGroupId);setTimeout(u);this.bArtificalRootContext=true;continue}var m=c.getURIToQueryResultEntries();if(!this.oContext&&m[0]!=="/"){m="/"+m}if(!this._isRequestPending(y.sRequestId)){this._registerNewRequest(y.sRequestId);if(this.iModelVersion===e.V1){a.push(this.oModel.createBatchOperation(m.replace(/\ /g,"%20"),"GET"))}else if(this.iModelVersion===e.V2){var _=this._getQueryODataRequestOptions(c,y.bIsLeafGroupsRequest,{encode:true});if(this.sCustomParams){_.push(this.sCustomParams)}var I=this.oModel.read(m.replace(/\ /g,"%20"),{success:d,error:h,context:this.oContext,urlParameters:_});a.push(I)}o.push(y)}}if(a.length>0){R.debug("AnalyticalBinding: executing batch request with "+o.length+" operations");var M;s=this._getIdForNewRequestHandle();this.fireDataRequested();if(this.iModelVersion===e.V1){this.oModel.addBatchReadOperations(a);M=this.oModel.submitBatch(q,b,true,true);this.oModel.fireRequestSent({url:this.oModel.sServiceUrl+"/$batch",type:"POST",async:true,info:"",infoObject:{}})}else{M={abort:function(){for(var e=0;e<a.length;e++){a[e].abort()}}};l.setup({executedRequests:o,binding:this,success:q,error:b})}this._registerNewRequestHandle(s,M)}function q(t,i){n._deregisterHandleOfCompletedRequest(s);if(o.length!=t.__batchResponses.length){R.fatal("assertion failed: received "+t.__batchResponses.length+" responses for "+o.length+" read operations in the batch request")}if(r!=n.iAnalyticalInfoVersionNumber){for(var a=0;a<o.length;a++){var u=o[a].sRequestId;if(u!==undefined){n._deregisterCompletedRequest(u);n._cleanupGroupingForCompletedRequest(u)}}n.fireDataReceived({data:[]});return}var l=0;for(var d=0;d<t.__batchResponses.length;d++){if(t.__batchResponses[d].data!=undefined){if(t.__batchResponses[d].data.results.length==0){l++}switch(o[d].iRequestType){case x._requestType.groupMembersQuery:n._processGroupMembersQueryResponse(o[d],t.__batchResponses[d].data);break;case x._requestType.totalSizeQuery:n._processTotalSizeQueryResponse(o[d],t.__batchResponses[d].data);break;case x._requestType.levelMembersQuery:n._processLevelMembersQueryResponse(o[d],t.__batchResponses[d].data);break;case x._requestType.reloadMeasuresQuery:n._processReloadMeasurePropertiesQueryResponse(o[d],t.__batchResponses[d].data);break;default:R.fatal("invalid request type "+o[d].iRequestType);continue}}n._deregisterCompletedRequest(o[d].sRequestId);n._cleanupGroupingForCompletedRequest(o[d].sRequestId)}if(n.mParameters&&n.mParameters.numberOfExpandedLevels>0){if(l==t.__batchResponses.length){n.mLength["/"]=0;n.mFinalLength["/"]=true}}var h=true;var p;n.fireDataReceived({data:t});var f={};if(n.iModelVersion===e.V1){p=n.oModel._getBatchErrors(t);if(p.length>0){h=false;f=n.oModel._handleError(p[0])}n.oModel.fireRequestCompleted({url:i.requestUri,type:"POST",async:true,info:"",infoObject:{},success:h,errorobject:h?{}:f});if(h){n.oModel.checkUpdate()}}}function b(t){if(t&&t.statusText!="abort"){n._deregisterHandleOfCompletedRequest(s);for(var i=-1,a;(a=o[++i])!==undefined;){n._deregisterCompletedRequest(a.sRequestId);n._cleanupGroupingForCompletedRequest(a.sRequestId)}}if(r!=n.iAnalyticalInfoVersionNumber){return}var u=t;if(n.iModelVersion===e.V1){u=n.oModel._handleError(t)}n.oModel.fireRequestCompleted({url:"",type:"POST",async:true,info:"",infoObject:{},success:false,errorobject:u});if(n.iModelVersion===e.V1){n.oModel.fireRequestFailed(u)}n.fireDataReceived()}};x.prototype._executeQueryRequest=function(t){if(t.iRequestType==x._requestType.groupMembersAutoExpansionQuery){for(var i=-1,r;(r=t.aGroupMembersAutoExpansionRequestDetails[++i])!==undefined;){this._executeQueryRequest(r)}return}var s=this.iAnalyticalInfoVersionNumber;var n=t.oAnalyticalQueryRequest,a=t.sGroupId;var o=n.getURIToQueryResultEntitySet();var u=this._getQueryODataRequestOptions(n,t.bIsLeafGroupsRequest);if(!u){return}var l=this;if(n.getURIQueryOptionValue("$select")==null){this.fireDataRequested({__simulateAsyncAnalyticalBinding:true});a=null;this.mServiceLength[a]=this.mLength[a]=1;this.mServiceFinalLength[a]=true;this._setServiceKey(this._getKeyIndexMapping(a,0),x._artificialRootContextGroupId);this.bNeedsUpdate=true;setTimeout(function(){if(l._cleanupGroupingForCompletedRequest(t.sRequestId)){l.fireDataReceived({__simulateAsyncAnalyticalBinding:true})}});this.bArtificalRootContext=true;return}this._registerNewRequest(t.sRequestId);this.fireDataRequested();for(var d=0;d<u.length;d++){u[d]=u[d].replace(/\ /g,"%20")}R.debug("AnalyticalBinding: executing query request");var h=this._getIdForNewRequestHandle();if(this.iModelVersion===e.V1){this.oModel._loadData(o,u,f,y,false,c,g)}else{if(this.sCustomParams){u.push(this.sCustomParams)}var p=this.oModel.read(o.replace(/ /g,"%20"),{success:f,error:y,context:this.oContext,urlParameters:u});l._registerNewRequestHandle(h,p)}function f(i){l._deregisterHandleOfCompletedRequest(h);if(s!=l.iAnalyticalInfoVersionNumber){l._deregisterCompletedRequest(t.sRequestId);return}switch(t.iRequestType){case x._requestType.groupMembersQuery:l._processGroupMembersQueryResponse(t,i);break;case x._requestType.totalSizeQuery:l._processTotalSizeQueryResponse(t,i);break;case x._requestType.levelMembersQuery:l._processLevelMembersQueryResponse(t,i);break;case x._requestType.reloadMeasuresQuery:l._processReloadMeasurePropertiesQueryResponse(t,i);break;default:R.fatal("invalid request type "+t.iRequestType);break}l._deregisterCompletedRequest(t.sRequestId);if(l.iModelVersion===e.V2){g(i)}}function g(e){if(s!=l.iAnalyticalInfoVersionNumber){return}if(l._cleanupGroupingForCompletedRequest(t.sRequestId)){l.fireDataReceived({data:e})}}function y(e){if(e&&e.statusText=="abort"){l.fireDataReceived();return}l._deregisterHandleOfCompletedRequest(h);l._deregisterCompletedRequest(t.sRequestId);l._cleanupGroupingForCompletedRequest(t.sRequestId);if(s!=l.iAnalyticalInfoVersionNumber){return}l.fireDataReceived()}function c(e){l._registerNewRequestHandle(h,e)}};x.prototype._abortAllPendingRequests=function(){this._abortAllPendingRequestsByHandle();this._clearAllPendingRequests()};x.prototype._processGroupMembersQueryResponse=function(e,t){var i,r=e.sGroupId,s=this.aSorter.length>0,n=e.aSelectedUnitPropertyName,a=e.aAggregationLevel,o=e.oKeyIndexMapping.iIndex,u=e.oKeyIndexMapping.iServiceKeyIndex,l=e.iLength,d=e.oKeyIndexMapping,h=r==null?0:this._getGroupIdLevel(r)+1,p=n.length>0,f,g,y,c=0,v,m,_=[];var I=t.results.length;if(r===null&&I>1&&this._canApplySortersToGroups()){this._warnNoSortingOfGroups(s?"binding is refreshed":undefined);if(s){setTimeout(this.refresh.bind(this),0);return}}var M=this._getServiceKeys(r,d.iIndex-1);f=undefined;if(M&&M.length>0){for(var q=0,b=M.length;q<b;q++){t.results[q-b]=this.oModel.getObject("/"+M[q])}var A=t.results[-M.length];f="";for(var P=0;P<a.length;P++){f+=A[a[P]]+"|"}}v=M&&M.length==1;for(var L=0;L<I;L++){var N=t.results[L];if(p){g="";for(var D=0;D<a.length;D++){g+=N[a[D]]+"|"}if(f==g){this._warnNoSortingOfGroups();if(y===undefined){if(L==0){y=-M.length;d.iServiceKeyIndex-=M.length-1}else{y=L-1}}var G=-1,Q=t.results[L-1];for(var F=0;F<n.length;F++){if(Q[n[F]]!=N[n[F]]){G=F;break}}if(G==-1){R.fatal("assertion failed: no deviating units found for result entries "+(L-1)+" and "+L,null,null,S(this,"NO_DEVIATING_UNITS"))}}if((f!=g||L==I-1)&&y!==undefined){var T=[];for(var C=y;C<L;C++){T.push(t.results[C])}if(f==g){T.push(t.results[L])}var E=[];for(var K=0;K<n.length;K++){var O=n[K];for(var U=1;U<T.length;U++){if(T[U-1][O]!=T[U][O]){E.push(O);break}}}var w=this._createMultiUnitRepresentativeEntry(r,t.results[y],n,E,e.bIsFlatListRequest);if(w.aReloadMeasurePropertyName.length>0){m=this._prepareReloadMeasurePropertiesQueryRequest(x._requestType.reloadMeasuresQuery,e,w);if(m.oAnalyticalQueryRequest&&m.oAnalyticalQueryRequest.getURIQueryOptionValue("$select")!=null){_.push(m)}}var V=this._setAdjacentMultiUnitKeys(d,w,T);var B;if(w.bIsNewEntry){B=T.length-1}else{B=V}if(v){v=false}if(B<0){R.fatal("assertion failed: iDiscardedEntriesCount must be non-negative")}c+=B;var k=this.oModel._getKey(w.oEntry);var H=this.oModel.getContext("/"+k);this._getGroupIdFromContext(H,h);this.mEntityKey[i]=k;y=undefined;if(f!=g){v=this._setServiceKey(d,this.oModel._getKey(N))}}else if(f!=g){v=this._setServiceKey(d,this.oModel._getKey(N))}f=g}else{this._setServiceKey(d,this.oModel._getKey(N))}if(!e.bIsLeafGroupsRequest){var z=this._getKey(r,d.iIndex-1);i=this._getGroupIdFromContext(this.oModel.getContext("/"+z),h);this.mEntityKey[i]=z}}var j=[];if(this.bReloadSingleUnitMeasures&&_.length>0){if(this.bUseBatchRequests){this.aBatchRequestQueue.push([x._requestType.reloadMeasuresQuery,_]);Promise.resolve().then(x.prototype._processRequestQueue.bind(this))}else{for(var $=0;$<_.length;$++){var Z=_[$];this._executeQueryRequest(Z)}}for(var W=0;W<_.length;W++){var J=_[W];j.push(J.sRequestId)}this._considerRequestGrouping(j)}if(M&&M.length>0){for(var X=0,Y=M.length;X<Y;X++){delete t.results[X-Y]}}if(p){c+=this._mergeLoadedKeyIndexWithSubsequentIndexes(d,a,n,e.bIsFlatListRequest)}if(!e.bAvoidLengthUpdate){var ee=false;if(t.__count){this.mServiceLength[r]=parseInt(t.__count);this.mLength[r]=this.mServiceLength[r]-c;this.mFinalLength[r]=true;if(e.bIsFlatListRequest){this.iTotalSize=this.mServiceLength[r]}ee=true}if(!(r in this.mServiceLength)||this.mServiceLength[r]<u+I){this.mServiceLength[r]=u+I;this.mLength[r]=o+I-c;this.mFinalLength[r]=false}if(I<l||l===undefined){this.mServiceLength[r]=u+I;this.mLength[r]=o+d.iIndex-o;this.mFinalLength[r]=true;ee=true}if(I==0){this.mLength[r]=this.mServiceLength[r]=0;this.mFinalLength[r]=true;ee=true}if(!ee&&this.mLength[r]!==undefined&&c>0){this.mLength[r]-=c}}this.bNeedsUpdate=true;if(c>0){if(t.results.length-c>0){this.aMultiUnitLoadFactor[a.length]=t.results.length/(t.results.length-c)}if(this.aMultiUnitLoadFactor[a.length]<1.5){this.aMultiUnitLoadFactor[a.length]=2}}R.info("MultiUnit Situation in Group ("+r+"), discarded: "+c+", load-factor is now: "+this.aMultiUnitLoadFactor[a.length])};x.prototype._processTotalSizeQueryResponse=function(e,t){if(t.__count==undefined){R.fatal("missing entity count in query result");return}this.iTotalSize=parseInt(t.__count)};x.prototype._processLevelMembersQueryResponse=function(e,t){var i=this;var r,n;var a=function(a,o){var u={iRequestType:x._requestType.groupMembersQuery,sRequestId:i._getRequestId(x._requestType.groupMembersQuery,{groupId:r}),oAnalyticalQueryRequest:e.oAnalyticalQueryRequest,sGroupId:r,aSelectedUnitPropertyName:e.aSelectedUnitPropertyName,aAggregationLevel:e.aAggregationLevel,bIsFlatListRequest:e.bIsFlatListRequest,bIsLeafGroupsRequest:e.bIsLeafGroupsRequest,iStartIndex:a?e.iStartIndex:0,iLength:e.iLength,bAvoidLengthUpdate:e.bAvoidLengthUpdate};if(a&&e.iStartIndex>0&&(e.sGroupId_Missing_AtLevel!=u.sGroupId||i._getKeys(u.sGroupId)===undefined)){var l=i._getParentGroupId(u.sGroupId);var d=i._findKeyIndex(l,i.mEntityKey[u.sGroupId]);if(d<0){R.fatal("assertion failed: failed to determine position of "+u.sGroupId+" in group "+l)}else if(!d){i.mFinalLength[e.sGroupId_Missing_AtLevel]=true}else if(i._getKey(l,d-1)!==undefined){var h=i._getKey(l,d-1);var p=i._getGroupIdFromContext(i.oModel.getContext("/"+h),i._getGroupIdLevel(u.sGroupId));i.mFinalLength[p]=true;u.iStartIndex=0}}if(o){u.iLength=n.length}u.oKeyIndexMapping=i._getKeyIndexMapping(u.sGroupId,u.iStartIndex);var f=s({},t);f.results=n;i._processGroupMembersQueryResponse(u,f)};if(t.results.length==0){this.bNeedsUpdate=true;return}r=this._getGroupIdFromContext(this.oModel.getContext("/"+this.oModel._getKey(t.results[0])),e.iLevel-1);n=[];var o=true;for(var u=0;u<t.results.length;u++){var l=t.results[u];var d=this.oModel.getContext("/"+this.oModel._getKey(t.results[u]));var h=this._getGroupIdFromContext(d,e.iLevel-1);if(r==h){n.push(l);if(u<t.results.length-1){continue}}a(o,t.results.length==e.iLength&&u==t.results.length-1);o=false;if(r!=h){n=[l]}r=h}if(t.results.length>1&&n.length==1){a(o,t.results.length==e.iLength)}};x.prototype._processReloadMeasurePropertiesQueryResponse=function(e,t){var i=e.oMultiUnitRepresentative;var r=this.oModel.getKey(i.oEntry);if(t.results.length!=1){R.fatal("assertion failed: more than one entity for reloaded measure properties of entity with key "+r);return}var s=t.results[0];var n=this.oModel.getObject("/"+r);if(!n){R.fatal("assertion failed: no entity found with key "+r);return}var a=i.aReloadMeasurePropertyName;for(var o=0;o<a.length;o++){n[a[o]]=s[a[o]]}};x.prototype._getLoadedContextsForGroup=function(e,t,i,r){var s=[],n,a,o=this._getKeys(e),u;if(!o){return s}if(!t){t=0}if(!i){i=this.oModel.iSizeLimit;if(this.mFinalLength[e]){i=this.mLength[e]}}if(r){a=t||0;u=o(a);while(u){n=this.oModel.getContext("/"+u);s.push(n);a++;u=o(a)}return s}for(a=t;a<t+i;a++){u=o(a);if(!u){break}n=this.oModel.getContext("/"+u);s.push(n)}return s};x.prototype._calculateRequiredGroupSection=function(e,t,i,r){var s=this.mKeyIndex[e]||[],n=this.mFinalLength[e]?this.mLength[e]:undefined,a=m._getReadIntervals(s,t,i,r,n),o=m._mergeIntervals(a);if(o){return{startIndex:o.start,length:o.end-o.start}}return{startIndex:0,length:Math.min(0,i)}};x.prototype._calculateRequiredGroupExpansion=function(e,t,i,r){var s={groupId_Missing:null,length_Missing:0};var n=this;var a=function(e,t,i,r){var o=n._getGroupIdLevel(e);if(o==t){var u=n._getLoadedContextsForGroup(e,i,r);var l=i+u.length-1;if(u.length>=r){return s}else if(n.mFinalLength[e]){if(u.length>=n.mLength[e]){return{groupId_Missing:null,length_Missing:r-u.length}}else{return{groupId_Missing:e,startIndex_Missing:l+1,length_Missing:r-u.length}}}else{return{groupId_Missing:e,startIndex_Missing:l+1,length_Missing:r-u.length}}}var d=n._getLoadedContextsForGroup(e,i,r);var h=r,p=i+d.length-1;for(var f=-1,g;(g=d[++f])!==undefined;){h--;var y=a(n._getGroupIdFromContext(g,o+1),t,0,h);if(y.groupId_Missing==null){if(y.length_Missing==0){return y}else{h=y.length_Missing}}else{return y}if(h==0){break}}if(n.mFinalLength[e]||h==0){return{groupId_Missing:null,length_Missing:h}}else{return{groupId_Missing:e,startIndex_Missing:p+1,length_Missing:h}}};var o=this._getGroupIdLevel(e);if(o==t+1){e=this._getParentGroupId(e);--o}if(e==null||o>t){return s}var u=r,l=i;while(e!=null){var d=a(e,t,l,u);if(d.groupId_Missing!=null){return d}else if(d.length_Missing==0){return d}else{var h=false;while(!h){var p=this._getParentGroupId(e);if(p==null){e=p;--o;break}var f=this.mEntityKey[e];if(!f){return s}var g=this._findKeyIndex(p,f);if(g==-1){return s}if(g==this._getKeyCount(p)-1){if(this.mFinalLength[p]){e=p;--o;continue}else{return{groupId_Missing:p,startIndex_Missing:g+1,length_Missing:u}}}else{f=this._getKey(p,g+1);e=this._getGroupIdFromContext(this.oModel.getContext("/"+f),o);h=true}}l=0;u=d.length_Missing}}return{groupId_Missing:null,length_Missing:u}};x.prototype._getResourcePath=function(){return this.isRelative()?this.getResolvedPath():this.sPath};x.prototype._getEntitySet=function(){var e=this.sEntitySetName;if(!e){e=this.sPath.split("/")[1];if(e.indexOf("(")!=-1){e=e.split("(")[0]+"Results"}}return e};x.prototype._getEffectiveSortOrder=function(e){for(var t=0;t<this.aSorter.length;t++){if(this.aSorter[t]&&this.aSorter[t].sPath==e){return this.aSorter[t].bDescending?i.SortOrder.Descending:i.SortOrder.Ascending}}return null};x.prototype._getFilterOperatorMatchingPropertySortOrder=function(e,t){var r;switch(this._getEffectiveSortOrder(e)){case i.SortOrder.Ascending:if(t){r=h.GE}else{r=h.GT}break;case i.SortOrder.Descending:if(t){r=h.LE}else{r=h.LT}break;default:r=h.GT}return r};x.prototype._convertDeprecatedFilterObjects=function(e){if(!e){return e}var t=sap.ui.require("sap/ui/model/odata/Filter");if(typeof t==="function"){for(var i=0,r=e.length;i<r;i++){if(e[i]instanceof t){e[i]=e[i].convert()}}}return e};x.prototype._getGroupIdFromContext=function(e,t){if(!e){return null}var i="/";var r=null;if(t>this.aAggregationLevel.length){R.fatal("assertion failed: aggregation level deeper than number of current aggregation levels")}for(var s=0;s<t;s++){r=e.getProperty(this.aAggregationLevel[s]);if(r!=null){if(r.__edmType==="Edm.Time"){r=r.ms}i+=encodeURIComponent(r)+"/"}else{i+="@/"}}return i};x.prototype._getGroupIdLevel=function(e){if(e==null){R.fatal("assertion failed: no need to determine level of group ID = null");return-1}return e.split("/").length-2};x.prototype._getGroupIdComponents=function(e){if(e==null){return null}var t=e.split("/");var i=[];for(var r=1;r<t.length-1;r++){if(t[r]=="@"){i[r-1]=null}else{i[r-1]=decodeURIComponent(t[r])}}return i};x.prototype._getGroupIdAncestors=function(e,t){if(!t){return[]}if(e==null){R.fatal("group ID null does not have ancestors");return[]}if(e=="/"){if(Math.abs(t)==1){return[null]}else{R.fatal("invalid level count "+t+" for ancestors of groupId "+e);return[]}}var i=e.split("/");var r=[],s="";var n=0,a=i.length-3;if(t>0){if(t-1>a){R.fatal("invalid level count "+t+" for ancestors of groupId "+e)}else{a=t-1}}else if(-(t+1)>a){R.fatal("invalid level count "+t+" for ancestors of groupId "+e)}else{n=a+1+t;for(var o=0;o<n;o++){s+=i[o]+"/"}}for(var u=n;u<=a;u++){s+=i[u]+"/";r.push(s)}return r};x.prototype._getParentGroupId=function(e){return this._getGroupIdAncestors(e,-1)[0]};x.prototype._removeDuplicatesFromStringArray=function(e){var t={};for(var i=0;i<e.length;i++){t[e[i]]=true}var r=[];for(var s in t){r.push(s)}return r};x.prototype._getIdForNewRequestHandle=function(){if(this.oPendingRequestHandle===undefined){this.oPendingRequestHandle=[]}for(var e=0;e<this.oPendingRequestHandle.length;e++){if(this.oPendingRequestHandle[e]===undefined){return e}}this.oPendingRequestHandle[this.oPendingRequestHandle.length]=undefined;return this.oPendingRequestHandle.length-1};x.prototype._registerNewRequestHandle=function(e,t){if(this.oPendingRequestHandle[e]!==undefined){R.fatal("request handle ID already in use")}this.oPendingRequestHandle[e]=t};x.prototype._deregisterHandleOfCompletedRequest=function(e){if(o(this.oPendingRequestHandle)){R.warning("No request handles to be cleared. Previous abort/resetData?");return}if(this.oPendingRequestHandle[e]===undefined){R.fatal("no handle found for this request ID")}this.oPendingRequestHandle[e]=undefined};x.prototype._abortAllPendingRequestsByHandle=function(){for(var e=0;e<this.oPendingRequestHandle.length;e++){if(this.oPendingRequestHandle[e]){if(this.oPendingRequestHandle[e]!==undefined){this.oPendingRequestHandle[e].abort()}}}this.oPendingRequestHandle=[]};x.prototype._getRequestId=function(e,t){switch(e){case x._requestType.groupMembersQuery:if(t.groupId===undefined){R.fatal("missing group ID")}return x._requestType.groupMembersQuery+(t.groupId==null?"":t.groupId);case x._requestType.levelMembersQuery:if(t.level===undefined){R.fatal("missing level")}if(t.groupId===undefined){R.fatal("missing groupId")}return""+x._requestType.levelMembersQuery+t.level+(t.tupleIndex?"-"+t.tupleIndex:"");case x._requestType.totalSizeQuery:return x._requestType.totalSizeQuery;case x._requestType.reloadMeasuresQuery:if(!t.multiUnitEntryKey){R.fatal("missing multi unit entry key")}return x._requestType.reloadMeasuresQuery+t.multiUnitEntryKey;default:R.fatal("invalid request type "+e);return-1}};x.prototype._registerNewRequest=function(e){if(e==undefined||e==""){R.fatal("missing request ID");return}if(!this.oPendingRequests[e]){this.oPendingRequests[e]=1}else{++this.oPendingRequests[e]}};x.prototype._considerRequestGrouping=function(e){for(var t=-1,i;(i=e[++t])!==undefined;){if(this.oGroupedRequests[i]===undefined){this.oGroupedRequests[i]={}}var r=this.oGroupedRequests[i];for(var s=0;s<e.length;s++){r[e[s]]=true}}};x.prototype._isRequestPending=function(e){return this.oPendingRequests[e]!=undefined&&this.oPendingRequests[e]>0};x.prototype._deregisterCompletedRequest=function(e){if(o(this.oPendingRequests)){R.warning("There are no pending requests which could be set to 'completed'.");return}if(!this.oPendingRequests[e]){R.fatal("assertion failed: there is no pending request ID "+e)}if(this.oPendingRequests[e]==1){delete this.oPendingRequests[e]}else{--this.oPendingRequests[e]}};x.prototype._cleanupGroupingForCompletedRequest=function(e){if(this._isRequestPending(e)){return false}var t=true;if(this.oGroupedRequests[e]!=undefined){for(var i in this.oGroupedRequests[e]){if(this.oPendingRequests[i]){t=false;break}}}if(t){var r=this.oGroupedRequests[e];delete this.oGroupedRequests[e];for(var s in r){if(s!=e){this._cleanupGroupingForCompletedRequest(s)}}}return t};x.prototype._getKeyIndexMapping=function(e,t){var i,r,s,n=this.mKeyIndex[e],a={sGroupId:e,iIndex:t,iServiceKeyIndex:t},o=this.mServiceKey[e];if(n!==undefined){if(n[t]!==undefined){a.iServiceKeyIndex=n[t]==="ZERO"?0:Math.abs(n[t]);return a}r=t;if(r>0){while(--r>0){if(n[r]!==undefined){break}}}if(r==0){s=0}else{if(n[r]>=0){s=n[r]}else if(n[r+1]===undefined){s=-n[r];while(o[s+1]!==undefined){++s}}else{s=Math.abs(n[r+1])-1}if(o[s]===undefined){R.fatal("assertion failed: no service key at iLastOccupiedServiceKeyIndex = "+s)}}i=t-r;a.iServiceKeyIndex=s+i}return a};x.prototype._moveKeyIndexMapping=function(e,t){return this._getKeyIndexMapping(e.sGroupId,e.iIndex+t)};x.prototype._getKey=function(e,t){var i=this.mKeyIndex[e][t];if(i===undefined){return undefined}if(i>=0){return this.mServiceKey[e][i]}if(this.mMultiUnitKey[e]===undefined){R.fatal("assertion failed: missing expected multi currency key for group with ID "+e);return null}var r=this.mMultiUnitKey[e][t];if(r===undefined){R.fatal("assertion failed: missing expected multi currency key for group with ID "+e+" at pos "+t);return null}return r};x.prototype._getKeys=function(e){if(this.mKeyIndex[e]===undefined){return undefined}var t=this;return function(i){return t._getKey(e,i)}};x.prototype._getServiceKeys=function(e,t){var i=this.mKeyIndex[e];if(i===undefined){return undefined}var r=this.mServiceKey[e],s=i[t];if(s===undefined){return undefined}if(s>=0){return[r[s]]}var n=[];if(i[t+1]===undefined){s=i[t]=="ZERO"?0:-i[t];while(r[s]!==undefined){n.push(r[s++])}}else{s=i[t]=="ZERO"?0:-i[t];for(var a=s,o=Math.abs(i[t+1]);a<o;a++){n.push(r[a])}}return n};x.prototype._getKeyCount=function(e){if(this.mKeyIndex[e]===undefined){return undefined}return this.mKeyIndex[e].length};x.prototype._findKeyIndex=function(e,t){var i=this.mKeyIndex[e];var r=this.mServiceKey[e];var s=this.mMultiUnitKey[e];for(var n=0;n<this.mLength[e];n++){if(i[n]<0||i[n]==="ZERO"){if(s[n]==t){return n}}else if(r[i[n]]==t){return n}}return-1};x.prototype._setServiceKey=function(e,t){if(!this.mServiceKey[e.sGroupId]){this.mServiceKey[e.sGroupId]=[]}if(!this.mKeyIndex[e.sGroupId]){this.mKeyIndex[e.sGroupId]=[]}var i=this.mServiceKey[e.sGroupId][e.iServiceKeyIndex]===undefined;this.mServiceKey[e.sGroupId][e.iServiceKeyIndex++]=t;this.mKeyIndex[e.sGroupId][e.iIndex++]=e.iServiceKeyIndex-1;return i};x.prototype._setAdjacentMultiUnitKeys=function(e,t,i){if(!this.mServiceKey[e.sGroupId]){this.mServiceKey[e.sGroupId]=[]}if(!this.mKeyIndex[e.sGroupId]){this.mKeyIndex[e.sGroupId]=[]}if(!this.mMultiUnitKey[e.sGroupId]){this.mMultiUnitKey[e.sGroupId]=[]}--e.iIndex;--e.iServiceKeyIndex;this.mMultiUnitKey[e.sGroupId][e.iIndex]=this.oModel._getKey(t.oEntry);this.mKeyIndex[e.sGroupId][e.iIndex++]=e.iServiceKeyIndex>0?-e.iServiceKeyIndex:"ZERO";var r=0;for(var s=0;s<i.length;s++){if(!this.mServiceKey[e.sGroupId][e.iServiceKeyIndex]){++r}this.mServiceKey[e.sGroupId][e.iServiceKeyIndex++]=this.oModel._getKey(i[s])}return r};x.prototype._mergeLoadedKeyIndexWithSubsequentIndexes=function(e,t,i,r){var s=this.mKeyIndex[e.sGroupId],n=this.mServiceKey[e.sGroupId],a=this.mMultiUnitKey[e.sGroupId],o=0,u=e.iServiceKeyIndex,l=e.iIndex;var d,h;if(s===undefined){return o}var p=false;var f=n[u-1],g=n[u];if(g===undefined){return o}if(f===undefined){R.fatal("assertion failed: missing expected entry before given key index");return o}var y=this.oModel.getObject("/"+f);var c=this.oModel.getObject("/"+g);var v="",m="";for(var _=0;_<t.length;_++){v+=y[t[_]]+"|";m+=c[t[_]]+"|"}p=v==m;var I=l;if(I>=this.mLength[e.sGroupId]){R.fatal("assertion failed: service key exists,but no corresponding key index found");return o}while(s[I]===undefined||Math.abs(s[I])<u){++I}if(p){if(Math.abs(s[I])==u&&s[I]<0){if(I>l){if(s[l-1]<0){a[I]=undefined;s.splice(l,I-l+1);a.splice(l,I-l+1)}else{s[l-1]=-s[l-1];a[l-1]=a[I];a[I]=undefined;s.splice(l,I-l+1);a.splice(l,I-l+1);o=1}}}else if(Math.abs(s[I])>u){var M=I-1;if(s[M]>0){d=this._createMultiUnitRepresentativeEntry(e.sGroupId,y,i,undefined,r);h=this.oModel._getKey(d.oEntry);s[M]=-s[M];a[M]=h;if(M>l){s.splice(l,M-l);a.splice(l,M-l)}if(d.bIsNewEntry){o=1}else{o=0}}else if(s[l-1]<0){if(I>l){a[M]=undefined;s.splice(l,M-l+1);a.splice(l,M-l+1)}}else{s[l-1]=-s[l-1];a[l-1]=a[M];a[M]=undefined;s.splice(l,M-l+1);a.splice(l,M-l+1)}}else if(s[I]==u){if(I>l){if(s[l-1]<0){s.splice(l,I-l+1);a.splice(l,I-l+1);o=1}else{d=this._createMultiUnitRepresentativeEntry(e.sGroupId,y,i,undefined,r);h=this.oModel._getKey(d.oEntry);if(!d.bIsNewEntry){R.fatal("assertion failed: multi-unit entry already existed before")}s[l-1]=-s[l-1];a[l-1]=h;s.splice(l,I-l+1);a.splice(l,I-l+1);o=1}}}else{R.fatal("assertion failed: uncovered case detected");return o}}else if(s[I]>u){R.fatal("unstable query result for group ID "+e.sGroupId+": entries have been removed or added. Complete reload required")}else if(I-l>0){s.splice(l,I-l);a.splice(l,I-l)}return o};x.prototype._createMultiUnitRepresentativeEntry=function(e,t,i,r,n){var a=s({},t);var o=[];for(var u in this.oMeasureDetailsSet){var l=this.oMeasureDetailsSet[u];if(!n&&this._isSkippingTotalForMeasure(u)){if(l.rawValuePropertyName!=undefined){a[l.rawValuePropertyName]=undefined}if(l.formattedValuePropertyName!=undefined){a[l.formattedValuePropertyName]=undefined}}else{if(l.rawValuePropertyName!=undefined){a[l.rawValuePropertyName]=null}if(l.formattedValuePropertyName!=undefined){a[l.formattedValuePropertyName]="*"}}if(r){if(!l.unitPropertyName||r.indexOf(l.unitPropertyName)==-1){o.push(l.rawValuePropertyName||l.name)}}}for(var d=0;d<i.length;d++){if(r.indexOf(i[d])!=-1){a[i[d]]="*"}}var h="";for(var p=0;p<this.aAllDimensionSortedByName.length;p++){var f=a[this.aAllDimensionSortedByName[p]];var g=f===""?'""':f;g=g===undefined?"":g;h+=encodeURIComponent(g)+","}h+="-multiple-units-not-dereferencable|"+this._iId;var y;if(this.mMultiUnitKey[e]&&(y=this.mMultiUnitKey[e].indexOf(h))!=-1){return{oEntry:this.oModel.getObject("/"+h),bIsNewEntry:false,iIndex:y,aReloadMeasurePropertyName:o}}a.__metadata.uri=h;delete a.__metadata["self"];delete a.__metadata["self_link_extensions"];a["^~volatile"]=true;this.oModel._importData(a,{},{});var c=this.oModel._getKey(a);this.oModel.getContext("/"+c)["_volatile"]=true;return{oEntry:a,bIsNewEntry:true,aReloadMeasurePropertyName:o}};x.prototype._clearAllPendingRequests=function(){this.oPendingRequests={};this.oGroupedRequests={}};x.prototype.resetData=function(e){var t=e?e.getPath():undefined;this._resetData(t)};x.prototype._resetData=function(e){if(e){delete this.mServiceKey[e];delete this.mServiceLength[e];delete this.mServiceFinalLength[e];delete this.mKeyIndex[e];delete this.mLength[e];delete this.mMultiUnitKey[e];delete this.mEntityKey[e]}else{this.mServiceKey={};this.mServiceLength={};this.mServiceFinalLength={};this.mFinalLength=this.mServiceFinalLength;this.mKeyIndex={};this.mLength={};this.mMultiUnitKey={};this.mEntityKey={}}};x.prototype.refresh=function(e){x.prototype._refresh.apply(this,arguments)};x.prototype._refresh=function(e,t,i){var r=false;if(!e){if(i){var s=this.getResolvedPath();var a=this.oModel.oMetadata._getEntityTypeByPath(s);if(a&&a.entityType in i){r=true}}if(t&&!r){n(this.mServiceKey,function(e,i){n(i,function(e,i){if(i in t){r=true;return false}});if(r){return false}})}if(!t&&!i){r=true}}if(e||r){this.iTotalSize=-1;this._abortAllPendingRequests();this.resetData();this.bNeedsUpdate=false;this._fireRefresh({reason:l.Refresh})}};x.prototype.checkUpdate=function(e,t){var i=false;if(!e){if(this.bNeedsUpdate||!t){i=true}else{n(this.mServiceKey,function(e,r){n(r,function(e,r){if(r in t){i=true;return false}});if(i){return false}})}}if(e||i){this.bNeedsUpdate=false;this._fireChange({reason:l.Change})}};x.prototype.getDownloadUrl=function(e){var t,r,s;var n=new i.QueryResultRequest(this.oAnalyticalQueryResult);n.setResourcePath(this._getResourcePath());var a=[];var o=[];for(var u in this.oDimensionDetailsSet){a.push(u)}n.setAggregationLevel(a);for(var l in this.oDimensionDetailsSet){var d=this.oDimensionDetailsSet[l];var h=d.textPropertyName!=undefined;n.includeDimensionKeyTextAttributes(d.name,true,h,d.aAttributeName)}for(var p in this.oMeasureDetailsSet){o.push(p)}n.setMeasures(o);for(var f in this.oMeasureDetailsSet){var g=this.oMeasureDetailsSet[f];var y=g.rawValuePropertyName!=undefined;var c=g.formattedValuePropertyName!=undefined;var v=g.unitPropertyName!=undefined;n.includeMeasureRawFormattedValueUnit(g.name,y,c,v)}var m=n.getSortExpression();m.clear();for(var _=0;_<this.aSorter.length;_++){if(this.aSorter[_]){m.addSorter(this.aSorter[_].sPath,this.aSorter[_].bDescending?i.SortOrder.Descending:i.SortOrder.Ascending)}}var I=n.getFilterExpression();I.clear();if(this.aApplicationFilter){I.addUI5FilterConditions(this.aApplicationFilter)}if(this.aControlFilter){I.addUI5FilterConditions(this.aControlFilter)}var R=n.getURIToQueryResultEntitySet();var M=this._getQueryODataRequestOptions(n,true);if(!M){return undefined}var q=[];for(var b=0,x=this.aAnalyticalInfo.length;b<x;b++){var S=this.aAnalyticalInfo[b];if((S.visible||S.inResult)&&S.name!==""&&S.name!==q[q.length-1]){q.push(S.name);if(this.oMeasureDetailsSet[S.name]!=undefined&&this.oMeasureDetailsSet[S.name].unitPropertyName!=undefined){q.push(this.oMeasureDetailsSet[S.name].unitPropertyName)}}}for(var A=0,P=M.length;A<P;A++){if(/^\$select/i.test(M[A])){if(this.mParameters.select){t=M[A].slice(8).split(",");for(s=0;s<t.length;s++){r=t[s];if(q.indexOf(r)===-1){q.push(r)}}}M[A]="$select="+q.join(",");break}}if(e){M.splice(0,0,"$format="+encodeURIComponent(e))}if(this.sCustomParams){M.push(this.sCustomParams)}if(R){return this.oModel._createRequestUrl(R,null,M).replace(/ /g,"%20")}};x.prototype._addSorters=function(e,t){var r=this._canApplySortersToGroups()?[].concat(this.aSorter).concat(t):[].concat(t).concat(this.aSorter);r.forEach(function(t){e.addSorter(t.sPath,t.bDescending?i.SortOrder.Descending:i.SortOrder.Ascending)})};x.prototype._canApplySortersToGroups=function(){var e=this._autoExpandMode;if(this.bApplySortersToGroups){if(this.aSorter.length>0){if(e!==this.sLastAutoExpandMode&&e!==y.Sequential){R.warning("Applying sorters to groups is only possible with auto"+" expand mode 'Sequential'; current mode is: "+e,this.sPath)}this.sLastAutoExpandMode=e}return e===y.Sequential}return false};x.prototype._warnNoSortingOfGroups=function(e){var t;if(this.bApplySortersToGroups){t="Detected a multi-unit case, so sorting is only possible on leaves";if(e){t+="; "+e}R.warning(t,this.sPath)}this.bApplySortersToGroups=false};x.prototype._isSkippingTotalForMeasure=function(e){var t=this.mAnalyticalInfoByProperty[e];return!!t&&t.total==false};x.Logger=R;return x});