/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/thirdparty/jquery","sap/ui/test/_LogCollector","sap/ui/test/_OpaLogger","sap/ui/test/_ParameterValidator","sap/ui/test/_UsageReport","sap/ui/test/_OpaUriParameterParser","sap/ui/test/_ValidationParameters"],function(e,t,r,n,i,a,o,s){"use strict";var u=n.getLogger("sap.ui.test.Opa"),c=r.getInstance(),f=[],l={},g=-1,p,d,v,m,h=new i({errorPrefix:"sap.ui.test.Opa#waitFor"});c.start();function _(e,t){if(window["sap-ui-debug"]){t.timeout=t.debugTimeout}var r=new Date;n();function n(){u.timestamp("opa.check");c.getAndClearLog();var i=e();m=t._stack;if(i.error){d.reject(t);return}if(i.result){w();return}var a=(new Date-r)/1e3;if(t.timeout===0||t.timeout>a){g=setTimeout(n,t.pollingInterval);return}k("Opa timeout after "+t.timeout+" seconds",t);if(t.error){try{t.error(t,i.arguments)}finally{d.reject(t)}}else{d.reject(t)}}}function w(){if(!f.length){if(d){d.resolve()}return true}var e=f.shift();g=setTimeout(function(){_(e.callback,e.options)},(P.config.asyncPolling?e.options.pollingInterval:0)+P.config.executionDelay)}function y(e,t){var r=e.get();if(r){var n=f.splice(f.length-r,r);n.forEach(function(e){e.options._nestedIn=t});f=n.concat(f)}}function O(e){var t=e.toString();if(e.stack){t+="\n"+e.stack}var r="Exception thrown by the testcode:'"+t+"'";return r}function k(e,t,r){var n=c.getAndClearLog();if(n){e+="\nThis is what Opa logged:\n"+n}if(!r&&t._stack){e+=F(t)}if(t.errorMessage){t.errorMessage+="\n"+e}else{t.errorMessage=e}u.error(t.errorMessage,"Opa")}function C(t){t=(t||0)+2;if(e.browser.mozilla){t=t-1}var r=new Error,n=r.stack;if(!n){try{throw r()}catch(e){n=e.stack}}if(!n){return""}n=n.split("\n");n.splice(0,t);return n.join("\n")}function F(e){var t="\nCallstack:\n";if(e._stack){t+=e._stack;delete e._stack}else{t+="Unknown"}if(e._nestedIn){t+=F(e._nestedIn);delete e._nestedIn}return t}var P=function(e){this.and=this;t.extend(this,e)};P.config={};P.extendConfig=function(e){var r=["actions","assertions","arrangements"];r.filter(function(t){return!!e[t]}).forEach(function(t){var r=e[t];var n=Object.getPrototypeOf(e[t]);var i=P.config[t];var a=Object.getPrototypeOf(P.config[t]);for(var o in i){if(!(o in r)){r[o]=i[o]}}for(var s in a){if(!(s in r)){n[s]=a[s]}}});P.config=t.extend(true,P.config,e,P._uriParams);n.setLevel(P.config.logLevel)};var x=0;if(e.browser.safari){x=50}P.resetConfig=function(){P.config=t.extend({arrangements:new P,actions:new P,assertions:new P,timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:x,asyncPolling:false},P._uriParams)};P.getContext=function(){return l};P.emptyQueue=function e(){if(v){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.")}v=true;p=null;d=t.Deferred();w();return d.promise().fail(function(e){f=[];if(p){var t=p.qunitTimeout?"QUnit timeout after "+p.qunitTimeout+" seconds":"Queue was stopped manually";e._stack=p.qunitTimeout&&m||C(1);k(t,e)}}).always(function(){f=[];g=-1;d=null;m=null;v=false})};P.stopQueue=function e(){P._stopQueue()};P._stopQueue=function(e){f=[];if(!d){u.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa")}else{if(g!==-1){clearTimeout(g)}p=e||{};d.reject(p)}};P._uriParams=o._getOpaParams();P.resetConfig();P._usageReport=new a(P.config);n.setLevel(P.config.logLevel);P.prototype={getContext:P.getContext,waitFor:function(e){var r=t.Deferred(),n=P._createFilteredConfig(P._aConfigValuesForWaitFor);e=t.extend({},n,e);this._validateWaitFor(e);e._stack=C(1+e._stackDropCount);delete e._stackDropCount;var i=t.extend({},this);r.promise(i);f.push({callback:function(){var t=true;if(e.check){try{t=e.check.apply(this,arguments)}catch(t){var n="Failure in Opa check function\n"+O(t);k(n,e,t.stack);r.reject(e);return{error:true,arguments:arguments}}}if(p){return{result:true,arguments:arguments}}if(!t){return{result:false,arguments:arguments}}if(e.success){var i=P._getWaitForCounter();try{e.success.apply(this,arguments)}catch(t){var n="Failure in Opa success function\n"+O(t);k(n,e,t.stack);r.reject(e);return{error:true,arguments:arguments}}finally{y(i,e)}}r.resolve();return{result:true,arguments:arguments}}.bind(this),options:e});return i},extendConfig:P.extendConfig,emptyQueue:P.emptyQueue,iWaitForPromise:function(e){return this._schedulePromiseOnFlow(e)},_schedulePromiseOnFlow:function(e,t){t=t||{};var r={};t.check=function(){if(!r.started){r.started=true;e.then(function(){r.done=true},function(e){r.errorMessage="Error while waiting for promise scheduled on flow"+(e?", details: "+e:"")})}if(r.errorMessage){throw new Error(r.errorMessage)}else{return!!r.done}};return this.waitFor(t)},_validateWaitFor:function(e){h.validate({validationInfo:s.OPA_WAITFOR,inputToValidate:e})}};P._createFilteredOptions=function(e,t){var r={};e.forEach(function(e){var n=t[e];if(n===undefined){return}r[e]=n});return r};P._createFilteredConfig=function(e){return P._createFilteredOptions(e,P.config)};P._getWaitForCounter=function(){var e=f.length;return{get:function(){var t=f.length-e;return Math.max(t,0)}}};P._aConfigValuesForWaitFor=Object.keys(s.OPA_WAITFOR_CONFIG);return P},true);