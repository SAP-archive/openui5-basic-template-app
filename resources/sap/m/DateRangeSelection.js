/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","./DatePicker","./library","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/ui/core/date/UniversalDate","./DateRangeSelectionRenderer","sap/ui/unified/calendar/CustomMonthPicker","sap/ui/unified/calendar/CustomYearPicker","sap/base/util/deepEqual","sap/base/Log","sap/base/assert","sap/ui/dom/jquery/cursorPos"],function(t,e,a,i,s,n,r,o,l,u,h,g){"use strict";var p=e.extend("sap.m.DateRangeSelection",{metadata:{library:"sap.m",properties:{delimiter:{type:"string",group:"Misc",defaultValue:"-"},secondDateValue:{type:"object",group:"Data",defaultValue:null},from:{type:"object",group:"Misc",defaultValue:null,deprecated:true},to:{type:"object",group:"Misc",defaultValue:null,deprecated:true}},designtime:"sap/m/designtime/DateRangeSelection.designtime",dnd:{draggable:false,droppable:true}}});var c=String.fromCharCode(45),f=String.fromCharCode(8211),d=String.fromCharCode(8212);p.prototype.init=function(){e.prototype.init.apply(this,arguments);this._bIntervalSelection=true};p.prototype._createPopupContent=function(){e.prototype._createPopupContent.apply(this,arguments);var t=this._getCalendar();if(t instanceof o){t._getMonthPicker().setIntervalSelection(true)}if(t instanceof l){t._getYearPicker().setIntervalSelection(true)}this._getCalendar().attachWeekNumberSelect(this._handleWeekSelect,this);this._getCalendar().getSelectedDates()[0].setStartDate(this._oDateRange.getStartDate());this._getCalendar().getSelectedDates()[0].setEndDate(this._oDateRange.getEndDate())};p.prototype.onkeypress=function(t){if(!t.charCode||t.metaKey||t.ctrlKey){return}var e=T.call(this);var a=V.call(this);var i=e.sAllowedCharacters+a+" ";var s=String.fromCharCode(t.charCode);if(s&&e.sAllowedCharacters&&i.indexOf(s)<0){t.preventDefault()}};p.prototype._getPlaceholder=function(){var t=this.getPlaceholder(),e,a,s,n;if(!t){e=this.getBinding("value");s=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();n=i.getInstance(s);if(e&&e.getType()instanceof sap.ui.model.type.DateInterval){a=e.getType();if(a.oFormatOptions&&a.oFormatOptions.format){t=n.getCustomDateTimePattern(a.oFormatOptions.format)}else{t=n.getDatePattern("medium")}}else{t=this.getDisplayFormat();if(!t){t="medium"}if(this._checkStyle(t)){t=n.getDatePattern(t)}}var r=V.call(this);if(r&&r!==""){t=t+" "+r+" "+t}}return t};p.prototype.setValue=function(t){if(t!==this.getValue()){this.setLastValue(t)}else{return this}this.setProperty("value",t);this._bValid=true;var e=[undefined,undefined];if(t){e=this._parseValue(t);if(!y.call(this,e[0],e[1])[0]){this._bValid=false;h.warning("Value can not be converted to a valid dates",this)}}this.setProperty("dateValue",D(e[0]));this.setProperty("secondDateValue",D(e[1]));if(this.getDomRef()){var a=this._formatValue(e[0],e[1]);if(this._$input.val()!==a){this._$input.val(a);this._curpos=this._$input.cursorPos()}}return this};function D(t){return typeof t==="number"?new Date(t):t}function _(t){return t&&t.getTime?t.getTime():t}p.prototype.setValueFormat=function(t){this.setProperty("valueFormat",t,true);h.warning("Property valueFormat is not supported in sap.m.DateRangeSelection control.",this);return this};p.prototype.setDisplayFormat=function(t){e.prototype.setDisplayFormat.apply(this,arguments);var a=this._formatValue(this.getDateValue(),this.getSecondDateValue());this.setProperty("value",a,true);if(this.getDomRef()&&this._$input.val()!==a){this._$input.val(a);this._curpos=this._$input.cursorPos()}return this};p.prototype.setFrom=function(t){this.setDateValue(t);return this};p.prototype.getFrom=function(){return this.getDateValue()};p.prototype.setTo=function(t){this.setSecondDateValue(t);return this};p.prototype.getTo=function(){return this.getSecondDateValue()};p.prototype.setDateValue=function(t){if(!this._isValidDate(t)){throw new Error("Date must be a JavaScript date object; "+this)}if(u(this.getDateValue(),t)){return this}e.prototype._dateValidation.call(this,t);this._syncDateObjectsToValue(t,this.getSecondDateValue());return this};p.prototype.setSecondDateValue=function(t){if(!this._isValidDate(t)){throw new Error("Date must be a JavaScript date object; "+this)}if(u(this.getSecondDateValue(),t)){return this}this._bValid=true;if(t&&(t.getTime()<this._oMinDate.getTime()||t.getTime()>this._oMaxDate.getTime())){this._bValid=false;g(this._bValid,"Date must be in valid range")}this.setProperty("secondDateValue",t);this._syncDateObjectsToValue(this.getDateValue(),t);return this};p.prototype.setMinDate=function(t){e.prototype.setMinDate.apply(this,arguments);if(t){var a=this.getSecondDateValue();if(a&&a.getTime()<this._oMinDate.getTime()){h.warning("SecondDateValue not in valid date range",this)}}return this};p.prototype.setMaxDate=function(t){e.prototype.setMaxDate.apply(this,arguments);if(t){var a=this.getSecondDateValue();if(a&&a.getTime()>this._oMaxDate.getTime()){h.warning("SecondDateValue not in valid date range",this)}}return this};p.prototype._checkMinMaxDate=function(){e.prototype._checkMinMaxDate.apply(this,arguments);var t=this.getSecondDateValue();if(t&&(t.getTime()<this._oMinDate.getTime()||t.getTime()>this._oMaxDate.getTime())){h.error("secondDateValue "+t.toString()+"(value="+this.getValue()+") does not match "+"min/max date range("+this._oMinDate.toString()+" - "+this._oMaxDate.toString()+"). App. "+"developers should take care to maintain secondDateValue/value accordingly.",this)}};p.prototype._parseValue=function(t){var e;var a=[];var i,s;var n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){try{a=n.getType().parseValue(t,"string")}catch(t){return[undefined,undefined]}if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){a=a.map(function(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())})}return a}var r=V.call(this);if(r&&t){t=t.trim();t=C(t,[r," "]);a=this._splitValueByDelimiter(t,r);if(a.length===2){if(a[0].slice(a[0].length-1,a[0].length)==" "){a[0]=a[0].slice(0,a[0].length-1)}if(a[1].slice(0,1)==" "){a[1]=a[1].slice(1)}}else{a=t.split(" "+r+" ")}if(t.indexOf(r)===-1){var o=t.split(" ");if(o.length===2){a=o}}}if(t&&a.length<=2){e=T.call(this);if(!r||r===""||a.length===1){i=e.parse(t)}else if(a.length===2){i=e.parse(a[0]);s=e.parse(a[1]);if(!i||!s){i=undefined;s=undefined}}}return[i,s]};p.prototype._splitValueByDelimiter=function(t,e){var a=[c,f,d],i;if(e){if(a.indexOf(e)===-1){return t.split(e)}}for(i=0;i<a.length;i++){if(t.indexOf(a[i])>0){return t.split(a[i])}}return t?t.split(" "):[]};p.prototype._formatValue=function(t,e){var a="",i=V.call(this),s,n,r,o;r=t;o=e;if(r){n=this.getBinding("value");if(n&&n.getType()instanceof sap.ui.model.type.DateInterval){if(n.getType().oFormatOptions&&n.getType().oFormatOptions.source&&n.getType().oFormatOptions.source.pattern==="timestamp"){a=n.getType().formatValue([_(t),_(e)],"string")}else{if(n.getType().oFormatOptions&&n.getType().oFormatOptions.UTC){r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()));if(e){o=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds()))}}a=n.getType().formatValue([r,o],"string")}}else{s=T.call(this);if(i&&i!==""&&o){a=s.format(r)+" "+i+" "+s.format(o)}else{a=s.format(r)}}}return a};p.prototype.onChange=function(){if(!this.getEditable()||!this.getEnabled()){return}var t=this._$input.val();var e=[undefined,undefined];if(this.getShowFooter()&&this._oPopup&&!t){this._oPopup.getBeginButton().setEnabled(false)}this._bValid=true;if(t!=""){e=this._parseValue(t);e[1]&&e[1].setHours(23,59,59,999);e=y.call(this,e[0],e[1]);if(e[0]){t=this._formatValue(e[0],e[1])}else{this._bValid=false}}if(t!==this.getLastValue()){if(this.getDomRef()&&this._$input.val()!==t){this._$input.val(t);this._curpos=this._$input.cursorPos()}this.setLastValue(t);this.setProperty("value",t,true);if(this._bValid){this.setProperty("dateValue",D(e[0]),true);this.setProperty("secondDateValue",D(e[1]),true)}if(this._oPopup&&this._oPopup.isOpen()){var a=this.getDateValue();if(a){if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!==a.getTime()){this._oDateRange.setStartDate(new Date(a.getTime()));this._getCalendar().focusDate(a)}}else{if(this._oDateRange.getStartDate()){this._oDateRange.setStartDate(undefined)}}var i=this.getSecondDateValue();if(i){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==i.getTime()){this._oDateRange.setEndDate(new Date(i.getTime()));this._getCalendar().focusDate(i)}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}}m.call(this,this._bValid)}};p.prototype._getInputValue=function(t){t=typeof t=="undefined"?this._$input.val():t.toString();if(!t){return""}var e=this._parseValue(t);t=this._formatValue(e[0],e[1]);return t};p.prototype.updateDomValue=function(t){this._bCheckDomValue=true;t=typeof t=="undefined"?this._$input.val():t.toString();this._curpos=this._$input.cursorPos();var e=this._parseValue(t);t=this._formatValue(e[0],e[1]);if(this.isActive()&&this._$input.val()!==t){this._$input.val(t);this._$input.cursorPos(this._curpos)}return this};p.prototype._fillDateRange=function(){e.prototype._fillDateRange.apply(this,arguments);var t=this.getSecondDateValue();if(t&&t.getTime()>=this._oMinDate.getTime()&&t.getTime()<=this._oMaxDate.getTime()){if(!this._oDateRange.getEndDate()||this._oDateRange.getEndDate().getTime()!==t.getTime()){this._oDateRange.setEndDate(new Date(t.getTime()))}}else{if(this._oDateRange.getEndDate()){this._oDateRange.setEndDate(undefined)}}};p.prototype._selectDate=function(){var e=this._getCalendar().getSelectedDates();if(e.length>0){var a=e[0].getStartDate();var i=e[0].getEndDate();if(a&&i){var s=this.getDateValue();var n=this.getSecondDateValue();i.setHours(23,59,59,999);var r;if(!u(a,s)||!u(i,n)){if(u(i,n)){this.setDateValue(a)}else{this.setProperty("dateValue",a,true);this.setSecondDateValue(i)}r=this.getValue();m.call(this,true);if(t.system.desktop||!t.support.touch){this._curpos=r.length;this._$input.cursorPos(this._curpos)}}else if(!this._bValid){r=this._formatValue(a,i);if(r!=this._$input.val()){this._bValid=true;if(this.getDomRef()){this._$input.val(r)}m.call(this,true)}}this._oDateRange.setStartDate(this._getCalendar().getSelectedDates()[0].getStartDate());this._oDateRange.setEndDate(this._getCalendar().getSelectedDates()[0].getEndDate());this._oPopup.close()}}};p.prototype._handleCalendarSelect=function(){var t=this._getCalendar().getSelectedDates(),e=t[0].getStartDate(),a=t[0].getEndDate();if(this.getShowFooter()){this._oPopup.getBeginButton().setEnabled(!!(e&&a));return}this._selectDate()};p.prototype._handleWeekSelect=function(t){var e=t.getParameter("weekDays"),a=e.getStartDate(),i=e.getEndDate();if(this.getShowFooter()){this._oPopup.getBeginButton().setEnabled(!!(a&&i));return}this._getCalendar().getSelectedDates()[0].setStartDate(a);this._getCalendar().getSelectedDates()[0].setEndDate(i);this._oDateRange.setStartDate(a);this._oDateRange.setEndDate(i);this._selectDate()};p.prototype.getAccessibilityInfo=function(){var t=this.getRenderer();var a=e.prototype.getAccessibilityInfo.apply(this,arguments);var i=this.getValue()||"";if(this._bValid){var s=this.getDateValue();if(s){i=this._formatValue(s,this.getSecondDateValue())}}a.type=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_DATERANGEINPUT");a.description=[i,t.getLabelledByAnnouncement(this),t.getDescribedByAnnouncement(this)].join(" ").trim();return a};p.prototype._syncDateObjectsToValue=function(t,e){var a=this._formatValue(t,e);if(a!==this.getValue()){this.setLastValue(a)}this.setProperty("value",a);if(this.getDomRef()){var i=this._formatValue(t,e);if(this._$input.val()!==i){this._$input.val(i);this._curpos=this._$input.cursorPos()}}};function m(t){this.fireChangeEvent(this.getValue(),{from:this.getDateValue(),to:this.getSecondDateValue(),valid:t})}function y(t,e){var a,i;if(t&&t.getTime){a=t.getTime()}else if(typeof t==="number"){a=t}if(e&&e.getTime){i=e.getTime()}else if(typeof e==="number"){i=e}if(t&&e&&a>i){var s=t;t=e;e=s}if(t&&(a<this._oMinDate.getTime()||a>this._oMaxDate.getTime())||e&&(i<this._oMinDate.getTime()||i>this._oMaxDate.getTime())){return[undefined,undefined]}else{return[t,e]}}p.prototype._increaseDate=function(t,e){var a=this._$input.val(),i=this._parseValue(a),s=i[0],n=i[1],r=T.call(this),o=V.call(this),l,g,p,c,f,d,D;if(!s||!this.getEditable()||!this.getEnabled()){return}if(!y.call(this,s,n)[0]){h.warning("Value can not be converted to a valid dates or dates are outside of the min/max range",this);this._bValid=false;m.call(this,this._bValid);return}a=C(a,[o," "]);l=this._$input.cursorPos();g=s?r.format(s).length:0;p=n?r.format(n).length:0;c=a.length;f=l<=g+1;d=l>=c-p-1&&l<=c;if(f&&s){D=v.call(this,s,t,e);if(!u(this.getDateValue(),D.getJSDate())){this.setDateValue(new Date(D.getTime()));this._curpos=l;this._$input.cursorPos(this._curpos);this.fireChangeEvent(this.getValue(),{valid:this._bValid})}}else if(d&&n){D=v.call(this,n,t,e);if(!u(this.getSecondDateValue(),D.getJSDate())){this.setSecondDateValue(new Date(D.getTime()));this._curpos=l;this._$input.cursorPos(this._curpos);this.fireChangeEvent(this.getValue(),{valid:this._bValid})}}};function v(t,e,a){var i=this.getBinding("value"),s,r,o,l;if(i&&i.oType&&i.oType.oOutputFormat){s=i.oType.oOutputFormat.oFormatOptions.calendarType}else if(i&&i.oType&&i.oType.oFormat){s=i.oType.oFormat.oFormatOptions.calendarType}if(!s){s=this.getDisplayFormatType()}o=n.getInstance(new Date(t.getTime()),s);l=o.getMonth();switch(a){case"day":o.setDate(o.getDate()+e);break;case"month":o.setMonth(o.getMonth()+e);r=(l+e)%12;if(r<0){r=12+r}while(o.getMonth()!=r){o.setDate(o.getDate()-1)}break;case"year":o.setFullYear(o.getFullYear()+e);while(o.getMonth()!=l){o.setDate(o.getDate()-1)}break;default:break}if(o.getTime()<this._oMinDate.getTime()){o=new n(this._oMinDate.getTime())}else if(o.getTime()>this._oMaxDate.getTime()){o=new n(this._oMaxDate.getTime())}return o}function V(){var t=this.getDelimiter();if(!t){if(!this._sLocaleDelimiter){var e=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var a=i.getInstance(e);var s=a.getIntervalPattern();var n=s.indexOf("{0}")+3;var r=s.indexOf("{1}");t=s.slice(n,r);if(t.length>1){if(t.slice(0,1)==" "){t=t.slice(1)}if(t.slice(t.length-1,t.length)==" "){t=t.slice(0,t.length-1)}}this._sLocaleDelimiter=t}else{t=this._sLocaleDelimiter}}return t}function T(){var t=this.getDisplayFormat()||"medium";var e;var a=this.getDisplayFormatType();if(t==this._sUsedDisplayPattern&&a==this._sUsedDisplayCalendarType){e=this._oDisplayFormat}else{if(this._checkStyle(t)){e=s.getInstance({style:t,strictParsing:true,calendarType:a})}else{e=s.getInstance({pattern:t,strictParsing:true,calendarType:a})}this._sUsedDisplayPattern=t;this._sUsedDisplayCalendarType=a;this._oDisplayFormat=e}return e}function S(t,e){return t&&e&&t.lastIndexOf(e)===t.length-e.length}function b(t,e){return t&&e&&t.indexOf(e)===0}function C(t,e){var a=0,i=e;if(!i){i=[" "]}while(a<i.length){if(S(t,i[a])){t=t.substring(0,t.length-i[a].length);a=0;continue}a++}a=0;while(a<i.length){if(b(t,i[a])){t=t.substring(i[a].length);a=0;continue}a++}return t}return p});