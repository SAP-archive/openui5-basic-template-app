/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/ui/core/Core","sap/ui/base/ManagedObjectObserver"],function(e,t,i){"use strict";var s=e.extend("sap.m.plugins.DataStateIndicator",{metadata:{library:"sap.m",properties:{filter:{type:"function",invalidate:false},messageLinkText:{type:"string",visibility:"hidden"},messageLinkVisible:{type:"boolean",defaultValue:true,visibility:"hidden"}},events:{dataStateChange:{allowPreventDefault:true,parameters:{dataState:{type:"sap.ui.model.DataState"},filteredMessages:{type:"any[]"}}}}}});s.prototype.setMessageLinkText=function(e){this.setProperty("messageLinkText",e,true);this._updateMessageLinkControl();return this};s.prototype.getMessageLinkText=function(){return this.getProperty("messageLinkText")};s.prototype.setMessageLinkVisible=function(e){this.setProperty("messageLinkVisible",e,true);if(this._oLink){this._oLink.setVisible(e)}return this};s.prototype.getMessageLinkVisible=function(){return this.getProperty("messageLinkVisible")};s.prototype.isApplicable=function(t){if(!t.addAriaLabelledBy||!e.prototype.isApplicable.apply(this,arguments)||!t.getMetadata().getAllPrivateAggregations()["_messageStrip"]||!this._getBindingName()){return false}return true};s.prototype.onActivate=function(e){var t=this._getBindingName();var s=e.getBinding(t);if(s){s.attachAggregatedDataStateChange(this._onAggregatedDataStateChange,this);this._processDataState(s.getDataState())}this._oObserver=new i(this._observeChanges.bind(this));this._oObserver.observe(e,{bindings:[t]})};s.prototype.onDeactivate=function(e){var t=this._getBindingName();var i=e.getBinding(t);if(i){i.detachAggregatedDataStateChange(this._onAggregatedDataStateChange,this);i.getDataState().getMessages().forEach(function(t){t.removeControlId(e.getId())})}if(this._oMessageStrip){this._oMessageStrip.destroy();this._oMessageStrip=null}if(this._oLink){this._oLink.destroy();this._oLink=null}this._oObserver.unobserve(e,{bindings:[t]});this._oObserver.destroy();this._oObserver=null};s.prototype.showMessage=function(e,t){if(!this.getEnabled()||!this.getControl()||!e&&!this._oMessageStrip){return}if(this._oMessageStrip){this._oMessageStrip.setText(e).setType(t).setVisible(!!e);return}sap.ui.require(["sap/m/MessageStrip"],function(i){var s=this.getControl();this._oMessageStrip=new i({showCloseButton:true,showIcon:true,close:function(){s.focus()}}).addStyleClass("sapUiTinyMargin");this._updateMessageLinkControl();s.setAggregation("_messageStrip",this._oMessageStrip);s.addAriaLabelledBy(this._oMessageStrip);this.showMessage(e,t)}.bind(this))};s.prototype._updateMessageLinkControl=function(){if(!this._oMessageStrip){return}var e=this.getMessageLinkText();if(!e){this._oMessageStrip.setLink(null);return}else if(this._oLink){this._oLink.setText(e);this._oMessageStrip.setLink(this._oLink)}if(!this._oLink){sap.ui.require(["sap/m/Link"],function(t){this._oLink=new t({text:e,visible:this.getMessageLinkVisible(),press:[function(){this.fireEvent("messageLinkPressed")},this]});this._oMessageStrip.setLink(this._oLink)}.bind(this))}};s.prototype.refresh=function(){if(this.isActive()){var e=this._getBindingName();var t=this.getControl().getBinding(e);if(t){this._processDataState(t.getDataState())}}};s.prototype._getBindingName=function(){return this.getControlPluginConfig("defaultBindingName")};s.prototype._translate=function(e){var i="DATASTATE_"+e;var s=this.getControl().getMetadata();var a=s.getLibraryName();var r=s.getName().split(".").pop().toUpperCase();var n=t.getLibraryResourceBundle(a);var o=r+"_"+i;if(n.hasText(o)){return n.getText(o)}if(a=="sap.m"){return n.getText(i)}return t.getLibraryResourceBundle("sap.m").getText(i)};s.prototype._getCombinedType=function(e){if(e&&e.length){var t={None:0,Information:1,Success:2,Warning:4,Error:8};var i=0;e.forEach(function(e){i|=t[e.getType()]});if(i&t.Error&&i&t.Warning){return"Issue"}else if(i&t.Error){return"Error"}else if(i&t.Warning){return"Warning"}else if(i&t.Success||i&t.Information){return"Notification"}}return""};s.prototype._processDataState=function(e){if(!e||!e.getChanges().messages){return}var i=e.getMessages();var s=this.getControl();var a=this.getFilter();if(a){i=i.filter(function(e){return a(e,s)})}if(!this.fireDataStateChange({dataState:e,filteredMessages:i})){return}if(i.length){var r=i[0];var n=this._getBindingName();var o=s.getBinding(n).getPath();var g=false;var h="";var p="";i.forEach(function(e){if(e.getControlIds().indexOf(s.getId())==-1){e.addControlId(s.getId());g=true}});if(i.length==1&&r.getTarget()&&r.getTarget().endsWith(o)){p=r.getMessage()}else{h=this._getCombinedType(i);if(h){p=this._translate(h.toUpperCase())}}this.showMessage(p,r.getType());if(g){t.getMessageManager().getMessageModel().checkUpdate(false,true)}}else{this.showMessage("")}};s.prototype._onAggregatedDataStateChange=function(e){this._processDataState(e.getParameter("dataState"))};s.prototype._observeChanges=function(e){var t=e.bindingInfo.binding;if(t){var i=e.mutation=="ready"?"attach":"detach";t[i+"AggregatedDataStateChange"](this._onAggregatedDataStateChange,this)}};e.setConfig({"sap.m.ListBase":{defaultBindingName:"items"},"sap.ui.table.Table":{defaultBindingName:"rows"}},s);return s});