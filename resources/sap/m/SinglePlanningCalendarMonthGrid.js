/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.getCore().loadLibrary("sap.ui.unified");sap.ui.define(["sap/ui/core/Control","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateTypeRange","sap/ui/unified/library","sap/ui/core/LocaleData","sap/ui/core/Locale","sap/ui/core/delegate/ItemNavigation","sap/ui/core/dnd/DragDropInfo","sap/ui/core/CustomData","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/core/Core","./Link","./PlanningCalendarLegend","./SinglePlanningCalendarMonthGridRenderer"],function(e,t,a,n,i,r,o,s,p,l,g,u,d,h,c,f,m){"use strict";var D=1.5625;var _=1.5;var y=2.125;var v=1.75;var C=e.extend("sap.m.SinglePlanningCalendarMonthGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_appsPlaceholders:{type:"sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},moreLinkPress:{parameters:{date:{type:"object"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}}}}});C.prototype.init=function(){this._aLinks=[];this._handleMorePress=this._handleMorePress.bind(this);this._oDateFormat=t.getDateTimeInstance({pattern:"YYYYMMdd"});this._oFormatAriaApp=t.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+this._getCoreLocaleData().getTimePattern("medium")});this._oFormatAriaFullDayCell=t.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY"});this.setStartDate(new Date);this._configureAppointmentsDragAndDrop()};C.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}for(var e=0;e<this._aLinks.length;e++){if(this._aLinks[e]){this._aLinks[e].destroy()}}delete this._aLinks};C.prototype.onBeforeRendering=function(){var e=this.getStartDate();this._oAppointmentsToRender=this._calculateAppointmentsNodes(e);this._createAppointmentsDndPlaceholders(e)};C.prototype.onAfterRendering=function(){this._initItemNavigation()};C.prototype._getColumns=function(){return 7};C.prototype._getRows=function(){return 6};C.prototype._getDateFormatter=function(){return this._oDateFormat};C.prototype._getAppointmetsForADay=function(e){return this._oAppointmentsToRender.filter(function(t){return t.start.valueOf()===e.valueOf()})};C.prototype._getPreviousAppointmetsForADay=function(e){return this._oAppointmentsToRender.filter(function(t){return t.start.valueOf()<e.valueOf()&&t.end.valueOf()>=e.valueOf()}).map(function(t){var a={data:t.data,start:t.start,end:t.end,len:t.len,level:t.level,width:t.width};a.width-=n._daysBetween(e,t.start);a.hasPrevious=true;return a},this)};C.prototype.ontap=function(e){this._fireSelectionEvent(e)};C.prototype.onkeydown=function(e){if(e.which===u.SPACE||e.which===u.ENTER){this._fireSelectionEvent(e);e.preventDefault()}};C.prototype._fireSelectionEvent=function(e){var t=e.srcControl,a=e.target,n=a&&a.classList.contains("sapMSPCMonthDay"),i=a&&a.classList.contains("sapMLnk"),r,o,s;if(t&&t.isA("sap.m.SinglePlanningCalendarMonthGrid")&&n&&!i){r=parseInt(a.getAttribute("sap-ui-date"));o=new Date(r);o=new Date(o.getFullYear(),o.getMonth(),o.getDate());s=new Date(o);s.setDate(s.getDate()+1);this.fireEvent("cellPress",{startDate:o,endDate:s});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)})}else if(t&&t.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:t,appointments:this._toggleAppointmentSelection(t,!(e.ctrlKey||e.metaKey))})}};C.prototype._toggleAppointmentSelection=function(e,t){var a=[],n,i,r;if(t){n=this.getAppointments();for(r=0,i=n.length;r<i;r++){if((!e||n[r].getId()!==e.getId())&&n[r].getSelected()){n[r].setProperty("selected",false);a.push(n[r])}}}if(e){e.setProperty("selected",!e.getSelected());a.push(e)}return a};C.prototype._getMoreLink=function(e,t,a){var n=h.getLibraryResourceBundle("sap.m").getText("SPC_MORE_LINK",[e.toString()]),i=new c({text:n,press:this._handleMorePress}).addCustomData(new g({key:"date",value:t.valueOf().toString(),writeToDom:true}));if(this._aLinks[a]){this._aLinks[a].destroy()}this._aLinks[a]=i;return i};C.prototype._handleMorePress=function(e){var t=parseInt(e.getSource().getCustomData()[0].getValue()),a=new Date(t);a=new Date(a.getFullYear(),a.getMonth(),a.getDate());this.fireEvent("moreLinkPress",{date:a})};C.prototype._getCoreLocaleData=function(){var e=h.getConfiguration().getFormatSettings().getFormatLocale().toString(),t=new s(e);return o.getInstance(t)};C.prototype._getCells=function(){return this._getVisibleDays(this.getStartDate())};C.prototype._getVerticalLabels=function(){var e=this._getVisibleDays(this.getStartDate()),t=this._getColumns(),a=[],i=h.getConfiguration().getFormatLocale().toString(),r=this._getCoreLocaleData();for(var o=0;o<this._getRows();o++){a.push(n.calculateWeekNumber(e[o*t].toUTCJSDate(),e[o*t].getYear(),i,r))}return a};C.prototype._getVisibleDays=function(e){var t,n,i,r,o,s,p=[];if(!e){return p}t=a.fromLocalJSDate(e);s=this._getCoreLocaleData().getFirstDayOfWeek();o=new a(t);o.setDate(1);r=o.getDay()-s;if(r<0){r=7+r}if(r>0){o.setDate(1-r)}n=new a(o);for(var l=0;l<this._getColumns()*this._getRows();l++){i=new a(n);p.push(i);n.setDate(n.getDate()+1)}return p};C.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender};C.prototype._calculateAppointmentsNodes=function(e){var t=this._getVisibleDays(e),i=t[0],r=t[t.length-1],o=this.getAppointments().filter(function(e){var t=e.getStartDate()&&e.getEndDate();if(!t){d.warning("Appointment "+e.getId()+" has no start or no end date. It is ignored.")}return t}).map(function(e){var t=a.fromLocalJSDate(e.getStartDate()),i=a.fromLocalJSDate(e.getEndDate());return{data:e,start:t,end:i,len:n._daysBetween(i,t)}}).filter(function(e){return n._isBetween(e.start,i,r,true)||n._isBetween(e.end,i,r,true)||n._isBetween(i,e.start,r,true)&&n._isBetween(r,i,e.end,true)}).sort(function e(t,a){return t.start.valueOf()-a.start.valueOf()}),s=[],p,l,g,u,h,c,f;for(h=0;h<t.length;h++){s.push([])}for(h=0;h<o.length;h++){p=o[h];l=n._daysBetween(p.start,t[0]);g=l+p.len;l=l>0?l:0;g=g<t.length?g:t.length-1;p.width=p.len+1;u=s[l].indexOf(true);if(u===-1){u=s[l].length}p.level=u;for(c=l;c<=g;c++){s[c][u]=false;for(f=0;f<u;f++){if(s[c][f]===undefined){s[c][f]=true}}}}this._aAppsLevelsPerDay=s;return o};C.prototype._getMoreCountPerCell=function(e){var t=this._aAppsLevelsPerDay[e];var a=this._getMaxAppointments();var n=0;var i=0;if(t.length<=a){return 0}for(var r=0;r<t.length;r++){if(!t[r]){n++}if(r<a-1){i++}}return n-i};C.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new l({sourceAggregation:"appointments",targetAggregation:"_appsPlaceholders",dragStart:function(e){if(!this.getEnableAppointmentsDragAndDrop()){e.preventDefault();return false}var t=function(){var e=jQuery(".sapMSinglePCOverlay");setTimeout(function(){e.addClass("sapMSinglePCOverlayDragging")});jQuery(document).one("dragend",function(){e.removeClass("sapMSinglePCOverlayDragging")})};t()}.bind(this),dragEnter:function(e){var t=e.getParameter("dragSession"),a=function(){var e=jQuery(t.getIndicator());e.css("min-height",t.getDropControl().$().outerHeight());e.css("min-width",t.getDropControl().$().outerWidth())};if(!t.getIndicator()){setTimeout(a,0)}else{a()}},drop:function(e){var t=e.getParameter("dragSession"),i=t.getDragControl(),r=t.getDropControl(),o=r.getDate(),s=a.fromLocalJSDate(i.getStartDate()),p=a.fromLocalJSDate(i.getEndDate()),l=n._daysBetween(o,s),g=new a(s),u=new a(p),d=e.getParameter("browserEvent"),h=d.metaKey||d.ctrlKey;g.setDate(g.getDate()+l);u.setDate(u.getDate()+l);this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(s.valueOf()===o.valueOf()){return}this.fireAppointmentDrop({appointment:i,startDate:g.toLocalJSDate(),endDate:u.toLocalJSDate(),copy:h})}.bind(this)}))};C.prototype._initItemNavigation=function(){var e=this.getDomRef();this._aGridCells=this.$().find(".sapMSPCMonthDay").toArray();if(!this._oItemNavigation){this._oItemNavigation=new p;this.addDelegate(this._oItemNavigation);this._oItemNavigation.attachEvent(p.Events.BorderReached,this._itemNavigationBorderReached,this)}this._oItemNavigation.setRootDomRef(e);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(false).setColumns(this._getColumns(),true);this._oItemNavigation.setPageSize(this._aGridCells.length)};C.prototype._itemNavigationBorderReached=function(e){var t,a,n=e.getParameter("event"),i;if(n.target.classList.contains("sapMSPCMonthDay")){t=n.target;a=parseInt(t.getAttribute("sap-ui-date"));switch(n.keyCode){case u.ARROW_LEFT:i=-1;break;case u.ARROW_UP:i=-this._getColumns();break;case u.ARROW_RIGHT:i=1;break;case u.ARROW_DOWN:i=this._getColumns();break;default:break}this.fireEvent("borderReached",{startDate:a,offset:i})}};C.prototype._createAppointmentsDndPlaceholders=function(e){var t=this._getVisibleDays(e);this.destroyAggregation("_appsPlaceholders");for(var a=0;a<t.length;a++){var n=new A({date:t[a]});this.addAggregation("_appsPlaceholders",n,true)}};var A=e.extend("sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addClass("sapMSinglePCPlaceholder");e.writeClasses();e.write("></div>")}});C.prototype._getCellStartInfo=function(e){var t=h.getLibraryResourceBundle("sap.ui.unified").getText("CALENDAR_START_TIME");return t+": "+this._oFormatAriaFullDayCell.format(e)+"; "};C.prototype._getAppointmentAnnouncementInfo=function(e){var t=h.getLibraryResourceBundle("sap.ui.unified"),a=t.getText("CALENDAR_START_TIME"),n=t.getText("CALENDAR_END_TIME"),i=this._oFormatAriaApp.format(e.getStartDate()),r=this._oFormatAriaApp.format(e.getEndDate()),o=a+": "+i+"; "+n+": "+r;return o+"; "+f.findLegendItemForItem(h.byId(this._sLegendId),e)};C.prototype._getMaxAppointments=function(){return this._isCompact()?4:3};C.prototype._getDensitySizes=function(){return this._isCompact()?{appHeight:D,cellHeaderHeight:_}:{appHeight:y,cellHeaderHeight:v}};C.prototype._isCompact=function(){var e=this.getDomRef()||(this.getParent()&&this.getParent().getDomRef&&this.getParent().getDomRef()||this.getParent()&&this.getParent().getRootNode&&this.getParent().getRootNode());while(e&&e.classList){if(e.classList.contains("sapUiSizeCompact")){return true}e=e.parentNode}return false};C.prototype._getSpecialDates=function(){var e=this.getSpecialDates();for(var t=0;t<e.length;t++){var a=e[t].getSecondaryType()===r.CalendarDayType.NonWorking&&e[t].getType()!==r.CalendarDayType.NonWorking;if(a){var n=new i;n.setType(r.CalendarDayType.NonWorking);n.setStartDate(e[t].getStartDate());if(e[t].getEndDate()){n.setEndDate(e[t].getEndDate())}e.push(n)}}return e};return C});