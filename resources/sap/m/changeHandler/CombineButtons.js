/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/uid","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/util/ManagedObjectModel"],function(e,t,n){"use strict";var r={};var o="$sap.m.flexibility.CombineButtonsModel";function i(e,t,n,r,i,a,u,c,s){var g="";var l="";var d="";var f=[];var m=sap.ui.getCore().getConfiguration().getRTL();var v=[];return e.reduce(function(e,p,b){var h;var C=b;var y;var I;var P=c.content.buttonsIdForSave[C];var S;var M="$sap.m.flexibility.MenuButtonModel"+C;return e.then(t.getProperty.bind(t,p,"text")).then(function(e){S=e;return t.createControl("sap.m.MenuItem",n,u,P)}).then(function(e){y=e;return t.findIndexInParentAggregation(p)}).then(function(e){s.insertIndexes[C]=e;return t.createControl("sap.ui.fl.util.ManagedObjectModel",n,u,Object.assign({},P,{id:P.id+"-managedObjectModel"}),{object:p,name:o})}).then(function(e){I=e;return t.insertAggregation(y,"dependents",I,0,u)}).then(function(){return t.createControl("sap.ui.core.CustomData",n,u,Object.assign({},P,{id:P.id+"-customData"}),{key:"{ path: '"+o+">key' }",value:"{ path: '"+o+">value' }"})}).then(function(e){t.bindProperty(y,"text",o+">/text");t.bindProperty(y,"icon",o+">/icon");t.bindProperty(y,"enabled",o+">/enabled");t.bindProperty(y,"visible",o+">/visible");return t.bindAggregation(y,"customData",{path:o+">/customData",template:e,templateShareable:false},u)}).then(function(){if(S){m?v.unshift(S):v.push(S)}var e=Object.assign({},P,{id:P.id+"-originalButtonId"});return t.createControl("sap.ui.core.CustomData",n,u,e)}).then(function(e){h=e;t.setProperty(h,"key","originalButtonId");t.setProperty(h,"value",t.getId(p));return t.removeAggregation(i,a,p)}).then(function(){return t.insertAggregation(i,"dependents",p,0,u)}).then(function(){t.insertAggregation(p,"customData",h,0,u)}).then(function(){t.insertAggregation(r,"items",y,C,u)}).then(function(){return t.createControl("sap.ui.fl.util.ManagedObjectModel",n,u,Object.assign({},P,{id:P.id+"-managedObjectModelMenuItem"}),{object:y,name:M})}).then(function(e){f[C]=e;g=g+d+"${"+M+">/enabled}";l=l+d+"${"+M+">/visible}";d=" || ";return{menuButtonModels:f,menuButtonName:v,propertyEnabled:g,propertyVisible:l}})},Promise.resolve())}r.applyChange=function(e,t,n){if(n.modifier.targets!=="jsControlTree"){return Promise.reject(new Error("Combine buttons change can't be applied on XML tree"))}var r=e.getDefinition();var o=n.modifier;var a=n.view;var u=n.appComponent;var c;var s;var g;var l;var d;var f;var m;var v={parentAggregation:"",insertIndexes:[]};var p=[];var b=[];return Promise.resolve().then(o.bySelector.bind(o,r.content.combineButtonSelectors[0],u,a)).then(function(e){s=e;c=o.getParent(s);var t=[];r.content.combineButtonSelectors.forEach(function(e){var n=Promise.resolve().then(o.bySelector.bind(o,e,u,a));t.push(n)});return Promise.all(t)}).then(function(e){d=e;return o.getParentAggregationName(d[0],c)}).then(function(e){l=e;v.parentAggregation=l;return o.findIndexInParentAggregation(s)}).then(function(e){g=e;return o.createControl("sap.m.Menu",u,a,r.content.menuIdSelector)}).then(function(e){f=e;return o.attachEvent(f,"itemSelected","sap.m.changeHandler.CombineButtons.pressHandler")}).then(function(){return i(d,o,u,f,c,l,a,r,v)}).then(function(e){p=e.menuButtonModels;b=e.menuButtonName;var t=e.propertyVisible;var n=e.propertyEnabled;return o.createControl("sap.m.MenuButton",u,a,r.content.menuButtonIdSelector,{visible:"{= "+t+"}",enabled:"{= "+n+"}"})}).then(function(e){m=e;return p.reduce(function(e,t){return e.then(o.insertAggregation.bind(o,m,"dependents",t,0,a))},Promise.resolve())}).then(function(){o.setProperty(m,"text",b.join("/"));return Promise.resolve().then(o.insertAggregation.bind(o,m,"menu",f,0,a)).then(o.insertAggregation.bind(o,c,l,m,g,a)).then(function(){e.setRevertData(v)})})};function a(e,t){return e.reduce(function(e,n){return e.then(function(){return t.getProperty(n,"key")}).then(function(e){if(e==="originalButtonId"){return t.destroy(n)}return undefined})},Promise.resolve())}r.revertChange=function(e,t,n){var r=n.modifier;var o=n.view;var i=e.getRevertData();var u=e.getDefinition();var c=i.parentAggregation;var s,g,l;return Promise.resolve().then(function(){return r.bySelector(u.content.menuButtonIdSelector,n.appComponent,o)}).then(function(e){s=e;g=r.getParent(s);l=u.content.combineButtonSelectors.slice().reverse();return r.removeAggregation(g,c,s)}).then(function(){return r.destroy(s)}).then(function(){var t=l.length;return l.reduce(function(e,u,s){var l=s;var d;return e.then(function(){return r.bySelector(u,n.appComponent,o)}).then(function(e){d=e;return r.getAggregation(d,"customData")}).then(function(e){return a(e,r)}).then(function(){return r.insertAggregation(g,c,d,i.insertIndexes[t-l-1],o)})},Promise.resolve()).then(function(){e.resetRevertData()})})};r.completeChangeContent=function(t,n,r){var o=r.modifier;var i=r.appComponent;var a=t.getDefinition();var u=n.combineElementIds;if(u&&u.length>1){t.addDependentControl(u,"combinedButtons",r);a.content.combineButtonSelectors=u.map(function(e){return o.getSelector(e,i)});a.content.menuButtonIdSelector=o.getSelector(i.createId(e()),i);a.content.menuIdSelector=o.getSelector(i.createId(e()),i);a.content.buttonsIdForSave=u.map(function(){return o.getSelector(i.createId(e()),i)})}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required")}};r.pressHandler=function(e){var t=e.getParameter("item").getModel(o).getObject();t.firePress()};return r},true);