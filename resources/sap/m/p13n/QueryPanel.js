/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/layout/Grid","./BasePanel","sap/ui/core/Item","sap/m/CustomListItem","sap/m/Select","sap/m/List","sap/m/HBox","sap/m/library","sap/m/Button"],function(t,e,n,o,i,r,s,a,p){"use strict";var u=e.extend("sap.m.p13n.QueryPanel",{metadata:{library:"sap.m",properties:{queryLimit:{type:"int",defaultValue:-1}}},renderer:{}});var l=a.ListType;var h=a.FlexJustifyContent;var g=a.ButtonType;u.prototype.NONE_KEY="$_none";u.prototype.init=function(){e.prototype.init.apply(this,arguments);this.setEnableReorder(true);this.addStyleClass("sapMP13nQueryPanel")};u.prototype.setP13nData=function(t){e.prototype.setP13nData.apply(this,arguments);this._oListControl.removeAllItems();if(t instanceof Array){t.forEach(function(t){if(t[this.PRESENCE_ATTRIBUTE]){this._addQueryRow(t)}}.bind(this));this._addQueryRow()}return this};u.prototype._moveTableItem=function(t,n){e.prototype._moveTableItem.apply(this,arguments);this._oListControl.removeItem(t);this._oListControl.insertItem(t,n)};u.prototype._updateEnableOfMoveButtons=function(t,n){e.prototype._updateEnableOfMoveButtons.apply(this,arguments);if(this._oListControl.getItems().indexOf(t)===this._oListControl.getItems().length-2){this._getMoveDownButton().setEnabled(false)}};u.prototype._createInnerListControl=function(){return new r(this.getId()+"-innerP13nList",{itemPress:[this._onItemPressed,this],dragDropConfig:this._getDragDropConfig()})};u.prototype._getModelEntry=function(t){var e=t.getContent()[0].getContent()[0]._key;var n=this._getP13nModel().getProperty("/items").find(function(t){return t.name==e});return n};u.prototype._getAvailableItems=function(t){var e=this._getP13nModel().getProperty("/items");var o=[new n({key:this.NONE_KEY,text:this._getResourceText("p13n.QUERY_NONE"),enabled:!t})];e.forEach(function(t,e){o.push(new n({key:t.name,text:t.label,enabled:{path:this.P13N_MODEL+">/items/"+e+"/"+this.PRESENCE_ATTRIBUTE,formatter:function(t){return!t}}}))}.bind(this));return o};u.prototype._getMoveDownButton=function(){var t=e.prototype._getMoveDownButton.apply(this,arguments);t.setIcon("sap-icon://navigation-down-arrow");return t};u.prototype._getMoveUpButton=function(){var t=e.prototype._getMoveUpButton.apply(this,arguments);t.setIcon("sap-icon://navigation-up-arrow");return t};u.prototype._addQueryRow=function(t){if(this.getQueryLimit()>-1&&this.getQueryLimit()===this._oListControl.getItems().length){return}t=t?t:{name:null};var e=this._createQueryRowGrid(t);var n=new o({type:l.Active,content:[e]});if(this.getEnableReorder()&&(this.getQueryLimit()===-1||this.getQueryLimit()>1)){this._addHover(n)}n.getContent()[0].getContent()[0]._key=t.name;this._oListControl.addItem(n);var i=!!t.name;var r=this._createRemoveButton(i);n.getContent()[0].addContent(r);return n};u.prototype._createQueryRowGrid=function(e){var n=this._createKeySelect(e.name);return new t({containerQuery:true,defaultSpan:"XL6 L6 M6 S6",content:[n]}).addStyleClass("sapUiTinyMargin")};u.prototype._handleActivated=function(t){var e=t.getContent()[0];if(e){var n=e.getContent().length-1;var o=t.getContent()[0].getContent()[n];if(t&&o.getItems().length<2){o.insertItem(this._getMoveUpButton(),0);o.insertItem(this._getMoveDownButton(),1);this._updateEnableOfMoveButtons(t,false)}}};u.prototype._createKeySelect=function(t){var e=new i({width:"14rem",items:this._getAvailableItems(t),selectedKey:t,change:this._selectKey.bind(this)});return e};u.prototype._selectKey=function(t){var e=t.getSource().getParent().getParent();var n=this._oListControl.getItems().length-1==this._oListControl.getItems().indexOf(e);var o=t.getParameter("selectedItem").getKey();var i=t.getSource()._key;var r=e.getContent()[0].getContent()[e.getContent()[0].getContent().length-1];r.setVisible(o!==this.NONE_KEY);if(i){this._updatePresence(i,false,undefined)}t.getSource()._key=o;this._updatePresence(o,true,this._oListControl.getItems().indexOf(e));if(o!==this.NONE_KEY&&n){this._addQueryRow();var s=t.getSource();var a=s.getItemByKey(this.NONE_KEY);a.setEnabled(false)}};u.prototype._createRemoveButton=function(t){var e=new s({justifyContent:h.End,width:"100%",visible:t,items:[new p({type:g.Transparent,icon:"sap-icon://decline",press:function(t){var e=t.getSource().getParent().getParent().getParent();this._oListControl.removeItem(e);this._updatePresence(e.getContent()[0].getContent()[0]._key,false,undefined);if(this._oListControl.getItems().length===0){this._addQueryRow()}else{var n=this._oListControl.getItems().length-1;this._oListControl.getItems()[n].getContent()[0].getContent()[0].focus()}}.bind(this)})]});return e};u.prototype._moveSelectedItem=function(){this._oSelectedItem=this._getMoveUpButton().getParent().getParent().getParent();e.prototype._moveSelectedItem.apply(this,arguments)};u.prototype._updatePresence=function(t,e,n){var o=this._getP13nModel().getProperty("/items");var i=o.filter(function(e){return e.name===t});if(i[0]){i[0][this.PRESENCE_ATTRIBUTE]=e}if(n!==undefined){var r=o.indexOf(i[0]);o.splice(n,0,o.splice(r,1)[0])}this._getP13nModel().setProperty("/items",o);this.fireChange({reason:e?this.CHANGE_REASON_ADD:this.CHANGE_REASON_REMOVE,item:i[0]})};return u});