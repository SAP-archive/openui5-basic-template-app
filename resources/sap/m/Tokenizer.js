/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/m/Button","sap/m/List","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/ui/core/Core","sap/ui/core/Control","sap/ui/core/delegate/ScrollEnablement","sap/ui/Device","sap/ui/core/InvisibleText","sap/ui/core/ResizeHandler","./TokenizerRenderer","sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/core/EnabledPropagator","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(e,t,o,i,n,s,r,a,l,d,p,h,u,c,f,g,T){"use strict";var k=e.TokenizerRenderMode,y=e.PlacementType,_=e.ListMode;var m=r.extend("sap.m.Tokenizer",{metadata:{library:"sap.m",properties:{editable:{type:"boolean",group:"Misc",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},maxWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},renderMode:{type:"string",group:"Misc",defaultValue:k.Loose},hiddenTokensCount:{type:"int",group:"Misc",defaultValue:0,visibility:"hidden"}},defaultAggregation:"tokens",aggregations:{tokens:{type:"sap.m.Token",multiple:true,singularName:"token"},_tokensInfo:{type:"sap.ui.core.InvisibleText",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{tokenChange:{parameters:{type:{type:"string"},token:{type:"sap.m.Token"},tokens:{type:"sap.m.Token[]"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},tokenUpdate:{allowPreventDefault:true,parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},tokenDelete:{parameters:{tokens:{type:"sap.m.Token[]"},keyCode:{type:"number"}}}}}});var v=s.getLibraryResourceBundle("sap.m");g.apply(m.prototype,[true]);m.prototype.init=function(){this.allowTextSelection(false);this._oTokensWidthMap={};this._oIndicator=null;this._oScroller=new a(this,this.getId()+"-scrollContainer",{horizontal:true,vertical:false,nonTouchScrolling:true});if(s.getConfiguration().getAccessibility()){var e=new d({text:v.getText("TOKENIZER_ARIA_CONTAIN_TOKEN")});this.setAggregation("_tokensInfo",e)}this.attachEvent("delete",function(e){var t=e.getSource();var o=this.getSelectedTokens();this.fireTokenChange({type:sap.m.Tokenizer.TokenChangeType.Removed,token:t,tokens:o.length?o:[t],addedTokens:[],removedTokens:o.length?o:[t]});this.fireTokenUpdate({type:sap.m.Tokenizer.TokenChangeType.Removed,addedTokens:[],removedTokens:o.length?o:[t]});this.fireEvent("tokenDelete",{tokens:[t]})},this)};m.prototype._handleNMoreIndicatorPress=function(){this._togglePopup(this.getTokensPopup())};m.prototype._getTokensList=function(){if(!this._oTokensList){this._oTokensList=new o({width:"auto",mode:_.Delete}).attachDelete(this._handleListItemDelete,this)}return this._oTokensList};m.prototype._setPopoverMode=function(e){var t={},o=this.getTokensPopup();switch(e){case _.Delete:t={showArrow:false,placement:y.VerticalPreferredBottom};break;default:t={showArrow:true,placement:y.Auto};break}o.setShowArrow(t.showArrow);o.setPlacement(t.placement);this._getTokensList().setMode(e)};m.prototype._fillTokensList=function(e,t){e.destroyItems();t=t?t:function(){return true};this.getTokens().filter(t).forEach(function(t){e.addItem(this._mapTokenToListItem(t))},this)};m.prototype._handleListItemDelete=function(e){var t=e.getParameter("listItem");var o=t&&t.data("tokenId");var i;i=this.getTokens().filter(function(e){return e.getId()===o&&e.getEditable()})[0];if(i){this.fireTokenUpdate({addedTokens:[],removedTokens:[i],type:m.TokenUpdateType.Removed});this.fireTokenDelete({tokens:[i]});t.destroy();this._adjustTokensVisibility()}};m.prototype.getTokensPopup=function(){if(this._oPopup){return this._oPopup}this._oPopup=new n({showArrow:false,showHeader:false,placement:y.Auto,offsetX:0,offsetY:3,horizontalScrolling:false,content:this._getTokensList()}).attachBeforeOpen(function(){var e=this.getEditable()?120:0,t=this._oPopup;if(t.getContent&&!t.getContent().length){t.addContent(this._getTokensList())}this._fillTokensList(this._getTokensList());e+=Object.keys(this._oTokensWidthMap).map(function(e){return this._oTokensWidthMap[e]},this).sort(function(e,t){return e-t}).pop()||0;t.setContentWidth(e+"px")},this);this.addDependent(this._oPopup);if(l.system.phone){this._oPopup.setEndButton(new t({text:v.getText("SUGGESTIONSPOPOVER_CLOSE_BUTTON"),press:function(){this._oPopup.close()}.bind(this)}))}return this._oPopup};m.prototype._togglePopup=function(e){var t,o=this.getDomRef(),i=e.isOpen(),n=this.getEditable();this._setPopoverMode(n?_.Delete:_.None);if(i){e.close()}else{t=n||this.hasOneTruncatedToken()?o:this._oIndicator[0];t=t&&t.className.indexOf("sapUiHidden")===-1?t:o;e.openBy(t||o)}};m.prototype._mapTokenToListItem=function(e){if(!e){return null}var t=new i({selected:true}).data("tokenId",e.getId());t.setTitle(e.getText());return t};m.prototype._getPixelWidth=function(){var e=this.getMaxWidth(),t,o=this.getDomRef(),i;if(!o){return}i=parseInt(this.$().css("padding-left"));if(e.indexOf("px")===-1){t=o.clientWidth}else{t=parseInt(this.getMaxWidth())}return t-i};m.prototype._adjustTokensVisibility=function(){if(!this.getDomRef()){return}var e=this._getPixelWidth(),t=this._getVisibleTokens().reverse(),o=t.length,i,n,s,r=-1;t.some(function(t,o){e=e-this._oTokensWidthMap[t.getId()];if(e<0){r=o;return true}else{n=e}},this);if(o===1&&r!==-1){this.setFirstTokenTruncated(true);return}else if(o===1&&t[0].getTruncated()){this.setFirstTokenTruncated(false)}if(r>-1){for(s=0;s<o;s++){if(s>=r){t[s].addStyleClass("sapMHiddenToken")}else{t[s].removeStyleClass("sapMHiddenToken")}}this._handleNMoreIndicator(o-r);i=this._oIndicator.width();if(i>=n){r=r-1;this._handleNMoreIndicator(o-r);t[r].addStyleClass("sapMHiddenToken")}this._setHiddenTokensCount(o-r)}else{this._setHiddenTokensCount(0);this._showAllTokens()}};m.prototype.setFirstTokenTruncated=function(e){var t=this.getTokens()[0];t&&t.setTruncated(e);if(e){this.addStyleClass("sapMTokenizerOneLongToken")}else{this.removeStyleClass("sapMTokenizerOneLongToken");this.scrollToEnd()}return this};m.prototype.hasOneTruncatedToken=function(){return this.getTokens().length===1&&this.getTokens()[0].getTruncated()};m.prototype._handleNMoreIndicator=function(e){if(!this.getDomRef()){return this}if(e){var t="MULTIINPUT_SHOW_MORE_TOKENS";if(e===this._getVisibleTokens().length){if(e===1){t="TOKENIZER_SHOW_ALL_ITEM"}else{t="TOKENIZER_SHOW_ALL_ITEMS"}}this._oIndicator.html(v.getText(t,e))}return this};m.prototype._getVisibleTokens=function(){return this.getTokens().filter(function(e){return e.getVisible()})};m.prototype._showAllTokens=function(){this._getVisibleTokens().forEach(function(e){e.removeStyleClass("sapMHiddenToken")})};m.prototype.getScrollDelegate=function(){return this._oScroller};m.prototype.scrollToEnd=function(){var e=this.getDomRef(),t;if(!this.getDomRef()){return}t=this.$().find(".sapMTokenizerScrollContainer")[0];if(l.browser.msie){setTimeout(function(){e.scrollLeft=t.scrollWidth})}else{e.scrollLeft=t.scrollWidth}};m.prototype._registerResizeHandler=function(){if(!this._sResizeHandlerId){this._sResizeHandlerId=p.register(this.getDomRef(),this._handleResize.bind(this))}};m.prototype._handleResize=function(){this._useCollapsedMode(this.getRenderMode());this.scrollToEnd()};m.prototype.setPixelWidth=function(e){if(typeof e!=="number"){f.warning("Tokenizer.setPixelWidth called with invalid parameter. Expected parameter of type number.");return}this.setWidth(e+"px");if(this._oScroller){this._oScroller.refresh()}};m.prototype.scrollToStart=function(){var e=this.getDomRef();if(!e){return}e.scrollLeft=0};m.prototype.getScrollWidth=function(){if(!this.getDomRef()){return 0}return this.$().children(".sapMTokenizerScrollContainer")[0].scrollWidth};m.prototype.onBeforeRendering=function(){var e=this.getTokens();if(e.length===0){this.setFirstTokenTruncated(false)}e.forEach(function(t,o){t.setProperty("editableParent",this.getEditable()&&this.getEnabled(),true);t.setProperty("posinset",o+1,true);t.setProperty("setsize",e.length,true)},this);this._setTokensAria()};m.prototype.onAfterRendering=function(){var e=this.getRenderMode();this._oIndicator=this.$().find(".sapMTokenizerIndicator");if(s.isThemeApplied()){this._storeTokensSizes()}this._useCollapsedMode(e);this._registerResizeHandler();if(e===k.Loose){this.scrollToEnd()}};m.prototype.onThemeChanged=function(){this._storeTokensSizes();this._useCollapsedMode(this.getRenderMode())};m.prototype._storeTokensSizes=function(){var e=this.getTokens();e.forEach(function(e){if(e.getDomRef()&&!e.$().hasClass("sapMHiddenToken")&&!e.getTruncated()){this._oTokensWidthMap[e.getId()]=e.$().outerWidth(true)}},this)};m.prototype._useCollapsedMode=function(e){var t=this._getVisibleTokens();if(!t.length){return}if(e===k.Narrow){this._adjustTokensVisibility()}else{this._setHiddenTokensCount(0);this._showAllTokens()}};m.prototype.onsapfocusleave=function(e){if(document.activeElement===this.getDomRef()||!this._checkFocus()){this._changeAllTokensSelection(false);this._oSelectionOrigin=null}};m.prototype.onsapbackspace=function(e){var t=this.getSelectedTokens();var o=this.getTokens().filter(function(e){return e.getFocusDomRef()===document.activeElement})[0];var i=t.length?t:[o];e.preventDefault();return this.fireTokenDelete({tokens:i,keyCode:e.which})};m.prototype.onsapdelete=m.prototype.onsapbackspace;m.prototype.onkeydown=function(e){var t;if(!this.getEnabled()){return}if(e.which===c.TAB){this._changeAllTokensSelection(false)}if((e.ctrlKey||e.metaKey)&&e.which===c.A){t=this.getSelectedTokens().length<this._getVisibleTokens().length;if(this._getVisibleTokens().length>0){this.focus();this._changeAllTokensSelection(t);e.preventDefault();e.stopPropagation()}}if((e.ctrlKey||e.metaKey)&&(e.which===c.C||e.which===c.INSERT)){this._copy()}if((e.ctrlKey||e.metaKey)&&e.which===c.X||e.shiftKey&&e.which===c.DELETE){if(this.getEditable()){this._cut()}else{this._copy()}}};m.prototype.onsappreviousmodifiers=function(e){this.onsapprevious(e)};m.prototype.onsapnextmodifiers=function(e){this.onsapnext(e)};m.prototype.onsaphomemodifiers=function(e){this._selectRange(false)};m.prototype.onsapendmodifiers=function(e){this._selectRange(true)};m.prototype._selectRange=function(e){var t={},o=this._getVisibleTokens(),i=T(document.activeElement).control()[0],n=o.indexOf(i);if(!i||!i.isA("sap.m.Token")){return}if(e){t.start=n;t.end=o.length-1}else{t.start=0;t.end=n}if(t.start<t.end){for(var s=t.start;s<=t.end;s++){o[s].setSelected(true)}}};m.prototype._copy=function(){this._fillClipboard("copy")};m.prototype._fillClipboard=function(e){var t=this.getSelectedTokens();var o=t.map(function(e){return e.getText()}).join("\r\n");var i=function(e){if(e.clipboardData){e.clipboardData.setData("text/plain",o)}else{e.originalEvent.clipboardData.setData("text/plain",o)}e.preventDefault()};if(l.browser.msie&&window.clipboardData){window.clipboardData.setData("text",o)}else{document.addEventListener(e,i);document.execCommand(e);document.removeEventListener(e,i)}};m.prototype._cut=function(){var e=this.getSelectedTokens();this._fillClipboard("cut");this.fireTokenChange({type:sap.m.Tokenizer.TokenChangeType.Removed,token:e,tokens:e,addedTokens:[],removedTokens:e});this.fireTokenUpdate({type:sap.m.Tokenizer.TokenChangeType.Removed,addedTokens:[],removedTokens:e});this.fireTokenDelete({tokens:e})};m.prototype._ensureTokenVisible=function(e){if(!e||!e.getDomRef()||!this.getDomRef()){return}var t=this.$().offset().left,o=this.$().width(),i=e.$().offset().left,n=e.$().width();if(this._getVisibleTokens().indexOf(e)===0){this.$().scrollLeft(0);return}if(i<t){this.$().scrollLeft(this.$().scrollLeft()-t+i)}if(i-t+n>o){this.$().scrollLeft(this.$().scrollLeft()+(i-t+n-o))}};m.prototype.ontap=function(e){var t=e.shiftKey,o=e.ctrlKey||e.metaKey,i=e.getMark("tokenTap"),n=e.getMark("tokenDeletePress"),s=this._getVisibleTokens(),r=s[s.length-1],a,d,p,h,u;if(n||!i||!t&&o){this._oSelectionOrigin=null;return}if(l.browser.msie&&i===r){this.scrollToEnd()}if(!t){this._oSelectionOrigin=i;this._changeAllTokensSelection(false,i,true)}a=i;if(this._oSelectionOrigin){a=this._oSelectionOrigin}else{this._oSelectionOrigin=a}if(i&&this.hasOneTruncatedToken()){this._handleNMoreIndicatorPress();return}d=this.indexOfToken(a);p=this.indexOfToken(i);h=Math.min(d,p);u=Math.max(d,p);s.forEach(function(e,t){if(t>=h&&t<=u){e.setSelected(true)}else if(!o){e.setSelected(false)}})};m.prototype.onsapprevious=function(e){var t=this._getVisibleTokens(),o=t.length;if(o===0){return}var i=T(document.activeElement).control()[0];var n=i?t.indexOf(i):-1;if(n===0){e.setMarked("forwardFocusToParent");return}var s,r;if(n>0){s=t[n-1];s.focus()}else{s=t[t.length-1];s.focus({preventScroll:true})}if(e.shiftKey){r=t[n];s.setSelected(true);r.setSelected(true)}e.setMarked();e.preventDefault()};m.prototype.onsapnext=function(e){var t=this._getVisibleTokens(),o=t.length;if(o===0){return}var i=T(document.activeElement).control()[0];var n=i?t.indexOf(i):-1;if(n<o-1){var s=t[n+1],r=t[n];s.focus();if(e.shiftKey){s.setSelected(true);r.setSelected(true)}this._ensureTokenVisible(s)}else{e.setMarked("forwardFocusToParent");return}e.setMarked();e.preventDefault()};m.prototype.addValidator=function(e){f.warning("[Warning]:","You are attempting to use deprecated method 'addValidator()', please use MultiInput.prototype.addValidator instead.",this)};m.prototype.removeValidator=function(e){f.warning("[Warning]:","You are attempting to use deprecated method 'addValidator()', please use MultiInput.prototype.addValidator instead.",this)};m.prototype.removeAllValidators=function(){f.warning("[Warning]:","You are attempting to use deprecated method 'addValidator()', please use MultiInput.prototype.addValidator instead.",this)};m.prototype.addValidateToken=function(e){f.warning("[Warning]:","You are attempting to use deprecated method 'addValidator()', please use MultiInput.prototype.addValidator instead.",this)};m.prototype._parseString=function(e){return e.split(/\r\n|\r|\n/g)};m.prototype._checkFocus=function(){return this.getDomRef()&&u(this.getDomRef(),document.activeElement)};m.prototype.selectAllTokens=function(e){if(e===undefined){e=true}this._changeAllTokensSelection(e);return this};m.prototype._changeAllTokensSelection=function(e,t,o){var i=this._getVisibleTokens();i.filter(function(e){return e!==t}).forEach(function(t){t.setSelected(e)});if(!o){this._doSelect()}return this};m.prototype.getSelectedTokens=function(){return this._getVisibleTokens().filter(function(e){return e.getSelected()})};m.prototype.onsaphome=function(e){var t=this.getTokens().filter(function(e){return e.getDomRef()&&!e.getDomRef().classList.contains("sapMHiddenToken")});t.length&&t[0].focus();this.scrollToStart();e.preventDefault()};m.prototype.onsapend=function(e){var t=this._getVisibleTokens(),o=t[t.length-1];if(o.getDomRef()!==document.activeElement){o.focus();this.scrollToEnd();e.stopPropagation()}else{e.setMarked("forwardFocusToParent")}e.preventDefault()};m.prototype.onclick=function(e){var t;if(!this.getEnabled()){return}t=!this.hasStyleClass("sapMTokenizerIndicatorDisabled")&&e.target.classList.contains("sapMTokenizerIndicator");if(t){this._handleNMoreIndicatorPress()}};m.prototype.ontouchstart=function(e){e.setMarked();if(l.browser.chrome&&window.getSelection()){window.getSelection().removeAllRanges()}};m.prototype.exit=function(){this._deregisterResizeHandler();if(this._oTokensList){this._oTokensList.destroy();this._oTokensList=null}if(this._oScroller){this._oScroller.destroy();this._oScroller=null}if(this._oPopup){this._oPopup.destroy();this._oPopup=null}this._oTokensWidthMap=null;this._oIndicator=null;this._aTokenValidators=null};m.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){p.deregister(this._sResizeHandlerId);delete this._sResizeHandlerId}};m.prototype._setTokensAria=function(){var e=this._getVisibleTokens().length;var t;var o="";var i="";var n={0:"TOKENIZER_ARIA_CONTAIN_TOKEN",1:"TOKENIZER_ARIA_CONTAIN_ONE_TOKEN"};if(s.getConfiguration().getAccessibility()){t=this.getAggregation("_tokensInfo");i=n[e]?n[e]:"TOKENIZER_ARIA_CONTAIN_SEVERAL_TOKENS";o=v.getText(i,e);t.setText(o)}};m.prototype._doSelect=function(){if(this._checkFocus()&&this._bCopyToClipboardSupport){var e=document.activeElement;var t=window.getSelection();t.removeAllRanges();if(this.getSelectedTokens().length){var o=document.createRange();o.selectNodeContents(this.getDomRef("clip"));t.addRange(o)}if(window.clipboardData&&e.id===this.getId()+"-clip"&&this.getDomRef()){this.getDomRef().focus()}}};m.prototype._setHiddenTokensCount=function(e){e=this.validateProperty("hiddenTokensCount",e);return this.setProperty("hiddenTokensCount",e)};m.prototype.getHiddenTokensCount=function(){return this.getProperty("hiddenTokensCount")};m.prototype.getTokensInfoId=function(){return this.getAggregation("_tokensInfo").getId()};m.prototype._handleBackspace=function(e,t){var o=this.getTokens();if(o[e-1]){return o[e-1].focus()}return t()};m.prototype._handleDelete=function(e,t){var o=this.getTokens();if(o[e+1]){return o[e+1].focus()}return t()};m.prototype.focusToken=function(e,t,o){var i=this.getTokens();var n=t.keyCode;var s=t.keyCode===c.BACKSPACE;if(i.length===0){return}if(!n){return}if(s){return this._handleBackspace(e,o)}return this._handleDelete(e,o)};m.TokenChangeType={Added:"added",Removed:"removed",RemovedAll:"removedAll",TokensChanged:"tokensChanged"};m.TokenUpdateType={Added:"added",Removed:"removed"};return m});